<!DOCTYPE html><html lang="en"><head><title>db</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="db"><meta name="groc-project-path" content="db.js"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path">db.js</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><p>db.js</p>
<p>Manages the Engine&#39;s internal database.  The database is implemented with tingodb
which is sort of a lightweight mongodb clone.  The database stores the following things:</p>
<ul>
<li>file metadata (actual files contents are stored on disk)</li>
<li>job data</li>
<li>file thumbnails (currently unused)</li>
</ul></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">'assert'</span>);
<span class="hljs-keyword">var</span> <span class="hljs-keyword">async</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'async'</span>);
<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs-extra'</span>);
<span class="hljs-keyword">var</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">'crypto'</span>);
<span class="hljs-keyword">var</span> log = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./log'</span>).logger(<span class="hljs-string">'db'</span>);
<span class="hljs-keyword">var</span> config = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./config'</span>);
<span class="hljs-keyword">var</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./util'</span>);
<span class="hljs-keyword">var</span> ncp = <span class="hljs-built_in">require</span>(<span class="hljs-string">'ncp'</span>).ncp;
<span class="hljs-keyword">var</span> process = <span class="hljs-built_in">require</span>(<span class="hljs-string">'process'</span>);
<span class="hljs-keyword">var</span> cnctosvg = <span class="hljs-built_in">require</span>(<span class="hljs-string">"cnctosvg"</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Connect to TingoDB database that stores the files
Confusingly called &quot;Engine&quot; but not to be confused with the FabMo engine</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> Engine = <span class="hljs-built_in">require</span>(<span class="hljs-string">'tingodb'</span>)();</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Collections (each of these is like a table in the database)
     files: Files refer to individual files on disk, which are created when Jobs are submitted.
      jobs: A job represents a single &quot;run&quot; - many jobs can refer to the same file (repeat runs or submittals of the same actual file data)
thumbnails: Preview thumbnails are generated when files are uploaded and can be previewed in the frontend.  This feature needs work, and is not currently exposed.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> files;
<span class="hljs-keyword">var</span> jobs;
<span class="hljs-keyword">var</span> thumbnails;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>maxStorage defines how much space all of the files can take up on disk before we start to prune the oldest ones.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> maxStorage = <span class="hljs-number">500000000</span>;
<span class="hljs-keyword">var</span> totalSize = <span class="hljs-number">0</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This function sends an event over the websocket to inform the dashboard that something in the job queue or history has changed.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">notifyChange</span>(<span class="hljs-params"></span>) </span>{
	<span class="hljs-keyword">var</span> machine = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./machine'</span>).machine;
	<span class="hljs-keyword">if</span>(machine) {
		machine.emit(<span class="hljs-string">'change'</span>, <span class="hljs-string">'jobs'</span>);
	}
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Job object has all of the features described.
  file_id refers to objects in the File collection.  Each job has a file, which is the CNC data that is run for that job.
  states for jobs:
    &#39;pending&#39; - Job is in the queue
    &#39;running&#39; - Job is currently active (There are only one of these at a time)
    &#39;finished&#39; - Job completed with no errors
    &#39;cancelled&#39; - Job was cancelled by user intervention
    &#39;failed&#39; - Job failed due to error
    &#39;trash&#39; - Job is marked for deletion from the history</p></div></div><div class="code"><div class="wrapper">Job = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">options</span>) </span>{
    <span class="hljs-keyword">this</span>.file_id = options.file_id || <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">this</span>.name = options.name || <span class="hljs-string">"Untitled Job"</span>;
    <span class="hljs-keyword">this</span>.description = options.description || <span class="hljs-string">""</span>;
    <span class="hljs-keyword">this</span>.created_at = <span class="hljs-built_in">Date</span>.now();
    <span class="hljs-keyword">this</span>.started_at = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">this</span>.finished_at = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">this</span>.state = <span class="hljs-string">"pending"</span>;
    <span class="hljs-keyword">this</span>.order = options.order || <span class="hljs-literal">null</span>;
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Clone a job.  Used for re-running files, usually.</p></div></div><div class="code"><div class="wrapper">Job.prototype.clone = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) </span>{
	<span class="hljs-keyword">var</span> job = <span class="hljs-keyword">new</span> Job({
		file_id : <span class="hljs-keyword">this</span>.file_id,
		name : <span class="hljs-keyword">this</span>.name,
		description : <span class="hljs-keyword">this</span>.description 
	});
	job.save(callback);
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>TODO @brendan</p></div></div><div class="code"><div class="wrapper">Job.prototype.update_order = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">order, callback</span>)</span>{
    log.info(<span class="hljs-string">"Upating "</span> + <span class="hljs-keyword">this</span>._id ? <span class="hljs-keyword">this</span>._id : <span class="hljs-string">'&lt;volatile job&gt;'</span>);
    <span class="hljs-keyword">this</span>.order = order;
    <span class="hljs-keyword">this</span>.save(callback);
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The functions below update the state of the job object in the database.
Note that they don&#39;t <em>do</em> anything other than manage state.</p></div></div><div class="code"><div class="wrapper">Job.prototype.start = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) </span>{
	log.info(<span class="hljs-string">"Starting job id "</span> + <span class="hljs-keyword">this</span>._id ? <span class="hljs-keyword">this</span>._id : <span class="hljs-string">'&lt;volatile job&gt;'</span>);
	<span class="hljs-keyword">this</span>.state = <span class="hljs-string">'running'</span>;
	<span class="hljs-keyword">this</span>.started_at = <span class="hljs-built_in">Date</span>.now();
	<span class="hljs-keyword">this</span>.save(callback);
};

Job.prototype.finish = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) </span>{
	log.info(<span class="hljs-string">"Finishing job id "</span> + <span class="hljs-keyword">this</span>._id ? <span class="hljs-keyword">this</span>._id : <span class="hljs-string">'&lt;volatile job&gt;'</span>);
	<span class="hljs-keyword">this</span>.state = <span class="hljs-string">'finished'</span>;
	<span class="hljs-keyword">this</span>.finished_at = <span class="hljs-built_in">Date</span>.now();
	<span class="hljs-keyword">this</span>.save(callback);
};

Job.prototype.fail = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) </span>{
	log.info(<span class="hljs-string">"Failing job id "</span> + (<span class="hljs-keyword">this</span>._id ? <span class="hljs-keyword">this</span>._id : <span class="hljs-string">'&lt;volatile job&gt;'</span>));
	<span class="hljs-keyword">this</span>.state = <span class="hljs-string">'failed'</span>;
	<span class="hljs-keyword">this</span>.finished_at = <span class="hljs-built_in">Date</span>.now();
	<span class="hljs-keyword">this</span>.save(callback);
};

Job.prototype.cancel = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) </span>{
	<span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.state === <span class="hljs-string">'running'</span>) {
		log.debug(<span class="hljs-string">"Cancelling running job id "</span> + <span class="hljs-keyword">this</span>._id);
		<span class="hljs-keyword">this</span>.state = <span class="hljs-string">'cancelled'</span>;
		<span class="hljs-keyword">this</span>.finished_at = <span class="hljs-built_in">Date</span>.now();
		<span class="hljs-keyword">this</span>.save(callback);
	} <span class="hljs-keyword">else</span> {
		setImmediate(callback, <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Cannot cancel a job that is '</span> + <span class="hljs-keyword">this</span>.state));
	}
};

Job.prototype.trash = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) </span>{
	<span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.state !== <span class="hljs-string">'running'</span>) {
		log.debug(<span class="hljs-string">"Trashing job id "</span> + <span class="hljs-keyword">this</span>._id);
		<span class="hljs-keyword">this</span>.state = <span class="hljs-string">'trash'</span>;
		<span class="hljs-keyword">this</span>.finished_at = <span class="hljs-built_in">Date</span>.now();
		<span class="hljs-keyword">this</span>.save(callback);
	} <span class="hljs-keyword">else</span> {
		setImmediate(callback, <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Cannot trash a job that is '</span> + <span class="hljs-keyword">this</span>.state));
	}
};

Job.prototype.cancelOrTrash = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) </span>{
	<span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.state === <span class="hljs-string">'running'</span>) {
		<span class="hljs-keyword">this</span>.cancel(callback);
	} <span class="hljs-keyword">else</span> {
		<span class="hljs-keyword">this</span>.trash(callback);
	}
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Write this job to the database</p></div></div><div class="code"><div class="wrapper">Job.prototype.save = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) </span>{
	<span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.file_id) {
		log.info(<span class="hljs-string">'Not saving this job because no file_id'</span>)
		<span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>, <span class="hljs-keyword">this</span>);
	}

	<span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.pending_cancel;

	jobs.save(<span class="hljs-keyword">this</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, record</span>) </span>{
		<span class="hljs-keyword">if</span>(!record) {
			<span class="hljs-keyword">return</span>;
		}
		notifyChange();
		callback(<span class="hljs-literal">null</span>, <span class="hljs-keyword">this</span>);
	}.bind(<span class="hljs-keyword">this</span>));
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Remove this job from the database entirely (careful!)</p></div></div><div class="code"><div class="wrapper">Job.prototype.delete = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>)</span>{
	jobs.remove({_id : <span class="hljs-keyword">this</span>._id},<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>)</span>{
		<span class="hljs-keyword">if</span>(err) {
			callback(err)
		} <span class="hljs-keyword">else</span> {
			callback();
			notifyChange();
		}
	});
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The functions below are for retrieving jobs from the database.
They do not modify any information in the database</p></div></div><div class="code"><div class="wrapper">Job.getPending = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) </span>{
	jobs.find({state:<span class="hljs-string">'pending'</span>}).toArray(callback);
};

Job.getRunning = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) </span>{
	jobs.find({state:<span class="hljs-string">'running'</span>}).toArray(callback);
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Retrieve the &quot;history&quot; which includes jobs that are in one of the completed states; finished, cancelled, or failed
options:</p>
<ul>
<li>start : The starting index for retrieval.</li>
<li>count : The number of files to retrieve from the history (sorted by creation date)</li>
</ul>
<p>example: 
   getHistory({count : 10})  will retrieve the 10 most recent jobs in the history. (Ordered by creation date)
   getHistory({start : 10, count : 5}) will retrieve 5 jobs from the history, starting with the tenth one. </p></div></div><div class="code"><div class="wrapper">Job.getHistory = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">options, callback</span>) </span>{
	<span class="hljs-keyword">var</span> total = jobs.count({
		state: {$<span class="hljs-keyword">in</span> : [<span class="hljs-string">'finished'</span>, <span class="hljs-string">'cancelled'</span>, <span class="hljs-string">'failed'</span>]}
	}, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, total</span>) </span>{
		<span class="hljs-keyword">if</span>(err) { <span class="hljs-keyword">return</span> callback(err); }
		jobs.find({
			state: {$<span class="hljs-keyword">in</span> : [<span class="hljs-string">'finished'</span>, <span class="hljs-string">'cancelled'</span>, <span class="hljs-string">'failed'</span>]}
		}).skip(options.start || <span class="hljs-number">0</span>).limit(options.count || <span class="hljs-number">0</span>).sort({<span class="hljs-string">'created_at'</span> : -<span class="hljs-number">1</span> }).toArray(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
			<span class="hljs-keyword">if</span>(err) {
				callback(err);
			}
			callback(<span class="hljs-literal">null</span>, {
				<span class="hljs-string">'total_count'</span> : total,
				<span class="hljs-string">'data'</span> : data
			});
		});
	});

};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Get every single job regardless of state, etc.
(careful, this might be a big list)</p></div></div><div class="code"><div class="wrapper">Job.getAll = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) </span>{
	jobs.find().toArray(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, array</span>) </span>{
		<span class="hljs-keyword">if</span>(err){
			<span class="hljs-keyword">throw</span> err
		} <span class="hljs-keyword">else</span> {
			callback(array);
		}

	});
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Given a job ID, retrieve the file object.
This returns file metadata only.  It is does not return the actual file on disk</p></div></div><div class="code"><div class="wrapper">Job.getFileForJobId = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">id, callback</span>) </span>{
	Job.getById(id, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, document</span>) </span>{
		<span class="hljs-keyword">if</span>(err) {
			callback(err);
		} <span class="hljs-keyword">else</span> {
			<span class="hljs-keyword">if</span>(<span class="hljs-built_in">document</span> &amp;&amp; <span class="hljs-built_in">document</span>.file_id) {
				File.getByID(<span class="hljs-built_in">document</span>.file_id, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, file</span>) </span>{
					<span class="hljs-keyword">if</span>(err) {
						callback(err);
					} <span class="hljs-keyword">else</span> {
						<span class="hljs-keyword">if</span>(file) {
							callback(<span class="hljs-literal">null</span>, file);
						} <span class="hljs-keyword">else</span> {
							callback(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Could not find file in database."</span>));
						}
					}
				});
			} <span class="hljs-keyword">else</span> {
				callback(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Could not find job in database."</span>))
			}
		}
	});
}

Job.getById = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">id,callback</span>) </span>{
	jobs.findOne({_id: id},<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err,document</span>)</span>{
		<span class="hljs-keyword">if</span> (!<span class="hljs-built_in">document</span>){
			callback(<span class="hljs-string">"No such job ID: "</span> + id, <span class="hljs-literal">undefined</span>);
			<span class="hljs-keyword">return</span>;
		}
		<span class="hljs-keyword">var</span> job = <span class="hljs-built_in">document</span>;
		job.__proto__ = Job.prototype;
		callback(<span class="hljs-literal">null</span>, job);
	});
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Return the next job in the queue (the one that will run next if a start job command is recieved)</p></div></div><div class="code"><div class="wrapper">Job.getNext = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) </span>{
	jobs.find({state:<span class="hljs-string">'pending'</span>}).toArray(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, result</span>) </span>{
        result.sort(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">a, b</span>)</span>{
            <span class="hljs-keyword">return</span> a.order - b.order;
        });
        log.info(<span class="hljs-string">'printing'</span> + result[<span class="hljs-number">0</span>]);
		<span class="hljs-keyword">if</span>(err) {
			callback(err, <span class="hljs-literal">null</span>);
		} <span class="hljs-keyword">else</span> {
			<span class="hljs-keyword">if</span>(result.length === <span class="hljs-number">0</span>) {
				<span class="hljs-keyword">return</span> callback(<span class="hljs-built_in">Error</span>(<span class="hljs-string">'No jobs in queue.'</span>));
			}
			<span class="hljs-keyword">var</span> job = result[<span class="hljs-number">0</span>];
			job.__proto__ = Job.prototype;
			callback(<span class="hljs-literal">null</span>, job);
		}
	});
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Dequeue the next job to run it (mark it as started, taking it out of the queue)</p></div></div><div class="code"><div class="wrapper">Job.dequeue = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) </span>{
	Job.getNext(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, job</span>) </span>{
		<span class="hljs-keyword">if</span>(err) {
			callback(err);
		} <span class="hljs-keyword">else</span> {
			job.start(callback);
		}
	});
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Remove all jobs in the queue</p></div></div><div class="code"><div class="wrapper">Job.deletePending = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) </span>{
	jobs.remove({state:<span class="hljs-string">'pending'</span>},callback);
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The File class represents a fabrication file on disk
In addition to the filename and path, file statistics such as
The run count, last time run, etc. are stored in the database.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">File</span>(<span class="hljs-params">filename,path, callback</span>)</span>{
	<span class="hljs-keyword">var</span> that=<span class="hljs-keyword">this</span>;
	<span class="hljs-keyword">this</span>.filename = filename;
	<span class="hljs-keyword">this</span>.path = path;
	<span class="hljs-keyword">this</span>.created = <span class="hljs-built_in">Date</span>.now();
	<span class="hljs-keyword">this</span>.last_run = <span class="hljs-literal">null</span>;
	<span class="hljs-keyword">this</span>.run_count = <span class="hljs-number">0</span>;
	<span class="hljs-keyword">this</span>.hash = <span class="hljs-literal">null</span>;
}

File.hash = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">path, callback</span>) </span>{
	<span class="hljs-keyword">var</span> fd = fs.createReadStream(path);
	<span class="hljs-keyword">var</span> hash = crypto.createHash(<span class="hljs-string">'md5'</span>);
	hash.setEncoding(<span class="hljs-string">'hex'</span>);
	fd.on(<span class="hljs-string">'end'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
	    hash.end();
	    callback(<span class="hljs-literal">null</span>, hash.read())
	});
	fd.pipe(hash);
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Save information about this file to back to the database</p></div></div><div class="code"><div class="wrapper">File.prototype.save = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) </span>{
	<span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>;
	files.findOne({path: that.path},<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err,document</span>)</span>{
	<span class="hljs-keyword">if</span> (err){
		callback(err);
	}
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-built_in">document</span>){</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>update the current entry in the database instead of creating a new one.</p></div></div><div class="code"><div class="wrapper">		log.info(<span class="hljs-string">'Updating document id '</span> + <span class="hljs-built_in">document</span>._id);
		files.update({_id : <span class="hljs-built_in">document</span>._id},that,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
			callback(that);
		});
	}
	<span class="hljs-keyword">else</span>{
		log.info(<span class="hljs-string">'Creating a new document.'</span>);
		util.getSize(that.path, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, size</span>)</span>{
			<span class="hljs-keyword">if</span>(err){
				log.warn(<span class="hljs-string">'file has no size'</span>);
			} <span class="hljs-keyword">else</span> {
				that.size = size;

				files.insert(that, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err,records</span>)</span>{
					<span class="hljs-keyword">if</span>(!err) {
						callback(<span class="hljs-literal">null</span>, records[<span class="hljs-number">0</span>]);
						backupDB(callback);
						totalSize += records[<span class="hljs-number">0</span>].size;
					}
					<span class="hljs-keyword">else</span> {
						callback(err);
					}
				});
			}

		});

	}
	});
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Delete this file (and associated thumbnail) from the database</p></div></div><div class="code"><div class="wrapper">File.prototype.delete = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>)</span>{
	files.remove({_id : <span class="hljs-keyword">this</span>._id},<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>)</span>{<span class="hljs-keyword">if</span>(!err)callback();<span class="hljs-keyword">else</span> callback(err);});
	thumbnails.remove({file_id : <span class="hljs-keyword">this</span>._id},<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>)</span>{<span class="hljs-keyword">if</span>(!err)callback();<span class="hljs-keyword">else</span> callback(err);});
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Delete this file, and every job in the history that refers to it.</p></div></div><div class="code"><div class="wrapper">File.obliterate = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">file, callback</span>)</span>{
	<span class="hljs-keyword">var</span> id = file._id
	fs.remove(file.path, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>)</span>{
		<span class="hljs-keyword">if</span> (err){
			callback(err);
		} <span class="hljs-keyword">else</span> {
			files.remove({_id : id},<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>)</span>{
				<span class="hljs-keyword">if</span>(err) {
					callback(err);
				} <span class="hljs-keyword">else</span> {
					jobs.remove({file_id : id},<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
						<span class="hljs-keyword">if</span>(err){
							callback(err);
						} <span class="hljs-keyword">else</span> {
							callback(<span class="hljs-literal">null</span>, <span class="hljs-string">'Obliterated'</span> + file.filename);
						}
					});
				}
			});
		}
	});
	</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>TODO figure out why this is commented out - if we obliterate a file, we should probably trash its thumbnail, yeah?</p></div></div><div class="code"><div class="wrapper">	<span class="hljs-comment">//thumbnails.remove({file_id : id},function(err){if(!err)callback();else callback(err);});</span>

}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>TODO Update docs </p></div></div><div class="code"><div class="wrapper">File.clearTrash = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>)</span>{
	<span class="hljs-keyword">var</span> toTrash = [];
	files.find().toArray(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, files</span>)</span>{
		Job.getAll (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">jobs</span>)</span>{
			<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>; j &lt; files.length -<span class="hljs-number">1</span>; j++) {
				<span class="hljs-keyword">var</span> keepFile = <span class="hljs-literal">false</span>;
				<span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; jobs.length -<span class="hljs-number">1</span>; i++) {
					<span class="hljs-keyword">if</span>(jobs[i].state !== <span class="hljs-string">'trash'</span> &amp;&amp; <span class="hljs-built_in">parseInt</span>(files[j]._id) === <span class="hljs-built_in">parseInt</span>(jobs[i].file_id))  {
						keepFile = <span class="hljs-literal">true</span>;
						<span class="hljs-keyword">break</span>
					}
				}
				<span class="hljs-keyword">if</span> (!keepFile){
					toTrash.push(files[j]);
				}
			}
			<span class="hljs-keyword">async</span>.each(toTrash, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">_file, callback</span>)</span>{
				File.obliterate(_file, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, msg</span>)</span>{
					<span class="hljs-keyword">if</span>(err){
						<span class="hljs-keyword">throw</span> err;
					} <span class="hljs-keyword">else</span> {
						totalSize -= _file.size;
						callback();
					}
				})
			

			});

			});
	
		
	});
	callback(<span class="hljs-literal">null</span>);
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Retrieve the total size of all files on disk (used to determine how much to prune if we hit max file size)</p></div></div><div class="code"><div class="wrapper">File.getTotalFileSize = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>)</span>{
	files.find().toArray(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err,result</span>)</span>{
		<span class="hljs-keyword">if</span>(err) {
			log.warn(err);
		} <span class="hljs-keyword">else</span> {
			result.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">file</span>)</span>{
				<span class="hljs-keyword">if</span>(file.size === <span class="hljs-literal">undefined</span>){
					<span class="hljs-keyword">var</span> size2b =  <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>( <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">resolve, reject</span>) </span>{
						util.getSize(file.path, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, fileSize</span>)</span>{
							resolve(fileSize);
						});
					});
					size2b.then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">val</span>)</span>{
						files.update({_id : file._id}, {$set : {size : val}});	
						totalSize += val;
					});
				} <span class="hljs-keyword">else</span> {
					totalSize += file.size;
				}

			});
		}
	});

};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Update the &quot;last run&quot; time (use the current time)</p></div></div><div class="code"><div class="wrapper">File.prototype.saverun = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
	files.update({_id : <span class="hljs-keyword">this</span>._id}, {$set : {last_run : <span class="hljs-built_in">Date</span>.now()}, $inc : {run_count:<span class="hljs-number">1</span>}});
};


File.writeToDisk = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">pathname, full_path, friendly_filename, hash, callback</span>)</span>{
	util.move(pathname, full_path, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
		<span class="hljs-keyword">if</span>(err) {
			<span class="hljs-keyword">return</span> callback(err);
		}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>delete the temporary file, so that the temporary upload dir does not get filled with unwanted files</p></div></div><div class="code"><div class="wrapper">		fs.unlink(pathname, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
			<span class="hljs-keyword">if</span> (err) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Failure to delete the temporary file is bad, but non-fatal</p></div></div><div class="code"><div class="wrapper">				log.warn(<span class="hljs-string">"failed to remove the job from temporary folder: "</span> + err);
			}

			<span class="hljs-keyword">var</span> file = <span class="hljs-keyword">new</span> File(friendly_filename, full_path);
			file.hash = hash;
			file.save(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, file</span>)</span>{
				<span class="hljs-keyword">if</span>(err) {
					<span class="hljs-keyword">return</span> callback(err);
				}
				log.info(<span class="hljs-string">'Saved a file: '</span> + file.filename + <span class="hljs-string">' ('</span> + file.path + <span class="hljs-string">')'</span>);

				callback(<span class="hljs-literal">null</span>, file)
			}.bind(<span class="hljs-keyword">this</span>)); <span class="hljs-comment">// save</span>
			<span class="hljs-comment">//set off async file size update</span>
		}.bind(<span class="hljs-keyword">this</span>)); <span class="hljs-comment">// unlink</span>
	}); <span class="hljs-comment">// move</span>
};

File.add = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">friendly_filename, pathname, callback</span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Create a unique name for actual storage</p></div></div><div class="code"><div class="wrapper">	<span class="hljs-keyword">var</span> filename = util.createUniqueFilename(friendly_filename);
	<span class="hljs-keyword">var</span> full_path = path.join(config.getDataDir(<span class="hljs-string">'files'</span>), filename);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Compute the hash for the file to be added</p></div></div><div class="code"><div class="wrapper">	File.hash(pathname, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, hash</span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Check to see if the hash is already found in the database</p></div></div><div class="code"><div class="wrapper">		files.findOne({hash:hash},<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err,document</span>) </span>{
			<span class="hljs-keyword">if</span>(<span class="hljs-built_in">document</span>) {
				log.info(<span class="hljs-string">"Using file with hash of "</span> + hash + <span class="hljs-string">" which already exists in the database."</span>);
				<span class="hljs-keyword">var</span> file = <span class="hljs-built_in">document</span>;
				file.__proto__ = File.prototype;
				callback(<span class="hljs-literal">null</span>, file);
			} <span class="hljs-keyword">else</span> {
				log.info(<span class="hljs-string">"Saving a new file with a hash of "</span> + hash + <span class="hljs-string">"."</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Move the file</p></div></div><div class="code"><div class="wrapper">				util.getSize(pathname, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, size</span>)</span>{
					<span class="hljs-keyword">if</span>(err){
						log.error(err)
					} <span class="hljs-keyword">else</span> {
						<span class="hljs-keyword">if</span>(size + totalSize &gt; maxStorage ) {
							File.clearTrash(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>)</span>{
								<span class="hljs-keyword">if</span>(err){
									<span class="hljs-keyword">throw</span> err
								} <span class="hljs-keyword">else</span> {
									log.info(<span class="hljs-string">'done with trash'</span>);
									File.writeToDisk(pathname, full_path, friendly_filename, hash, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, file</span>)</span>{

										<span class="hljs-keyword">if</span>(err){
											<span class="hljs-keyword">throw</span> err;
										} <span class="hljs-keyword">else</span> {
											callback(<span class="hljs-literal">null</span>, file);
										}
									})
								}
							})
						} <span class="hljs-keyword">else</span> {
							File.writeToDisk(pathname, full_path, friendly_filename, hash, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, file</span>)</span>{
								<span class="hljs-keyword">if</span>(err){
									<span class="hljs-keyword">throw</span> err;
								} <span class="hljs-keyword">else</span> {
									callback(<span class="hljs-literal">null</span>, file);
								}
							})
						}
					}
				}.bind(<span class="hljs-keyword">this</span>));<span class="hljs-comment">//check size </span>
			}
		});
	})


} <span class="hljs-comment">// add</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Return a list of all the files in the database</p></div></div><div class="code"><div class="wrapper">File.list_all = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>)</span>{
	files.find().toArray(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err,result</span>)</span>{
		<span class="hljs-keyword">if</span> (err){
			<span class="hljs-keyword">throw</span> err;
		}
		callback(result);
	});
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Return a file object for the provided id</p></div></div><div class="code"><div class="wrapper">File.getByID = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">id,callback</span>)
</span>{
	files.findOne({_id: id},<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err,document</span>)</span>{
		<span class="hljs-keyword">if</span> (!<span class="hljs-built_in">document</span>) {
			callback(<span class="hljs-literal">true</span>, <span class="hljs-literal">undefined</span>);
			<span class="hljs-keyword">return</span>;
		}
		<span class="hljs-keyword">var</span> file = <span class="hljs-built_in">document</span>;
		file.__proto__ = File.prototype;
		callback(<span class="hljs-literal">null</span>, file);
	});
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Given a file and metadata, create a new file and job in the database
callback with the job object if success.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> createJob = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">file, options, callback</span>) </span>{
	File.add(options.filename || file.name, file.path, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, dbfile</span>) </span>{

		<span class="hljs-keyword">if</span> (err) { <span class="hljs-keyword">return</span> callback(err); }
		Job.getPending(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>)</span>{
			<span class="hljs-keyword">if</span>(err){
				log.info(err);
			} <span class="hljs-keyword">else</span> {
				<span class="hljs-keyword">var</span> order = (data.length + options.index);
				<span class="hljs-keyword">try</span> {
					<span class="hljs-keyword">var</span> job = <span class="hljs-keyword">new</span> Job({
						file_id : dbfile._id,
						name : options.name || file.name,
						description : options.description,
						order : order
					});
				} <span class="hljs-keyword">catch</span>(e) {
					log.error(e);
					<span class="hljs-keyword">return</span> callback(e);
				}
				job.save(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, job</span>) </span>{
					<span class="hljs-keyword">if</span>(err) { <span class="hljs-keyword">return</span> callback(err); }
					callback(<span class="hljs-literal">null</span>, job);
				});
			}
		})
    });
}</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p>Creates a new Thumbnail which represents the thumbnails stored in the
database. Thumbnails are 2D representation of the path a file is describing
(in G-Code or OpenSBP).</p>
<p>Parameters:</p>
<ul>
<li><strong>thumbnailDocument is optional and must be a Document.</strong><br/>(- The thumbnail stored in the database.)</li>
</ul></div></div><div class="code"><div class="wrapper">Thumbnail = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">thumbnailDocument</span>) </span>{
    <span class="hljs-keyword">if</span>(thumbnailDocument) {
        <span class="hljs-keyword">this</span>.file_id = thumbnailDocument.file_id;
        <span class="hljs-keyword">this</span>.version = thumbnailDocument.version;
        <span class="hljs-keyword">this</span>.image = thumbnailDocument.image;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">this</span>.file_id = <span class="hljs-string">""</span>;
        <span class="hljs-keyword">this</span>.version = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">this</span>.image = <span class="hljs-string">""</span>;
    }
}</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p>Checks if needs update.</p>
<p><strong>Returns a boolean</strong><br/>(If needs update.)</p></div></div><div class="code"><div class="wrapper">Thumbnail.prototype.needUpdate = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.version &lt; cnctosvg.VERSION;
};</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p>Updates the thumbnail in the database.</p>
<p>Parameters:</p>
<ul>
<li><strong>callback must be a function.</strong><br/>(({Error} err, {Thumbnail} thumbnail): if err is not null, thumbnail is old one else new one)</li>
</ul></div></div><div class="code"><div class="wrapper">Thumbnail.prototype.update = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) </span>{
    <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>;

    File.getByID(that.file_id, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, file</span>) </span>{
        <span class="hljs-keyword">if</span>(err) {
            callback(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Cannot find file with id = "</span> + that.file_id), that);
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-keyword">var</span> machine = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./machine'</span>).machine;
        machine.getGCodeForFile(file.path, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, gcode</span>) </span>{
            <span class="hljs-keyword">if</span>(err) {
                callback(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Cannot find G-Code for file with id = "</span> + fileId), that);
                <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-keyword">var</span> gcodeString = gcode.toString(<span class="hljs-string">"utf8"</span>);
            <span class="hljs-keyword">var</span> modifications = {
                <span class="hljs-string">"image"</span> : Thumbnail.createImage(gcodeString, file.filename),
                <span class="hljs-string">"version"</span> : cnctosvg.VERSION
            };
            <span class="hljs-keyword">var</span> query = { <span class="hljs-string">"file_id"</span> : that.file_id };
            thumbnails.update(query, modifications, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, thumbnail</span>) </span>{
                <span class="hljs-keyword">if</span>(err) {
                    callback(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Cannot update thumbnail with file_id = "</span> + that.file_id), that);
                    <span class="hljs-keyword">return</span>;
                }
                that.image = modifications.image;
                that.version = modifications.version;
                callback(<span class="hljs-literal">null</span>, that);
            });
        });
    });
};</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p>Checks if needs update and returns himself to callback (the new or old
version)</p>
<p>Parameters:</p>
<ul>
<li><strong>callback must be a function.</strong><br/>(({boolean} err, {Thumbnail} thumbnail): err is always false, thumbnail is old one or news one)</li>
</ul></div></div><div class="code"><div class="wrapper">Thumbnail.prototype.checkUpdateAndReturn = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) </span>{
    <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">if</span>(that.needUpdate()) {
        that.update(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, thumbnail</span>) </span>{
            callback(<span class="hljs-literal">false</span>, thumbnail);
        });
    } <span class="hljs-keyword">else</span> {
        callback(<span class="hljs-literal">false</span>, that);
    }
};</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p>Creates image but does not add a thumbnail into the database</p>
<p>Parameters:</p>
<ul>
<li><p><strong>gcode must be a string.</strong></p>
</li>
<li><p><strong>title must be a string.</strong></p>
</li>
</ul>
<p><strong>Returns a string</strong><br/>(the image)</p></div></div><div class="code"><div class="wrapper">Thumbnail.createImage = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">gcode, title</span>) </span>{
    <span class="hljs-keyword">var</span> colors = { G1 : <span class="hljs-string">"#000000"</span>, G2G3 : <span class="hljs-string">"#000000"</span> };
    <span class="hljs-keyword">var</span> width = <span class="hljs-number">100</span>;
    <span class="hljs-keyword">var</span> height = <span class="hljs-number">100</span>;
    <span class="hljs-keyword">var</span> lineThickness = <span class="hljs-number">2</span>;
    <span class="hljs-keyword">return</span> cnctosvg.createSVG(gcode, colors, title, width, height, lineThickness, <span class="hljs-literal">true</span>);
};</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p>Generates the thumbnail and insert it in the database</p>
<p>Parameters:</p>
<ul>
<li><strong>callback must be a function.</strong><br/>(({Error} err, {Thumbnail} thumbnail): if err is not null, thumbnail is undefined else new one)</li>
</ul></div></div><div class="code"><div class="wrapper">Thumbnail.generate = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">fileId, callback</span>) </span>{
    thumbnails.findOne({ <span class="hljs-string">"file_id"</span> : fileId }, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, thumbnail</span>) </span>{
        <span class="hljs-keyword">if</span>(!err &amp;&amp; thumbnail) {
            <span class="hljs-keyword">new</span> Thumbnail(thumbnail).checkUpdateAndReturn(callback);
            <span class="hljs-keyword">return</span>;
        }
        File.getByID(fileId, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, file</span>) </span>{
            <span class="hljs-keyword">if</span>(err) {
                callback(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Cannot find file with id = "</span> + fileId));
                <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-keyword">var</span> machine = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./machine'</span>).machine;
            machine.getGCodeForFile(file.path, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, gcode</span>) </span>{
                <span class="hljs-keyword">if</span>(err) {
                    callback(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Cannot find G-Code for file with id = "</span> + fileId));
                    <span class="hljs-keyword">return</span>;
                }
                <span class="hljs-keyword">var</span> gcodeString = gcode.toString(<span class="hljs-string">"utf8"</span>);
                <span class="hljs-keyword">var</span> newThumbnail = <span class="hljs-keyword">new</span> Thumbnail();
                newThumbnail.file_id = fileId;
                newThumbnail.version = cnctosvg.VERSION;
                newThumbnail.image = Thumbnail.createImage(gcodeString, file.filename);
                thumbnails.insert(newThumbnail, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, records</span>) </span>{
                    <span class="hljs-keyword">if</span>(err) {
                        callback(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Cannot insert thumbnail in database"</span>));
                    } <span class="hljs-keyword">else</span> {
                        callback(<span class="hljs-literal">null</span>, newThumbnail);
                    }
                });
            });
        });
    });
};</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p>Get the thumbnail, if no thumbnail in database: try to make one and return it</p>
<p>Parameters:</p>
<ul>
<li><strong>callback must be a function.</strong><br/>(({Error} err, {Thumbnail} thumbnail): if err is not null, thumbnail is undefined else the found one)</li>
</ul></div></div><div class="code"><div class="wrapper">Thumbnail.getFromFileId = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">fileId, callback</span>) </span>{
    thumbnails.findOne({ <span class="hljs-string">"file_id"</span> : fileId }, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, thumbnail</span>) </span>{
        <span class="hljs-keyword">if</span>(err) {
            callback(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Cannot find thumbnail with file_id = "</span> + fileId));
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-keyword">if</span>(!thumbnail) {
            Thumbnail.generate(fileId, callback);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">new</span> Thumbnail(thumbnail).checkUpdateAndReturn(callback);
        }
    });
};</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p>Get the thumbnail, if no thumbnail in database: try to make one and return it</p>
<p>Parameters:</p>
<ul>
<li><strong>callback must be a function.</strong><br/>(({Error} err, {Thumbnail} thumbnail): if err is not null, thumbnail is undefined else the found one)</li>
</ul></div></div><div class="code"><div class="wrapper">Thumbnail.getFromJobId = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">jobId, callback</span>) </span>{
    Job.getById(jobId, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, job</span>) </span>{
        <span class="hljs-keyword">if</span>(err || !job) {
            callback(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Cannot find job with id = "</span> + jobId));
        } <span class="hljs-keyword">else</span> {
            Thumbnail.getFromFileId(job.file_id, callback);
        }
    });
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isDirectory</span>(<span class="hljs-params">path, callback</span>)</span>{
	fs.stat(path,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err,stats</span>)</span>{
		<span class="hljs-keyword">if</span>(err) callback(<span class="hljs-literal">undefined</span>);
		<span class="hljs-keyword">else</span> callback(stats.isDirectory());
	});
}


checkCollection = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">collection, callback</span>) </span>{
	collection.find().toArray(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
		<span class="hljs-keyword">if</span>(err) {
			log.error(<span class="hljs-string">"Error reading "</span> + collection.collectionName + <span class="hljs-string">" from the database: "</span> + err);
			callback(err);
		} <span class="hljs-keyword">else</span> {
			callback(<span class="hljs-literal">null</span>);
		}
	});
}


backupDB = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) </span>{
	src = config.getDataDir(<span class="hljs-string">'db'</span>);
	dest = config.getDataDir(<span class="hljs-string">'backup'</span>) + <span class="hljs-string">'/db/'</span>
	isDirectory(dest, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">isdir</span>) </span>{
			<span class="hljs-keyword">if</span>(!isdir) {
				<span class="hljs-comment">//Replace with new copy of DB</span>
				log.info(<span class="hljs-string">'No existing backup. Making one now'</span>);
				ncp(src, dest, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
					<span class="hljs-keyword">if</span> (err){
						log.error(<span class="hljs-string">'Could not remove backup because '</span>+err);
					} <span class="hljs-keyword">else</span> {
						log.info(<span class="hljs-string">'Backed up to '</span>+dest);
					}
				});
			} <span class="hljs-keyword">else</span> {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Remove old copy of the backup if it exists</p></div></div><div class="code"><div class="wrapper">				fs.remove(dest, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
					<span class="hljs-keyword">if</span>(err) {
						log.error(<span class="hljs-string">'Could not remove backup because '</span>+err);
					} <span class="hljs-keyword">else</span> {
						log.info(<span class="hljs-string">'Removed old copy of backup'</span>);
						<span class="hljs-comment">//Replace with new copy of DB</span>
						ncp(src, dest, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
							<span class="hljs-keyword">if</span> (err){
								log.error(<span class="hljs-string">'Could not remove backup because '</span>+err);
							} <span class="hljs-keyword">else</span> {
								log.info(<span class="hljs-string">'Backed up to '</span>+dest);
							}
						});
					}
				});
			}
	});
	
	
}

reConfig = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>)</span>{
	db = <span class="hljs-keyword">new</span> Engine.Db(config.getDataDir(<span class="hljs-string">'db'</span>), {});
	files = db.collection(<span class="hljs-string">"files"</span>);
	jobs = db.collection(<span class="hljs-string">"jobs"</span>);
	thumbnails = db.collection(<span class="hljs-string">"thumbnails"</span>);

	<span class="hljs-keyword">async</span>.parallel([
			<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">cb</span>) </span>{
				checkCollection(users, cb);
			},
			<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">cb</span>) </span>{
				checkCollection(files, cb);
			},
			<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">cb</span>) </span>{
				checkCollection(jobs, cb);
			},
			<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">cb</span>) </span>{
				checkCollection(thumbnails, cb);
			}
		],
		<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, results</span>) </span>{
			<span class="hljs-keyword">if</span>(err) {
				log.error(<span class="hljs-string">'There was a database corruption issue!'</span>)
				<span class="hljs-keyword">var</span> src = config.getDataDir(<span class="hljs-string">'db'</span>)
				<span class="hljs-keyword">var</span> dest = config.getDataDir(<span class="hljs-string">'debug'</span>) + <span class="hljs-string">'/bad-db-'</span> + (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime())
				ncp(src, dest, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
					<span class="hljs-keyword">if</span>(err) {
						log.error(<span class="hljs-string">'The database could not be successfully backed up: '</span> + err);
						callback(<span class="hljs-literal">null</span>);
					} <span class="hljs-keyword">else</span> {
						log.debug(<span class="hljs-string">'The database has been successfully copied to the debug directory for inspection.'</span>);
						fs.remove(src, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
							<span class="hljs-keyword">if</span>(err) {
								log.error(<span class="hljs-string">'Could not delete the corrupted database:'</span> + err);
								callback(<span class="hljs-literal">null</span>);
							} <span class="hljs-keyword">else</span> {
								log.debug(<span class="hljs-string">'Everythign is terrible shutting down'</span>);
								process.exit(<span class="hljs-number">1</span>);

							}
						});
					}
				});
			} <span class="hljs-keyword">else</span> {
				log.info(<span class="hljs-string">"Databases are clean. Reconfig Success"</span>);
				callback(<span class="hljs-literal">null</span>);
				
			}
			
	});

}

exports.configureDB = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) </span>{
	db = <span class="hljs-keyword">new</span> Engine.Db(config.getDataDir(<span class="hljs-string">'db'</span>), {});
	files = db.collection(<span class="hljs-string">"files"</span>);
	jobs = db.collection(<span class="hljs-string">"jobs"</span>);
	thumbnails = db.collection(<span class="hljs-string">"thumbnails"</span>);

	

	<span class="hljs-keyword">async</span>.parallel([
			<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">cb</span>) </span>{
				checkCollection(files, cb);
			},
			<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">cb</span>) </span>{
				checkCollection(jobs, cb);
			},
			<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">cb</span>) </span>{
				checkCollection(thumbnails, cb);
			}
		],
		<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, results</span>) </span>{
			<span class="hljs-keyword">if</span>(err) {
				log.error(<span class="hljs-string">'There was a database corruption issue!'</span>)
				<span class="hljs-keyword">var</span> src = config.getDataDir(<span class="hljs-string">'db'</span>)
				<span class="hljs-keyword">var</span> dest = config.getDataDir(<span class="hljs-string">'debug'</span>) + <span class="hljs-string">'/bad-db-'</span> + (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime())
				ncp(src, dest, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
					<span class="hljs-keyword">if</span>(err) {
						log.error(<span class="hljs-string">'The database could not be successfully backed up: '</span> + err);
						callback(<span class="hljs-literal">null</span>);
					} <span class="hljs-keyword">else</span> {
						log.debug(<span class="hljs-string">'The database has been successfully copied to the debug directory for inspection.'</span>);
						fs.remove(src, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
							<span class="hljs-keyword">if</span>(err) {
								log.error(<span class="hljs-string">'Could not delete the corrupted database:'</span> + err);
								callback(<span class="hljs-literal">null</span>);
							} <span class="hljs-keyword">else</span> {
								log.debug(<span class="hljs-string">'The corrupted database has been deleted.  Inserting Backup and re-config'</span>);
								<span class="hljs-comment">//process.exit(1);</span>
								src = config.getDataDir(<span class="hljs-string">'backup/db'</span>);
								dest = config.getDataDir(<span class="hljs-string">'db'</span>);
								
								ncp(src, dest, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
									<span class="hljs-keyword">if</span>(err) {
										log.error(<span class="hljs-string">'The backup could not be copied engine shutting down because '</span> + err);
										process.exit(<span class="hljs-number">1</span>);
									} <span class="hljs-keyword">else</span> {
										log.debug(<span class="hljs-string">'Backup copied over re-trying config'</span>);
										reConfig(callback);
									}		
								})

							}
						});
					}
				});
			} <span class="hljs-keyword">else</span> {
				log.info(<span class="hljs-string">"Databases are clean."</span>);
				callback(<span class="hljs-literal">null</span>);
				backupDB(callback);
				
			}
		});
		File.getTotalFileSize();
};

exports.cleanup = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) </span>{
	jobs.update({state: <span class="hljs-string">'running'</span>}, {$set : {state:<span class="hljs-string">'failed'</span>, finished_at : <span class="hljs-built_in">Date</span>.now()}}, {multi:<span class="hljs-literal">true</span>}, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, result</span>) </span>{
		<span class="hljs-keyword">if</span>(err) {
			log.error(<span class="hljs-string">'There was a problem cleaning the db: '</span> + err)
		} <span class="hljs-keyword">else</span> {
			<span class="hljs-keyword">if</span>(result &gt; <span class="hljs-number">1</span>) {
				log.warn(<span class="hljs-string">"Found more than one ("</span> + result + <span class="hljs-string">") running job in the db.  This is a database inconsistency!"</span>);
			} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(result == <span class="hljs-number">1</span>) {
				log.info(<span class="hljs-string">"Cleaned up a single failed job."</span>);
			}
		}
	});
	setImmediate(callback, <span class="hljs-literal">null</span>);
};

exports.File = File;
exports.Job = Job;
exports.Thumbnail = Thumbnail;
exports.createJob = createJob;</div></div></div></div></body></html>