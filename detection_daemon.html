<!DOCTYPE html><html lang="en"><head><title>detection_daemon</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="detection_daemon"><meta name="groc-project-path" content="detection_daemon.js"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path">detection_daemon.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> os=<span class="hljs-built_in">require</span>(<span class="hljs-string">'os'</span>);
<span class="hljs-keyword">var</span> util=<span class="hljs-built_in">require</span>(<span class="hljs-string">'util'</span>);
<span class="hljs-keyword">var</span> EventEmitter = <span class="hljs-built_in">require</span>(<span class="hljs-string">'events'</span>).EventEmitter;
<span class="hljs-keyword">var</span> dgram = <span class="hljs-built_in">require</span>(<span class="hljs-string">'dgram'</span>);
<span class="hljs-keyword">var</span> log = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./log'</span>).logger(<span class="hljs-string">'detection'</span>);
<span class="hljs-keyword">var</span> settings = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./settings'</span>);

<span class="hljs-keyword">var</span> OK = <span class="hljs-string">"YES I M !\0"</span>;
<span class="hljs-keyword">var</span> ERR = <span class="hljs-string">"I DNT UNDRSTND !\0"</span>;
<span class="hljs-keyword">var</span> HOSTNAME = <span class="hljs-string">"U NAME ?\0"</span>;
<span class="hljs-keyword">var</span> REQ = <span class="hljs-string">"R U A SBT ?\0"</span>;
<span class="hljs-keyword">var</span> default_port = <span class="hljs-number">24862</span>; <span class="hljs-comment">// = 7777 without conversion</span>

<span class="hljs-keyword">var</span> start = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(port)</span> {</span>
	<span class="hljs-keyword">var</span> socket = dgram.createSocket(<span class="hljs-string">'udp4'</span>);
	<span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>;
	<span class="hljs-keyword">var</span> Port = port || default_port;	
		socket.bind(Port);
		
		socket.on(<span class="hljs-string">"message"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( data, rinfo )</span> {</span>
			<span class="hljs-keyword">if</span>(data.toString() == REQ)
			{
				log.info(<span class="hljs-string">'scan in progress by '</span>+ rinfo.address);
				socket.send(<span class="hljs-keyword">new</span> Buffer(OK), <span class="hljs-number">0</span>, OK.length, rinfo.port, rinfo.address, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> {</span>
							<span class="hljs-keyword">if</span> (err) {
								console.log(err);
							}
							<span class="hljs-keyword">else</span> {
								<span class="hljs-comment">//console.log("reply yes to "+rinfo.address+" on port "+rinfo.port);</span>
							}
						});
			}
			<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(data.toString() == HOSTNAME) <span class="hljs-comment">// if the device is a sbt, continue the dialog.</span>
			{
				<span class="hljs-comment">//console.log("hostname asked");</span>
				<span class="hljs-keyword">var</span> result = {};
				result.hostname= os.hostname();
				result.networks=[];
				result.port = settings.server_port;
				<span class="hljs-built_in">Object</span>.keys(os.networkInterfaces()).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key,index,arr)</span>{</span> <span class="hljs-comment">//val = ip adresses , key = name of interface</span>
					<span class="hljs-keyword">var</span> networks_list = <span class="hljs-keyword">this</span>;
					networks_list[key].forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(val2,key2,arr2)</span>{</span>
						<span class="hljs-keyword">if</span> (val2.internal === <span class="hljs-literal">false</span> &amp;&amp; val2.family === <span class="hljs-string">'IPv4'</span>)
						{
							result.networks.push({<span class="hljs-string">'interface'</span> : key , <span class="hljs-string">'ip_address'</span> : val2.address});
						}
					});
				},os.networkInterfaces());
				socket.send(<span class="hljs-keyword">new</span> Buffer(<span class="hljs-built_in">JSON</span>.stringify(result)), <span class="hljs-number">0</span>, <span class="hljs-built_in">JSON</span>.stringify(result).length, rinfo.port, rinfo.address, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> {</span>
					<span class="hljs-keyword">if</span> (err) log.error(err);
							<span class="hljs-comment">//console.log("ask info");</span>
					});
				that.emit(<span class="hljs-string">'client_scan'</span>,rinfo.address);
			}
			<span class="hljs-keyword">else</span>
			{
				log.info(<span class="hljs-string">"[detection_tool.js] received from "</span>+rinfo.address+<span class="hljs-string">" : unknown message : '"</span>+ data.toString() +<span class="hljs-string">"'"</span>);
			}
		});



	<span class="hljs-keyword">this</span>.on(<span class="hljs-string">'newListener'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(listener)</span> {</span>});

};
util.inherits(start , EventEmitter);
module.exports = start;</div></div></div></div></body></html>