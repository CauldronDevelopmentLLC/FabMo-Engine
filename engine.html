<!DOCTYPE html><html lang="en"><head><title>engine</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="engine"><meta name="groc-project-path" content="engine.js"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path">engine.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> restify = <span class="hljs-built_in">require</span>(<span class="hljs-string">'restify'</span>);
<span class="hljs-keyword">var</span> socketio = <span class="hljs-built_in">require</span>(<span class="hljs-string">'socket.io'</span>);
<span class="hljs-keyword">var</span> <span class="hljs-keyword">async</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'async'</span>);
<span class="hljs-keyword">var</span> process = <span class="hljs-built_in">require</span>(<span class="hljs-string">'process'</span>);
<span class="hljs-keyword">var</span> machine = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./machine'</span>);
<span class="hljs-keyword">var</span> detection_daemon = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./detection_daemon'</span>)();
<span class="hljs-keyword">var</span> config = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./config'</span>);
<span class="hljs-keyword">var</span> PLATFORM = process.platform;
<span class="hljs-keyword">var</span> log = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./log'</span>).logger(<span class="hljs-string">'engine'</span>);
<span class="hljs-keyword">var</span> db = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./db'</span>);
<span class="hljs-keyword">var</span> macros = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./macros'</span>);
<span class="hljs-keyword">var</span> dashboard = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./dashboard'</span>);
<span class="hljs-keyword">var</span> network = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./network'</span>);
<span class="hljs-keyword">var</span> updater = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./updater'</span>);
<span class="hljs-keyword">var</span> glob = <span class="hljs-built_in">require</span>(<span class="hljs-string">'glob'</span>);
<span class="hljs-keyword">var</span> argv = <span class="hljs-built_in">require</span>(<span class="hljs-string">'minimist'</span>)(process.argv);

<span class="hljs-keyword">var</span> Engine = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">this</span>.version = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">this</span>.time_synced = <span class="hljs-literal">false</span>;
};

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">EngineConfigFirstTime</span>(<span class="hljs-params">callback</span>) </span>{
    <span class="hljs-keyword">switch</span>(PLATFORM) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">'darwin'</span>:
            glob.glob(<span class="hljs-string">'/dev/cu.usbmodem*'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, files</span>) </span>{
                <span class="hljs-keyword">if</span>(files.length &gt;= <span class="hljs-number">2</span>) {
                    <span class="hljs-keyword">var</span> ports = {
                        <span class="hljs-string">'control_port_osx'</span> : files[<span class="hljs-number">0</span>],
                        <span class="hljs-string">'data_port_osx'</span> : files[<span class="hljs-number">1</span>]
                    }
                    config.engine.update(ports, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                        callback();
                    });
                }
            });
        <span class="hljs-keyword">break</span>;

        <span class="hljs-keyword">default</span>:
            callback();
        <span class="hljs-keyword">break</span>;
    }
};

Engine.prototype.setTime = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">obj</span>) </span>{
    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.time_synced) {
        <span class="hljs-keyword">this</span>.time_synced = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">var</span> d = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(obj.utc);
        log.debug(<span class="hljs-string">"Setting the time to "</span> + d.toUTCString());
        <span class="hljs-keyword">var</span> t = d.getUTCFullYear() + <span class="hljs-string">'-'</span> + d.getUTCMonth() + <span class="hljs-string">'-'</span> + d.getUTCDay() + <span class="hljs-string">' '</span> + d.getUTCHours() + <span class="hljs-string">':'</span> + d.getUTCMinutes() + <span class="hljs-string">':'</span> + d.getUTCSeconds()
	cmd = <span class="hljs-string">'timedatectl set-time '</span> + t + <span class="hljs-string">'; timedatectl'</span>;
        util.doshell(cmd, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">stdout</span>) </span>{
            <span class="hljs-built_in">console</span>.log(stdout);
        });
    }
}

Engine.prototype.stop = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) </span>{
    <span class="hljs-keyword">this</span>.machine.disconnect();
    <span class="hljs-keyword">this</span>.machine.setState(<span class="hljs-keyword">this</span>.machine, <span class="hljs-string">'stopped'</span>);

    <span class="hljs-comment">//this.server.close();</span>
    <span class="hljs-comment">//this.server.io.server.close();</span>
    callback(<span class="hljs-literal">null</span>);
};

Engine.prototype.start = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) </span>{

    <span class="hljs-keyword">async</span>.series([</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Configure the engine data directories</p></div></div><div class="code"><div class="wrapper">       <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setup_application</span>(<span class="hljs-params">callback</span>) </span>{
            log.info(<span class="hljs-string">'Checking engine data directory tree...'</span>);
            config.createDataDirectories(callback);
        },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Load the engine configuration from disk</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">load_engine_config</span>(<span class="hljs-params">callback</span>) </span>{
            log.info(<span class="hljs-string">"Loading engine configuration..."</span>);
            config.configureEngine(callback);
        },

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">check_engine_config</span>(<span class="hljs-params">callback</span>) </span>{
            <span class="hljs-keyword">if</span>(!config.engine.userConfigLoaded) {
                EngineConfigFirstTime(callback);
            } <span class="hljs-keyword">else</span> {
                callback();
            }
        },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Create the version string that will be used to identify the software version</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_fabmo_version</span>(<span class="hljs-params">callback</span>) </span>{
            log.info(<span class="hljs-string">"Getting engine version..."</span>);
            updater.getFabmoVersionString(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, string</span>) </span>{
                <span class="hljs-keyword">if</span>(!err) {
                    log.info(<span class="hljs-string">"Engine version: "</span> + string);
                    <span class="hljs-keyword">this</span>.version = string;
                } <span class="hljs-keyword">else</span> {
                    log.error(err);
                }
                callback();
            }.bind(<span class="hljs-keyword">this</span>));
        }.bind(<span class="hljs-keyword">this</span>),</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>&quot;Apply&quot; the engine configuration, that is, take the configuration values loaded and actually
set up the application based on them.</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">apply_engine_config</span>(<span class="hljs-params">callback</span>) </span>{
            log.info(<span class="hljs-string">"Applying engine configuration..."</span>);
            config.engine.apply(callback);
        },

	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setup_network</span>(<span class="hljs-params">callback</span>) </span>{
		<span class="hljs-keyword">if</span>(config.engine.get(<span class="hljs-string">'wifi_manager'</span>)) {
			log.info(<span class="hljs-string">"Setting up the network..."</span>);
            <span class="hljs-keyword">try</span> {
                network.init();
            } <span class="hljs-keyword">catch</span>(e) {
                log.error(<span class="hljs-string">'Problem starting network manager:'</span>)
                log.error(e);
            }
			callback(<span class="hljs-literal">null</span>);
		} <span class="hljs-keyword">else</span> {
			log.warn(<span class="hljs-string">"Skipping network setup because wifi manager is disabled."</span>);
			callback(<span class="hljs-literal">null</span>);
		}
	},</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Configure the DB</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setup_database</span>(<span class="hljs-params">callback</span>) </span>{
            log.info(<span class="hljs-string">"Configuring database..."</span>);
            db.configureDB(callback);
        },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Cleanup the DB</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clean_database</span>(<span class="hljs-params">callback</span>) </span>{
            log.info(<span class="hljs-string">"Cleaning up database..."</span>);
            db.cleanup(callback);
        },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Connect to G2 and initialize machine runtimes</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">connect</span>(<span class="hljs-params">callback</span>) </span>{
            log.info(<span class="hljs-string">"Connecting to G2..."</span>);
            machine.connect(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, machine</span>) </span>{
                <span class="hljs-keyword">if</span>(err) {
                    log.error(<span class="hljs-string">"!!!!!!!!!!!!!!!!!!!!!!!!"</span>);
                    log.error(<span class="hljs-string">"Could not connect to G2."</span>);
                    log.error(<span class="hljs-string">"("</span> + err + <span class="hljs-string">")"</span>);
                    log.error(<span class="hljs-string">"!!!!!!!!!!!!!!!!!!!!!!!!"</span>);
                }
                callback(<span class="hljs-literal">null</span>);
            });
        }.bind(<span class="hljs-keyword">this</span>),

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">load_machine_config</span>(<span class="hljs-params">callback</span>) </span>{
            <span class="hljs-keyword">this</span>.machine = machine.machine;
            log.info(<span class="hljs-string">'Loading the machine configuration...'</span>)
            config.configureMachine(<span class="hljs-keyword">this</span>.machine.driver, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, result</span>) </span>{
                <span class="hljs-keyword">if</span>(err) {
                    log.warn(err);
                }
                callback(<span class="hljs-literal">null</span>);
            });
        }.bind(<span class="hljs-keyword">this</span>),
	
	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">set_units</span>(<span class="hljs-params">callback</span>) </span>{
		<span class="hljs-keyword">this</span>.machine.driver.setUnits(config.machine.get(<span class="hljs-string">'units'</span>), callback);
	}.bind(<span class="hljs-keyword">this</span>),</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Configure G2 by loading all its json settings and static configuration parameters</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">load_driver_config</span>(<span class="hljs-params">callback</span>) </span>{
            <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.machine.isConnected()) {
                log.info(<span class="hljs-string">"Configuring G2..."</span>);
                config.configureDriver(machine.machine.driver, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
                    <span class="hljs-keyword">if</span>(err) {
                        log.error(<span class="hljs-string">"There were problems loading the G2 configuration."</span>);
                    }
                    callback(<span class="hljs-literal">null</span>);
                });
            } <span class="hljs-keyword">else</span> {
                log.warn(<span class="hljs-string">"Skipping G2 configuration due to no connection."</span>);
                config.configureDriver(<span class="hljs-literal">null</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
                    callback(<span class="hljs-literal">null</span>);
                })
                callback(<span class="hljs-literal">null</span>);
            }
        }.bind(<span class="hljs-keyword">this</span>),

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_g2_version</span>(<span class="hljs-params">callback</span>) </span>{
            <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.machine.isConnected()) {
                log.info(<span class="hljs-string">"Getting G2 firmware version..."</span>);
                <span class="hljs-keyword">this</span>.machine.driver.get(<span class="hljs-string">'fb'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, value</span>) </span>{
                    <span class="hljs-keyword">if</span>(err) {
                        log.error(<span class="hljs-string">'Could not get the G2 firmware build. ('</span> + err + <span class="hljs-string">')'</span>);
                    } <span class="hljs-keyword">else</span> {
                        log.info(<span class="hljs-string">'G2 Firmware Build: '</span> + value);
                    }
                    callback(<span class="hljs-literal">null</span>);
                });
            } <span class="hljs-keyword">else</span> {
                log.warn(<span class="hljs-string">"Skipping G2 firmware version check due to no connection."</span>)
                callback(<span class="hljs-literal">null</span>);
            }
    	}.bind(<span class="hljs-keyword">this</span>),

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">apply_machine_config</span>(<span class="hljs-params">callback</span>) </span>{
            log.info(<span class="hljs-string">"Applying machine configuration..."</span>);
            config.machine.apply(callback);
        }.bind(<span class="hljs-keyword">this</span>),


        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">load_opensbp_commands</span>(<span class="hljs-params">callback</span>) </span>{
            log.info(<span class="hljs-string">"Loading OpenSBP Commands..."</span>);
            <span class="hljs-keyword">this</span>.machine.sbp_runtime.loadCommands(callback);
        }.bind(<span class="hljs-keyword">this</span>),

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">load_opensbp_config</span>(<span class="hljs-params">callback</span>) </span>{
            log.info(<span class="hljs-string">"Configuring OpenSBP runtime..."</span>);
            config.configureOpenSBP(callback);
        },

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">configure_dashboard</span>(<span class="hljs-params">callback</span>) </span>{
            log.info(<span class="hljs-string">"Configuring dashboard..."</span>);
            dashboard.configure(callback);
        },

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">load_apps</span>(<span class="hljs-params">callback</span>) </span>{
            log.info(<span class="hljs-string">"Loading dashboard apps..."</span>);
            dashboard.loadApps(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, result</span>) </span>{
                callback(<span class="hljs-literal">null</span>, result);
            });
        },

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">load_macros</span>(<span class="hljs-params">callback</span>) </span>{
            log.info(<span class="hljs-string">"Loading macros..."</span>)
            macros.load(callback);
        },

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">load_instance_config</span>(<span class="hljs-params">callback</span>) </span>{
            log.info(<span class="hljs-string">"Loading instance info..."</span>);
            config.configureInstance(<span class="hljs-keyword">this</span>.machine.driver, callback);
        }.bind(<span class="hljs-keyword">this</span>),

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">apply_instance_config</span>(<span class="hljs-params">callback</span>) </span>{
            log.info(<span class="hljs-string">"Applying instance configuration..."</span>);
            config.instance.apply(callback);
        },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Kick off the server if all of the above went OK.</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">start_server</span>(<span class="hljs-params">callback</span>) </span>{
            log.info(<span class="hljs-string">"Setting up the webserver..."</span>);
            <span class="hljs-keyword">var</span> server = restify.createServer({name:<span class="hljs-string">"FabMo Engine"</span>});
            <span class="hljs-keyword">this</span>.server = server;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Allow JSON over Cross-origin resource sharing </p></div></div><div class="code"><div class="wrapper">            log.info(<span class="hljs-string">"Configuring cross-origin requests..."</span>);
            server.use(
                <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">crossOrigin</span>(<span class="hljs-params">req,res,next</span>)</span>{
                    res.header(<span class="hljs-string">"Access-Control-Allow-Origin"</span>, <span class="hljs-string">"*"</span>);
                    res.header(<span class="hljs-string">"Access-Control-Allow-Headers"</span>, <span class="hljs-string">"X-Requested-With"</span>);
                    <span class="hljs-keyword">return</span> next();
                }
            );

            <span class="hljs-keyword">if</span>(<span class="hljs-string">'debug'</span> <span class="hljs-keyword">in</span> argv &amp;&amp; argv.debug === <span class="hljs-string">'slow'</span>) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Introduce deliberate latency for testing</p></div></div><div class="code"><div class="wrapper">                log.warn(<span class="hljs-string">"Configuring deliberate latency for testing..."</span>)
                server.use(
                    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">latency</span>(<span class="hljs-params">req, res, next</span>) </span>{
                        setTimeout(next,<span class="hljs-number">500</span>*<span class="hljs-built_in">Math</span>.random());
                    }
                );
            }

            server.on(<span class="hljs-string">'uncaughtException'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, route, err</span>) </span>{
                log.uncaught(err);
                answer = {
                    status:<span class="hljs-string">"error"</span>,
                    message:err
                };
                res.json(answer)
            });</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Configure local directory for uploading files</p></div></div><div class="code"><div class="wrapper">            log.info(<span class="hljs-string">"Cofiguring upload directory..."</span>);
            server.use(restify.bodyParser({<span class="hljs-string">'uploadDir'</span>:config.engine.get(<span class="hljs-string">'upload_dir'</span>) || <span class="hljs-string">'/tmp'</span>}));
            server.pre(restify.pre.sanitizePath());

            log.info(<span class="hljs-string">"Enabling gzip for transport..."</span>);
            server.use(restify.gzipResponse());</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Import the routes module and apply the routes to the server</p></div></div><div class="code"><div class="wrapper">            log.info(<span class="hljs-string">"Loading routes..."</span>);
            server.io = socketio.listen(server.server);
            <span class="hljs-keyword">var</span> routes = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./routes'</span>)(server);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Kick off the server listening for connections</p></div></div><div class="code"><div class="wrapper">            server.listen(config.engine.get(<span class="hljs-string">'server_port'</span>), <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                log.info(server.name+ <span class="hljs-string">' listening at '</span>+ server.url);
                callback(<span class="hljs-literal">null</span>, server);
            });

        }.bind(<span class="hljs-keyword">this</span>),
        ],

        <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, results</span>) </span>{
            <span class="hljs-keyword">if</span>(err) {
                log.error(err);
                <span class="hljs-keyword">typeof</span> callback === <span class="hljs-string">'function'</span> &amp;&amp; callback(err);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">typeof</span> callback === <span class="hljs-string">'function'</span> &amp;&amp; callback(<span class="hljs-literal">null</span>, <span class="hljs-keyword">this</span>);
            }
        }.bind(<span class="hljs-keyword">this</span>)
    );
};

<span class="hljs-built_in">module</span>.exports = <span class="hljs-keyword">new</span> Engine();</div></div></div></div></body></html>