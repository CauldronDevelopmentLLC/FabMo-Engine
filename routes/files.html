<!DOCTYPE html><html lang="en"><head><title>routes/files</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="routes/files"><meta name="groc-project-path" content="routes/files.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">routes/files.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">var</span> machine = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../machine'</span>).machine;
<span class="hljs-keyword">var</span> config = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../config'</span>);
<span class="hljs-keyword">var</span> db = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../db'</span>);
<span class="hljs-keyword">var</span> File=db.File;
<span class="hljs-keyword">var</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../util'</span>);
<span class="hljs-keyword">var</span> allowed_file = util.allowed_file;

get_files = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req, res, next)</span> {</span>
	File.list_all(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(result)</span>{</span>
		res.json({<span class="hljs-string">'files'</span>:result});
	});
};

upload_file = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req, res, next)</span> {</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Get the one and only one file you&#39;re currently allowed to upload at a time</p></div></div><div class="code"><div class="wrapper">	<span class="hljs-keyword">var</span> file = req.files.file;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Only write &quot;allowed files&quot;</p></div></div><div class="code"><div class="wrapper">	<span class="hljs-keyword">if</span>(file &amp;&amp; allowed_file(file.name))
	{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Keep the name of the file uploaded (but put it in the parts directory)</p></div></div><div class="code"><div class="wrapper">		<span class="hljs-keyword">var</span> filename=file.name;
		<span class="hljs-keyword">var</span> full_path = path.join(config.getDataDir(<span class="hljs-string">'files'</span>), filename);
		</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Uploaded files are stored in a temporary directory (per restify)
Move the file from that path to the parts directory</p></div></div><div class="code"><div class="wrapper">		
		util.move(file.path, full_path, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> {</span>
			<span class="hljs-keyword">if</span> (err){
				<span class="hljs-keyword">throw</span> err;
			}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>delete the temporary file, so that the temporary upload dir does not get filled with unwanted files</p></div></div><div class="code"><div class="wrapper">			fs.unlink(file.path, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
				<span class="hljs-keyword">if</span> (err) {<span class="hljs-keyword">throw</span> err;}
				<span class="hljs-keyword">new</span> File(filename, full_path).save(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(file)</span>{</span>
				res.send(<span class="hljs-number">302</span>,file); <span class="hljs-comment">// file saved</span>
			}); <span class="hljs-comment">//save in db</span>
				
			});
		});
	}
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (file){
	res.send(<span class="hljs-number">415</span>); <span class="hljs-comment">// wrong format</span>
	}
	<span class="hljs-keyword">else</span>{
	res.send(<span class="hljs-number">400</span>);<span class="hljs-comment">// problem reciving the file (bad request)	</span>
	}
};

delete_file = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req, res, next)</span> {</span>
	console.log(<span class="hljs-string">'Deleting file'</span>);
	File.get_by_id(req.params.id,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(file)</span>{</span>
		<span class="hljs-keyword">if</span>(file)
		{
			fs.unlink(file.path, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span> <span class="hljs-comment">//delete file on hdd</span>
				file.delete(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>res.send(<span class="hljs-number">204</span>);}); <span class="hljs-comment">// delete file in db</span>
				
			});
		}
		<span class="hljs-keyword">else</span>
		{
			console.log(<span class="hljs-string">"file not found ! cannot delete"</span>);
			res.send(<span class="hljs-number">404</span>);
		}
	});
	
};


download_file = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req, res, next)</span> {</span>
	File.get_by_id(req.params.id,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(file)</span>{</span>
		<span class="hljs-keyword">if</span>(!file){res.send(<span class="hljs-number">404</span>);<span class="hljs-keyword">return</span>;}
		console.log(<span class="hljs-string">'Downloading file'</span>);
		fs.readFile((file.path),<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, data)</span>{</span>
			<span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;
			res.header(<span class="hljs-string">'Content-Description'</span>,<span class="hljs-string">'File Transfer'</span>);
			res.header(<span class="hljs-string">'Content-Type'</span>,<span class="hljs-string">'application/octet-stream'</span>);
			res.header(<span class="hljs-string">'Content-Disposition'</span>,<span class="hljs-string">'attachment; filename='</span>+file.filename);
			res.header(<span class="hljs-string">'Content-Transfer-Encoding'</span>,<span class="hljs-string">'binary'</span>);
			res.header(<span class="hljs-string">'Expires'</span>, <span class="hljs-number">0</span>);
			res.header(<span class="hljs-string">'Cache-Control'</span>,<span class="hljs-string">'must-revalidate, post-check=0, pre-check=0'</span>);
			res.header(<span class="hljs-string">'Pragma'</span>,<span class="hljs-string">'public'</span>);
			res.header(<span class="hljs-string">'Content-Length'</span>, file.size);
			res.header(<span class="hljs-string">'Location'</span>, req.headers[<span class="hljs-string">'referer'</span>]);	
			res.send(data.toString());
		});
	});
	
};


view_file = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req, res, next)</span> {</span>
	File.get_by_id(req.params.id,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(file)</span>{</span>
		<span class="hljs-keyword">if</span>(!file){res.send(<span class="hljs-number">404</span>);<span class="hljs-keyword">return</span>;}
		console.log(<span class="hljs-string">'Downloading file'</span>);
		fs.readFile((file.path),<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, data)</span>{</span>
			<span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;
			res.header(<span class="hljs-string">'Content-Type'</span>,<span class="hljs-string">'text/plain'</span>);
			res.header(<span class="hljs-string">'Content-Length'</span>, file.size);
			res.header(<span class="hljs-string">'Location'</span>, req.headers[<span class="hljs-string">'referer'</span>]);	
			res.send(data.toString());
		});
	});
	
};


module.exports = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(server)</span> {</span>
	server.get(<span class="hljs-string">'/file'</span>, get_files); <span class="hljs-comment">//OK</span>
	server.post(<span class="hljs-string">'/file'</span>,upload_file); <span class="hljs-comment">//OK</span>
	server.del(<span class="hljs-string">'/file/:id'</span>,delete_file); <span class="hljs-comment">//OK</span>
	server.get(<span class="hljs-string">'/file/:id'</span>,download_file); <span class="hljs-comment">//OK</span>
	server.get(<span class="hljs-string">'/file/:id/view'</span>,view_file); <span class="hljs-comment">//OK</span>
}</div></div></div></div></body></html>