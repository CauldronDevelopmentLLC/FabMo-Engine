<!DOCTYPE html><html lang="en"><head><title>routes/jobs</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="routes/jobs"><meta name="groc-project-path" content="routes/jobs.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">routes/jobs.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> db = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../db'</span>);
<span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">var</span> config = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../config'</span>);
<span class="hljs-keyword">var</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../util'</span>);
<span class="hljs-keyword">var</span> log = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../log'</span>).logger(<span class="hljs-string">'routes'</span>);
<span class="hljs-keyword">var</span> machine = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../machine'</span>).machine;
<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">var</span> uuid = <span class="hljs-built_in">require</span>(<span class="hljs-string">'node-uuid'</span>);</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'> apiGroup Jobs, api {post} /job Submit a job, apiDescription Add a job to the job queue., apiParam {String} name Job name, apiParam {String} description Job description, apiParam {Object} file G-Code or OpenSBP file submission, apiSuccess {String} status <code>success</code>, apiSuccess {Object} data null, apiError {String} status <code>error</code>, and apiError {Object} message Error message</span></p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> submitJob = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Get the one and only one file you&#39;re currently allowed to upload at a time</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">var</span> file = req.files.file;
    <span class="hljs-keyword">var</span> answer;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Only write &quot;allowed files&quot;</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span>(file &amp;&amp; util.allowed_file(file.name))
    {
        db.File.add(file.name, file.path, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, dbfile</span>) </span>{
            <span class="hljs-keyword">if</span> (err) {
                answer = {
                    status:<span class="hljs-string">"error"</span>,
                    message:err
                };
                <span class="hljs-keyword">return</span> res.json(answer);
            }
            <span class="hljs-keyword">var</span> job;
            <span class="hljs-keyword">try</span> {
                job = <span class="hljs-keyword">new</span> db.Job({
                    file_id : dbfile._id,
                    name : req.body.name || file.name,
                    description : req.body.description
                });
            } <span class="hljs-keyword">catch</span>(e) {
                log.error(e);
            }

            log.info(<span class="hljs-string">'Created a job.'</span>);
            job.save(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, job</span>) </span>{
                <span class="hljs-keyword">if</span>(err) {
                    log.error(err);
                answer = {
                        status:<span class="hljs-string">"error"</span>,
                        message:err
                    };
                    res.json(answer);
                } <span class="hljs-keyword">else</span> {
                answer = {
                        status:<span class="hljs-string">"success"</span>,
                        data : {job:job}
                    };
                    res.json(answer);
                }
            }); <span class="hljs-comment">// job.save</span>
        });
    } <span class="hljs-comment">// if file and allowed</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (file){
        answer = {
            status:<span class="hljs-string">"fail"</span>,
            data : {<span class="hljs-string">"job"</span> : <span class="hljs-string">"Wrong file format"</span>}
        };
        res.json(answer);
    }
    <span class="hljs-keyword">else</span>{
        answer = {
            status:<span class="hljs-string">"fail"</span>,
            data : {<span class="hljs-string">"job"</span> : <span class="hljs-string">"Problem receiving the job : bad request"</span>}
        };
        res.json(answer);
    }
}; <span class="hljs-comment">// submitJob</span></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'> api {delete} /jobs/queue Clear job queue, apiGroup Jobs, apiDescription Empty the job queue of all pending jobs., apiSuccess {String} status <code>success</code>, apiSuccess {Object} data null, apiError {String} status <code>error</code>, and apiError {Object} message Error message</span></p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> clearQueue = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{
    <span class="hljs-keyword">var</span> answer;
    db.Job.deletePending(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
        <span class="hljs-keyword">if</span>(err) {
            answer = {
                status:<span class="hljs-string">"error"</span>,
                message:err
            };
            res.json(answer);
        } <span class="hljs-keyword">else</span> {
            answer = {
                status:<span class="hljs-string">"success"</span>,
                data : <span class="hljs-literal">null</span>
            };
            res.json(answer);
        }
    });
};</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'> apiGroup Jobs, api {post} /jobs/queue/run Run next job in queue, apiDescription Runs the next job in the queue if able., apiSuccess {String} status <code>success</code>, apiSuccess {Object} data null, apiError {String} status <code>error</code>, and apiError {Object} message Error message</span></p></div></div><div class="code"><div class="wrapper">runNextJob = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{
    <span class="hljs-keyword">var</span> answer;
    log.info(<span class="hljs-string">'Running the next job in the queue'</span>);
    machine.runNextJob(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, job</span>) </span>{
        <span class="hljs-keyword">if</span>(err) {
            log.error(err);
            answer = {
                status:<span class="hljs-string">"failed"</span>,
                data:{job:err}
            };
            res.json(answer);
        } <span class="hljs-keyword">else</span> {
            answer = {
                status:<span class="hljs-string">"success"</span>,
                data : {job:job}
            };
            res.json(answer);
        }
    });
};</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'> apiGroup Jobs, api {post} /jobs/:id Resubmit job, apiDescription Submit a new job identical to the one specified.  Used to re-run completed jobs without modification., apiParam {String} id ID of job to resubmit, apiSuccess {String} status <code>success</code>, apiSuccess {Object} data null, apiError {String} status <code>error</code>, and apiError {Object} message Error message</span></p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> resubmitJob = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{
    <span class="hljs-keyword">var</span> answer;
    log.debug(<span class="hljs-string">"Resubmitting job "</span> + req.params.id);
    db.Job.getById(req.params.id, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, result</span>) </span>{
        log.debug(result);
        <span class="hljs-keyword">if</span>(err) {
            log.error(<span class="hljs-built_in">JSON</span>.stringify(err));
        }
        result.clone(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, result</span>) </span>{
            log.debug(<span class="hljs-string">"Cloned!"</span>);
            <span class="hljs-keyword">if</span>(err) {
                log.error(err);
                answer = {
                    status:<span class="hljs-string">"failed"</span>,
                    data:{job:err}
                };
                res.json(answer);
            } <span class="hljs-keyword">else</span> {
                answer = {
                    status:<span class="hljs-string">"success"</span>,
                    data : {job:result}
                };
                res.json(answer);
            }
        });
    });
};</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'> apiGroup Jobs, api {get} /jobs/queue Job queue, apiDescription Get a list of all the pending jobs currently in the queue., apiSuccess {String} status <code>success</code>, apiSuccess {Object} data Response data, apiSuccess {Object[]} data.jobs List of all jobs, apiSuccess {Number} data.jobs._id Unique job ID, apiSuccess {String} data.jobs.state <code>pending</code> | <code>running</code> | <code>finished</code> | <code>cancelled</code>, apiSuccess {String} data.jobs.name Human readable job name, apiSuccess {String} data.jobs.description Job description, apiSuccess {Number} data.jobs.created_at Time job was added to the queue (UNIX timestamp), apiSuccess {Number} data.jobs.started_at Time job was started (UNIX timestamp), apiSuccess {Number} data.jobs.finished_at Time job was finished (UNIX timestamp), apiError {String} status <code>error</code>, and apiError {Object} message Error message</span></p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> getQueue = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{
    <span class="hljs-keyword">var</span> answer;
    db.Job.getPending(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, result</span>) </span>{
        <span class="hljs-keyword">if</span>(err) {
            log.error(err);
            answer = {
                status:<span class="hljs-string">"error"</span>,
                message:<span class="hljs-string">"failed to get jobs from DB"</span>
            };
            res.json(answer);
        } <span class="hljs-keyword">else</span> {
            answer = {
                status:<span class="hljs-string">"success"</span>,
                data : {jobs:result}
            };
            res.json(answer);
        }
    });
};</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'> apiGroup Jobs, api {get} /jobs List all jobs, apiDescription Get a list of all jobs, including those that are pending, currently running, and finished., apiSuccess {String} status <code>success</code>, apiSuccess {Object} data Response data, apiSuccess {Object[]} data.jobs List of all jobs, apiSuccess {Number} data.jobs._id Unique job ID, apiSuccess {String} data.jobs.state <code>pending</code> | <code>running</code> | <code>finished</code> | <code>cancelled</code>, apiSuccess {String} data.jobs.name Human readable job name, apiSuccess {String} data.jobs.description Job description, apiSuccess {Number} data.jobs.created_at Time job was added to the queue (UNIX timestamp), apiSuccess {Number} data.jobs.started_at Time job was started (UNIX timestamp), apiSuccess {Number} data.jobs.finished_at Time job was finished (UNIX timestamp), apiError {String} status <code>error</code>, and apiError {Object} message Error message</span></p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> getAllJobs = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{
    <span class="hljs-keyword">var</span> answer;
    db.Job.getAll(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, result</span>) </span>{
        <span class="hljs-keyword">if</span>(err) {
            log.error(err);
            answer = {
                status:<span class="hljs-string">"error"</span>,
                message:<span class="hljs-string">"failed to get jobs from DB"</span>
            };
            res.json(answer);
        } <span class="hljs-keyword">else</span> {
            answer = {
                status:<span class="hljs-string">"success"</span>,
                data : {jobs:result}
            };
            res.json(answer);
        }
    });
};

<span class="hljs-keyword">var</span> getJobHistory = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{
    <span class="hljs-keyword">var</span> answer;
    db.Job.getHistory(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, result</span>) </span>{
        <span class="hljs-keyword">if</span>(err) {
            log.error(err);
            answer = {
                status:<span class="hljs-string">"error"</span>,
                message:<span class="hljs-string">"failed to get jobs from DB"</span>
            };
            res.json(answer);
        } <span class="hljs-keyword">else</span> {
            answer = {
                status:<span class="hljs-string">"success"</span>,
                data : {jobs:result}
            };
            res.json(answer);
        }
    });
};</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'> apiGroup Jobs, api {get} /jobs/:id Job info, apiDescription Get detailed information about a specific job., apiParam {String} id ID of requested job, apiSuccess {Object} data Response data, apiSuccess {Object} data.job Requested job , apiSuccess {Number} data.job._id Unique job ID, apiSuccess {String} data.job.state <code>pending</code> | <code>running</code> | <code>finished</code> | <code>cancelled</code>, apiSuccess {String} data.job.name Human readable job name, apiSuccess {String} data.job.description Job description, apiSuccess {Number} data.job.created_at Time job was added to the queue (UNIX timestamp), apiSuccess {Number} data.job.started_at Time job was started (UNIX timestamp), apiSuccess {Number} data.job.finished_at Time job was finished (UNIX timestamp), apiError {String} status <code>error</code>, and apiError {Object} message Error message</span></p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> getJobById = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{
    <span class="hljs-keyword">var</span> answer;
    db.Job.getById(req.params.id, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, result</span>) </span>{
        <span class="hljs-keyword">if</span>(err) {
            log.error(err);
            answer = {
                    status:<span class="hljs-string">"fail"</span>,
                    data:{job:err}
            };
            res.json(answer);
        } <span class="hljs-keyword">else</span> {
            answer = {
                status:<span class="hljs-string">"success"</span>,
                data : {job:result}
            };
            res.json(answer);
        }
    });
};</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'> apiGroup Jobs, api {delete} /jobs/:id Cancel job, apiDescription Cancel a pending job., apiParam {String} id ID of job to cancel, apiSuccess {String} status <code>success</code>, apiSuccess {Object} data null, apiError {String} status <code>error</code>, and apiError {Object} message Error message</span></p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> cancelJob = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{
    <span class="hljs-keyword">var</span> answer;
    db.Job.getById(req.params.id, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, result</span>) </span>{
        <span class="hljs-keyword">if</span>(err) {
            log.error(err);
            answer = {
                    status:<span class="hljs-string">"fail"</span>,
                    data:{job:err}
            };
            res.json(answer);
        } <span class="hljs-keyword">else</span> {
            result.cancel(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, result</span>) </span>{
                <span class="hljs-keyword">if</span>(err) {
                    log.error(err);
                    answer = {
                            status:<span class="hljs-string">"fail"</span>,
                            data:{job:err}
                    };
                    res.json(answer);
                } <span class="hljs-keyword">else</span> {
                    answer = {
                        status:<span class="hljs-string">"success"</span>,
                        data : {job:result}
                    };
                    res.json(answer);
                }
            });
        }
    });
};

<span class="hljs-keyword">var</span> getJobFile = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{
    db.Job.getFileForJobId(req.params.id, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, file</span>) </span>{
        <span class="hljs-keyword">if</span>(err) {
            log.error(err);
            <span class="hljs-keyword">var</span> answer = {
                    status:<span class="hljs-string">"fail"</span>,
                    data:{file:err}
            };
            res.json(answer);                        
        } <span class="hljs-keyword">else</span> {
            res.setHeader(<span class="hljs-string">'content-type'</span>, <span class="hljs-string">'text/plain'</span>);
            res.setHeader(<span class="hljs-string">'content-disposition'</span>, <span class="hljs-string">'filename="'</span> + file.filename + <span class="hljs-string">'"'</span>);
            <span class="hljs-keyword">var</span> readStream = fs.createReadStream(file.path);
            readStream.pipe(res);
        }
    });
};

<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">server</span>) </span>{
    server.post(<span class="hljs-string">'/job'</span>, submitJob);
    server.get(<span class="hljs-string">'/jobs'</span>, getAllJobs);
    
    server.get(<span class="hljs-string">'/job/:id'</span>, getJobById);
    server.post(<span class="hljs-string">'/job/:id'</span>, resubmitJob);
    server.get(<span class="hljs-string">'/job/:id/file'</span>, getJobFile);
    server.get(<span class="hljs-string">'/jobs/queue'</span>, getQueue);
    server.del(<span class="hljs-string">'/jobs/queue'</span>, clearQueue);
    server.post(<span class="hljs-string">'/jobs/queue/run'</span>, runNextJob);
    server.get(<span class="hljs-string">'/jobs/history'</span>, getJobHistory);

};</div></div></div></div></body></html>