<!DOCTYPE html><html lang="en"><head><title>routes/authentication</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="routes/authentication"><meta name="groc-project-path" content="routes/authentication.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">routes/authentication.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> log = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../log'</span>).logger(<span class="hljs-string">'authentication'</span>);
<span class="hljs-keyword">var</span> authentication = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../authentication'</span>);
<span class="hljs-keyword">var</span> passport = authentication.passport;

<span class="hljs-keyword">var</span> login = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{
  authentication.passport.authenticate(<span class="hljs-string">'local'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, user, info</span>) </span>{
    <span class="hljs-keyword">if</span> (err) {
      <span class="hljs-keyword">return</span> next(err); <span class="hljs-comment">// will generate a 500 error</span>
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Generate a JSON response reflecting authentication status</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (! user) {
      <span class="hljs-keyword">return</span> res.send(<span class="hljs-number">401</span>,{ status:<span class="hljs-string">'error'</span>, message : info.message, userAlreadyLogedIn:info.userAlreadyLogedIn});
    }
    req.login(user, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>)</span>{
      <span class="hljs-keyword">if</span>(err){
        <span class="hljs-keyword">return</span> next(err);
      }
      authentication.setCurrentUser(user);
      <span class="hljs-keyword">return</span> res.send({ status:<span class="hljs-string">'success'</span>, message : <span class="hljs-string">'authentication succeeded'</span> });
    });
  })(req, res, next);
};

<span class="hljs-keyword">var</span> addUser = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{

  currentUser = authentication.getCurrentUser();
  <span class="hljs-keyword">if</span>(currentUser &amp;&amp; currentUser.isAdmin){
    <span class="hljs-keyword">if</span>(req.params.user===<span class="hljs-literal">undefined</span> || req.params.user.username==<span class="hljs-literal">undefined</span> || req.params.user.password==<span class="hljs-literal">undefined</span>){
      res.send(<span class="hljs-number">200</span>,{ status:<span class="hljs-string">'error'</span>, message:<span class="hljs-string">'you need to provide an object with a user object inside containing a username AND a password'</span>});
      <span class="hljs-keyword">return</span>;
    }<span class="hljs-keyword">else</span>{
      authentication.addUser(req.params.user.username,req.params.user.password,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err,user</span>)</span>{
        <span class="hljs-keyword">if</span>(err){
          res.send(<span class="hljs-number">200</span>,{ status:<span class="hljs-string">'error'</span>, message:err});
          <span class="hljs-keyword">return</span>;
        }<span class="hljs-keyword">else</span>{
          res.send(<span class="hljs-number">200</span>,{ status:<span class="hljs-string">'success'</span>, data : user});
          <span class="hljs-keyword">return</span>;
        }
      });
    }
  }<span class="hljs-keyword">else</span> {
    res.send(<span class="hljs-number">200</span>,{status:<span class="hljs-string">'error'</span>,message:<span class="hljs-string">"you need to be admin to register new users"</span>});
    <span class="hljs-keyword">return</span>;
  }


};

<span class="hljs-keyword">var</span> logout = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{
  log.error(req);
  req.logout();
  authentication.setCurrentUser(<span class="hljs-literal">null</span>);
  res.redirect(<span class="hljs-string">''</span>,next);
  <span class="hljs-keyword">return</span>;
};

<span class="hljs-keyword">var</span> getUsers = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req,res,next</span>)</span>{
  currentUser = authentication.getCurrentUser();
  <span class="hljs-keyword">if</span>(currentUser &amp;&amp; currentUser.isAdmin){ <span class="hljs-comment">// if admin</span>
    authentication.getUsers(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err,users</span>)</span>{
      <span class="hljs-keyword">if</span>(err){
        res.send(<span class="hljs-number">200</span>,{status:<span class="hljs-string">'error'</span>,message:err});
        <span class="hljs-keyword">return</span>;
      }
      res.send(<span class="hljs-number">200</span>,{status:<span class="hljs-string">'success'</span>,data:users});
      <span class="hljs-keyword">return</span>;
    });
  }<span class="hljs-keyword">else</span> {
    res.send(<span class="hljs-number">200</span>,{status:<span class="hljs-string">'error'</span>,message:<span class="hljs-string">"you need to be admin to get users info"</span>});
    <span class="hljs-keyword">return</span>;
  }
};

<span class="hljs-keyword">var</span> getUser = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req,res,next</span>)</span>{
  currentUser = authentication.getCurrentUser();
  <span class="hljs-keyword">if</span>(currentUser &amp;&amp;( (currentUser.username == req.params.id ) || currentUser.isAdmin)){ <span class="hljs-comment">// if current user or admin</span>
    authentication.getUser(req.params.id,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err,user</span>)</span>{
      <span class="hljs-keyword">if</span>(err){
        res.send(<span class="hljs-number">200</span>,{status:<span class="hljs-string">'error'</span>,message:err});
        <span class="hljs-keyword">return</span>;
      }
      res.send(<span class="hljs-number">200</span>,{status:<span class="hljs-string">'success'</span>,data:user});
      <span class="hljs-keyword">return</span>;
    });
  }<span class="hljs-keyword">else</span> {
    res.send(<span class="hljs-number">200</span>,{status:<span class="hljs-string">'error'</span>,message:<span class="hljs-string">"you need to be admin or request your own id to get the user info"</span>});
    <span class="hljs-keyword">return</span>;
  }
};

<span class="hljs-keyword">var</span> getCurrentUser = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req,res,next</span>)</span>{
  currentUser = authentication.getCurrentUser();
  <span class="hljs-keyword">if</span>(currentUser){ <span class="hljs-comment">// if current user</span>
    authentication.getUser(currentUser.username,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err,user</span>)</span>{
      <span class="hljs-keyword">if</span>(err){
        res.send(<span class="hljs-number">200</span>,{status:<span class="hljs-string">'error'</span>,message:err});
        <span class="hljs-keyword">return</span>;
      }
      res.send(<span class="hljs-number">200</span>,{status:<span class="hljs-string">'success'</span>,data:user});
      <span class="hljs-keyword">return</span>;
    });
  }<span class="hljs-keyword">else</span> {
    res.send(<span class="hljs-number">200</span>,{status:<span class="hljs-string">'error'</span>,message:<span class="hljs-string">"you need to be connected to request your own user info"</span>});
    <span class="hljs-keyword">return</span>;
  }
};


<span class="hljs-keyword">var</span> modifyUser = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req,res,next</span>)</span>{
  currentUser = authentication.getCurrentUser();
  <span class="hljs-keyword">if</span>(!req.params.id){
    res.send(<span class="hljs-number">200</span>,{status:<span class="hljs-string">'error'</span>,message:<span class="hljs-string">"no username provided"</span>});
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-keyword">if</span>(currentUser &amp;&amp;(currentUser.username == req.params.username || currentUser.isAdmin)){ <span class="hljs-comment">// if current user or admin</span>
    <span class="hljs-keyword">if</span>(!req.params.user){
      res.send(<span class="hljs-number">200</span>,{status:<span class="hljs-string">'error'</span>,message:<span class="hljs-string">"no user object provided"</span>});
      <span class="hljs-keyword">return</span>;
    }
    authentication.modifyUser(req.params.id,req.params.user,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err,user</span>)</span>{
      <span class="hljs-keyword">if</span>(err){
        res.send(<span class="hljs-number">200</span>,{status:<span class="hljs-string">'error'</span>,message:err});
        <span class="hljs-keyword">return</span>;
      }
      res.send(<span class="hljs-number">200</span>,{status:<span class="hljs-string">'success'</span>,data:user});
      <span class="hljs-keyword">return</span>;
    });
  }<span class="hljs-keyword">else</span> {
    res.send(<span class="hljs-number">200</span>,{status:<span class="hljs-string">'error'</span>,message:<span class="hljs-string">"you need to be admin or request your own id to modify the user info"</span>});
    <span class="hljs-keyword">return</span>;
  }
};

<span class="hljs-keyword">var</span> deleteUser = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req,res,next</span>)</span>{ <span class="hljs-comment">// if admin</span>
  currentUser = authentication.getCurrentUser();
  <span class="hljs-keyword">if</span>(currentUser &amp;&amp; currentUser.isAdmin){ <span class="hljs-comment">// if admin</span>
    authentication.deleteUser(req.params.id,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err,user</span>)</span>{
      <span class="hljs-keyword">if</span>(err){
        res.send(<span class="hljs-number">200</span>,{status:<span class="hljs-string">'error'</span>,message:err});
        <span class="hljs-keyword">return</span>;
      }
      res.send(<span class="hljs-number">200</span>,{status:<span class="hljs-string">'success'</span>});
      <span class="hljs-keyword">return</span>;
    });
  }<span class="hljs-keyword">else</span> {
    res.send(<span class="hljs-number">200</span>,{status:<span class="hljs-string">'error'</span>,message:<span class="hljs-string">"you need to be admin to delete users"</span>});
    <span class="hljs-keyword">return</span>;
  }
};

<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">server</span>) </span>{
  server.post(<span class="hljs-string">'/authentication/login'</span>, login);
  server.get(<span class="hljs-string">'/authentication/logout'</span>,passport.authenticate(<span class="hljs-string">'local'</span>), logout);
  server.get(<span class="hljs-string">'/authentication/user'</span>,passport.authenticate(<span class="hljs-string">'local'</span>), getCurrentUser);<span class="hljs-comment">// return current user info.</span>
  server.post(<span class="hljs-string">'/authentication/user'</span>,passport.authenticate(<span class="hljs-string">'local'</span>), addUser);<span class="hljs-comment">//only authenticated user can add new users.</span>
  server.get(<span class="hljs-string">'/authentication/users'</span>,passport.authenticate(<span class="hljs-string">'local'</span>), getUsers);
  server.get(<span class="hljs-string">'/authentication/user/:id'</span>,passport.authenticate(<span class="hljs-string">'local'</span>), getUser);
  server.post(<span class="hljs-string">'/authentication/user/:id'</span>,passport.authenticate(<span class="hljs-string">'local'</span>), modifyUser);
  server.del(<span class="hljs-string">'/authentication/user/:id'</span>,passport.authenticate(<span class="hljs-string">'local'</span>), deleteUser);

};</div></div></div></div></body></html>