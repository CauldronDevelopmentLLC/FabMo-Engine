<!DOCTYPE html><html lang="en"><head><title>routes/wifi_manager</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="routes/wifi_manager"><meta name="groc-project-path" content="routes/wifi_manager.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">routes/wifi_manager.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">try</span>{<span class="hljs-keyword">var</span> wifiscanner = <span class="hljs-built_in">require</span>(<span class="hljs-string">'node-simplerwifiscanner'</span>);}<span class="hljs-keyword">catch</span>(e){};
<span class="hljs-keyword">var</span> log = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../log'</span>).logger(<span class="hljs-string">'wifi'</span>);
<span class="hljs-keyword">var</span> config =  <span class="hljs-built_in">require</span>(<span class="hljs-string">'../config'</span>)
<span class="hljs-keyword">var</span> fs= <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);

<span class="hljs-keyword">var</span> profiles_folder = <span class="hljs-string">"/etc/netctl/"</span>;
<span class="hljs-keyword">var</span> itr = <span class="hljs-string">"wlan0"</span>;


detection = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req, res, next)</span> {</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>data is a wifi_info Object</p></div></div><div class="code"><div class="wrapper">    wifiscanner.scan(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err,data)</span>{</span>
    	<span class="hljs-keyword">if</span> (err) {
        	log.error(err);
        	res.json(<span class="hljs-number">500</span>,err);
        	<span class="hljs-keyword">return</span>;
    	}
    	    res.json(<span class="hljs-number">200</span>,data);
    });

};


list_profiles = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req, res, next)</span> {</span>
	profiles = [];
	fs.readdir(profiles_folder,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err,files)</span>{</span>
		<span class="hljs-keyword">if</span>(err){
			log.error(<span class="hljs-string">'bad wifi profiles folder : '</span>+ profiles_folder + <span class="hljs-string">' ['</span>+err+<span class="hljs-string">']'</span>);
        	res.json(<span class="hljs-number">500</span>,err); 
        	<span class="hljs-keyword">return</span>;
        }
    	files.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(file,index,array)</span>{</span>
    		<span class="hljs-keyword">if</span>(file.indexOf(itr+<span class="hljs-string">"-"</span>)===<span class="hljs-number">0</span>){
    			fs.readFile(profiles_folder+file, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, data)</span> {</span>
					<span class="hljs-keyword">if</span>(err){
						log.error(<span class="hljs-string">'error while reading wifi profile : '</span>+ profiles_folder+file + <span class="hljs-string">' ['</span>+err+<span class="hljs-string">']'</span>);
			        	res.json(<span class="hljs-number">500</span>,err); 
			        	<span class="hljs-keyword">return</span>;
					}
					profiles.push(parse_profile(data));
					<span class="hljs-keyword">if</span> (index===array.length-<span class="hljs-number">1</span>)
						res.json(<span class="hljs-number">200</span>,profiles);
				});
    		}
    	})

	});
};

add_profile = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req, res, next)</span> {</span>
    <span class="hljs-keyword">if</span>(req.params.wifi_info !== <span class="hljs-literal">undefined</span>){
    	<span class="hljs-keyword">var</span> wifi_info = req.params.wifi_info;
    	<span class="hljs-keyword">var</span> file_string = create_profile(wifi_info);
    	<span class="hljs-keyword">if</span>(file_string !== <span class="hljs-literal">undefined</span>){
    		fs.writeFile(profiles_folder+itr+<span class="hljs-string">'-'</span>+wifi_info.ssid,file_string, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> {</span> <span class="hljs-comment">// write the profile file</span>
			  <span class="hljs-keyword">if</span> (err){
				log.error(<span class="hljs-string">'error while writing wifi profile : '</span>+ profiles_folder+itr+<span class="hljs-string">'-'</span>+wifi_info.ssid + <span class="hljs-string">' ['</span>+err+<span class="hljs-string">']'</span>);
	        	res.json(<span class="hljs-number">500</span>,err); 
	        	<span class="hljs-keyword">return</span>;
			  } 
			  log.info(<span class="hljs-string">'Wifi profile added for '</span>+ wifi_info.ssid);
			  res.json(<span class="hljs-number">200</span>,{<span class="hljs-string">'Success'</span>:<span class="hljs-string">'Profile added'</span>});
			});
    	}<span class="hljs-keyword">else</span>{
    		res.json({<span class="hljs-string">'error'</span>:<span class="hljs-string">'Bad network informations provided'</span>});
    	}
    }
    <span class="hljs-keyword">else</span>
    	res.json({<span class="hljs-string">'error'</span>:<span class="hljs-string">'No network informations provided'</span>});
};

delete_profile = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req, res, next)</span> {</span>
    <span class="hljs-keyword">if</span>(req.params.ssid)
    {
    	fs.unlink(profiles_folder+itr+<span class="hljs-string">'-'</span>+req.params.ssid, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> {</span>
			<span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;
			res.json(<span class="hljs-number">200</span>,{<span class="hljs-string">'Success'</span>:<span class="hljs-string">'Profile removed'</span>});
		});
    }
	<span class="hljs-keyword">else</span>{
    	res.json({<span class="hljs-string">'error'</span>:<span class="hljs-string">'no ssid provided'</span>});
    }
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>parse a profile string and convert it into a json Object</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parse_profile</span><span class="hljs-params">(profile_txt)</span>{</span>
	<span class="hljs-keyword">var</span> profile = {};
	<span class="hljs-keyword">var</span> lines = profile_txt.toString().split(<span class="hljs-string">'\n'</span>);
	<span class="hljs-keyword">for</span>(index <span class="hljs-keyword">in</span> lines){
		<span class="hljs-keyword">var</span> arg = lines[index].trim().split(<span class="hljs-string">'='</span>);
		log.debug(arg);
		<span class="hljs-keyword">if</span>(arg[<span class="hljs-number">0</span>])
			profile[arg[<span class="hljs-number">0</span>]]=arg[<span class="hljs-number">1</span>];
	}
	<span class="hljs-keyword">return</span> profile;
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>create a profile string from a wifi_info object</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create_profile</span><span class="hljs-params">(wifi_info)</span>{</span>
	<span class="hljs-keyword">if</span>(!wifi_info)
		<span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
	<span class="hljs-keyword">if</span>(wifi_info.security !== <span class="hljs-string">"none"</span> &amp;&amp; wifi_info.security &amp;&amp; <span class="hljs-string">"wep"</span> &amp;&amp; wifi_info.security !== <span class="hljs-string">"wpa"</span> )
		<span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
	<span class="hljs-keyword">if</span>(!wifi_info.ssid)
		<span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;

	<span class="hljs-keyword">var</span> profile_string=<span class="hljs-string">""</span>;

	profile_string+=	<span class="hljs-string">"Description='Generated profile through the FabMo Platform'\n"</span>;
	profile_string+=	<span class="hljs-string">"Interface="</span>+itr+<span class="hljs-string">'\n'</span>;
	profile_string+=	<span class="hljs-string">"Connection=wireless\n"</span>;
	profile_string+=	<span class="hljs-string">"Security="</span>+wifi_info.security+<span class="hljs-string">'\n'</span>;
	profile_string+=	<span class="hljs-string">"ESSID="</span>+wifi_info.ssid+<span class="hljs-string">'\n'</span>;
	profile_string+=	<span class="hljs-string">"IP=dhcp\n"</span>;
	<span class="hljs-keyword">if</span>(wifi_info.security!==<span class="hljs-string">"none"</span> &amp;&amp; wifi_info.key === <span class="hljs-literal">undefined</span>)
		<span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
	<span class="hljs-keyword">else</span>
		profile_string+=<span class="hljs-string">"Key="</span>+wifi_info.key+<span class="hljs-string">'\n'</span>;


	<span class="hljs-keyword">return</span> profile_string;

};


module.exports = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(server)</span> {</span>
	<span class="hljs-keyword">if</span>(config.engine.get(<span class="hljs-string">'wifi_manager'</span>)){
		server.get(<span class="hljs-string">'/wifi_manager/detection'</span>,detection); <span class="hljs-comment">//OK</span>
		server.get(<span class="hljs-string">'/wifi_manager/profiles'</span>,list_profiles); <span class="hljs-comment">//OK</span>
		server.post(<span class="hljs-string">'/wifi_manager/profile'</span>,add_profile); <span class="hljs-comment">//OK</span>
		server.del(<span class="hljs-string">'/wifi_manager/profile/:ssid'</span>,delete_profile); <span class="hljs-comment">//OK</span>
	}
}</div></div></div></div></body></html>