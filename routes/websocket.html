<!DOCTYPE html><html lang="en"><head><title>routes/websocket</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="routes/websocket"><meta name="groc-project-path" content="routes/websocket.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">routes/websocket.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">var</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../util'</span>);
<span class="hljs-keyword">var</span> machine = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../machine'</span>).machine;
<span class="hljs-keyword">var</span> log=<span class="hljs-built_in">require</span>(<span class="hljs-string">'../log'</span>).logger(<span class="hljs-string">"websocket"</span>);
<span class="hljs-keyword">var</span> clients_limit = <span class="hljs-number">5</span>;
<span class="hljs-keyword">var</span> nb_clients=<span class="hljs-number">0</span>;


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setupStatusBroadcasts</span>(<span class="hljs-params">server</span>)</span>{
	<span class="hljs-keyword">var</span> previous_status = {<span class="hljs-string">'state'</span>:<span class="hljs-literal">null</span>}
	machine.on(<span class="hljs-string">'status'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">status</span>)</span>{
		server.io.sockets.sockets.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">socket</span>) </span>{ 
			<span class="hljs-keyword">if</span>(status.state === <span class="hljs-string">'idle'</span> || status.state != previous_status.state) {
				socket.emit(<span class="hljs-string">'status'</span>,status);
			} <span class="hljs-keyword">else</span> {
				socket.volatile.emit(<span class="hljs-string">'status'</span>, status);
			}
		});
		previous_status.state = status.state;
	});

	machine.on(<span class="hljs-string">'change'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">topic</span>) </span>{
		server.io.sockets.sockets.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">socket</span>) </span>{ 
			socket.emit(<span class="hljs-string">'change'</span>,topic);
		});
	});
}


<span class="hljs-keyword">var</span> onConnect = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">socket</span>) </span>{

	<span class="hljs-keyword">var</span> client = util.getClientAddress(socket.client.request)
	log.info(<span class="hljs-string">"Client "</span> + client + <span class="hljs-string">" connected."</span>);

	socket.on(<span class="hljs-string">'disconnect'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
		log.debug(<span class="hljs-string">"Client disconnected"</span>);
	});

	socket.on(<span class="hljs-string">'status'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{
		socket.emit(<span class="hljs-string">'status'</span>, machine.status);
	});

	socket.on(<span class="hljs-string">'code'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{
		<span class="hljs-keyword">if</span>(<span class="hljs-string">'rt'</span> <span class="hljs-keyword">in</span> data) {
			<span class="hljs-keyword">try</span> {
				machine.executeRuntimeCode(data.rt, data.data)
			} <span class="hljs-keyword">catch</span>(e) {
				log.error(e);
			}
		}
	});

	socket.on(<span class="hljs-string">'ping'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{
		socket.emit(<span class="hljs-string">'pong'</span>);
	});

	socket.on(<span class="hljs-string">'cmd'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{
		<span class="hljs-keyword">try</span> {

		<span class="hljs-keyword">switch</span>(data.name) {
			<span class="hljs-keyword">case</span> <span class="hljs-string">'pause'</span>:
				machine.pause();
				<span class="hljs-keyword">break</span>;

			<span class="hljs-keyword">case</span> <span class="hljs-string">'quit'</span>:
				machine.quit();
				<span class="hljs-keyword">break</span>;

			<span class="hljs-keyword">case</span> <span class="hljs-string">'resume'</span>:
				machine.resume();
				<span class="hljs-keyword">break</span>;

			<span class="hljs-keyword">default</span>:</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Meh?</p></div></div><div class="code"><div class="wrapper">				<span class="hljs-keyword">break</span>;
		}
		} <span class="hljs-keyword">catch</span>(e) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>pass</p></div></div><div class="code"><div class="wrapper">		}
	});
};

<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">server</span>) </span>{
	server.io.on(<span class="hljs-string">'connection'</span>, onConnect);
	setupStatusBroadcasts(server);
};</div></div></div></div></body></html>