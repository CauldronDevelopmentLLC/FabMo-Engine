<!DOCTYPE html><html lang="en"><head><title>routes/websocket</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="routes/websocket"><meta name="groc-project-path" content="routes/websocket.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">routes/websocket.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">var</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../util'</span>);
<span class="hljs-keyword">var</span> machine = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../machine'</span>).machine;
<span class="hljs-keyword">var</span> log=<span class="hljs-built_in">require</span>(<span class="hljs-string">'../log'</span>).logger(<span class="hljs-string">"websocket"</span>);
<span class="hljs-keyword">var</span> authentication = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../authentication'</span>);
<span class="hljs-keyword">var</span> passport = authentication.passport;
<span class="hljs-keyword">var</span> sessions = <span class="hljs-built_in">require</span>(<span class="hljs-string">"client-sessions"</span>);
<span class="hljs-keyword">var</span> parseCookie = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./util'</span>).parseCookie;
<span class="hljs-keyword">var</span> server = <span class="hljs-literal">null</span>;
<span class="hljs-keyword">var</span> clients_limit = <span class="hljs-number">5</span>;
<span class="hljs-keyword">var</span> nb_clients=<span class="hljs-number">0</span>;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setupAuthentication</span>(<span class="hljs-params">svr</span>) </span>{
	server.io.of(<span class="hljs-string">'/private'</span>).use(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">socket, next</span>) </span>{
		<span class="hljs-keyword">var</span> handshakeData = socket.request;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Check that the cookie header is present</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-keyword">if</span> (!handshakeData.headers.cookie) {
            <span class="hljs-keyword">return</span> next(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'No cookie transmitted.'</span>));
        }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Get all the cookie objects</p></div></div><div class="code"><div class="wrapper">		<span class="hljs-keyword">var</span> cookie = parseCookie(handshakeData.headers.cookie);

        <span class="hljs-keyword">if</span> (!cookie[<span class="hljs-string">'session'</span>]) {
            <span class="hljs-keyword">var</span> err = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'No session provided.'</span>);
            log.error(err);
            <span class="hljs-keyword">return</span> next(err);
        }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Pull out the user from the cookie by using the decode function</p></div></div><div class="code"><div class="wrapper">        handshakeData.sessionID = sessions.util.decode({
            cookieName: <span class="hljs-string">'session'</span>,
			secret: server.cookieSecret
		}, cookie[<span class="hljs-string">'session'</span>]);
        <span class="hljs-keyword">if</span> (handshakeData.sessionID.content.passport !== <span class="hljs-literal">undefined</span>) {
                <span class="hljs-keyword">var</span> user = handshakeData.sessionID.content.passport.user;
                authentication.getUserById(user, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{

                    <span class="hljs-keyword">if</span> (err) {
						<span class="hljs-keyword">var</span> err = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(err);
           				log.error(err);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>delete socket.request.headers.cookie;</p></div></div><div class="code"><div class="wrapper">            			<span class="hljs-keyword">return</span> next(err);
                    } <span class="hljs-keyword">else</span> {
						authentication.setCurrentUser(data);
						next();
                    }
                });</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>authentication.configure();</p></div></div><div class="code"><div class="wrapper">                <span class="hljs-keyword">if</span> (!handshakeData.sessionID) {
                    <span class="hljs-keyword">var</span> err = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Wrong session.'</span>);

                    <span class="hljs-keyword">return</span> next(err);
                }
        } <span class="hljs-keyword">else</span> {
            next();
        }
    });
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setupStatusBroadcasts</span>(<span class="hljs-params">server</span>)</span>{
	<span class="hljs-keyword">var</span> previous_status = {<span class="hljs-string">'state'</span>:<span class="hljs-literal">null</span>}
	machine.on(<span class="hljs-string">'status'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">status</span>)</span>{
		server.io.of(<span class="hljs-string">'/private'</span>).sockets.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">socket</span>) </span>{
			<span class="hljs-keyword">if</span>(status.state === <span class="hljs-string">'idle'</span> || status.state != previous_status.state) {
				socket.emit(<span class="hljs-string">'status'</span>,status);
			} <span class="hljs-keyword">else</span> {
				socket.volatile.emit(<span class="hljs-string">'status'</span>, status);
			}
		});

		server.io.sockets.sockets.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">socket</span>) </span>{
			<span class="hljs-keyword">if</span>(status.state === <span class="hljs-string">'idle'</span> || status.state != previous_status.state) {
				socket.emit(<span class="hljs-string">'status'</span>,status);
			} <span class="hljs-keyword">else</span> {
				socket.volatile.emit(<span class="hljs-string">'status'</span>, status);
			}
		});
		previous_status.state = status.state;
	});

	machine.on(<span class="hljs-string">'change'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">topic</span>) </span>{
		server.io.of(<span class="hljs-string">'/private'</span>).sockets.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">socket</span>) </span>{
			socket.emit(<span class="hljs-string">'change'</span>,topic);
		});
		server.io.sockets.sockets.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">socket</span>) </span>{
			socket.emit(<span class="hljs-string">'change'</span>,topic);
		});
	});
}


<span class="hljs-keyword">var</span> onPublicConnect = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">socket</span>) </span>{
	<span class="hljs-keyword">var</span> client_address = util.getClientAddress(socket.client.request)
	log.info(<span class="hljs-string">"Anonymous client at "</span>+ client_address + <span class="hljs-string">" connected."</span>);

	socket.on(<span class="hljs-string">'disconnect'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
		log.debug(<span class="hljs-string">"Client disconnected"</span>);
	});

	socket.on(<span class="hljs-string">'status'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{
		socket.emit(<span class="hljs-string">'status'</span>, machine.status);
	});

	socket.on(<span class="hljs-string">'ping'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{
		socket.emit(<span class="hljs-string">'pong'</span>);
	});


};


<span class="hljs-keyword">var</span> onPrivateConnect = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">socket</span>) </span>{	
	<span class="hljs-keyword">if</span>(!socket.request.sessionID.content.passport) {
		<span class="hljs-keyword">return</span> socket.disconnect();
	}
		
	<span class="hljs-keyword">var</span> userId = socket.request.sessionID.content.passport.user;

	authentication.eventEmitter.on(<span class="hljs-string">'user_change'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>)</span>{
		socket.emit(<span class="hljs-string">'user_change'</span>, data);
	});

	authentication.eventEmitter.on(<span class="hljs-string">'user_kickout'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">user_kickout_listener</span>(<span class="hljs-params">user</span>)</span>{
		authentication.eventEmitter.removeListener(<span class="hljs-string">'user_kickout'</span>,user_kickout_listener);
		<span class="hljs-comment">//console.log("user kickout event");</span>
		<span class="hljs-keyword">if</span>(user.username == userId){
			socket.emit(<span class="hljs-string">'authentication_failed'</span>,<span class="hljs-string">'kicked out'</span>);
			<span class="hljs-keyword">return</span> socket.disconnect();
		}
	});

	<span class="hljs-keyword">var</span> client_address = util.getClientAddress(socket.client.request)
	log.info(<span class="hljs-string">"Client #"</span>+userId+<span class="hljs-string">" at "</span>+ client_address + <span class="hljs-string">" connected."</span>);

	socket.on(<span class="hljs-string">'code'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{
		<span class="hljs-keyword">var</span> handshakeData = socket.request;
		<span class="hljs-keyword">var</span> cookie = parseCookie(handshakeData.headers.cookie);
		handshakeData.sessionID = sessions.util.decode({
            cookieName: <span class="hljs-string">'session'</span>,
			secret: server.cookieSecret
		}, cookie[<span class="hljs-string">'session'</span>]);
		<span class="hljs-keyword">var</span> user = handshakeData.sessionID;

		<span class="hljs-keyword">if</span>(!authentication.getCurrentUser() || authentication.getCurrentUser().username != userId){
			log.error(userId);
			log.error(authentication.getCurrentUser());
			socket.emit(<span class="hljs-string">'authentication_failed'</span>,<span class="hljs-string">'not authenticated'</span>);
			<span class="hljs-keyword">return</span> socket.disconnect();
		} <span class="hljs-comment">// make sure that if the user logout, he can't talk through the socket anymore.</span>
		<span class="hljs-keyword">if</span>(<span class="hljs-string">'rt'</span> <span class="hljs-keyword">in</span> data) {
			<span class="hljs-keyword">try</span> {
				machine.executeRuntimeCode(data.rt, data.data)
			} <span class="hljs-keyword">catch</span>(e) {
				log.error(e);
			}
		}
	});

	socket.on(<span class="hljs-string">'cmd'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data, callback</span>) </span>{
		<span class="hljs-keyword">if</span>(!authentication.getCurrentUser() || authentication.getCurrentUser().username != userId){
			log.error(userId);
			log.error(authentication.getCurrentUser());
			socket.emit(<span class="hljs-string">'authentication_failed'</span>,<span class="hljs-string">'not authenticated'</span>);
			<span class="hljs-keyword">return</span> socket.disconnect();
		} <span class="hljs-comment">// make sure that if the user logout, he can't talk through the socket anymore.</span>
		<span class="hljs-keyword">try</span> {
			<span class="hljs-keyword">switch</span>(data.name) {
				<span class="hljs-keyword">case</span> <span class="hljs-string">'pause'</span>:
					machine.pause(callback);
					<span class="hljs-keyword">break</span>;

				<span class="hljs-keyword">case</span> <span class="hljs-string">'quit'</span>:
					machine.quit(callback);
					<span class="hljs-keyword">break</span>;

				<span class="hljs-keyword">case</span> <span class="hljs-string">'resume'</span>:
					machine.resume(callback);
					<span class="hljs-keyword">break</span>;

				<span class="hljs-keyword">default</span>:</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Meh?</p></div></div><div class="code"><div class="wrapper">					<span class="hljs-keyword">break</span>;
			}
		} <span class="hljs-keyword">catch</span>(e) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>pass</p></div></div><div class="code"><div class="wrapper">		}
	});

	socket.on(<span class="hljs-string">'user_kickout'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>)</span>{
		<span class="hljs-built_in">console</span>.error(data);
	});



	onPublicConnect(socket); <span class="hljs-comment">// inherit routes from the public function</span>

};

<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">svr</span>) </span>{
	server = svr
	setupAuthentication(server);
	server.io.on(<span class="hljs-string">'connection'</span>, onPublicConnect);
	server.io.of(<span class="hljs-string">'/private'</span>).on(<span class="hljs-string">'connection'</span>, onPrivateConnect);
	setupStatusBroadcasts(server);
};</div></div></div></div></body></html>