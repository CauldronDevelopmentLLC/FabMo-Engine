<!DOCTYPE html><html lang="en"><head><title>routes/dashboard</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="routes/dashboard"><meta name="groc-project-path" content="routes/dashboard.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">routes/dashboard.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> config = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../config'</span>);
<span class="hljs-keyword">var</span> restify = <span class="hljs-built_in">require</span>(<span class="hljs-string">'restify'</span>);
<span class="hljs-keyword">var</span> dashboard = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../dashboard'</span>);
<span class="hljs-keyword">var</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../util'</span>);
<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'> api {get} /apps List Apps, apiGroup Dashboard, apiDescription Get detailed information about all installed apps, apiSuccess {String} status <code>success</code>, apiSuccess {Object} data Response data, apiSuccess {Object[]} data.apps List of app objects, apiSuccess {String} data.apps.name Human-readable app name, apiSuccess {String} data.apps.app_url Root URL for the app, apiSuccess {String} data.apps.app_path App path (Used internally by the engine), apiSuccess {String} data.apps.icon_path URL of app icon, apiSuccess {String} data.apps.icon_background_color CSS color value of the app icon, and apiSuccess {String} data.apps.id Unique ID of this app (used in app URLs)</span></p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> getApps = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{
	<span class="hljs-keyword">var</span> answer = {
		status:<span class="hljs-string">"success"</span>,
		data : {apps : dashboard.getAppList()}
	};
	res.json(answer);
};</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'> api {get} /apps/:id App info, apiGroup Dashboard, apiDescription Get detailed information about the specified app, apiParam {String} id ID of requested app, apiSuccess {String} status <code>success</code>, apiSuccess {Object} data Response data, apiSuccess {Object} data.app App object, apiSuccess {String} data.app.name Human-readable app name, apiSuccess {String} data.app.app_url Root URL for the app, apiSuccess {String} data.app.app_path App path (Used internally by the engine), apiSuccess {String} data.app.icon_path URL of app icon, apiSuccess {String} data.app.icon_background_color CSS color value of the app icon, and apiSuccess {String} data.app.id Unique ID of this app (used in app URLs)</span></p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> getAppInfo = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{
	log.info(<span class="hljs-string">"Getting app "</span> + req.params.id);
	<span class="hljs-keyword">var</span> answer = {
		status:<span class="hljs-string">"success"</span>,
		data : {app : dashboard.getAppIndex()[req.params.id]}
	};
	res.json(answer);
};</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'> api {delete} /apps/:id Delete App, apiDescription Delete the specified app, and apiGroup Dashboard</span></p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> deleteApp = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{
    log.info(<span class="hljs-string">"Deleting app "</span> + req.params.id);
    dashboard.deleteApp(req.params.id, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, result</span>) </span>{
        <span class="hljs-keyword">var</span> answer;
        <span class="hljs-keyword">if</span>(err) {
            answer = {
                status:<span class="hljs-string">"error"</span>,
                message : err
            };
        } <span class="hljs-keyword">else</span> {
            answer = {
                status:<span class="hljs-string">"success"</span>,
                data : {app : result}
            };
        }
        res.json(answer);
    });
};</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'> api {get} /apps/:id/files List App Files, apiGroup Dashboard, apiParam {String} id ID of requested app, and apiSuccess {Object} root Root of directory tree</span></p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> listAppFiles = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{
	log.info(<span class="hljs-string">"Listing files"</span>);
	id = req.params.id;

	files = dashboard.getAppFiles(id);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Add URL attributes to all of the leaves of the file tree</p></div></div><div class="code"><div class="wrapper">	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">add_urls</span>(<span class="hljs-params">node</span>) </span>{
		<span class="hljs-keyword">if</span>(node.type === <span class="hljs-string">'file'</span>) {
			node.url = <span class="hljs-string">'/approot'</span> + node.path;
		}
		<span class="hljs-keyword">if</span>(node.children) {
			node.children.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">node</span>) </span>{
				add_urls(node);
			});
		}
	}

	add_urls(files);

		<span class="hljs-keyword">var</span> answer = {
		status:<span class="hljs-string">"success"</span>,
		data : {files : files}
	};
	res.json(answer);
};</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'> apiGroup Dashboard, api {post} /app Install App, and apiDescription Install an app to the user&#39;s app installation directory.  App will be decompressed and installed immediately.</span></p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> submitApp = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Get the one and only one file you&#39;re currently allowed to upload at a time</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">var</span> file = req.files.file;
    <span class="hljs-keyword">var</span> answer;

    log.debug(<span class="hljs-string">"Submitting an app..."</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Only write &quot;allowed files&quot;</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span>(file &amp;&amp; util.allowedAppFile(file.name))
    {
        log.debug(file);
        log.debug(<span class="hljs-string">"This is an allowed file!"</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Keep the name of the file uploaded for a &quot;friendly name&quot;</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-keyword">var</span> friendly_filename = file.name;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>But create a unique name for actual storage</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-keyword">var</span> filename = util.createUniqueFilename(friendly_filename);
        <span class="hljs-keyword">var</span> full_path = path.join(config.getDataDir(<span class="hljs-string">'apps'</span>), filename);

        log.debug(filename);
        log.debug(full_path);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Move the file</p></div></div><div class="code"><div class="wrapper">        util.move(file.path, full_path, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
            log.debug(<span class="hljs-string">"Done with a move"</span>);
            <span class="hljs-keyword">if</span> (err) {
                answer = {
                    status:<span class="hljs-string">"error"</span>,
                    message:<span class="hljs-string">"failed to move the app from temporary folder to app installation folder"</span>
                }; 
                <span class="hljs-keyword">return</span> res.json(answer);
                <span class="hljs-comment">//throw err; </span>
            }
            log.debug(<span class="hljs-string">"No error."</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>delete the temporary file, so that the temporary upload dir does not get filled with unwanted files</p></div></div><div class="code"><div class="wrapper">            fs.unlink(file.path, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
                <span class="hljs-keyword">if</span> (err) {
                    log.warn(<span class="hljs-string">"failed to remove the app from temporary folder: "</span> + err);
                }
            }); <span class="hljs-comment">// unlink</span>
            
            dashboard.loadApp(full_path, {}, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
                <span class="hljs-keyword">var</span> answer;
                <span class="hljs-keyword">if</span>(err) {
                    answer = {
                        status: <span class="hljs-string">"error"</span>,
                        data : {<span class="hljs-string">"app"</span> : err}
                    };
                } <span class="hljs-keyword">else</span> {
                    answer = {
                        status: <span class="hljs-string">"success"</span>,
                        data : {<span class="hljs-string">"app"</span> : data}
                    };
                }
                res.json(answer);
            });

        }); <span class="hljs-comment">// move</span>
    } <span class="hljs-comment">// if file and allowed</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (file){
        answer = {
            status:<span class="hljs-string">"fail"</span>,
            data : {<span class="hljs-string">"app"</span> : <span class="hljs-string">"Wrong file format for app upload."</span>}
        };
        res.json(answer);
    }
    <span class="hljs-keyword">else</span>{
        answer = {
            status:<span class="hljs-string">"fail"</span>,
            data : {<span class="hljs-string">"job"</span> : <span class="hljs-string">"Problem receiving the app : bad request."</span>}
        };
        res.json(answer);
    }
}; <span class="hljs-comment">// submitJob</span>


<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">server</span>) </span>{
    server.post(<span class="hljs-string">'/apps'</span>, submitApp);
    server.get(<span class="hljs-string">'/apps'</span>, getApps);
    server.get(<span class="hljs-string">'/apps/:id'</span>, getAppInfo);
    server.del(<span class="hljs-string">'/apps/:id'</span>, deleteApp);
    server.get(<span class="hljs-string">'/apps/:id/files'</span>, listAppFiles);
    server.get(<span class="hljs-regexp">/\/approot\/?.*/</span>, restify.serveStatic({
        directory: config.getDataDir(<span class="hljs-string">'approot'</span>),
    }));
};</div></div></div></div></body></html>