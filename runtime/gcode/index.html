<!DOCTYPE html><html lang="en"><head><title>runtime/gcode/index</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../"><meta name="groc-document-path" content="runtime/gcode/index"><meta name="groc-project-path" content="runtime/gcode/index.js"><meta name="groc-github-url" content="https://github.com/FabMo/FabMo-Engine.git"><link rel="stylesheet" type="text/css" media="all" href="../../assets/style.css"><script type="text/javascript" src="../../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/FabMo/FabMo-Engine.git/blob/master/runtime/gcode/index.js">runtime/gcode/index.js</a></div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">var</span> log = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../../log'</span>).logger(<span class="hljs-string">'gcode'</span>);
<span class="hljs-keyword">var</span> config = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../../config'</span>);
<span class="hljs-keyword">var</span> countLineNumbers = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../../util'</span>).countLineNumbers


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">GCodeRuntime</span>(<span class="hljs-params"></span>) </span>{
	<span class="hljs-keyword">this</span>.machine = <span class="hljs-literal">null</span>;
	<span class="hljs-keyword">this</span>.driver = <span class="hljs-literal">null</span>;
	<span class="hljs-keyword">this</span>.ok_to_disconnect = <span class="hljs-literal">true</span>;
	<span class="hljs-keyword">this</span>.completeCallback = <span class="hljs-literal">null</span>;
}

GCodeRuntime.prototype.toString = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
	<span class="hljs-keyword">return</span> <span class="hljs-string">"[GCodeRuntime]"</span>;
}
<span class="hljs-comment">//Check if move requires auth</span>
GCodeRuntime.prototype.needsAuth = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">s</span>) </span>{
	<span class="hljs-comment">//all needs auth (check) so just return true</span>
	<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
GCodeRuntime.prototype.connect = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">machine</span>) </span>{
	<span class="hljs-keyword">this</span>.machine = machine;
	<span class="hljs-keyword">this</span>.driver = machine.driver;
	<span class="hljs-keyword">this</span>.status_handler =  <span class="hljs-keyword">this</span>._onDriverStatus.bind(<span class="hljs-keyword">this</span>);
	<span class="hljs-keyword">this</span>.status_report = {};
	<span class="hljs-keyword">this</span>.driver.on(<span class="hljs-string">'status'</span>,<span class="hljs-keyword">this</span>.status_handler);
	log.info(<span class="hljs-string">"Connected G-Code Runtime"</span>);
};

GCodeRuntime.prototype.disconnect = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
	<span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.ok_to_disconnect) {
		<span class="hljs-keyword">this</span>.driver.removeListener(<span class="hljs-string">'status'</span>, <span class="hljs-keyword">this</span>.status_handler);
		log.info(<span class="hljs-string">"Disconnected G-Code Runtime"</span>);
	} <span class="hljs-keyword">else</span> {
		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Cannot disconnect GCode Runtime"</span>)
	}
};

GCodeRuntime.prototype.pause = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
	<span class="hljs-keyword">this</span>.driver.feedHold();
}

GCodeRuntime.prototype.quit = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
	<span class="hljs-keyword">this</span>.driver.quit();
}

GCodeRuntime.prototype.resume = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
	<span class="hljs-keyword">this</span>.driver.resume();
}

GCodeRuntime.prototype._changeState = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">newstate</span>) </span>{
	log.debug(<span class="hljs-string">"Changing state to "</span> + newstate)
	<span class="hljs-keyword">if</span>(newstate != <span class="hljs-string">"idle"</span>) {
		<span class="hljs-keyword">this</span>.ok_to_disconnect = <span class="hljs-literal">false</span>;
	}
	<span class="hljs-keyword">this</span>.machine.setState(<span class="hljs-keyword">this</span>, newstate);
};

GCodeRuntime.prototype._limit = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
	<span class="hljs-keyword">var</span> er = <span class="hljs-keyword">this</span>.driver.getLastException();
	<span class="hljs-keyword">if</span>(er &amp;&amp; er.st == <span class="hljs-number">203</span>) {
		<span class="hljs-keyword">var</span> msg = er.msg.replace(<span class="hljs-regexp">/\[[^\[\]]*\]/</span>,<span class="hljs-string">''</span>);
		<span class="hljs-keyword">this</span>.driver.clearLastException();
		<span class="hljs-keyword">this</span>._fail(msg);
		<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
	}
	<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}

GCodeRuntime.prototype._onDriverStatus = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">status</span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Update the machine copy of g2 status variables</p></div></div><div class="code"><div class="wrapper">	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.machine.status) {
		<span class="hljs-keyword">if</span>(key <span class="hljs-keyword">in</span> status) {
			<span class="hljs-keyword">this</span>.machine.status[key] = status[key];
		}
	}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Update the machine copy of g2 status variables</p></div></div><div class="code"><div class="wrapper">	<span class="hljs-keyword">for</span> (key <span class="hljs-keyword">in</span> status) {
		<span class="hljs-keyword">this</span>.status_report[key] = status[key];
	}

	<span class="hljs-keyword">this</span>.machine.emit(<span class="hljs-string">'status'</span>,<span class="hljs-keyword">this</span>.machine.status);
};


GCodeRuntime.prototype._die = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
	<span class="hljs-keyword">this</span>.machine.status.current_file = <span class="hljs-literal">null</span>;
	<span class="hljs-keyword">this</span>.machine.status.line=<span class="hljs-literal">null</span>;
	<span class="hljs-keyword">this</span>.machine.status.nb_lines=<span class="hljs-literal">null</span>;
 	<span class="hljs-keyword">try</span> {
 		<span class="hljs-keyword">this</span>.machine.status.job.fail();
 	} <span class="hljs-keyword">catch</span>(e) {}
 	<span class="hljs-keyword">finally</span> {
		<span class="hljs-keyword">this</span>.machine.status.job=<span class="hljs-literal">null</span>;
 		<span class="hljs-keyword">this</span>.machine.setState(<span class="hljs-keyword">this</span>, <span class="hljs-string">'dead'</span>, {error : <span class="hljs-string">'A G2 exception has occurred. You must reboot your tool.'</span>});
 	}
}

GCodeRuntime.prototype._fail = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">message</span>) </span>{
	<span class="hljs-keyword">this</span>.machine.status.current_file = <span class="hljs-literal">null</span>;
	<span class="hljs-keyword">this</span>.machine.status.line=<span class="hljs-literal">null</span>;
	<span class="hljs-keyword">this</span>.machine.status.nb_lines=<span class="hljs-literal">null</span>;
 	<span class="hljs-keyword">try</span> {
 		<span class="hljs-keyword">this</span>.machine.status.job.fail();
 	} <span class="hljs-keyword">catch</span>(e) {}
 	<span class="hljs-keyword">finally</span> {
		<span class="hljs-keyword">this</span>.machine.status.job=<span class="hljs-literal">null</span>;
 		<span class="hljs-keyword">this</span>.machine.setState(<span class="hljs-keyword">this</span>, <span class="hljs-string">'stopped'</span>, {error : message});
 	}
}

GCodeRuntime.prototype._idle = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
	<span class="hljs-keyword">this</span>.machine.status.current_file = <span class="hljs-literal">null</span>;
	<span class="hljs-keyword">this</span>.machine.status.line=<span class="hljs-literal">null</span>;
	<span class="hljs-keyword">this</span>.machine.status.nb_lines=<span class="hljs-literal">null</span>;
	<span class="hljs-keyword">var</span> job = <span class="hljs-keyword">this</span>.machine.status.job;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Set the machine state to idle and return the units to their default configuration</p></div></div><div class="code"><div class="wrapper">	<span class="hljs-keyword">var</span> finishUp = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
		<span class="hljs-keyword">this</span>.driver.setUnits(config.machine.get(<span class="hljs-string">'units'</span>), <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
			<span class="hljs-keyword">var</span> callback = <span class="hljs-keyword">this</span>.completeCallback || <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{};
			<span class="hljs-keyword">this</span>.ok_to_disconnect = <span class="hljs-literal">true</span>;
			<span class="hljs-keyword">this</span>.completeCallback = <span class="hljs-literal">null</span>;
			<span class="hljs-keyword">this</span>.machine.setState(<span class="hljs-keyword">this</span>, <span class="hljs-string">'idle'</span>);
			callback();
		}.bind(<span class="hljs-keyword">this</span>))
	}.bind(<span class="hljs-keyword">this</span>);

	<span class="hljs-keyword">if</span>(job) {
		<span class="hljs-keyword">if</span>(job.pending_cancel) {
			<span class="hljs-keyword">this</span>.machine.status.job.cancel(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, job</span>) </span>{
				<span class="hljs-keyword">this</span>.machine.status.job=<span class="hljs-literal">null</span>;
				finishUp();
			}.bind(<span class="hljs-keyword">this</span>));
		} <span class="hljs-keyword">else</span> {
			<span class="hljs-keyword">this</span>.machine.status.job.finish(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, job</span>) </span>{
				<span class="hljs-keyword">this</span>.machine.status.job=<span class="hljs-literal">null</span>;
				finishUp();
			}.bind(<span class="hljs-keyword">this</span>));
		}
	} <span class="hljs-keyword">else</span> {
		finishUp();
	}
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Run the provided string
callback runs only when execution is complete.</p></div></div><div class="code"><div class="wrapper">GCodeRuntime.prototype.runString = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">string, callback</span>) </span>{
	<span class="hljs-keyword">if</span>(callback) { log.error(<span class="hljs-string">"CALLBACK PASSED TO RUNSTRING"</span>)}

	<span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.machine.status.state === <span class="hljs-string">'idle'</span> || <span class="hljs-keyword">this</span>.machine.status.state === <span class="hljs-string">'armed'</span>) {
		<span class="hljs-keyword">var</span> lines =  string.split(<span class="hljs-string">'\n'</span>);
		<span class="hljs-keyword">var</span> mode = config.driver.get(<span class="hljs-string">'gdi'</span>) ? <span class="hljs-string">'G91'</span>: <span class="hljs-string">'G90'</span>;
		<span class="hljs-keyword">this</span>.machine.status.nb_lines = lines.length;
		<span class="hljs-keyword">for</span> (i=<span class="hljs-number">0</span>;i&lt;lines.length;i++){
			<span class="hljs-keyword">if</span> (lines[i][<span class="hljs-number">0</span>]!==<span class="hljs-literal">undefined</span> &amp;&amp; lines[i][<span class="hljs-number">0</span>].toUpperCase() !== <span class="hljs-string">'N'</span> ){
				lines[i]= <span class="hljs-string">'N'</span>+ (i+<span class="hljs-number">1</span>) + lines[i];
			}
		}
		lines.unshift(mode);
		<span class="hljs-keyword">this</span>.completeCallback = callback;
		<span class="hljs-keyword">this</span>._changeState(<span class="hljs-string">"running"</span>);
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.driver.runList(lines)
		.on(<span class="hljs-string">'stat'</span>, <span class="hljs-keyword">this</span>._handleStateChange.bind(<span class="hljs-keyword">this</span>))
		.then(<span class="hljs-keyword">this</span>._handleStop.bind(<span class="hljs-keyword">this</span>));
	}
};

GCodeRuntime.prototype._handleStop = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
	<span class="hljs-keyword">this</span>._idle();
}

GCodeRuntime.prototype._handleStateChange = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">stat</span>) </span>{
	<span class="hljs-keyword">switch</span>(stat) {
		<span class="hljs-keyword">case</span> <span class="hljs-keyword">this</span>.driver.STAT_HOLDING:
			<span class="hljs-keyword">this</span>._changeState(<span class="hljs-string">'paused'</span>);
			<span class="hljs-keyword">break</span>;
		<span class="hljs-keyword">case</span> <span class="hljs-keyword">this</span>.driver.STAT_RUNNING:
			<span class="hljs-keyword">this</span>._changeState(<span class="hljs-string">'running'</span>);
			<span class="hljs-keyword">break</span>;
		<span class="hljs-keyword">default</span>:
			<span class="hljs-keyword">break</span>;
	}
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Run a file given the filename</p></div></div><div class="code"><div class="wrapper">GCodeRuntime.prototype.runFile = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">filename, callback</span>) </span>{
	countLineNumbers(filename, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, lines</span>) </span>{
		<span class="hljs-keyword">this</span>.machine.status.nb_lines = lines;
		<span class="hljs-keyword">this</span>.driver.runFile(filename, callback)
			.on(<span class="hljs-string">'stat'</span>, <span class="hljs-keyword">this</span>._handleStateChange.bind(<span class="hljs-keyword">this</span>))
			.then(<span class="hljs-keyword">this</span>._handleStop.bind(<span class="hljs-keyword">this</span>));
	}.bind(<span class="hljs-keyword">this</span>));
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Run the given string as gcode</p></div></div><div class="code"><div class="wrapper">GCodeRuntime.prototype.executeCode = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">string, callback</span>) </span>{
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.runString(string);
}

exports.GCodeRuntime = GCodeRuntime;</div></div></div></div></body></html>