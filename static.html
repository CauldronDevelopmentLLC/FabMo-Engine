<!DOCTYPE html><html lang="en"><head><title>static</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="static"><meta name="groc-project-path" content="static.js"><meta name="groc-github-url" content="https://github.com/FabMo/FabMo-Engine.git"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/FabMo/FabMo-Engine.git/blob/master/static.js">static.js</a></div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><p>Copyright 2012 Mark Cavage, Inc.  All rights reserved.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-pi">
'use strict'</span>;

<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">var</span> escapeRE = <span class="hljs-built_in">require</span>(<span class="hljs-string">'escape-regexp-component'</span>);

<span class="hljs-keyword">var</span> assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">'assert-plus'</span>);
<span class="hljs-keyword">var</span> mime = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mime'</span>);
<span class="hljs-keyword">var</span> errors = <span class="hljs-built_in">require</span>(<span class="hljs-string">'restify-errors'</span>);
<span class="hljs-keyword">var</span> config = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./config'</span>);



<span class="hljs-comment">///--- Globals</span>

<span class="hljs-keyword">var</span> MethodNotAllowedError = errors.MethodNotAllowedError;
<span class="hljs-keyword">var</span> NotAuthorizedError = errors.NotAuthorizedError;
<span class="hljs-keyword">var</span> ResourceNotFoundError = errors.ResourceNotFoundError;


<span class="hljs-comment">///--- Functions</span></div></div></div><div class="segment"><div class="comments doc-section doc-section-public"><div class="wrapper"><p><span class='doc-section-header'>Public function serveStatic</span></p>
<p>serves static files.</p>
<p>Parameters:</p>
<ul>
<li><strong>options must be an Object.</strong><br/>(an options object)</li>
</ul>
<p><strong>Can throw a MethodNotAllowedError  or a  NotAuthorizedError  or a  ResourceNotFoundError</strong><br/><strong>and</strong> <strong>Returns a Function</strong></p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">serveStatic</span>(<span class="hljs-params">options</span>) </span>{
    <span class="hljs-keyword">var</span> opts = options || {};

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> opts.appendRequestPath === <span class="hljs-string">'undefined'</span>) {
        opts.appendRequestPath = <span class="hljs-literal">true</span>;
    }

    assert.object(opts, <span class="hljs-string">'options'</span>);
    assert.string(opts.directory, <span class="hljs-string">'options.directory'</span>);
    assert.optionalNumber(opts.maxAge, <span class="hljs-string">'options.maxAge'</span>);
    assert.optionalObject(opts.match, <span class="hljs-string">'options.match'</span>);
    assert.optionalString(opts.charSet, <span class="hljs-string">'options.charSet'</span>);
    assert.optionalString(opts.file, <span class="hljs-string">'options.file'</span>);
    assert.bool(opts.appendRequestPath, <span class="hljs-string">'options.appendRequestPath'</span>);

    <span class="hljs-keyword">var</span> p = path.normalize(opts.directory).replace(<span class="hljs-regexp">/\\/g</span>, <span class="hljs-string">'/'</span>);
    <span class="hljs-keyword">var</span> re = <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(<span class="hljs-string">'^'</span> + escapeRE(p) + <span class="hljs-string">'/?.*'</span>);

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">serveFileFromStats</span>(<span class="hljs-params">file, err, stats, isGzip, req, res, next</span>) </span>{

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> req.connectionState === <span class="hljs-string">'function'</span> &amp;&amp;
            (req.connectionState() === <span class="hljs-string">'close'</span> ||
            req.connectionState() === <span class="hljs-string">'aborted'</span>)) {
            next(<span class="hljs-literal">false</span>);
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">if</span> (err) {
            next(<span class="hljs-keyword">new</span> ResourceNotFoundError(err, <span class="hljs-string">'%s'</span>, req.path()));
            <span class="hljs-keyword">return</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!stats.isFile()) {
            next(<span class="hljs-keyword">new</span> ResourceNotFoundError(<span class="hljs-string">'%s does not exist'</span>, req.path()));
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">if</span> (res.handledGzip &amp;&amp; isGzip) {
            res.handledGzip();
        }

        <span class="hljs-keyword">var</span> fstream = fs.createReadStream(file + (isGzip ? <span class="hljs-string">'.gz'</span> : <span class="hljs-string">''</span>));
        <span class="hljs-keyword">var</span> maxAge = opts.maxAge === <span class="hljs-literal">undefined</span> ? <span class="hljs-number">3600</span> : opts.maxAge;
        fstream.once(<span class="hljs-string">'open'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">fd</span>) </span>{
            res.cache({maxAge: maxAge});
            res.set(<span class="hljs-string">'Content-Length'</span>, stats.size);
            res.set(<span class="hljs-string">'Content-Type'</span>, mime.lookup(file));
            res.set(<span class="hljs-string">'Last-Modified'</span>, stats.mtime);

            <span class="hljs-keyword">if</span> (opts.charSet) {
                <span class="hljs-keyword">var</span> type = res.getHeader(<span class="hljs-string">'Content-Type'</span>) +
                    <span class="hljs-string">'; charset='</span> + opts.charSet;
                res.setHeader(<span class="hljs-string">'Content-Type'</span>, type);
            }

            <span class="hljs-keyword">if</span> (opts.etag) {
                res.set(<span class="hljs-string">'ETag'</span>, opts.etag(stats, opts));
            }
            res.writeHead(<span class="hljs-number">200</span>);
            fstream.pipe(res);
            fstream.once(<span class="hljs-string">'close'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                next(<span class="hljs-literal">false</span>);
            });
        });

        res.once(<span class="hljs-string">'close'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            fstream.close();
        });
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">serveNormal</span>(<span class="hljs-params">file, req, res, next</span>) </span>{
        fs.stat(file, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, stats</span>) </span>{
            <span class="hljs-keyword">if</span> (!err &amp;&amp; stats.isDirectory() &amp;&amp; opts.default) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Serve an index.html page or similar</p></div></div><div class="code"><div class="wrapper">                <span class="hljs-keyword">var</span> filePath = path.join(file, opts.default);
                fs.stat(filePath, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">dirErr, dirStats</span>) </span>{
                    serveFileFromStats(filePath,
                        dirErr,
                        dirStats,
                        <span class="hljs-literal">false</span>,
                        req,
                        res,
                        next);
                });
            } <span class="hljs-keyword">else</span> {
                serveFileFromStats(file,
                    err,
                    stats,
                    <span class="hljs-literal">false</span>,
                    req,
                    res,
                    next);
            }
        });
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">serve</span>(<span class="hljs-params">req, res, next</span>) </span>{
        <span class="hljs-keyword">var</span> file;
        <span class="hljs-keyword">var</span> path_arr = req.path().split(<span class="hljs-string">'/'</span>)

        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; path_arr.length; i++){
            <span class="hljs-keyword">if</span>(path_arr[i] === config.engine.get(<span class="hljs-string">'version'</span>)) {
                path_arr.splice(i, <span class="hljs-number">1</span>);
            }
        }

        <span class="hljs-keyword">if</span> (path_arr.length &gt; <span class="hljs-number">1</span>) {
            <span class="hljs-keyword">var</span> newPath = path_arr.join(<span class="hljs-string">'/'</span>);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">var</span> newPath = <span class="hljs-string">'/'</span>;
        }
       
        req.url = newPath;

        <span class="hljs-keyword">if</span> (opts.file) {
            <span class="hljs-comment">//serves a direct file</span>
            file = path.join(opts.directory,
                <span class="hljs-built_in">decodeURIComponent</span>(opts.file));
        } <span class="hljs-keyword">else</span> {

            <span class="hljs-keyword">if</span> (opts.appendRequestPath) {
                file = path.join(opts.directory,
                    <span class="hljs-built_in">decodeURIComponent</span>(req.path()));
            }
            <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">var</span> dirBasename = path.basename(opts.directory);
                <span class="hljs-keyword">var</span> reqpathBasename = path.basename(req.path());

                <span class="hljs-keyword">if</span> (path.extname(req.path()) === <span class="hljs-string">''</span> &amp;&amp;
                    dirBasename === reqpathBasename) {
     
                    file = opts.directory;
                }
                <span class="hljs-keyword">else</span> {
                    file = path.join(opts.directory,
                        <span class="hljs-built_in">decodeURIComponent</span>(path.basename(req.path())));
                }
            }
        }

        <span class="hljs-keyword">if</span> (req.method !== <span class="hljs-string">'GET'</span> &amp;&amp; req.method !== <span class="hljs-string">'HEAD'</span>) {
            next(<span class="hljs-keyword">new</span> MethodNotAllowedError(req.method));
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">if</span> (!re.test(file.replace(<span class="hljs-regexp">/\\/g</span>, <span class="hljs-string">'/'</span>))) {
            next(<span class="hljs-keyword">new</span> NotAuthorizedError(<span class="hljs-string">'%s'</span>, req.path()));
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">if</span> (opts.match &amp;&amp; !opts.match.test(file)) {
            next(<span class="hljs-keyword">new</span> NotAuthorizedError(<span class="hljs-string">'%s'</span>, req.path()));
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">if</span> (opts.gzip &amp;&amp; req.acceptsEncoding(<span class="hljs-string">'gzip'</span>)) {
            fs.stat(file + <span class="hljs-string">'.gz'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, stats</span>) </span>{
                <span class="hljs-keyword">if</span> (!err) {
                    res.setHeader(<span class="hljs-string">'Content-Encoding'</span>, <span class="hljs-string">'gzip'</span>);
                    serveFileFromStats(file,
                        err,
                        stats,
                        <span class="hljs-literal">true</span>,
                        req,
                        res,
                        next);
                } <span class="hljs-keyword">else</span> {
                    serveNormal(file, req, res, next);
                }
            });
        } <span class="hljs-keyword">else</span> {
            serveNormal(file, req, res, next);
        }

    }

    <span class="hljs-keyword">return</span> (serve);
}

<span class="hljs-built_in">module</span>.exports = serveStatic;</div></div></div></div></body></html>