<!DOCTYPE html><html lang="en"><head><title>scripts/convert_sb3</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="scripts/convert_sb3"><meta name="groc-project-path" content="scripts/convert_sb3.js"><meta name="groc-github-url" content="https://github.com/FabMo/FabMo-Engine.git"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/FabMo/FabMo-Engine.git/blob/master/scripts/convert_sb3.js">scripts/convert_sb3.js</a></div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> csv = <span class="hljs-built_in">require</span>(<span class="hljs-string">'csv'</span>);  <span class="hljs-comment">// Requires this at 0.3.7: npm install csv@0.3.7</span>
<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);

prm = fs.readFileSync(<span class="hljs-string">'../data/shopbotw.prm'</span>,<span class="hljs-string">'utf8'</span>);
cmd = fs.readFileSync(<span class="hljs-string">'../data/shopbotw.cmd'</span>,<span class="hljs-string">'utf8'</span>);

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">scrubName</span>(<span class="hljs-params">name</span>) </span>{
	name = name.replace(<span class="hljs-regexp">/\[\&amp;([A-Za-z0-9#])\]/</span>, <span class="hljs-string">'$1'</span>); <span class="hljs-comment">// Normalize [&amp;H]otkeys</span>
	name = name.replace(<span class="hljs-regexp">/\s*\*\s*/</span>, <span class="hljs-string">''</span>);              <span class="hljs-comment">// Remove astrixes</span>
	<span class="hljs-keyword">return</span> name;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseDefault</span>(<span class="hljs-params">dflt</span>) </span>{
	parts = dflt.split(<span class="hljs-regexp">/[-=](?![0-9])/</span>);
	<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(parts[<span class="hljs-number">0</span>].trim(), parts[<span class="hljs-number">1</span>].trim());
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Deal with commands </p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> commands = {};

<span class="hljs-keyword">var</span> cmd_done = <span class="hljs-literal">false</span>;
row_count = <span class="hljs-number">0</span>;
csv().from.string(cmd).on(<span class="hljs-string">'record'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">record, idx</span>) </span>{
	<span class="hljs-keyword">if</span>(row_count &lt; <span class="hljs-number">9</span>) {
		row_count += <span class="hljs-number">1</span>;
		<span class="hljs-keyword">return</span>;
	}
	row_count += <span class="hljs-number">1</span>;

	cmd = record[<span class="hljs-number">0</span>];
	fullname = record[<span class="hljs-number">1</span>];
	order = record[<span class="hljs-number">2</span>];
	nparam = record[<span class="hljs-number">3</span>];
	line = record[<span class="hljs-number">4</span>];
	type = record[<span class="hljs-number">5</span>];
	disptype = record[<span class="hljs-number">6</span>];
	dispset = record[<span class="hljs-number">7</span>];
	lastcur = record[<span class="hljs-number">8</span>];

	command = {};
	command.cmd = cmd;
	command.name = scrubName(fullname);

	<span class="hljs-keyword">if</span>(command.name != <span class="hljs-string">"&lt;seperator&gt;"</span> &amp;&amp; cmd != <span class="hljs-string">'H5'</span>) {
		commands[cmd] = command;
	}
}).on(<span class="hljs-string">'end'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">count</span>) </span>{
	<span class="hljs-keyword">var</span>	row_count = <span class="hljs-number">0</span>;
	<span class="hljs-keyword">var</span> param_list = [];
	<span class="hljs-keyword">var</span> prm_done = <span class="hljs-literal">false</span>;
	<span class="hljs-keyword">var</span> params = {};
	<span class="hljs-keyword">var</span> current_cmd = <span class="hljs-literal">null</span>;
	<span class="hljs-keyword">var</span> current_param = {};

	csv().from.string(prm).on(<span class="hljs-string">'record'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">record, idx</span>) </span>{
		<span class="hljs-keyword">if</span>(row_count &lt; <span class="hljs-number">2</span>) {
			row_count += <span class="hljs-number">1</span>;
			<span class="hljs-keyword">return</span>;
		}
		row_count += <span class="hljs-number">1</span>;

		<span class="hljs-keyword">if</span>(record[<span class="hljs-number">0</span>] !== <span class="hljs-string">''</span>){
			<span class="hljs-keyword">if</span>(current_cmd !== <span class="hljs-literal">null</span>) {
				commands[current_cmd].params = param_list;
			}
			current_cmd = record[<span class="hljs-number">1</span>];
			nparams = <span class="hljs-built_in">parseInt</span>(record[<span class="hljs-number">0</span>]);
			param_list = [];
		}
		current_param.type = record[<span class="hljs-number">7</span>];
		<span class="hljs-keyword">switch</span>(current_param.type) {
			<span class="hljs-keyword">case</span> <span class="hljs-string">'ops'</span>:
			<span class="hljs-keyword">case</span> <span class="hljs-string">'opt'</span>:
			<span class="hljs-keyword">case</span> <span class="hljs-string">'ck'</span>:
				<span class="hljs-keyword">if</span>(record[<span class="hljs-number">6</span>] === <span class="hljs-string">''</span>) {
					df = parseDefault(record[<span class="hljs-number">10</span>]);
					opt = {};
					opt.value = df[<span class="hljs-number">0</span>];
					opt.desc = df[<span class="hljs-number">1</span>];
					current_param.opts.push({<span class="hljs-string">'value'</span>:df[<span class="hljs-number">0</span>], <span class="hljs-string">'desc'</span>:df[<span class="hljs-number">1</span>]});
				} <span class="hljs-keyword">else</span> {
					current_param = {};
					current_param.name = record[<span class="hljs-number">4</span>];
					current_param.desc = record[<span class="hljs-number">5</span>];
					current_param.abrev = record[<span class="hljs-number">6</span>];
					current_param.typeext = <span class="hljs-built_in">parseInt</span>(record[<span class="hljs-number">8</span>]);
					df = parseDefault(record[<span class="hljs-number">10</span>]);
					current_param.default = df[<span class="hljs-number">0</span>];
					current_param.default_desc = df[<span class="hljs-number">1</span>];
					current_param.opts = [];
					param_list.push(current_param);
					current_param.sysvar = record[<span class="hljs-number">13</span>];
				}

			<span class="hljs-keyword">break</span>;

			<span class="hljs-keyword">case</span> <span class="hljs-string">'sep'</span>:
			<span class="hljs-keyword">case</span> <span class="hljs-string">'rel'</span>:
			<span class="hljs-keyword">break</span>;
			
			<span class="hljs-keyword">default</span>:
				current_param = {};
				current_param.name = record[<span class="hljs-number">4</span>];
				current_param.desc = record[<span class="hljs-number">5</span>];
				current_param.abrev = record[<span class="hljs-number">6</span>];
				current_param.typeext = <span class="hljs-built_in">parseInt</span>(record[<span class="hljs-number">8</span>]);
				current_param.default = record[<span class="hljs-number">10</span>];
				lo = record[<span class="hljs-number">11</span>] || <span class="hljs-literal">null</span>;
				hi = record[<span class="hljs-number">12</span>] || <span class="hljs-literal">null</span>;
				current_param.sysvar = <span class="hljs-built_in">parseInt</span>(record[<span class="hljs-number">13</span>]);
				current_param.range = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(lo,hi);
				param_list.push(current_param);

			<span class="hljs-keyword">break</span>;		
		}

	}).on(<span class="hljs-string">'end'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">count</span>) </span>{
		fs.writeFile(<span class="hljs-string">"../data/sb3_commands.json"</span>,<span class="hljs-built_in">JSON</span>.stringify(commands, <span class="hljs-literal">null</span>, <span class="hljs-number">3</span>));
	});
});</div></div></div></div></body></html>