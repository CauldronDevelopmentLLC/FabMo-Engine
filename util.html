<!DOCTYPE html><html lang="en"><head><title>util</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="util"><meta name="groc-project-path" content="util.js"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path">util.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">var</span> log = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./log'</span>).logger(<span class="hljs-string">'util'</span>);
<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">var</span> q = <span class="hljs-built_in">require</span>(<span class="hljs-string">'q'</span>);

<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">var</span> escapeRE = <span class="hljs-built_in">require</span>(<span class="hljs-string">'escape-regexp-component'</span>);

<span class="hljs-keyword">var</span> mime = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mime'</span>);
<span class="hljs-keyword">var</span> restify = <span class="hljs-built_in">require</span>(<span class="hljs-string">'restify'</span>);
<span class="hljs-keyword">var</span> errors = restify.errors;

<span class="hljs-keyword">var</span> MethodNotAllowedError = errors.MethodNotAllowedError;
<span class="hljs-keyword">var</span> NotAuthorizedError = errors.NotAuthorizedError;
<span class="hljs-keyword">var</span> ResourceNotFoundError = errors.ResourceNotFoundError;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">listify</span><span class="hljs-params">(x)</span> {</span>
    <span class="hljs-keyword">if</span>(x <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Array</span>) {
        <span class="hljs-keyword">return</span> x;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> [x];
    }
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Simple queue, faster than using array.shift</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Queue</span><span class="hljs-params">()</span>{</span>

  <span class="hljs-keyword">var</span> queue  = [];
  <span class="hljs-keyword">var</span> offset = <span class="hljs-number">0</span>;

  <span class="hljs-keyword">this</span>.getLength = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span> <span class="hljs-keyword">return</span> (queue.length - offset); }
  <span class="hljs-keyword">this</span>.getContents = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span> <span class="hljs-keyword">return</span> queue; }
  <span class="hljs-keyword">this</span>.isEmpty = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span> <span class="hljs-keyword">return</span> (queue.length == <span class="hljs-number">0</span>); }
  <span class="hljs-keyword">this</span>.enqueue = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(item)</span>{</span> queue.push(item); }
  <span class="hljs-keyword">this</span>.dequeue = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>if the queue is empty, return immediately</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (queue.length == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>store the item at the front of the queue</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">var</span> item = queue[offset];</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>increment the offset and remove the free space if necessary</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (++ offset * <span class="hljs-number">2</span> &gt;= queue.length){
      queue  = queue.slice(offset);
      offset = <span class="hljs-number">0</span>;
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>return the dequeued item</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">return</span> item;

  }
  <span class="hljs-keyword">this</span>.peek = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    <span class="hljs-keyword">return</span> (queue.length &gt; <span class="hljs-number">0</span> ? queue[offset] : <span class="hljs-literal">undefined</span>);
  }
  <span class="hljs-keyword">this</span>.clear = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
	queue = [];
	offset = <span class="hljs-number">0</span>;
	}
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><em>TODO:</em> This is defined in two places, we should fix that.</p></div></div><div class="code"><div class="wrapper">ALLOWED_EXTENSIONS = [<span class="hljs-string">'.nc'</span>,<span class="hljs-string">'.g'</span>,<span class="hljs-string">'.sbp'</span>,<span class="hljs-string">'.gc'</span>,<span class="hljs-string">'.gcode'</span>];

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">allowed_file</span><span class="hljs-params">(filename)</span>{</span>
  <span class="hljs-keyword">if</span> (ALLOWED_EXTENSIONS.indexOf(path.extname(filename).toLowerCase()) !== -<span class="hljs-number">1</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
  <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Move a file from src to dest, avoiding cross-device rename failures.
This method will first try fs.rename and call the supplied callback if it succeeds. Otherwise
it will pump the conent of src into dest and unlink src upon completion.</p>
<p>This might take a little more time than a single fs.rename, but it avoids error when
trying to rename files from one device to the other.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> move = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(src, dest, cb)</span> {</span>
	<span class="hljs-keyword">var</span> renameDeferred = q.defer();
 
	fs.rename(src, dest, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> {</span>
		<span class="hljs-keyword">if</span> (err) {
			renameDeferred.reject(err);
		}
		<span class="hljs-keyword">else</span> {
			renameDeferred.resolve();
		}
	});
 
	renameDeferred.promise.then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>rename worked</p></div></div><div class="code"><div class="wrapper">		<span class="hljs-keyword">return</span> cb(<span class="hljs-literal">null</span>);
	}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> {</span>
 
		log.warn(<span class="hljs-string">'io.move: standard rename failed, trying stream pipe... ('</span> + err + <span class="hljs-string">')'</span>);
 </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>rename didn&#39;t work, try pumping</p></div></div><div class="code"><div class="wrapper">		<span class="hljs-keyword">var</span> is = fs.createReadStream(src),
			os = fs.createWriteStream(dest);
 
		is.pipe(os);
 
		is.on(<span class="hljs-string">'end'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
			fs.unlinkSync(src);
			cb(<span class="hljs-literal">null</span>);
		});
 
		is.on(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> {</span>
			<span class="hljs-keyword">return</span> cb(err);
		});
 
		os.on(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> {</span>
			<span class="hljs-keyword">return</span> cb(err);
		})
	});
};

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">serveStatic</span><span class="hljs-params">(opts)</span> {</span>
    opts = opts || {};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>assert.object(opts, &#39;options&#39;);
assert.string(opts.directory, &#39;options.directory&#39;);
assert.optionalNumber(opts.maxAge, &#39;options.maxAge&#39;);
assert.optionalObject(opts.match, &#39;options.match&#39;);
assert.optionalString(opts.charSet, &#39;options.charSet&#39;);</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">var</span> p = path.normalize(opts.directory).replace(<span class="hljs-regexp">/\\/g</span>, <span class="hljs-string">'/'</span>);
    <span class="hljs-keyword">var</span> re = <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(<span class="hljs-string">'^'</span> + escapeRE(p) + <span class="hljs-string">'/?.*'</span>);

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">serveFileFromStats</span><span class="hljs-params">(file, err, stats, isGzip, req, res, next)</span> {</span>
        <span class="hljs-keyword">if</span> (err) {
            next(<span class="hljs-keyword">new</span> ResourceNotFoundError(err,
                req.path()));
            <span class="hljs-keyword">return</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!stats.isFile()) {
            next(<span class="hljs-keyword">new</span> ResourceNotFoundError(<span class="hljs-string">'%s does not exist'</span>, req.path()));
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">if</span> (res.handledGzip &amp;&amp; isGzip) {
            res.handledGzip();
        }

        <span class="hljs-keyword">var</span> fstream = fs.createReadStream(file + (isGzip ? <span class="hljs-string">'.gz'</span> : <span class="hljs-string">''</span>));
        <span class="hljs-keyword">var</span> maxAge = opts.maxAge === <span class="hljs-literal">undefined</span> ? <span class="hljs-number">3600</span> : opts.maxAge;
        fstream.once(<span class="hljs-string">'open'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fd)</span> {</span>
            res.cache({maxAge: maxAge});
            res.set(<span class="hljs-string">'Content-Length'</span>, stats.size);
            res.set(<span class="hljs-string">'Content-Type'</span>, mime.lookup(file));
            res.set(<span class="hljs-string">'Last-Modified'</span>, stats.mtime);
            <span class="hljs-keyword">if</span> (opts.charSet) {
                <span class="hljs-keyword">var</span> type = res.getHeader(<span class="hljs-string">'Content-Type'</span>) +
                    <span class="hljs-string">'; charset='</span> + opts.charSet;
                res.setHeader(<span class="hljs-string">'Content-Type'</span>, type);
            }
            <span class="hljs-keyword">if</span> (opts.etag) {
                res.set(<span class="hljs-string">'ETag'</span>, opts.etag(stats, opts));
            }
            res.writeHead(<span class="hljs-number">200</span>);
            fstream.pipe(res);
            fstream.once(<span class="hljs-string">'end'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                next(<span class="hljs-literal">false</span>);
            });
        });
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">serveNormal</span><span class="hljs-params">(file, req, res, next)</span> {</span>
        fs.stat(file, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, stats)</span> {</span>
            <span class="hljs-keyword">if</span> (!err &amp;&amp; stats.isDirectory() &amp;&amp; opts.default) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Serve an index.html page or similar</p></div></div><div class="code"><div class="wrapper">                file = path.join(file, opts.default);
                fs.stat(file, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(dirErr, dirStats)</span> {</span>
                    serveFileFromStats(file,
                        dirErr,
                        dirStats,
                        <span class="hljs-literal">false</span>,
                        req,
                        res,
                        next);
                });
            } <span class="hljs-keyword">else</span> {
                serveFileFromStats(file,
                    err,
                    stats,
                    <span class="hljs-literal">false</span>,
                    req,
                    res,
                    next);
            }
        });
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">serve</span><span class="hljs-params">(req, res, next)</span> {</span>
        <span class="hljs-keyword">var</span> uricomp = <span class="hljs-built_in">decodeURIComponent</span>(req.path());
        console.log(<span class="hljs-string">"URI COMPONENT: "</span> + uricomp)
        console.log(<span class="hljs-string">"DIR: "</span> + opts.directory)
        <span class="hljs-keyword">var</span> file = path.join(opts.directory, uricomp);

        <span class="hljs-keyword">if</span> (req.method !== <span class="hljs-string">'GET'</span> &amp;&amp; req.method !== <span class="hljs-string">'HEAD'</span>) {
            next(<span class="hljs-keyword">new</span> MethodNotAllowedError(req.method));
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">if</span> (!re.test(file.replace(<span class="hljs-regexp">/\\/g</span>, <span class="hljs-string">'/'</span>))) {
            next(<span class="hljs-keyword">new</span> NotAuthorizedError(req.path()));
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">if</span> (opts.match &amp;&amp; !opts.match.test(file)) {
            next(<span class="hljs-keyword">new</span> NotAuthorizedError(req.path()));
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">if</span> (opts.gzip &amp;&amp; req.acceptsEncoding(<span class="hljs-string">'gzip'</span>)) {
            fs.stat(file + <span class="hljs-string">'.gz'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, stats)</span> {</span>
                <span class="hljs-keyword">if</span> (!err) {
                    res.setHeader(<span class="hljs-string">'Content-Encoding'</span>, <span class="hljs-string">'gzip'</span>);
                    serveFileFromStats(file,
                        err,
                        stats,
                        <span class="hljs-literal">true</span>,
                        req,
                        res,
                        next);
                } <span class="hljs-keyword">else</span> {
                    serveNormal(file, req, res, next);
                }
            });
        } <span class="hljs-keyword">else</span> {
            serveNormal(file, req, res, next);
        }

    }

    <span class="hljs-keyword">return</span> (serve);
}

<span class="hljs-keyword">var</span> walk = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(dir, obj, done)</span> {</span>
  <span class="hljs-keyword">var</span> results = {};
  fs.readdir(dir, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, list)</span> {</span>

    <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> done(err);

    <span class="hljs-keyword">var</span> pending = list.length;
    <span class="hljs-keyword">if</span> (!pending) <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, obj);

    list.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(file)</span> {</span>
      path = dir + <span class="hljs-string">'/'</span> + file;
      fs.stat(path, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, stat)</span> {</span>
        <span class="hljs-keyword">if</span> (stat &amp;&amp; stat.isDirectory()) {
          dirobject =  {    name: file, 
                            path: path,
                            type: <span class="hljs-string">'dir'</span>,
                            created : stat.ctime, 
                            modified : stat.mtime, 
                            children:[]
                        };
          obj.children.push(dirobject);
          walk(file, dirobject, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, res)</span> {</span>
            <span class="hljs-keyword">if</span> (!--pending) done(<span class="hljs-literal">null</span>, obj);
          });
        } <span class="hljs-keyword">else</span> {
          fileobject =  {   name: file,
                            path: path,
                            type: <span class="hljs-string">'file'</span>,
                            created : stat.ctime, 
                            modified : stat.mtime, 
                            children:<span class="hljs-literal">null</span>
                        };
          obj.children.push(fileobject);
          <span class="hljs-comment">//results.push(file);</span>
          <span class="hljs-keyword">if</span> (!--pending) done(<span class="hljs-literal">null</span>, obj);
        }
      });
    });
  });
};

<span class="hljs-keyword">var</span> walkDir = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(dir, callback)</span> {</span>
    obj = {
        children : [],
        name : <span class="hljs-string">'/'</span>,
        path : <span class="hljs-string">'/'</span>,
        type : <span class="hljs-string">'dir'</span>
    }
    <span class="hljs-keyword">return</span> walk(dir, obj, callback);
}

exports.serveStatic = serveStatic;
exports.Queue = Queue;
exports.allowed_file = allowed_file;
exports.move = move;
exports.walkDir = walkDir;</div></div></div></div></body></html>