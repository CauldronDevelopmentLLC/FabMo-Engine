<html>
  <head>
    <meta charset="utf-8">
    <title>Dashboard login</title>

    <link rel="stylesheet" href="/css/foundation.min.css" />
    <link rel="stylesheet" href="/css/font-awesome.min.css" />
    <script src="/js/libs/jquery.min.js" charset="utf-8"></script>
    <style>
    .error{
      color : red;
      text-align: center;
      background-color: #eeeeee;
    }
    .success{
      color : green;
      text-align: center;
      background-color: #eeeeee;
    }
    .loading{
      color : blue;
      text-align: center;
      background-color: #eeeeee;
    }
    h1{
      color : #444444;
    }
    .login_panel{
      padding: 1em;
    }
    .signup_panel{
      padding: 1em;
    }

    </style>
  </head>
  <body>
  <div class="main">
    <div class="err" id="add_err"></div>
    <div class = "login_panel">
      <div class="login_panel_header"><h1>Log In</h1><hr></div>
      <form id= "login_form" action="/authentication/login" method="post">
        <div>
            <label>Username
              <input type="text" name="username"/>
            </label>
        </div>
        <div>
            <label>Password
              <input type="password" name="password"/>
            </label>
        </div>
        <div>
            <input class="button" type="submit" value="Log In"/>
        </div>
      </form>
      <a class="signup_link" href="#signup">Don't have an account? Sign up !</a>
    </div>
    <div class = "signup_panel hide">
      <div class="signup_panel_header"><h1>Sign Up</h1><hr></div>
      <form id="signup_form" action="/authentication/signup" method="post">
        <div>
            <label>Username
              <input type="text" name="username"/>
            </label>
        </div>
        <div>
            <label>Password
              <input type="password" name="password"/>
            </label>
        </div>
        <div>
            <label>Password Confirmation
              <input type="password" name="password_confirm"/>
            </label>
        </div>
        <div>
            <input  class="button" type="submit" value="Sign up"/>
        </div>
      </form>
      <a class="login_link" href="#login">Already have an account? Sign in !</a>
    </div>
  </div>

  <script type="text/javascript">
    $(document).ready(function(){
      $("#add_err").css('display', 'none', 'important');

      if(getUrlParameter("message")==="kicked-out"){
        $("#add_err").css('display', 'inline', 'important');
        $("#add_err").html('<div class="error"> <i class="fa fa-exclamation-circle" aria-hidden="true"></i><span class="sr-only">You have been kicked out from the tool.</span></div>');
      }else if (getUrlParameter("message")==="not-authenticated") {
        $("#add_err").css('display', 'inline', 'important');
        $("#add_err").html('<div class="error"> <i class="fa fa-exclamation-circle" aria-hidden="true"></i><span class="sr-only"> You need to be authenticated to access this page.</span></div>');

      }


      $("#login_form").submit(function(e){
        e.preventDefault();
        username=$('#login_form input[name="username"]').val();
        password=$('#login_form input[name="password"]').val();
        login_request(username,password);
       return false;
     });

     $("#signup_form").submit(function(e){
       e.preventDefault();
       username=$('#signup_form input[name="username"]').val();
       password=$('#signup_form input[name="password"]').val();
       password_confirm = $('#signup_form input[name="password_confirm"]').val();
       if(password===password_confirm){
            signup_request(username,password);
       }else{
         $("#add_err").css('display', 'inline', 'important');
         $("#add_err").html('<div class="error"> <i class="fa fa-exclamation-circle" aria-hidden="true"></i><span class="sr-only"> Password confirmation doesn\'t match.</span></div>');
       }

      return false;
    });

     $(".signup_link").click(function(){
       $(".login_panel").addClass("hide");
       $(".signup_panel").removeClass("hide");
       $("#add_err").css('display', 'none', 'important');
     })
     $(".login_link").click(function(){
       $(".signup_panel").addClass("hide");
       $(".login_panel").removeClass("hide");
       $("#add_err").css('display', 'none', 'important');
     })
   });


   function login_request(username,password,kickout){
     $.ajax({
       type: "POST",
       url: "/authentication/login",
       contentType: 'application/json',
       dataType: "json",
       data: JSON.stringify({username:username,password:password,kickout:kickout}),
       success: function(data){
         console.log(data);
         if(data.success){
           $("#add_err").css('display', 'inline', 'important');
           $("#add_err").html('<div class="success"> <i class="fa fa-check" aria-hidden="true"></i><span class="sr-only"> Successful Log in !</span></div>');
           window.location="/";

         }
         else{
           $("#add_err").css('display', 'inline', 'important');
           $("#add_err").html('<div class="error"> <i class="fa fa-exclamation-circle" aria-hidden="true"></i><span class="sr-only"> Wrong username or password</span></div>');
         }
      },
      error:function(data){
        if(data.responseJSON.userAlreadyLogedIn){
          r= confirm(data.responseJSON.message+"\n do you want to kick this user out ? ")
          if(r){
            login_request(username,password,true); // kick the user out
          }else{
            $("#add_err").css('display', 'inline', 'important');
            $("#add_err").html('<div class="error"> <i class="fa fa-exclamation-circle" aria-hidden="true"></i><span class="sr-only"> '+data.responseJSON.message+'</span></div>');
          }
        }else{
          $("#add_err").css('display', 'inline', 'important');
          $("#add_err").html('<div class="error"> <i class="fa fa-exclamation-circle" aria-hidden="true"></i><span class="sr-only"> '+data.responseJSON.message+'</span></div>');
        }
      },
      beforeSend:function(){
        $("#add_err").css('display', 'inline', 'important');
        $("#add_err").html('<div class="loading"><i class="fa fa-circle-o-notch fa-spin fa-fw margin-bottom"></i><span class="sr-only"> Loading...</span></div>');
      }
    });
   }

   function signup_request(username,password){
     $.ajax({
       type: "POST",
       url: "/authentication/signup",
       contentType: 'application/json',
       dataType: "json",
       data: JSON.stringify({username:username,password:password}),
       success: function(data){
         console.log(data);
         if(data.success){
           $("#add_err").css('display', 'inline', 'important');
           $("#add_err").html('<div class="success"> <i class="fa fa-check" aria-hidden="true"></i><span class="sr-only"> User successfully created !</span></div>');
           window.location="/";
         }
         else{
           $("#add_err").css('display', 'inline', 'important');
           $("#add_err").html('<div class="error"> <i class="fa fa-exclamation-circle" aria-hidden="true"></i><span class="sr-only"> '+data.message+'</span></div>');
         }
      },
      error:function(data){
        $("#add_err").css('display', 'inline', 'important');
        $("#add_err").html('<div class="error"> <i class="fa fa-exclamation-circle" aria-hidden="true"></i><span class="sr-only"> '+data.responseJSON.message+'</span></div>');
      },
      beforeSend:function(){
        $("#add_err").css('display', 'inline', 'important');
        $("#add_err").html('<div class="loading"><i class="fa fa-circle-o-notch fa-spin fa-fw margin-bottom"></i><span class="sr-only"> Loading...</span></div>');
      }
    });
   }


   var getUrlParameter = function getUrlParameter(sParam) {
      var sPageURL = decodeURIComponent(window.location.search.substring(1)),
          sURLVariables = sPageURL.split('&'),
          sParameterName,
          i;

      for (i = 0; i < sURLVariables.length; i++) {
          sParameterName = sURLVariables[i].split('=');

          if (sParameterName[0] === sParam) {
              return sParameterName[1] === undefined ? true : sParameterName[1];
          }
      }
  };

  </script>
  </body>
</html>
