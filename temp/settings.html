<!DOCTYPE html><html lang="en"><head><title>temp/settings</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="temp/settings"><meta name="groc-project-path" content="temp/settings.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">temp/settings.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> PLATFORM = <span class="hljs-built_in">require</span>(<span class="hljs-string">'process'</span>).platform;
<span class="hljs-keyword">var</span> settings;
<span class="hljs-keyword">try</span>{settings= <span class="hljs-built_in">require</span>(<span class="hljs-string">'./app_settings'</span>);}<span class="hljs-keyword">catch</span>(ex){settings= <span class="hljs-literal">undefined</span>;}
<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">var</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'util'</span>);
<span class="hljs-keyword">var</span> path=<span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">var</span> exec = <span class="hljs-built_in">require</span>(<span class="hljs-string">'child_process'</span>).exec;

<span class="hljs-keyword">var</span> log_conf = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./log'</span>);
<span class="hljs-keyword">var</span> log = log_conf.logger(<span class="hljs-string">'settings'</span>);
<span class="hljs-keyword">var</span> settings_filename = <span class="hljs-string">"app_settings.json"</span>;

<span class="hljs-keyword">var</span> default_conf = {
	<span class="hljs-string">"server_port"</span> : <span class="hljs-number">8080</span>,
	<span class="hljs-string">"driver"</span> : <span class="hljs-string">"g2"</span>,
	<span class="hljs-string">"debug_lvl"</span> : <span class="hljs-string">"info"</span>, <span class="hljs-comment">// info level</span>
	<span class="hljs-string">"install_dir"</span>: <span class="hljs-string">"/opt/fabmo/"</span>,
	<span class="hljs-string">"parts_dir"</span> : <span class="hljs-string">"./parts/"</span>,
	<span class="hljs-string">"db_dir"</span> : <span class="hljs-string">"./db/"</span>,
	<span class="hljs-string">"log_dir"</span>:<span class="hljs-string">"./logs/"</span>,
	<span class="hljs-string">"tmp_dir"</span>:<span class="hljs-string">"./tmp/"</span>
};

<span class="hljs-keyword">if</span> (!settings)
{
	fs.writeFile(settings_filename, <span class="hljs-built_in">JSON</span>.stringify(default_conf, <span class="hljs-literal">null</span>, <span class="hljs-number">4</span>), <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span>{</span>
		<span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;
  		log.debug(<span class="hljs-string">'settings file created'</span>);
  		settings = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./app_settings'</span>);
  		correct_app_tree(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(correct)</span>{</span>
  			<span class="hljs-keyword">if</span>(correct)
	  		{
	  			set_export();
	  			log_conf.setGlobalLevel(exports.debug_lvl);
	  		}
  		});
  		

	});
}
<span class="hljs-keyword">else</span>
{
	correct_app_tree(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(correct)</span>{</span>
		log.debug(<span class="hljs-string">'correctly read the settings file'</span>);
  		<span class="hljs-keyword">if</span>(correct)
  		{
  			set_export();
  			log_conf.setGlobalLevel(exports.debug_lvl);
  		}
  	});
}


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">set_export</span><span class="hljs-params">()</span>{</span>
	exports.server_port = settings.server_port || default_conf.server_port;
	exports.driver = settings.driver || default_conf.driver;
	exports.debug_lvl = (settings.debug_lvl === <span class="hljs-literal">undefined</span>)? default_conf.debug_lvl : settings.debug_lvl;
	exports.app_root_dir = getAppRoot();
	exports.upload_dir = path.normalize( getAppRoot() + (settings.parts_dir || default_conf.parts_dir));
	exports.db_dir = path.normalize( getAppRoot()+ (settings.db_dir || default_conf.db_dir) );
	exports.tmp_dir = path.normalize( getAppRoot()+ (settings.tmp_dir || default_conf.tmp_dir) );
	<span class="hljs-keyword">try</span>{
		wifiscanner = <span class="hljs-built_in">require</span>(<span class="hljs-string">'node-simplerwifiscanner'</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>check if it&#39;s a linux distrib</p></div></div><div class="code"><div class="wrapper">		<span class="hljs-keyword">if</span>(PLATFORM!==<span class="hljs-string">'linux'</span>)
			<span class="hljs-keyword">throw</span> <span class="hljs-string">'not linux'</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>check if netctl-auto is installed</p></div></div><div class="code"><div class="wrapper">		exec(<span class="hljs-string">'netctl-auto --version'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(error, stdout, stderr)</span> {</span>
	    	<span class="hljs-keyword">if</span> (error)
	    		<span class="hljs-keyword">throw</span> error;
	    	exports.wifi_manager=<span class="hljs-literal">true</span>;
			log.info(<span class="hljs-string">"wifi manager enable"</span>);
		});

	}<span class="hljs-keyword">catch</span>(e){
		wifiscanner = <span class="hljs-literal">undefined</span>;
		exports.wifi_manager=<span class="hljs-literal">false</span>;
		log.info(<span class="hljs-string">"wifi manager disable"</span>);
	}

}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getRoot</span><span class="hljs-params">()</span> {</span>
	<span class="hljs-keyword">switch</span>(PLATFORM) {
		<span class="hljs-keyword">case</span> <span class="hljs-string">'win32'</span>:
		<span class="hljs-keyword">case</span> <span class="hljs-string">'win64'</span>:
			<span class="hljs-keyword">return</span> <span class="hljs-string">'c:/'</span>;
		<span class="hljs-keyword">case</span> <span class="hljs-string">'linux'</span>:
		<span class="hljs-keyword">case</span> <span class="hljs-string">'darwin'</span>:
		<span class="hljs-keyword">default</span>:
			<span class="hljs-keyword">return</span> <span class="hljs-string">'/'</span>;
	}
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getAppRoot</span><span class="hljs-params">()</span> {</span>
	<span class="hljs-keyword">return</span> path.normalize(getRoot() + (settings.install_dir || default_conf.install_dir));
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">correct_app_tree</span><span class="hljs-params">(callback)</span>{</span>
	isDirectory(getAppRoot(),<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(app_root_dir)</span>{</span> <span class="hljs-comment">// app root dir</span>
		<span class="hljs-keyword">if</span>(app_root_dir){
			isDirectory(path.normalize(getAppRoot() + (settings.parts_dir || default_conf.parts_dir)),<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(parts_dir)</span>{</span> <span class="hljs-comment">// parts dir</span>
				<span class="hljs-keyword">if</span>(!parts_dir){</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>wrong parts dir</p></div></div><div class="code"><div class="wrapper">					log.warn(<span class="hljs-string">"the parts folder can't be found : creating a new one."</span>);
					fs.mkdir(path.normalize(getAppRoot() + (settings.parts_dir || default_conf.parts_dir)));
				}
				isDirectory(path.normalize(getAppRoot() + (settings.db_dir || default_conf.db_dir)),<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(db_dir)</span>{</span> <span class="hljs-comment">//db dir</span>
					<span class="hljs-keyword">if</span>(!db_dir){</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>wrong db dir</p></div></div><div class="code"><div class="wrapper">						log.warn(<span class="hljs-string">"the db folder can't be found : creating a new one."</span>);
						fs.mkdir(path.normalize(getAppRoot() + (settings.db_dir || default_conf.db_dir)));
					}
					isDirectory(path.normalize(getAppRoot() + (settings.tmp_dir || default_conf.tmp_dir)),<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(tmp_dir)</span>{</span> <span class="hljs-comment">//tmp dir</span>
						<span class="hljs-keyword">if</span>(!tmp_dir){</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>wrong tmp dir</p></div></div><div class="code"><div class="wrapper">							log.warn(<span class="hljs-string">"the tmp folder can't be found : creating a new one."</span>);
							fs.mkdir(path.normalize(getAppRoot() + (settings.tmp_dir || default_conf.tmp_dir)));
						}
						isDirectory(path.normalize(getAppRoot() + (settings.log_dir || default_conf.log_dir)),<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(log_dir)</span>{</span> <span class="hljs-comment">//log dir</span>
							<span class="hljs-keyword">if</span>(!log_dir){</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>wrong log dir</p></div></div><div class="code"><div class="wrapper">								log.warn(<span class="hljs-string">"the log folder can't be found : creating a new one."</span>);
								fs.mkdir(path.normalize(getAppRoot() + (settings.log_dir || default_conf.log_dir)));
							}
							callback(<span class="hljs-literal">true</span>);
						});
					});
				});
			});
		}
		<span class="hljs-keyword">else</span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>wrong app root dir</p></div></div><div class="code"><div class="wrapper">			log.error(<span class="hljs-string">"the app's root folder is corrumpted in the app_settings.json file. please fix it before relaunching the app."</span>);
		}	
	});
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isDirectory</span><span class="hljs-params">(path, callback)</span>{</span>
	fs.stat(path,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err,stats)</span>{</span>
		<span class="hljs-keyword">if</span>(err) callback(<span class="hljs-literal">undefined</span>);
		<span class="hljs-keyword">else</span> callback(stats.isDirectory());
	});
}</div></div></div></div></body></html>