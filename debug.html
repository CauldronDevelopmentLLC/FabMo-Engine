<!DOCTYPE html><html lang="en"><head><title>debug</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="debug"><meta name="groc-project-path" content="debug.js"><meta name="groc-github-url" content="https://github.com/FabMo/FabMo-Engine.git"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/FabMo/FabMo-Engine.git/blob/master/debug.js">debug.js</a></div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><p>debug.js</p>
<p>This module provides some functions that are used when the engine is run in &quot;debug&quot; mode.
(Debug mode is enacted by passing the --debug switch to server.js)</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> dashboard = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./dashboard'</span>);
<span class="hljs-keyword">var</span> log = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./log'</span>).logger(<span class="hljs-string">'debug'</span>);
<span class="hljs-keyword">var</span> config = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./config'</span>);
<span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">var</span> pathIsInside = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path-is-inside'</span>);

<span class="hljs-keyword">var</span> watch_semaphore = <span class="hljs-number">0</span>;
<span class="hljs-keyword">var</span> NCP_TIMEOUT = <span class="hljs-number">4000</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>App reloader</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> appReloader = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event, pth, details</span>) </span>{
  <span class="hljs-keyword">var</span> pth = path.normalize(details.watchedPath || details.path);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Don&#39;t watch for changes if there is an update in progress</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">if</span>(watch_semaphore) { 
    log.warn(<span class="hljs-string">"Not reloading "</span> + pth + <span class="hljs-string">" because a reload is already in progress."</span>);
    <span class="hljs-keyword">return</span>; 
  }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Determine which app changed, and re-copy that app</p></div></div><div class="code"><div class="wrapper">  app_index = dashboard.getAppIndex();
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> app_id <span class="hljs-keyword">in</span> app_index) {
    app_path = app_index[app_id].app_archive_path;
    app_path = path.normalize(app_path);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>if(pathIsInside(app_path, pth) || pathIsInside(pth, app_path)) {
  log.info(app_id + &#39; was changed. Reloading...&#39;);
  watch_semaphore+=1;
  var timeout = setTimeout(function() {
    log.warn(&#39;Timeout waiting for reload of &#39; + app_id);
    watch_semaphore-=1;
    watch_semaphore = watch_semaphore &lt; 0 ? 0 : watch_semaphore;
  }, NCP_TIMEOUT);
  return dashboard.reloadApp(app_id, function(err, result) {
    clearTimeout(timeout);
    log.info(app_id + &#39; updated.&#39;);
    watch_semaphore-=1;<br>    watch_semaphore = watch_semaphore &lt; 0 ? 0 : watch_semaphore;
  });        </p></div></div><div class="code"><div class="wrapper">    <span class="hljs-comment">// </span>
  } 
}; </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This function is called (if enabled) at application startup.
Nominally, it sets up a &quot;watcher&quot; that live-reloads system apps if they are edited while the system is running.
The code the actually performs the copy operation is commented out above, however, so it really does nothing.</p>
<p>TODO : Figure out why the code above is commented out - do we still need this module?</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">startDebug</span>(<span class="hljs-params"></span>) </span>{
  log.info(<span class="hljs-string">"Starting debug watcher..."</span>);
  <span class="hljs-keyword">var</span> chokidar = <span class="hljs-built_in">require</span>(<span class="hljs-string">'chokidar'</span>);
  <span class="hljs-keyword">var</span> pth = path.resolve(<span class="hljs-string">'./dashboard/apps'</span>);
  log.debug(<span class="hljs-string">'Watching '</span>+ pth + <span class="hljs-string">' for changes...'</span>);
  <span class="hljs-keyword">var</span> watcher = chokidar.watch(pth, {
    ignored: <span class="hljs-regexp">/[\/\\]\./</span>,
    persistent: <span class="hljs-literal">true</span>
  });
  watcher.on(<span class="hljs-string">'raw'</span>, appReloader);
  <span class="hljs-keyword">var</span> watcher = chokidar.watch(config.getDataDir(<span class="hljs-string">'apps'</span>), {
    ignored: <span class="hljs-regexp">/[\/\\]\./</span>,
    persistent: <span class="hljs-literal">true</span>
  });
  watcher.on(<span class="hljs-string">'raw'</span>, appReloader);
}

exports.start = startDebug;</div></div></div></div></body></html>