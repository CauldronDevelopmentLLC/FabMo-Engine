<!DOCTYPE html><html lang="en"><head><title>debug</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="debug"><meta name="groc-project-path" content="debug.js"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path">debug.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> dashboard = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./dashboard'</span>);
<span class="hljs-keyword">var</span> log = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./log'</span>).logger(<span class="hljs-string">'debug'</span>);
<span class="hljs-keyword">var</span> config = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./config'</span>);
<span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">var</span> pathIsInside = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path-is-inside'</span>);

<span class="hljs-keyword">var</span> watch_semaphore = <span class="hljs-number">0</span>;
<span class="hljs-keyword">var</span> NCP_TIMEOUT = <span class="hljs-number">4000</span>;

<span class="hljs-keyword">var</span> appReloader = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event, pth, details</span>) </span>{
  <span class="hljs-keyword">var</span> pth = path.normalize(details.watchedPath || details.path);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Don&#39;t watch for changes if there is an update in progress</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">if</span>(watch_semaphore) { 
    log.warn(<span class="hljs-string">"Not reloading "</span> + pth + <span class="hljs-string">" because a reload is already in progress."</span>);
    <span class="hljs-keyword">return</span>; 
  }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Determine which app changed, and re-copy that app</p></div></div><div class="code"><div class="wrapper">  app_index = dashboard.getAppIndex();
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> app_id <span class="hljs-keyword">in</span> app_index) {
    app_path = app_index[app_id].app_archive_path;
    app_path = path.normalize(app_path);
    <span class="hljs-keyword">if</span>(pathIsInside(app_path, pth) || pathIsInside(pth, app_path)) {
      log.info(app_id + <span class="hljs-string">' was changed. Reloading...'</span>);
      watch_semaphore+=<span class="hljs-number">1</span>;
      <span class="hljs-keyword">var</span> timeout = setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        log.warn(<span class="hljs-string">'Timeout waiting for reload of '</span> + app_id);
        watch_semaphore-=<span class="hljs-number">1</span>;
        watch_semaphore = watch_semaphore &lt; <span class="hljs-number">0</span> ? <span class="hljs-number">0</span> : watch_semaphore;
      }, NCP_TIMEOUT);
      <span class="hljs-keyword">return</span> dashboard.reloadApp(app_id, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, result</span>) </span>{
        clearTimeout(timeout);
        log.info(app_id + <span class="hljs-string">' updated.'</span>);
        watch_semaphore-=<span class="hljs-number">1</span>;  
        watch_semaphore = watch_semaphore &lt; <span class="hljs-number">0</span> ? <span class="hljs-number">0</span> : watch_semaphore;
      });        
    }
  } 
}; 

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">startDebug</span>(<span class="hljs-params"></span>) </span>{
  log.info(<span class="hljs-string">"Starting debug watcher..."</span>);
  <span class="hljs-keyword">var</span> chokidar = <span class="hljs-built_in">require</span>(<span class="hljs-string">'chokidar'</span>);
  <span class="hljs-keyword">var</span> pth = path.resolve(<span class="hljs-string">'./dashboard/apps'</span>);
  log.debug(<span class="hljs-string">'Watching '</span>+ pth + <span class="hljs-string">' for changes...'</span>);
  <span class="hljs-keyword">var</span> watcher = chokidar.watch(pth, {
    ignored: <span class="hljs-regexp">/[\/\\]\./</span>,
    persistent: <span class="hljs-literal">true</span>
  });
  watcher.on(<span class="hljs-string">'raw'</span>, appReloader);
  <span class="hljs-keyword">var</span> watcher = chokidar.watch(config.getDataDir(<span class="hljs-string">'apps'</span>), {
    ignored: <span class="hljs-regexp">/[\/\\]\./</span>,
    persistent: <span class="hljs-literal">true</span>
  });
  watcher.on(<span class="hljs-string">'raw'</span>, appReloader);
}

exports.start = startDebug;</div></div></div></div></body></html>