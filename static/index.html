<!DOCTYPE html> <html> <head>
  <meta charset="utf-8">
  <title>Shopbot Example App</title>
  <!-- From bootstrap -->
  <link rel="stylesheet" href="./css/bootstrap.min.css">
  <link rel="stylesheet" href="./css/normalize.css">
  <link rel="stylesheet" href="./css/style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
	<nav class="navbar navbar-default" role="navigation">
	<div class="container-fluid">
	  <div class="navbar-header">
		<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
		  <span class="sr-only">Toggle navigation</span>
		  <span class="icon-bar"></span>
		  <span class="icon-bar"></span>
		  <span class="icon-bar"></span>
		</button>
		<a class="brand" href="/"><img src="./images/shopbot_logo.png"></a>
	  </div>
	  <div class="collapse navbar-collapse fabmo-file-control" id="bs-example-navbar-collapse-1">
		<ul class="nav navbar-nav fabmo-status" style="margin-right: 20%;">
		  <li><a><span class="label status-label label-default state">&nbsp;</span></a></li>
		  <li><a><strong>X: </strong><span class="posx"></span></a></li>
		  <li><a><strong>Y: </strong><span class="posy"></span></a></li>
		  <li><a><strong>Z: </strong><span class="posz"></span></a></li>
		  <li class="hide file-info"><a><strong>File: </strong><span class="filename"></span>    <span class="progress"></span></a></li>
		</ul>
		  <button type="button" style="margin-left: 5px; margin-right: 5px;" class="btn btn-default navbar-btn navbar-right" id="keypad" data-target="#manual-modal" data-toggle="modal"><span class="glyphicon glyphicon-screenshot"></span>
		  <button type="button" style="margin-left: 5px; margin-right: 5px;" class="btn btn-warning navbar-btn navbar-right fabmo-pause-button hide"><span class="glyphicon glyphicon-pause"></span></button>
		  <button type="button" style="margin-left: 5px; margin-right: 5px;" class="btn btn-success navbar-btn navbar-right fabmo-resume-button hide"><span class="glyphicon glyphicon-play"></span></button>
		<button type="button" style="margin-left: 5px; margin-right: 5px;" class="btn btn-danger navbar-btn navbar-right fabmo-stop-button hide"><span class="glyphicon glyphicon-stop"></span></button>
	  </div><!-- /.navbar-collapse -->
	</div><!-- /.container-fluid -->
  </nav>

  <div class="container">
	<div class="panel panel-default">
	  <div class="panel-heading app-heading">FabMo G-Code Streamer</div>
	  <div class="panel-body">
		<table class="table table-hover table-bordered" id="files">
		  <tr><th colspan="3">Files on the tool (click to run)</th></tr>
		</table>
		<strong>Upload a file...</strong>
		<p>
		<form id="add_file" action="/file" method="post" enctype="multipart/form-data">
		  <div class="pull-left">
			<input id='file_selector' type="file" name="file" data-filename-placement="inside" title="Browse...">
		  </div>
		  <div class="pull-right">
			<button type="submit" class="btn btn-default btn-primary">
				<span class="glyphicon glyphicon-upload"></span>Upload
			</button>
		  </div>
		</form>
		</p>
	</div>
	</div>
	<div class="panel panel-default">
		<div class="panel-heading app-heading">Single G-Code</div>
		<div class="panel-body">
			<form id="gcode-sender" action="/run" method="post" enctype="multipart/form-data" role="form" class="">
				<input id="gcode-input" class="form-control input-lg" type="text" onclick="this.select();">
			</form>
		</div>
	</div>

		<div class="panel panel-default">
		<div class="panel-heading app-heading">Single OpenSBP Command</div>
		<div class="panel-body">
			<form id="sbp-sender" action="/run" method="post" enctype="multipart/form-data" role="form" class="">
				<input id="sbp-input" class="form-control input-lg" type="text" onclick="this.select();">
			</form>
		</div>
	</div>
  </div>

<!-- KEYBOARD DIALOG -->
<div class="modal fade" id="manual-modal" tabindex="-1" role="dialog" aria-labelledby="manual-modal-label" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal">
					<span aria-hidden="true">&times;</span><span class="sr-only">Close</span>
				</button>
				<h4 class="modal-title" id="manual-modal-label">Manual Control</h4>
				<!--<span class="label status-label label-default tool-state pull-right">&nbsp;</span>-->
			</div>
			<div class="modal-body">
				<div class="container-fluid">
					<div class="row">
						<div class="col-xs-6">
							<form class="form-horizontal fabmo-status" role="form">
								<div class="form-group">
									<label for="modal-posx" class="col-sm-2 control-label">X:</label>
									<div class="col-sm-10">
										<div class="input-group">
											<input type="text" class="form-control posx dropdown" id="modal-posx"></input>
											<div class="input-group-addon dropdown-toggle" data-toggle="dropdown" style="cursor: pointer;" id="dropdownMenu1">
											<span class="caret"></span>
											</div>
											<ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu1">
												<li role="presentation"><a role="menuitem" tabindex="-1" href="#" class="homex-button">Home Axis</a></li>
												<li role="presentation"><a role="menuitem" tabindex="-1" href="#" class="zerox-button">Zero Axis</a></li>
											</ul>
										</div>
									</div>
								</div>
								<div class="form-group">
									<label for="modal-posy" class="col-sm-2 control-label">Y:</label>
									<div class="col-sm-10">
										<div class="input-group">
											<input type="text" class="form-control posy" id="modal-posy"></input>
											<div class="input-group-addon dropdown-toggle" data-toggle="dropdown" style="cursor: pointer;" id="dropdownMenu1">
											<span class="caret"></span>
											</div>
											<ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu1">
												<li role="presentation"><a role="menuitem" tabindex="-1" href="#" class="homey-button">Home Axis</a></li>
												<li role="presentation"><a role="menuitem" tabindex="-1" href="#" class="zeroy-button">Zero Axis</a></li>
											</ul>
										</div>
									</div>
								</div>
								<div class="form-group">
									<label for="modal-posz" class="col-sm-2 control-label">Z:</label>
									<div class="col-sm-10">
										<div class="input-group">
											<input type="text" class="form-control posz" id="modal-posz"></input>
											<div class="input-group-addon dropdown-toggle" data-toggle="dropdown" style="cursor: pointer;" id="dropdownMenu1">
											<span class="caret"></span>
											</div>
											<ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu1">
												<li role="presentation"><a role="menuitem" tabindex="-1" href="#" class="homez-button">Home Axis</a></li>
												<li role="presentation"><a role="menuitem" tabindex="-1" href="#" class="zeroz-button">Zero Axis</a></li>
												<li role="presentation"><a role="menuitem" tabindex="-1" href="#" class="probez-button">Probe Axis</a></li>
											</ul>
										</div>
									</div>
								</div>
							</form>
							<div class="pull-right">
							<button class="btn btn-default homexy-button">
								<span class="glyphicon glyphicon-home"></span> Home XY
							</button>
							</div>
						</div>
						<div class="col-xs-6">
							<div class="container-fluid fabmo-keypad">
								<div class="row" style="margin-top: 15px;">
									<div class="col-xs-3"><button class="btn btn-default btn-lg button-plus-Z">↥</button></div>
									<div class="col-xs-3"><button class="btn btn-default btn-lg button-plus-Y">↑</button></div>
									<div class="col-xs-3"><button class="btn btn-default btn-lg button-minus-Z">↧</button></div>
								</div>							
								<div class="row" style="margin-top: 15px;">
									<div class="col-xs-3"><button class="btn btn-default btn-lg button-minus-X">←</button></div>
									<div class="col-xs-3"><button class="btn btn-default btn-lg button-minus-Y">↓</button></div>
									<div class="col-xs-3"><button class="btn btn-default btn-lg button-plus-X">→</button></div>
								</div>							
							</div>
						</div>

					</div>
				</div>
			</div> <!-- modal-body -->
			<!--
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
				<button type="button" class="btn btn-primary">Save changes</button>
			</div> -->
		</div>
	</div>
</div>


  <script src="./js/libs/jquery-1.10.2.js"></script>
  <script src="./js/bootstrap.min.js"></script>
  <script src="./js/libs/bootstrap.file-input.js"></script>
  <script src="./js/FabMo-latest.js"></script>
  <script src="./js/FabMoUI-latest.js"></script>

  
  <script type="text/javascript">
  	var tool= new FabMo('192.168.33.134','8080');
	//var tool = new FabMo(location.hostname||'localhost', '8080');
	var ui = new FabMoUI(tool);

	$('#manual-modal').on('show.bs.modal', function (e) {
		ui.allowKeypad();
	});


	$('#manual-modal').on('hide.bs.modal', function (e) {
		ui.forbidKeypad();
	});

	$(document).ready(function(){
	  // Style the file input so it looks nice
	  $('input[type=file]').bootstrapFileInput();

	  // Load the list of files available on the tool
	  refresh_files_list();
	});


	function gcode(string) {
		tool.gcode(string,function(err,data){
			if(!err) {
				console.log('Success: ' + string);
			} else {
				console.log('Failure: ' + string);
			}
		});
	}


	function refresh_files_list(){
	  // Load the list of files available on the tool
	  tool.list_files(function(err,files){
	$(".files_list").remove();
		$.each( files, function( key, val ) {
		  $("#files").append( "<tr class='files_list'>"+
		"<td class='run-button' value='" + val._id + "'><a style='cursor: pointer;'>" + val.filename + "</a></td>" +
		"<td class='view-button' value='" + val._id + "' style='text-align: right;width: 3%;'><span style='cursor: pointer;' class='glyphicon glyphicon-eye-open'></span></td>"+
		"<td class='download-button' value='" + val._id + "' style='text-align: right;width: 3%;'><span style='cursor: pointer;' class='glyphicon glyphicon-download-alt'></span></td>" +
		"<td class='delete-button' value='" + val._id + "' style='text-align: right;width: 3%;'><span style='cursor: pointer;' class='glyphicon glyphicon-remove'></span></td>"+
		"</tr>");
		});
	  });
	}

	$('#add_file').submit(function(e){
	e.preventDefault();
		tool.upload_file($(this),function(err,file){
		if(err){console.log(err);return;}
		$('#file_selector').replaceWith($('#file_selector').clone(true)); //reset file field
		$('#file_selector').prev().html('Browse for a file to upload...');
			refresh_files_list();
	});
	});



	$(' tbody').on( "click", 'tr .delete-button', function(e) {	
	tool.delete_by_id($(this).attr('value'),function(err) {
	if(!err)	
		refresh_files_list();
	else
		alert(err);
	});
   });

	$(' tbody').on( "click", 'tr .download-button', function(e) {	
	tool.download_by_id($(this).attr('value'));
});

	$(' tbody').on( "click", 'tr .run-button', function(e) {	
	tool.run_by_id($(this).attr('value'),function(err){
	if(!err)	
		console.log('file is running !');
	else
		alert(err);
	});

});

	function flash_input(cls, value, duration) {
		if(value === 'error') {
			$(cls).addClass('has-success');
			$(cls).removeClass('has-error');
		} else if(value === 'success') {
			$(cls).addClass('has-success');
			$(cls).removeClass('has-error');
		}
		setTimeout(function() {
			$(cls).removeClass('has-error');
			$(cls).removeClass('has-success');
		}, duration);
	}

	$('#gcode-sender').submit(function(e) {
	e.preventDefault();
	tool.gcode($('#gcode-input').val(),function(err,data){
		if(!err) {
			console.log('success');
			flash_input('#gcode-sender', 'success', 500);
		} else {
			console.log('failure');
			flash_input('#gcode-sender', 'error', 500);
		}
	});
	});

	$('#sbp-sender').submit(function(e) {
	e.preventDefault();
	tool.sbp($('#sbp-input').val(),function(err,data){
		if(!err) {
			console.log('success');
			flash_input('#sbp-sender', 'success', 500);
		} else {
			console.log('failure');
			flash_input('#sbp-sender', 'success', 500);
		}
	});
	});
	
	$('.homex-button').click(function(e) {gcode('G28.2 X0'); });
	$('.homey-button').click(function(e) {gcode('G28.2 Y0'); });
	$('.homez-button').click(function(e) {gcode('G28.2 Z0'); });
	$('.homexy-button').click(function(e) {gcode('G28.2 X0 Y0'); });

	$('.probez-button').click(function(e) {gcode('G38.2 Z-4 F10\nG10 L2 P1 Z-0.125'); });   

	$('.zerox-button').click(function(e) {gcode('G28.3 X0'); });  
	$('.zeroy-button').click(function(e) {gcode('G28.3 Y0'); });  
	$('.zeroz-button').click(function(e) {gcode('G28.3 Z0'); });  


	$('.fabmo-status').on('statechange',function(e,state){
		if (state === 'running' || state === 'manual' || state === 'homing' || state==='probing')
			$('.state').removeClass('label-success label-info label-default label-warning label-danger').addClass('label-success');
		else if (state === 'paused' || state === 'passthrough' || state === 'limit')
			$('.state').removeClass('label-success label-info label-default label-warning label-danger').addClass('label-warning');
		else if (state === 'Error' || state === 'Disconnected')
			$('.state').removeClass('label-success label-info label-default label-warning label-danger').addClass('label-error');
		else
			$('.state').removeClass('label-success label-info label-default label-warning label-danger').addClass('label-default');
	});

  </script>

</body>
</html>
