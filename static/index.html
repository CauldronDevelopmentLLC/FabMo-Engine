<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Shopbot Example App</title>
  <!-- From bootstrap -->
  <link rel="stylesheet" href="./css/bootstrap.min.css">
  <link rel="stylesheet" href="./css/normalize.css">
  <link rel="stylesheet" href="./css/style.css">
</head>
<body>
    <nav class="navbar navbar-default" role="navigation">
    <div class="container-fluid">
      <!-- Brand and toggle get grouped for better mobile display -->
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="brand" href="/"><img src="./images/shopbot_logo.png"></a>
      </div>

      <!-- Collect the nav links, forms, and other content for toggling -->
      <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
        <ul class="nav navbar-nav" style="margin-right: 20%;">
          <li><a><span class="label status-label label-default tool-state">&nbsp;</span></a></li>
          <li><a><strong>X: </strong><span class="posx"></span></a></li>
          <li><a><strong>Y: </strong><span class="posy"></span></a></li>
          <li><a><strong>Z: </strong><span class="posz"></span></a></li>
        </ul>
	      <a class="navbar-right" id="keypad" style="opacity:0.2;"><img src="./images/arrow_key.png" /></a>
        <button type="button" class="btn btn-danger navbar-btn navbar-right stop-button hide">STOP TOOL</button>
      </div><!-- /.navbar-collapse -->
    </div><!-- /.container-fluid -->
  </nav>

  <div class="container">

    <div class="panel panel-default">
      <div class="panel-heading app-heading">Shopbot G-Code Streamer</div>
      <div class="panel-body">
        
        <p>
        This is a simple application for streaming a G-Code file.
        </p>
        

        
        <table class="table table-hover table-bordered" id="files">
          <tr><th>Files on the tool (click to run)</th></tr>
        </table>

        <strong>Upload a file...</strong>
        
	<p>
        <form action="/run" method="post" enctype="multipart/form-data">
          <div class="pull-left">
            <input type="file" name="file" data-filename-placement="inside" title="Browse for a file to upload...">
          </div>
          <div class="pull-right">
            <input type="submit" value="Upload" class="btn btn-default btn-primary">
          </div>
        </form>
        </p>
	
      
	</div>
    </div>
    <div class="panel panel-default">
	<div class="panel-heading app-heading">Single G-Code</div>
	<p>
        <form action="/run" method="post" enctype="multipart/form-data">
		<input id="gcode-input" class="form-control" type="text">
	</form>
	</p>
    </div>
  </div>

  <script src="./js/libs/jquery-1.10.2.js"></script>
  <script src="./js/bootstrap.min.js"></script>
  <script src="./js/libs/bootstrap.file-input.js"></script>
  
  <script type="text/javascript">
	var keypad_allow=false;
	var lock_right = false,lock_left = false ,lock_up = false ,lock_down = false,lock_page_up = false,lock_page_down = false;
	$(document).keydown(function(e) {
	if (keypad_allow){
		if (e.which === 37 && !lock_left && !lock_right) //left
		{
			lock_left=true;
			 $.post( "http://"+location.hostname+":8080/direct/move",{"move" : "-x"});
		}
		if (e.which === 38 && !lock_up && !lock_down) //up
		{
			 lock_up=true;
			 $.post( "http://"+location.hostname+":8080/direct/move",{"move" : "y"});
		}
		if (e.which === 39 && !lock_right && !lock_left) //right
		{
			 lock_right=true;
			 $.post( "http://"+location.hostname+":8080/direct/move",{"move" : "x"});
		}
		if (e.which === 40  && !lock_up && !lock_down) //down
		{
			 lock_down=true;
			 $.post( "http://"+location.hostname+":8080/direct/move",{"move" : "-y"});
		}
		if (e.which === 33  && !lock_page_up && !lock_page_down) //page_up
		{
			 lock_page_up=true;
			 $.post( "http://"+location.hostname+":8080/direct/move",{"move" : "z"});
		}
		if (e.which === 34 && !lock_page_up && !lock_page_down) //page_down
		{
			 lock_page_down=true;
			 $.post( "http://"+location.hostname+":8080/direct/move",{"move" : "-z"});
		}
	}
	});
    	$(document).keyup(function(e) {
	if (keypad_allow){
		if (e.which === 37 ) //left
		{
			lock_left=false;
			$.post( "http://"+location.hostname+":8080/direct/move",{"move" : "stop"});
		}
		if (e.which === 38 ) //up
		{
			lock_up=false;
			$.post( "http://"+location.hostname+":8080/direct/move",{"move" : "stop"});
		}
		if (e.which === 39 ) //right
		{
			lock_right=false;
			$.post( "http://"+location.hostname+":8080/direct/move",{"move" : "stop"});
		}
		if (e.which === 40 ) //down
		{
			lock_down=false;
			$.post( "http://"+location.hostname+":8080/direct/move",{"move" : "stop"});
		}
		if (e.which === 33 ) //page_up
		{
			lock_page_up=false;
			$.post( "http://"+location.hostname+":8080/direct/move",{"move" : "stop"});
		}
		if (e.which === 34 ) //page_down
		{
			lock_page_down=false;
			$.post( "http://"+location.hostname+":8080/direct/move",{"move" : "stop"});
		}
	}
    	});

    $(document).ready(function(){
      $('form').attr('action',"http://"+location.hostname+":8080/file");
      // Style the file input so it looks nice
      $('input[type=file]').bootstrapFileInput();

      // Load the list of files available on the tool
      $.getJSON("http://"+location.hostname+":8080/file", function( data ) {
        $.each( data.files, function( key, val ) {
          $("#files").append( "<tr>"+
"<td id='file" + val._id + "'><a href='"+"http://"+location.hostname+":8080/run/" + val._id + "' >" + val.filename + "</a></td>" +
"<td class='download-button' value='" + val._id + "' style='text-align: right;width: 3%;'><img src='./images/download.png'></td>" +
"<td class='delete-button' value='" + val._id + "' style='text-align: right;width: 3%;'><img src='./images/delete.png'></td>"+
"</tr>");
        });
      });
    setInterval(timer, 50);
    });

    function timer() {
      $.ajax( {
        url: "http://"+location.hostname+":8080/status", 
        dataType : 'json', 
        success: function( data ) {
       	$('.posx').html(data.status.posx.toFixed(3));
        $('.posy').html(data.status.posy.toFixed(3));
        $('.posz').html(data.status.posz.toFixed(3));
        if(data.status.state == 'idle') {
          $('.status-label').removeClass('label-success');
          $('.status-label').removeClass('label-danger');
          $('.status-label').addClass('label-default');
          $('.tool-state').html('Tool State: Idle');
          $('.stop-button').addClass('hide');
        } else {
          $('.status-label').removeClass('label-default');
          $('.status-label').removeClass('label-danger');
          $('.status-label').addClass('label-success');         
          $('.tool-state').html('Tool State: Running');
          $('.stop-button').removeClass('hide');
        }}, 
        error: function(data) {
          $('.status-label').removeClass('label-success');
          $('.status-label').removeClass('label-default');
          $('.status-label').addClass('label-danger');
          $('.tool-state').html('Tool State: Disconnected');
          $('.stop-button').addClass('hide');
          $('.posx').html('???');
          $('.posy').html('???');
          $('.posz').html('???');
        }
      });
      //setTimeout(timer, 500);
    }

    $('.stop-button').click(function() {
      $.getJSON("http://"+location.hostname+":8080/quit", function(data) {});
    });


    $(' tbody').on( "click", 'tr .delete-button', function() {	
	$.ajax({
		url: "http://"+location.hostname+":8080/file/" + $(this).attr('value'),
		type: 'DELETE',
		success: function(){location.reload()}
	});
   });

    $(' tbody').on( "click", 'tr .download-button', function() {	
	window.location ="http://"+location.hostname+":8080/file/"+ $(this).attr('value');
});

    $('#keypad').click(function() {
	if (keypad_allow)
        {
	    $(this).css('opacity',0.2);
	    keypad_allow = false;
	}
	else
        {
	    $(this).css('opacity',1);
	    keypad_allow = true;
	}
    });
  </script>

</body>
</html>
