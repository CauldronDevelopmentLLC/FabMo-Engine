<!DOCTYPE html><html lang="en"><head><title>config/engine_config</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="config/engine_config"><meta name="groc-project-path" content="config/engine_config.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">config/engine_config.js</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><p>engine_config.js</p>
<p>This file defines the configuration for the engine.</p>
<p>When the profile is changed, the new profile is applied as needed.
When the log level changes, apply that change immediately to the logging system.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">var</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'util'</span>);
<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs-extra'</span>);
<span class="hljs-keyword">var</span> PLATFORM = <span class="hljs-built_in">require</span>(<span class="hljs-string">'process'</span>).platform;
<span class="hljs-keyword">var</span> G2 = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../g2.js'</span>);
<span class="hljs-keyword">var</span> exec = <span class="hljs-built_in">require</span>(<span class="hljs-string">'child_process'</span>).exec;
<span class="hljs-keyword">var</span> Config = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./config'</span>).Config;
<span class="hljs-keyword">var</span> log = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../log'</span>);
<span class="hljs-keyword">var</span> logger = log.logger(<span class="hljs-string">'config'</span>);
<span class="hljs-keyword">var</span> profiles = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../profiles'</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The EngineConfig object keeps track of engine-specific settings</p></div></div><div class="code"><div class="wrapper">EngineConfig = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
	Config.call(<span class="hljs-keyword">this</span>, <span class="hljs-string">'engine'</span>);
};
util.inherits(EngineConfig, Config);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The update function
Nothing special here EXCEPT:
If the value passed in for the profile is different than the current profile, we write
the configuration to disk and exit the engine altogether.  It is assumed that systemd (or whoever launched the engine)
will pick up and restart the engine after the abort.</p></div></div><div class="code"><div class="wrapper">EngineConfig.prototype.update = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data, callback</span>) </span>{
	<span class="hljs-keyword">var</span> profile_changed = <span class="hljs-literal">false</span>;
	<span class="hljs-keyword">try</span> {
		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> data) {
			<span class="hljs-keyword">if</span>((key === <span class="hljs-string">'profile'</span>)) {
				<span class="hljs-keyword">var</span> newProfile = data[key];</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Make note if the profile changed.  If so, we want to apply the new profile
(Which will probably make a bunch of sweeping configuration changes)</p></div></div><div class="code"><div class="wrapper">				<span class="hljs-keyword">if</span>((key <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>._cache) &amp;&amp; (data[key] != <span class="hljs-keyword">this</span>._cache[key])) {
					<span class="hljs-keyword">try</span> { logger.info(<span class="hljs-string">"Profile changed from "</span> + <span class="hljs-keyword">this</span>._cache[key] + <span class="hljs-string">' to '</span> + data[key]); }
					<span class="hljs-keyword">catch</span>(err) {}
					profile_changed = <span class="hljs-literal">true</span>;
				} <span class="hljs-keyword">else</span> {
					logger.info(<span class="hljs-string">'Profile is unchanged.'</span>);
				}
			}
			<span class="hljs-keyword">this</span>._cache[key] = data[key];				
		}
	} <span class="hljs-keyword">catch</span> (e) {
		<span class="hljs-keyword">if</span>(callback) {
			<span class="hljs-keyword">return</span> setImmediate(callback, e);
		}
	}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>TODO - fix the that=this pattern - it&#39;s obnoxious.  Bind, or eventually arrow function</p></div></div><div class="code"><div class="wrapper">	<span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>;
	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">save</span>(<span class="hljs-params">callback</span>) </span>{
		that.save(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, result</span>) </span>{
			<span class="hljs-keyword">if</span>(err) {
				<span class="hljs-keyword">typeof</span> callback === <span class="hljs-string">'function'</span> &amp;&amp; callback(e);
			} <span class="hljs-keyword">else</span> {
				<span class="hljs-keyword">typeof</span> callback === <span class="hljs-string">'function'</span> &amp;&amp; callback(<span class="hljs-literal">null</span>, data);
			}
		});
	};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If the profile changed above, we apply it, and if that was successful, we abort the process.</p></div></div><div class="code"><div class="wrapper">	<span class="hljs-keyword">if</span>(profile_changed) {
		logger.warn(<span class="hljs-string">'Engine profile changed - engine will be restarted.'</span>)
		profiles.apply(newProfile, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
			<span class="hljs-keyword">if</span>(err) {
				<span class="hljs-built_in">console</span>.log(err);
				callback(err);
			} <span class="hljs-keyword">else</span> {
				<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'shutting down'</span>);
				process.exit(<span class="hljs-number">1</span>);
			}
		});
	} <span class="hljs-keyword">else</span> {
		save(callback);
	}
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Apply the engine settings
  callback - Called when settings have been applied or with error if error</p></div></div><div class="code"><div class="wrapper">EngineConfig.prototype.apply = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) </span>{
	<span class="hljs-keyword">try</span> {
		log.setGlobalLevel(<span class="hljs-keyword">this</span>.get(<span class="hljs-string">'log_level'</span>));
		callback(<span class="hljs-literal">null</span>, <span class="hljs-keyword">this</span>);
	}
	<span class="hljs-keyword">catch</span> (e) {
		callback(e);
	}
};


exports.EngineConfig = EngineConfig;</div></div></div></div></body></html>