<!DOCTYPE html><html lang="en"><head><title>config/engine_config</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="config/engine_config"><meta name="groc-project-path" content="config/engine_config.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">config/engine_config.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">var</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'util'</span>);
<span class="hljs-keyword">var</span> PLATFORM = <span class="hljs-built_in">require</span>(<span class="hljs-string">'process'</span>).platform;

Config = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./config'</span>).Config
log = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../log'</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The EngineConfig object keeps track of engine-specific settings</p></div></div><div class="code"><div class="wrapper">EngineConfig = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
	Config.call(<span class="hljs-keyword">this</span>);
	<span class="hljs-keyword">this</span>.default_config_file = <span class="hljs-string">'./config/default/engine.json'</span>
	<span class="hljs-keyword">this</span>.config_file = <span class="hljs-string">'./config/data/engine.json'</span>
}
util.inherits(EngineConfig, Config);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The engine update function is pretty basic for now, 
but if new values provoke a reconfiguration of the application, this is where it will be done.</p></div></div><div class="code"><div class="wrapper">EngineConfig.prototype.update = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data, callback)</span> {</span>
	<span class="hljs-keyword">try</span> {
		<span class="hljs-keyword">for</span>(key <span class="hljs-keyword">in</span> data) {
			<span class="hljs-keyword">this</span>._cache[key] = data[key];
		}
	} <span class="hljs-keyword">catch</span> (e) {
		<span class="hljs-keyword">return</span> callback(e);
	}
	callback(<span class="hljs-literal">null</span>, data);
}

EngineConfig.prototype.apply = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback)</span> {</span>
	<span class="hljs-keyword">try</span> {
		log.setGlobalLevel(<span class="hljs-keyword">this</span>.get(<span class="hljs-string">'log_level'</span>));
		callback(<span class="hljs-literal">null</span>, <span class="hljs-keyword">this</span>);
	}
	<span class="hljs-keyword">catch</span> (e) {
		callback(e);
	}
}

EngineConfig.prototype.getDataDir = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span> <span class="hljs-keyword">return</span> path.normalize(getRoot() + <span class="hljs-keyword">this</span>.get(<span class="hljs-string">'data_dir'</span>)); }
EngineConfig.prototype.getDBDir = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span> <span class="hljs-keyword">return</span> path.join(<span class="hljs-keyword">this</span>.getDataDir(), <span class="hljs-string">'db'</span>); }
EngineConfig.prototype.getTempDir = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span> <span class="hljs-keyword">return</span> path.join(<span class="hljs-keyword">this</span>.getDataDir(), <span class="hljs-string">'tmp'</span>); }
EngineConfig.prototype.getLogDir = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span> <span class="hljs-keyword">return</span> path.join(<span class="hljs-keyword">this</span>.getDataDir(), <span class="hljs-string">'log'</span>); }
EngineConfig.prototype.getPartsDir = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span> <span class="hljs-keyword">return</span> path.join(<span class="hljs-keyword">this</span>.getDataDir(), <span class="hljs-string">'parts'</span>); }


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getRoot</span><span class="hljs-params">()</span> {</span>
	<span class="hljs-keyword">switch</span>(PLATFORM) {
		<span class="hljs-keyword">case</span> <span class="hljs-string">'win32'</span>:
		<span class="hljs-keyword">case</span> <span class="hljs-string">'win64'</span>:
			<span class="hljs-keyword">return</span> <span class="hljs-string">'c:/'</span>;
		<span class="hljs-keyword">default</span>:
			<span class="hljs-keyword">return</span> <span class="hljs-string">'/'</span>;
	}
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">correct_app_tree</span><span class="hljs-params">(callback)</span>{</span>
	isDirectory(getAppRoot(),<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(app_root_dir)</span>{</span> <span class="hljs-comment">// app root dir</span>
		<span class="hljs-keyword">if</span>(app_root_dir){
			isDirectory(path.normalize(getAppRoot() + (settings.parts_dir || default_conf.parts_dir)),<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(parts_dir)</span>{</span> <span class="hljs-comment">// parts dir</span>
				<span class="hljs-keyword">if</span>(!parts_dir){</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>wrong parts dir</p></div></div><div class="code"><div class="wrapper">					log.warn(<span class="hljs-string">"the parts folder can't be found : creating a new one."</span>);
					fs.mkdir(path.normalize(getAppRoot() + (settings.parts_dir || default_conf.parts_dir)));
				}
				isDirectory(path.normalize(getAppRoot() + (settings.db_dir || default_conf.db_dir)),<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(db_dir)</span>{</span> <span class="hljs-comment">//db dir</span>
					<span class="hljs-keyword">if</span>(!db_dir){</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>wrong db dir</p></div></div><div class="code"><div class="wrapper">						log.warn(<span class="hljs-string">"the db folder can't be found : creating a new one."</span>);
						fs.mkdir(path.normalize(getAppRoot() + (settings.db_dir || default_conf.db_dir)));
					}
					isDirectory(path.normalize(getAppRoot() + (settings.tmp_dir || default_conf.tmp_dir)),<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(tmp_dir)</span>{</span> <span class="hljs-comment">//tmp dir</span>
						<span class="hljs-keyword">if</span>(!tmp_dir){</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>wrong tmp dir</p></div></div><div class="code"><div class="wrapper">							log.warn(<span class="hljs-string">"the tmp folder can't be found : creating a new one."</span>);
							fs.mkdir(path.normalize(getAppRoot() + (settings.tmp_dir || default_conf.tmp_dir)));
						}
						isDirectory(path.normalize(getAppRoot() + (settings.log_dir || default_conf.log_dir)),<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(log_dir)</span>{</span> <span class="hljs-comment">//log dir</span>
							<span class="hljs-keyword">if</span>(!log_dir){</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>wrong log dir</p></div></div><div class="code"><div class="wrapper">								log.warn(<span class="hljs-string">"the log folder can't be found : creating a new one."</span>);
								fs.mkdir(path.normalize(getAppRoot() + (settings.log_dir || default_conf.log_dir)));
							}
							callback(<span class="hljs-literal">true</span>);
						});
					});
				});
			});
		}
		<span class="hljs-keyword">else</span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>wrong app root dir</p></div></div><div class="code"><div class="wrapper">			log.error(<span class="hljs-string">"the app's root folder is corrumpted in the app_settings.json file. please fix it before relaunching the app."</span>);
		}	
	});
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isDirectory</span><span class="hljs-params">(path, callback)</span>{</span>
	fs.stat(path,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err,stats)</span>{</span>
		<span class="hljs-keyword">if</span>(err) callback(<span class="hljs-literal">undefined</span>);
		<span class="hljs-keyword">else</span> callback(stats.isDirectory());
	});
}

exports.EngineConfig = EngineConfig;</div></div></div></div></body></html>