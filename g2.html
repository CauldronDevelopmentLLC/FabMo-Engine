<!DOCTYPE html><html lang="en"><head><title>g2</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="g2"><meta name="groc-project-path" content="g2.js"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path">g2.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> serialport = <span class="hljs-built_in">require</span>(<span class="hljs-string">"serialport"</span>);
<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>);
<span class="hljs-keyword">var</span> events = <span class="hljs-built_in">require</span>(<span class="hljs-string">'events'</span>);
<span class="hljs-keyword">var</span> <span class="hljs-keyword">async</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'async'</span>);
<span class="hljs-keyword">var</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'util'</span>);
<span class="hljs-keyword">var</span> Queue = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./util'</span>).Queue;
<span class="hljs-keyword">var</span> log = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./log'</span>).logger(<span class="hljs-string">'g2'</span>);
<span class="hljs-keyword">var</span> process = <span class="hljs-built_in">require</span>(<span class="hljs-string">'process'</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Values of the <strong>stat</strong> field that is returned from G2 status reports</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> STAT_INIT = <span class="hljs-number">0</span>;
<span class="hljs-keyword">var</span> STAT_READY = <span class="hljs-number">1</span>;
<span class="hljs-keyword">var</span> STAT_ALARM = <span class="hljs-number">2</span>;
<span class="hljs-keyword">var</span> STAT_STOP = <span class="hljs-number">3</span>;
<span class="hljs-keyword">var</span> STAT_END = <span class="hljs-number">4</span>;
<span class="hljs-keyword">var</span> STAT_RUNNING = <span class="hljs-number">5</span>;
<span class="hljs-keyword">var</span> STAT_HOLDING = <span class="hljs-number">6</span>;
<span class="hljs-keyword">var</span> STAT_PROBE = <span class="hljs-number">7</span>;
<span class="hljs-keyword">var</span> STAT_CYCLING = <span class="hljs-number">8</span>;
<span class="hljs-keyword">var</span> STAT_HOMING = <span class="hljs-number">9</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Should take no longer than CMD_TIMEOUT to do a get or a set operation</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> CMD_TIMEOUT = <span class="hljs-number">10000</span>;
<span class="hljs-keyword">var</span> EXPECT_TIMEOUT = <span class="hljs-number">5000</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>When jogging, &quot;keepalive&quot; jog commands must arrive faster than this interval (ms)
This can be slowed down if necessary for spotty connections, but a slow timeout means
the machine has more time to run away before stopping.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> JOG_TIMEOUT = <span class="hljs-number">500</span>;

<span class="hljs-keyword">var</span> GCODE_BLOCK_SEND_SIZE = <span class="hljs-number">1000</span>;
<span class="hljs-keyword">var</span> GCODE_MIN_LINE_THRESH = <span class="hljs-number">250</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Map used by the jog command to turn incoming direction specifiers to g-code</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> JOG_AXES = {<span class="hljs-string">'x'</span>:<span class="hljs-string">'X'</span>, 
				<span class="hljs-string">'-x'</span>:<span class="hljs-string">'X-'</span>, 
				<span class="hljs-string">'y'</span>:<span class="hljs-string">'Y'</span>,
				<span class="hljs-string">'-y'</span>:<span class="hljs-string">'Y-'</span>,
				<span class="hljs-string">'z'</span>:<span class="hljs-string">'Z'</span>,
				<span class="hljs-string">'-z'</span>:<span class="hljs-string">'Z-'</span>,
				<span class="hljs-string">'a'</span>:<span class="hljs-string">'A'</span>,
				<span class="hljs-string">'-a'</span>:<span class="hljs-string">'A-'</span>,
				<span class="hljs-string">'b'</span>:<span class="hljs-string">'B'</span>,
				<span class="hljs-string">'-b'</span>:<span class="hljs-string">'B-'</span>,
				<span class="hljs-string">'c'</span>:<span class="hljs-string">'C'</span>,
				<span class="hljs-string">'-c'</span>:<span class="hljs-string">'C-'</span>};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Error codes defined by G2
See <a href="https://github.com/synthetos/g2/blob/edge/TinyG2/tinyg2.h">https://github.com/synthetos/g2/blob/edge/TinyG2/tinyg2.h</a> for the latest error codes and messages</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">try</span> {
	<span class="hljs-keyword">var</span> G2_ERRORS = <span class="hljs-built_in">JSON</span>.parse(fs.readFileSync(<span class="hljs-string">'./data/g2_errors.json'</span>,<span class="hljs-string">'utf8'</span>));
} <span class="hljs-keyword">catch</span>(e) {
	<span class="hljs-keyword">var</span> G2_ERRORS = {};
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>G2 Constructor</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">G2</span>(<span class="hljs-params"></span>) </span>{
	<span class="hljs-keyword">this</span>.current_data = [];
	<span class="hljs-keyword">this</span>.current_gcode_data = [];
	<span class="hljs-keyword">this</span>.g2_status = {<span class="hljs-string">'stat'</span>:<span class="hljs-literal">null</span>, <span class="hljs-string">'posx'</span>:<span class="hljs-number">0</span>, <span class="hljs-string">'posy'</span>:<span class="hljs-number">0</span>, <span class="hljs-string">'posz'</span>:<span class="hljs-number">0</span>};
	<span class="hljs-keyword">this</span>.status = {<span class="hljs-string">'stat'</span>:<span class="hljs-string">'idle'</span>, <span class="hljs-string">'posx'</span>:<span class="hljs-number">0</span>, <span class="hljs-string">'posy'</span>:<span class="hljs-number">0</span>, <span class="hljs-string">'posz'</span>:<span class="hljs-number">0</span>};

	<span class="hljs-keyword">this</span>.gcode_queue = <span class="hljs-keyword">new</span> Queue();
	<span class="hljs-keyword">this</span>.pause_flag = <span class="hljs-literal">false</span>;
	<span class="hljs-keyword">this</span>.connected = <span class="hljs-literal">false</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Jogging state</p></div></div><div class="code"><div class="wrapper">	<span class="hljs-keyword">this</span>.jog_stop_pending = <span class="hljs-literal">false</span>;
	<span class="hljs-keyword">this</span>.jog_direction = <span class="hljs-literal">null</span>;
	<span class="hljs-keyword">this</span>.jog_command = <span class="hljs-literal">null</span>;
	<span class="hljs-keyword">this</span>.jog_heartbeat = <span class="hljs-literal">null</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Feedhold/flush</p></div></div><div class="code"><div class="wrapper">	<span class="hljs-keyword">this</span>.quit_pending = <span class="hljs-literal">false</span>;
	<span class="hljs-keyword">this</span>.stat = <span class="hljs-literal">null</span>;
	<span class="hljs-keyword">this</span>.hold = <span class="hljs-literal">null</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Readers and callbacks</p></div></div><div class="code"><div class="wrapper">	<span class="hljs-keyword">this</span>.expectations = [];
	<span class="hljs-keyword">this</span>.readers = {};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Members related to streaming</p></div></div><div class="code"><div class="wrapper">	<span class="hljs-keyword">this</span>.qtotal = <span class="hljs-number">0</span>;
	<span class="hljs-keyword">this</span>.flooded = <span class="hljs-literal">false</span>;
	<span class="hljs-keyword">this</span>.send_rate = <span class="hljs-number">1</span>;
	<span class="hljs-keyword">this</span>.lines_sent = <span class="hljs-number">0</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Event emitter inheritance and behavior setup</p></div></div><div class="code"><div class="wrapper">	events.EventEmitter.call(<span class="hljs-keyword">this</span>);	
	<span class="hljs-keyword">this</span>.setMaxListeners(<span class="hljs-number">50</span>);
}
util.inherits(G2, events.EventEmitter);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Actually open the serial port and configure G2 based on stored settings</p></div></div><div class="code"><div class="wrapper">G2.prototype.connect = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">control_path, gcode_path, callback</span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Store paths for safe keeping</p></div></div><div class="code"><div class="wrapper">	<span class="hljs-keyword">this</span>.control_path = control_path;
	<span class="hljs-keyword">this</span>.gcode_path = gcode_path;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Called once BOTH ports have been opened</p></div></div><div class="code"><div class="wrapper">	<span class="hljs-keyword">this</span>.connect_callback = callback;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Open both ports</p></div></div><div class="code"><div class="wrapper">	log.info(<span class="hljs-string">'Opening control port '</span> + control_path);
	<span class="hljs-keyword">this</span>.control_port = <span class="hljs-keyword">new</span> serialport.SerialPort(control_path, {rtscts:<span class="hljs-literal">true</span>}, <span class="hljs-literal">false</span>);
	<span class="hljs-keyword">if</span>(control_path !== gcode_path) {
		log.info(<span class="hljs-string">"Dual USB since control port and gcode port are different. ("</span> + <span class="hljs-keyword">this</span>.control_path + <span class="hljs-string">","</span> + <span class="hljs-keyword">this</span>.gcode_path + <span class="hljs-string">")"</span>);
		<span class="hljs-keyword">this</span>.gcode_port = <span class="hljs-keyword">new</span> serialport.SerialPort(gcode_path, {rtscts:<span class="hljs-literal">true</span>}, <span class="hljs-literal">false</span>);
	} <span class="hljs-keyword">else</span> {
		log.info(<span class="hljs-string">"Single USB since control port and gcode port are the same. ("</span> + <span class="hljs-keyword">this</span>.control_path + <span class="hljs-string">")"</span>);
		<span class="hljs-keyword">this</span>.gcode_port = <span class="hljs-keyword">this</span>.control_port;
	}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Handle errors</p></div></div><div class="code"><div class="wrapper">	<span class="hljs-keyword">this</span>.control_port.on(<span class="hljs-string">'error'</span>, <span class="hljs-keyword">this</span>.onSerialError.bind(<span class="hljs-keyword">this</span>));</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The control port is the only one to truly handle incoming data</p></div></div><div class="code"><div class="wrapper">	<span class="hljs-keyword">this</span>.control_port.on(<span class="hljs-string">'data'</span>, <span class="hljs-keyword">this</span>.onData.bind(<span class="hljs-keyword">this</span>));
	<span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.gcode_port !== <span class="hljs-keyword">this</span>.control_port) {
		<span class="hljs-keyword">this</span>.gcode_port.on(<span class="hljs-string">'error'</span>, <span class="hljs-keyword">this</span>.onSerialError.bind(<span class="hljs-keyword">this</span>));
		<span class="hljs-keyword">this</span>.gcode_port.on(<span class="hljs-string">'data'</span>, <span class="hljs-keyword">this</span>.onWAT.bind(<span class="hljs-keyword">this</span>));
	}

	<span class="hljs-keyword">var</span> onOpen = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) </span>{
		<span class="hljs-keyword">this</span>.controlWrite(<span class="hljs-string">"\x04"</span>)
		<span class="hljs-keyword">this</span>.gcodeWrite(<span class="hljs-string">"{clr:n}\n"</span>);
		<span class="hljs-keyword">this</span>.command(<span class="hljs-string">"M30"</span>);
		<span class="hljs-keyword">this</span>.requestStatusReport();
		<span class="hljs-keyword">this</span>.connected = <span class="hljs-literal">true</span>;
		callback(<span class="hljs-literal">null</span>, <span class="hljs-keyword">this</span>);
	}.bind(<span class="hljs-keyword">this</span>);

	<span class="hljs-keyword">this</span>.control_port.open(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error</span>) </span>{
		<span class="hljs-keyword">if</span>(error) {
			log.error(<span class="hljs-string">"ERROR OPENING CONTROL PORT "</span> + error );
			<span class="hljs-keyword">return</span> callback(error);
		}

		<span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.control_port !== <span class="hljs-keyword">this</span>.gcode_port) {
			<span class="hljs-keyword">this</span>.gcode_port.open(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error</span>) </span>{
				<span class="hljs-keyword">if</span>(error) {
					log.error(<span class="hljs-string">"ERROR OPENING GCODE PORT "</span> + error );
					<span class="hljs-keyword">return</span> callback(error);
				}
				onOpen(callback);
			}.bind(<span class="hljs-keyword">this</span>));
		} <span class="hljs-keyword">else</span> {
			onOpen(callback);
		}
	}.bind(<span class="hljs-keyword">this</span>));
};

G2.prototype.disconnect = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) </span>{
	<span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.control_port !== <span class="hljs-keyword">this</span>.gcode_port) {
		<span class="hljs-keyword">this</span>.control_port.close(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) </span>{
			<span class="hljs-keyword">this</span>.gcode_port.close(callback);   
		}.bind(<span class="hljs-keyword">this</span>));
	} <span class="hljs-keyword">else</span> {
		<span class="hljs-keyword">this</span>.control_port.close(callback);
	}

};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Log serial errors.  Most of these are exit-able offenses, though.</p></div></div><div class="code"><div class="wrapper">G2.prototype.onSerialError = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{
	<span class="hljs-comment">//if(this.connect_callback) {</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>this.connect_callback(data);</p></div></div><div class="code"><div class="wrapper">	<span class="hljs-comment">//}</span>
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Write data to the control port.  Log to the system logger.</p></div></div><div class="code"><div class="wrapper">G2.prototype.controlWrite = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">s</span>) </span>{
	t = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime();
	log.g2(<span class="hljs-string">'--C-'</span> + t + <span class="hljs-string">'----&gt; '</span> + s.trim());
	<span class="hljs-keyword">this</span>.control_port.write(s);
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Write data to the gcode port.  Log to the system logger.</p></div></div><div class="code"><div class="wrapper">G2.prototype.gcodeWrite = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">s</span>) </span>{
	t = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime();
	log.g2(<span class="hljs-string">'--G-'</span> + t + <span class="hljs-string">'----&gt; '</span> + s.trim());
	<span class="hljs-keyword">this</span>.gcode_port.write(s);
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Write data to the serial port.  Log to the system logger.  Execute <strong>callback</strong> when transfer is complete.</p></div></div><div class="code"><div class="wrapper">G2.prototype.controlWriteAndDrain = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">s, callback</span>) </span>{
	t = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime();
	log.g2(<span class="hljs-string">'--C-'</span> + t + <span class="hljs-string">'----&gt; '</span> + s);
	<span class="hljs-keyword">this</span>.control_port.write(s, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
		<span class="hljs-keyword">this</span>.control_port.drain(callback);
	}.bind(<span class="hljs-keyword">this</span>));
};

G2.prototype.gcodeWriteAndDrain = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">s, callback</span>) </span>{
	t = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime();
	log.g2(<span class="hljs-string">'--G-'</span> + t + <span class="hljs-string">'----&gt; '</span> + s);
	<span class="hljs-keyword">this</span>.gcode_port.write(s, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
		<span class="hljs-keyword">this</span>.gcode_port.drain(callback);
	}.bind(<span class="hljs-keyword">this</span>));
};

G2.prototype.clearAlarm = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
	<span class="hljs-keyword">this</span>.command({<span class="hljs-string">"clear"</span>:<span class="hljs-literal">null</span>});
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Start or continue jogging in the direction provided, which is one of x,-x,y,-y,z-z,a,-a,b,-b,c,-c</p></div></div><div class="code"><div class="wrapper">G2.prototype.jog = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">direction</span>) </span>{

	<span class="hljs-keyword">var</span> MOVES = <span class="hljs-number">10</span>;
	<span class="hljs-keyword">var</span> FEED_RATE = <span class="hljs-number">60.0</span>;			<span class="hljs-comment">// in/min</span>
	<span class="hljs-keyword">var</span> MOVE_DISTANCE = <span class="hljs-number">0.05</span>;		<span class="hljs-comment">// in</span>
	<span class="hljs-keyword">var</span> START_DISTANCE = <span class="hljs-number">0.001</span>; 	<span class="hljs-comment">// sec</span>
	<span class="hljs-keyword">var</span> START_RATE = <span class="hljs-number">10.0</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Normalize the direction provided by the user</p></div></div><div class="code"><div class="wrapper">	direction = <span class="hljs-built_in">String</span>(direction).trim().toLowerCase().replace(<span class="hljs-regexp">/\+/g</span>,<span class="hljs-string">""</span>);

	<span class="hljs-keyword">if</span> ( !(direction <span class="hljs-keyword">in</span> JOG_AXES) &amp;&amp; !jog_stop_pending ) {
		<span class="hljs-keyword">this</span>.stopJog();
	}
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.jog_direction === <span class="hljs-literal">null</span>) {
		<span class="hljs-keyword">this</span>.jog_stop_pending = <span class="hljs-literal">false</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Build a block of short moves to start jogging
Starter move (plans down to zero no matter what so we make it short)</p></div></div><div class="code"><div class="wrapper">		<span class="hljs-keyword">var</span> d = JOG_AXES[direction];</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Continued burst of short moves</p></div></div><div class="code"><div class="wrapper">		<span class="hljs-keyword">var</span> starting_cmd = <span class="hljs-string">'G91 G1 '</span> + d + START_DISTANCE + <span class="hljs-string">' F'</span> + START_RATE;
		<span class="hljs-keyword">var</span> move = <span class="hljs-string">'G91 G1 '</span> + d + MOVE_DISTANCE + <span class="hljs-string">' F'</span> + FEED_RATE;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Compile moves into a list</p></div></div><div class="code"><div class="wrapper">		<span class="hljs-keyword">var</span> codes = [starting_cmd];</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Create string buffer of moves from list</p></div></div><div class="code"><div class="wrapper">		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i&lt;MOVES; i++) {codes.push(move);}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The queue report handler will keep up the jog if these are set</p></div></div><div class="code"><div class="wrapper">		<span class="hljs-keyword">this</span>.jog_command = move;
		<span class="hljs-keyword">this</span>.jog_direction = direction;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Build serial string and send</p></div></div><div class="code"><div class="wrapper">		<span class="hljs-keyword">try</span> {
			<span class="hljs-keyword">this</span>.gcodeWrite(codes.join(<span class="hljs-string">'\n'</span>));
		} <span class="hljs-keyword">finally</span> {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Timeout jogging if we don&#39;t get a keepalive from the client</p></div></div><div class="code"><div class="wrapper">			<span class="hljs-keyword">this</span>.jog_heartbeat = setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
				log.warn(<span class="hljs-string">"Jog abandoned!  Stopping due to timeout."</span>);
				<span class="hljs-keyword">this</span>.stopJog();
			}.bind(<span class="hljs-keyword">this</span>), JOG_TIMEOUT);
		}
	} <span class="hljs-keyword">else</span> {
		<span class="hljs-keyword">if</span>(direction == <span class="hljs-keyword">this</span>.jog_direction) {
			<span class="hljs-keyword">this</span>.jog_keepalive();
		}
	}
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Start or continue jogging in the direction provided, which is one of x,-x,y,-y,z-z,a,-a,b,-b,c,-c</p></div></div><div class="code"><div class="wrapper">G2.prototype.fixed_move = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">direction,step,speed</span>) </span>{
	<span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.quit_pending){ 
		log.warn(<span class="hljs-string">"WARNING QUIT PENDING WHILE DOING A FIXED MOVE"</span>)
	}
	<span class="hljs-keyword">var</span> mstep = <span class="hljs-built_in">parseFloat</span>(step ? step : <span class="hljs-number">0.01</span>).toFixed(<span class="hljs-number">5</span>);
	<span class="hljs-keyword">var</span> speed = <span class="hljs-built_in">parseFloat</span>(speed || <span class="hljs-number">60.0</span>).toFixed(<span class="hljs-number">2</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Normalize the direction provided by the user</p></div></div><div class="code"><div class="wrapper">	direction = <span class="hljs-built_in">String</span>(direction).trim().toLowerCase().replace(<span class="hljs-regexp">/\+/g</span>,<span class="hljs-string">""</span>);

	<span class="hljs-keyword">if</span> ( !(direction <span class="hljs-keyword">in</span> JOG_AXES)) {
		<span class="hljs-keyword">return</span>;
	}
	<span class="hljs-keyword">else</span> {
		<span class="hljs-keyword">var</span> d = JOG_AXES[direction];
		<span class="hljs-keyword">var</span> move;
		<span class="hljs-keyword">if</span>(mstep &gt; <span class="hljs-number">0.005</span>) {
			mstep -= <span class="hljs-number">0.005</span>;
			mstep = mstep.toFixed(<span class="hljs-number">5</span>)
			<span class="hljs-keyword">var</span> move = <span class="hljs-string">'G91 G1 '</span> + d + <span class="hljs-number">0.005</span> + <span class="hljs-string">' F'</span> + speed + <span class="hljs-string">'\n'</span> +<span class="hljs-string">'G1'</span> + d + mstep + <span class="hljs-string">'F'</span> + speed + <span class="hljs-string">'\n'</span>;
		} <span class="hljs-keyword">else</span> {
			move = <span class="hljs-string">'G91 G1 '</span> + d + mstep + <span class="hljs-string">' F'</span> + speed;
		}
		<span class="hljs-keyword">this</span>.gcodeWrite(move);
	} 
};

G2.prototype.jog_keepalive = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
	log.info(<span class="hljs-string">'Keeping jog alive.'</span>);
	clearTimeout(<span class="hljs-keyword">this</span>.jog_heartbeat);
	<span class="hljs-keyword">this</span>.jog_heartbeat = setTimeout(<span class="hljs-keyword">this</span>.stopJog.bind(<span class="hljs-keyword">this</span>), JOG_TIMEOUT);
};

G2.prototype.stopJog = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
	<span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.jog_direction &amp;&amp; !<span class="hljs-keyword">this</span>.jog_stop_pending) {
		log.debug(<span class="hljs-string">'stopJog()'</span>);
		<span class="hljs-keyword">this</span>.jog_stop_pending = <span class="hljs-literal">true</span>;
		clearTimeout(<span class="hljs-keyword">this</span>.jog_heartbeat);
		<span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.status.stat === STAT_RUNNING) {
			<span class="hljs-keyword">this</span>.quit();
		}
	}
};

G2.prototype.setUnits = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">units, callback</span>) </span>{
	<span class="hljs-keyword">if</span>(units === <span class="hljs-number">0</span> || units == <span class="hljs-string">'in'</span>) {
		gc = <span class="hljs-string">'G20'</span>;
	} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(units === <span class="hljs-number">1</span> || units === <span class="hljs-string">'mm'</span>) {
		gc = <span class="hljs-string">'G21'</span>;
	} <span class="hljs-keyword">else</span> {
		<span class="hljs-keyword">return</span> callback(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Invalid unit setting: '</span> + units))
	}
	<span class="hljs-keyword">this</span>.runString(gc, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
		<span class="hljs-keyword">this</span>.requestStatusReport(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">status</span>) </span>{
			callback(<span class="hljs-literal">null</span>);
		});
	}.bind(<span class="hljs-keyword">this</span>));
}

G2.prototype.requestStatusReport = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Register the callback to be called when the next status report comes in</p></div></div><div class="code"><div class="wrapper">	<span class="hljs-keyword">typeof</span> callback === <span class="hljs-string">'function'</span> &amp;&amp; <span class="hljs-keyword">this</span>.once(<span class="hljs-string">'status'</span>, callback);
	<span class="hljs-keyword">this</span>.command({<span class="hljs-string">'sr'</span>:<span class="hljs-literal">null</span>}); 
};

G2.prototype.requestQueueReport = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">this</span>.command({<span class="hljs-string">'qr'</span>:<span class="hljs-literal">null</span>}); };

G2.prototype.onWAT = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{
	<span class="hljs-keyword">var</span> s = data.toString(<span class="hljs-string">'ascii'</span>);
	<span class="hljs-keyword">var</span> len = s.length;
	<span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i&lt;len; i++) {
		c = s[i];
		<span class="hljs-keyword">if</span>(c === <span class="hljs-string">'\n'</span>) {
			string = <span class="hljs-keyword">this</span>.current_gcode_data.join(<span class="hljs-string">''</span>);
			t = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime();
			log.g2(<span class="hljs-string">'&lt;-G--'</span> + t + <span class="hljs-string">'---- '</span> + string);
			<span class="hljs-keyword">this</span>.current_gcode_data = [];
		} <span class="hljs-keyword">else</span> {
			<span class="hljs-keyword">this</span>.current_gcode_data.push(c);
		}
	}

};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Called for every chunk of data returned from G2</p></div></div><div class="code"><div class="wrapper">G2.prototype.onData = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{
	t = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime();
	<span class="hljs-comment">//log.debug('&lt;----' + t + '---- ' + data);</span>
	<span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'raw_data'</span>,data);
	<span class="hljs-keyword">var</span> s = data.toString(<span class="hljs-string">'ascii'</span>);
	<span class="hljs-keyword">var</span> len = s.length;
	<span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i&lt;len; i++) {
		c = s[i];
		<span class="hljs-keyword">if</span>(c === <span class="hljs-string">'\n'</span>) {
			<span class="hljs-keyword">var</span> json_string = <span class="hljs-keyword">this</span>.current_data.join(<span class="hljs-string">''</span>);
			t = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime();
			log.g2(<span class="hljs-string">'&lt;-C--'</span> + t + <span class="hljs-string">'---- '</span> + json_string);
			obj = <span class="hljs-literal">null</span>;
			<span class="hljs-keyword">try</span> {
				obj = <span class="hljs-built_in">JSON</span>.parse(json_string);
			}<span class="hljs-keyword">catch</span>(e){</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>A JSON parse error usually means the asynchronous LOADER SEGMENT NOT READY MESSAGE</p></div></div><div class="code"><div class="wrapper">				<span class="hljs-keyword">if</span>(json_string.trim() === <span class="hljs-string">'######## LOADER - SEGMENT NOT READY'</span>) {
					<span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'error'</span>, [-<span class="hljs-number">1</span>, <span class="hljs-string">'LOADER_SEGMENT_NOT_READY'</span>, <span class="hljs-string">'Asynchronous error: Segment not ready.'</span>]);
				} <span class="hljs-keyword">else</span> {
					<span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'error'</span>, [-<span class="hljs-number">1</span>, <span class="hljs-string">'JSON_PARSE_ERROR'</span>, <span class="hljs-string">"Could not parse response: '"</span> + json_string + <span class="hljs-string">"' ("</span> + e.toString() + <span class="hljs-string">")"</span>]);
				}
			} <span class="hljs-keyword">finally</span> {
				<span class="hljs-keyword">if</span>(obj) {
					<span class="hljs-keyword">this</span>.onMessage(obj);
				}
			}
			<span class="hljs-keyword">this</span>.current_data = [];
		} <span class="hljs-keyword">else</span> {
			<span class="hljs-keyword">this</span>.current_data.push(c);
		}
	}
};

G2.prototype.handleQueueReport = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">r</span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Deal with jog mode</p></div></div><div class="code"><div class="wrapper">	<span class="hljs-keyword">var</span> qo = r.qo || <span class="hljs-number">0</span>;
	<span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.jog_command &amp;&amp; (qo &gt; <span class="hljs-number">0</span>)) {
		<span class="hljs-keyword">this</span>.gcodeWrite(<span class="hljs-keyword">this</span>.jog_command + <span class="hljs-string">'\n'</span>);
		<span class="hljs-keyword">return</span>;
	}
};

G2.prototype.handleFooter = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) </span>{
	<span class="hljs-keyword">if</span>(response.f) {
		<span class="hljs-keyword">if</span>(response.f[<span class="hljs-number">1</span>] !== <span class="hljs-number">0</span>) {
			<span class="hljs-keyword">var</span> err_code = response.f[<span class="hljs-number">1</span>];
			<span class="hljs-keyword">var</span> err_msg = G2_ERRORS[err_code] || [<span class="hljs-string">'ERR_UNKNOWN'</span>, <span class="hljs-string">'Unknown Error'</span>];</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>TODO we&#39;ll have to go back and clean up alarms later
For now, let&#39;s not emit a bunch of errors into the log that don&#39;t mean anything to us</p></div></div><div class="code"><div class="wrapper">			<span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'error'</span>, [err_code, err_msg[<span class="hljs-number">0</span>], err_msg[<span class="hljs-number">1</span>]]);
		}
	}
};

G2.prototype.handleExceptionReport = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) </span>{
	<span class="hljs-keyword">if</span>(response.er) {
		<span class="hljs-keyword">var</span> stat = response.er.st
		<span class="hljs-keyword">if</span>(((stat === <span class="hljs-number">204</span>) || (stat === <span class="hljs-number">207</span>)) &amp;&amp; <span class="hljs-keyword">this</span>.quit_pending) {
			<span class="hljs-keyword">this</span>.gcodeWrite(<span class="hljs-string">"{clear:n}\nM30\n"</span>);
			<span class="hljs-keyword">this</span>.quit_pending = <span class="hljs-literal">false</span>;
		}
	}
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>0    machine is initializing
1    machine is ready for use
2    machine is in alarm state (shut down)
3    program stop or no more blocks (M0, M1, M60)
4    program end via M2, M30
5    motion is running
6    motion is holding
7    probe cycle active
8    machine is running (cycling)
9    machine is homing</p></div></div><div class="code"><div class="wrapper">G2.prototype.handleStatusReport = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) </span>{
	<span class="hljs-keyword">if</span>(response.sr) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Update our copy of the system status</p></div></div><div class="code"><div class="wrapper">		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> response.sr) {
			value = response.sr[key];
			<span class="hljs-keyword">this</span>.status[key] = value;
		}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Emit status no matter what</p></div></div><div class="code"><div class="wrapper">		<span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'status'</span>, <span class="hljs-keyword">this</span>.status);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Send more g-codes if warranted</p></div></div><div class="code"><div class="wrapper">		<span class="hljs-keyword">if</span>(<span class="hljs-string">'line'</span> <span class="hljs-keyword">in</span> response.sr) {
			line = response.sr.line;
			lines_left = <span class="hljs-keyword">this</span>.lines_sent - line;

			<span class="hljs-keyword">if</span>(lines_left &lt; GCODE_MIN_LINE_THRESH) {
				<span class="hljs-keyword">this</span>.last_line_seen = line;
				<span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.gcode_queue.getLength() &gt; <span class="hljs-number">0</span>) {
					log.warn(<span class="hljs-string">"Lines left has fallen to "</span> + lines_left + <span class="hljs-string">" sending more..."</span>);
					<span class="hljs-keyword">this</span>.sendMoreGCodes();
				}
			}
		}

		<span class="hljs-keyword">if</span>(<span class="hljs-string">'stat'</span> <span class="hljs-keyword">in</span> response.sr) {
			<span class="hljs-keyword">if</span>(response.sr.stat === STAT_STOP) {
				<span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.flushcallback) {
					<span class="hljs-keyword">this</span>.flushcallback(<span class="hljs-literal">null</span>);
					<span class="hljs-keyword">this</span>.flushcallback = <span class="hljs-literal">null</span>;
				}
			}
			<span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.expectations.length &gt; <span class="hljs-number">0</span>) {
				<span class="hljs-keyword">var</span> expectation = <span class="hljs-keyword">this</span>.expectations.pop();
				<span class="hljs-keyword">var</span> stat = states[<span class="hljs-keyword">this</span>.status.stat];
				<span class="hljs-keyword">if</span>(stat <span class="hljs-keyword">in</span> expectation) {
					<span class="hljs-keyword">if</span>(expectation[stat] === <span class="hljs-literal">null</span>) {
						<span class="hljs-keyword">this</span>.expectations.push(expectation);
					} <span class="hljs-keyword">else</span> {
						expectation[stat](<span class="hljs-keyword">this</span>);
					}
				} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-literal">null</span> <span class="hljs-keyword">in</span> expectation) {
					expectation[<span class="hljs-literal">null</span>](<span class="hljs-keyword">this</span>);
				}
			}
		}

		<span class="hljs-keyword">this</span>.stat = <span class="hljs-keyword">this</span>.status.stat !== <span class="hljs-literal">undefined</span> ? <span class="hljs-keyword">this</span>.status.stat : <span class="hljs-keyword">this</span>.stat;
		<span class="hljs-keyword">this</span>.hold = <span class="hljs-keyword">this</span>.status.hold !== <span class="hljs-literal">undefined</span> ? <span class="hljs-keyword">this</span>.status.hold : <span class="hljs-keyword">this</span>.hold;

	}
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Called once a proper JSON response is decoded from the chunks of data that come back from G2</p></div></div><div class="code"><div class="wrapper">G2.prototype.onMessage = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) </span>{
	</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>TODO more elegant way of dealing with &quot;response&quot; data.</p></div></div><div class="code"><div class="wrapper">	<span class="hljs-keyword">if</span>(response.r) {
		<span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'response'</span>, <span class="hljs-literal">false</span>, response.r);
		r = response.r;
	} <span class="hljs-keyword">else</span> {
		r = response;
	}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Deal with G2 status (top priority)</p></div></div><div class="code"><div class="wrapper">	<span class="hljs-keyword">this</span>.handleStatusReport(r);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Deal with exceptions</p></div></div><div class="code"><div class="wrapper">	<span class="hljs-keyword">this</span>.handleExceptionReport(r);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Deal with streaming (if response contains a queue report)</p></div></div><div class="code"><div class="wrapper">	<span class="hljs-keyword">this</span>.handleQueueReport(r);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Deal with footer</p></div></div><div class="code"><div class="wrapper">	<span class="hljs-keyword">this</span>.handleFooter(response); </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Emitted everytime a message is received, regardless of content</p></div></div><div class="code"><div class="wrapper">	<span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'message'</span>, response);

	<span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> r) {
		<span class="hljs-keyword">if</span>(key <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.readers) {
			<span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> <span class="hljs-keyword">this</span>.readers[key][<span class="hljs-keyword">this</span>.readers[key].length-<span class="hljs-number">1</span>] === <span class="hljs-string">'function'</span>) {
				<span class="hljs-comment">//if(r[key] !== null) {</span>
					callback = <span class="hljs-keyword">this</span>.readers[key].shift();
					callback(<span class="hljs-literal">null</span>, r[key]);
				<span class="hljs-comment">//}</span>
			}
		}
	}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Special message type for initial system ready message</p></div></div><div class="code"><div class="wrapper">	<span class="hljs-keyword">if</span>(r.msg &amp;&amp; (r.msg === <span class="hljs-string">"SYSTEM READY"</span>)) {
		<span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'ready'</span>, <span class="hljs-keyword">this</span>);
	}
};

G2.prototype.feedHold = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) </span>{
	<span class="hljs-keyword">this</span>.pause_flag = <span class="hljs-literal">true</span>;
	<span class="hljs-keyword">this</span>.flooded = <span class="hljs-literal">false</span>;
	<span class="hljs-keyword">typeof</span> callback === <span class="hljs-string">'function'</span> &amp;&amp; <span class="hljs-keyword">this</span>.once(<span class="hljs-string">'state'</span>, callback);
	log.debug(<span class="hljs-string">"Sending a feedhold"</span>);
	<span class="hljs-keyword">this</span>.controlWriteAndDrain(<span class="hljs-string">'!\n'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
		log.debug(<span class="hljs-string">"Drained."</span>);   
	});
};

G2.prototype.queueFlush = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) </span>{
	log.debug(<span class="hljs-string">'Clearing the queue.'</span>);
	<span class="hljs-keyword">this</span>.flushcallback = callback;
	<span class="hljs-keyword">this</span>.gcodeWrite(<span class="hljs-string">'{clear:n}\n'</span>);
	<span class="hljs-keyword">this</span>.controlWrite(<span class="hljs-string">'\%\n'</span>);
};

G2.prototype.resume = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
	<span class="hljs-keyword">this</span>.controlWrite(<span class="hljs-string">'~\n'</span>); <span class="hljs-comment">//cycle start command character</span>
	<span class="hljs-keyword">this</span>.pause_flag = <span class="hljs-literal">false</span>;
};


G2.prototype.quit = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
	<span class="hljs-keyword">this</span>.quit_pending = <span class="hljs-literal">true</span>;
	<span class="hljs-keyword">this</span>.gcode_queue.clear();
	<span class="hljs-keyword">this</span>.controlWrite(<span class="hljs-string">'\x04'</span>);
}

G2.prototype.get = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">key, callback</span>) </span>{
	<span class="hljs-keyword">var</span> keys;
	<span class="hljs-keyword">if</span>(key <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Array</span>) {
		keys = key;
		is_array = <span class="hljs-literal">true</span>;
	} <span class="hljs-keyword">else</span> {
		is_array = <span class="hljs-literal">false</span>;
		keys = [key];
	}
	<span class="hljs-keyword">async</span>.map(keys, </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Function called for each item in the keys array</p></div></div><div class="code"><div class="wrapper">		<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">k, cb</span>) </span>{
			cb = cb.bind(<span class="hljs-keyword">this</span>);
			cmd = {};
			cmd[k] = <span class="hljs-literal">null</span>;

			<span class="hljs-keyword">if</span>(k <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.readers) {
				<span class="hljs-keyword">this</span>.readers[k].push(cb);
			} <span class="hljs-keyword">else</span> {
				<span class="hljs-keyword">this</span>.readers[k] = [cb];
			}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Ensure that an errback is called if the data isn&#39;t read out</p></div></div><div class="code"><div class="wrapper">			setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
				<span class="hljs-keyword">if</span>(k <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.readers) {
						callbacks = <span class="hljs-keyword">this</span>.readers[k];
						stored_cb = callbacks[callbacks.length-<span class="hljs-number">1</span>];
						<span class="hljs-keyword">if</span>(cb == stored_cb) {
							<span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> cb == <span class="hljs-string">'function'</span>) {
								<span class="hljs-keyword">this</span>.readers[k].shift();
								cb(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Timeout"</span>), <span class="hljs-literal">null</span>);
							}
						}
					}
			}.bind(<span class="hljs-keyword">this</span>), CMD_TIMEOUT);

			<span class="hljs-keyword">this</span>.command(cmd);
		}.bind(<span class="hljs-keyword">this</span>),
	</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Function to call with the list of results</p></div></div><div class="code"><div class="wrapper">		<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, result</span>) </span>{
			<span class="hljs-keyword">if</span>(err) {
				<span class="hljs-keyword">return</span> callback(err, result);
			} <span class="hljs-keyword">else</span> {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If given an array, return one.  Else, return a single item.</p></div></div><div class="code"><div class="wrapper">				<span class="hljs-keyword">if</span>(is_array) {
					<span class="hljs-keyword">return</span> callback(err, result);
				} <span class="hljs-keyword">else</span> {
					<span class="hljs-keyword">return</span> callback(err, result[<span class="hljs-number">0</span>]);
				}
			}
		}
	);
};

G2.prototype.setMany = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">obj, callback</span>) </span>{
	<span class="hljs-keyword">var</span> keys = <span class="hljs-built_in">Object</span>.keys(obj);
	<span class="hljs-keyword">async</span>.map(keys, </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Function called for each item in the keys array</p></div></div><div class="code"><div class="wrapper">		<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">k, cb</span>) </span>{
			cmd = {};
			cmd[k] = obj[k];
			<span class="hljs-keyword">if</span>(k <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.readers) {
				<span class="hljs-keyword">this</span>.readers[k].push(cb.bind(<span class="hljs-keyword">this</span>));
			} <span class="hljs-keyword">else</span> {
				<span class="hljs-keyword">this</span>.readers[k] = [cb.bind(<span class="hljs-keyword">this</span>)];
			}
			<span class="hljs-keyword">this</span>.command(cmd);
		}.bind(<span class="hljs-keyword">this</span>),</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Function to call with the list of results</p></div></div><div class="code"><div class="wrapper">		<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, result</span>) </span>{
			<span class="hljs-keyword">if</span>(err) {
				<span class="hljs-keyword">return</span> callback(err, result);
			} <span class="hljs-keyword">else</span> {
				<span class="hljs-keyword">var</span> retval = {};
				<span class="hljs-keyword">try</span> {
					<span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>; i&lt;keys.length; i++) {
						retval[keys[i]] = result[i];
					}
				} <span class="hljs-keyword">catch</span>(e) {
					callback(e, <span class="hljs-literal">null</span>);
				}
				<span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>, retval);
			}
		}
	);
};

G2.prototype.set = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">key, value, callback</span>) </span>{
	cmd = {};
	cmd[key] = value;
	<span class="hljs-keyword">if</span> (key <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.readers) {
		<span class="hljs-keyword">this</span>.readers[key].push(callback);
	} <span class="hljs-keyword">else</span> {
		<span class="hljs-keyword">this</span>.readers[key] = [callback];
	}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Ensure that an errback is called if the data isn&#39;t read out</p></div></div><div class="code"><div class="wrapper">	setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
		<span class="hljs-keyword">if</span>(key <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.readers) {
			callbacks = <span class="hljs-keyword">this</span>.readers[key];
			stored_cb = callbacks[callbacks.length-<span class="hljs-number">1</span>];
			<span class="hljs-keyword">if</span>(callback == stored_cb) {
				<span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> callback == <span class="hljs-string">'function'</span>) {
					<span class="hljs-keyword">this</span>.readers[key].shift();
					callback(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Timeout"</span>), <span class="hljs-literal">null</span>);
				}
			}
		}
	}.bind(<span class="hljs-keyword">this</span>), CMD_TIMEOUT);

	<span class="hljs-keyword">this</span>.command(cmd);
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Send a command to G2 (can be string or JSON)</p></div></div><div class="code"><div class="wrapper">G2.prototype.command = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">obj</span>) </span>{
	<span class="hljs-keyword">var</span> cmd;
	<span class="hljs-keyword">if</span>((<span class="hljs-keyword">typeof</span> obj) == <span class="hljs-string">'string'</span>) {
		cmd = obj.trim();
		<span class="hljs-comment">//this.controlWrite('{"gc":"'+cmd+'"}\n');</span>
		<span class="hljs-keyword">this</span>.gcodeWrite(cmd + <span class="hljs-string">'\n'</span>);
	} <span class="hljs-keyword">else</span> {
		cmd = <span class="hljs-built_in">JSON</span>.stringify(obj);
		<span class="hljs-keyword">this</span>.controlWrite(cmd + <span class="hljs-string">'\n'</span>);
	}
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Send a (possibly multi-line) string
An M30 will be placed at the end to put the machine back in the &quot;idle&quot; state</p></div></div><div class="code"><div class="wrapper">G2.prototype.runString = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data, callback</span>) </span>{
	<span class="hljs-keyword">this</span>.runSegment(data + <span class="hljs-string">"\nM30\n"</span>, callback);
};

G2.prototype.runImmediate = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data, callback</span>) </span>{
	<span class="hljs-keyword">this</span>.expectStateChange( {
		<span class="hljs-string">'end'</span>:callback,
		<span class="hljs-string">'stop'</span>:callback,
		<span class="hljs-string">'timeout'</span>:<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
			callback(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Timeout while running immediate gcode"</span>));
		}
	});
	<span class="hljs-keyword">this</span>.runString(data);
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Send a (possibly multi-line) string</p></div></div><div class="code"><div class="wrapper">G2.prototype.runSegment = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data, callback</span>) </span>{
	line_count = <span class="hljs-number">0</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Divide string into a list of lines</p></div></div><div class="code"><div class="wrapper">	lines = data.split(<span class="hljs-string">'\n'</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Cleanup the lines and enqueue</p></div></div><div class="code"><div class="wrapper">	<span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i&lt;lines.length; i++) {
		line_count += <span class="hljs-number">1</span>;
		line = lines[i].trim().toUpperCase();
		<span class="hljs-keyword">if</span>(callback) {
			callback.line = line_count;
		}
		<span class="hljs-keyword">this</span>.gcode_queue.enqueue(line);
	}

	<span class="hljs-keyword">this</span>.lines_sent = <span class="hljs-number">0</span>;
	<span class="hljs-keyword">this</span>.sendMoreGCodes();</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Kick off the run if any lines were queued</p></div></div><div class="code"><div class="wrapper">	<span class="hljs-keyword">if</span>(line_count &gt; <span class="hljs-number">0</span>) {
		<span class="hljs-keyword">this</span>.pause_flag = <span class="hljs-literal">false</span>;
		<span class="hljs-keyword">typeof</span> callback === <span class="hljs-string">"function"</span> &amp;&amp; callback(<span class="hljs-literal">null</span>);
	} <span class="hljs-keyword">else</span> {
		<span class="hljs-keyword">typeof</span> callback === <span class="hljs-string">"function"</span> &amp;&amp; callback(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"No G-codes were present in the provided string"</span>));
	}
};

G2.prototype.sendMoreGCodes = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
	codes = <span class="hljs-keyword">this</span>.gcode_queue.multiDequeue(GCODE_BLOCK_SEND_SIZE);
	<span class="hljs-keyword">if</span>(codes.length &gt; <span class="hljs-number">0</span>) {
		<span class="hljs-keyword">this</span>.lines_sent += codes.length;
		<span class="hljs-keyword">this</span>.gcodeWrite(codes.join(<span class="hljs-string">'\n'</span>) + <span class="hljs-string">'\n'</span>);
	}
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Function works like &quot;once()&quot; for a state change
callbacks is an associative array mapping states to callbacks
If the <em>next</em> state change matches a state in the associative array, the callback it maps to is called.
If null is specified in the array, this callback is used for any state that is unspecified</p>
<p>eg:
this.expectStateChange {
                         STAT_END : end_callback,
                         STAT_PAUSE : pause_callback,
                         null : other_callback};</p>
<p>In the above example, when the next change of state happens, the appropriate callback is called in the case
that the new state is either STAT_END or STAT_PAUSE.  If the new state is neither, other_callback is called.</p></div></div><div class="code"><div class="wrapper">G2.prototype.expectStateChange = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callbacks</span>) </span>{
	<span class="hljs-keyword">if</span>(<span class="hljs-string">"timeout"</span> <span class="hljs-keyword">in</span> callbacks) {
		<span class="hljs-keyword">var</span> fn = callbacks.timeout;
		setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
			<span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.expectations.length &gt; <span class="hljs-number">0</span>) {
				callbacks = <span class="hljs-keyword">this</span>.expectations[<span class="hljs-keyword">this</span>.expectations.length-<span class="hljs-number">1</span>];
				<span class="hljs-keyword">if</span>(callbacks.timeout === fn) {
					log.debug(<span class="hljs-string">"Calling timeout function"</span>);
					<span class="hljs-keyword">this</span>.expectations.pop();
					fn(<span class="hljs-keyword">this</span>);
				}
			}
		}.bind(<span class="hljs-keyword">this</span>), EXPECT_TIMEOUT);
	}
	<span class="hljs-keyword">this</span>.expectations.push(callbacks);
};

states = {
	<span class="hljs-number">0</span> : <span class="hljs-string">"init"</span>,
	<span class="hljs-number">1</span> : <span class="hljs-string">"ready"</span>,
	<span class="hljs-number">2</span> : <span class="hljs-string">"alarm"</span>,
	<span class="hljs-number">3</span> : <span class="hljs-string">"stop"</span>,
	<span class="hljs-number">4</span> : <span class="hljs-string">"end"</span> ,
	<span class="hljs-number">5</span> : <span class="hljs-string">"running"</span>,
	<span class="hljs-number">6</span> : <span class="hljs-string">"holding"</span>,
	<span class="hljs-number">7</span> : <span class="hljs-string">"probe"</span>,
	<span class="hljs-number">8</span> : <span class="hljs-string">"cycling"</span>,
	<span class="hljs-number">9</span> : <span class="hljs-string">"homing"</span>
};

state = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">s</span>) </span>{
	<span class="hljs-keyword">return</span> states[s];
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>export the class</p></div></div><div class="code"><div class="wrapper">exports.G2 = G2;

exports.STAT_INIT = STAT_INIT;
exports.STAT_READY = STAT_READY;
exports.STAT_ALARM = STAT_ALARM;
exports.STAT_STOP = STAT_STOP;
exports.STAT_END = STAT_END;
exports.STAT_RUNNING = STAT_RUNNING;
exports.STAT_HOLDING = STAT_HOLDING;
exports.STAT_PROBE = STAT_PROBE;
exports.STAT_CYCLING = STAT_CYCLING;
exports.STAT_HOMING = STAT_HOMING;

G2.prototype.STAT_INIT = STAT_INIT;
G2.prototype.STAT_READY = STAT_READY;
G2.prototype.STAT_ALARM = STAT_ALARM;
G2.prototype.STAT_STOP = STAT_STOP;
G2.prototype.STAT_END = STAT_END;
G2.prototype.STAT_RUNNING = STAT_RUNNING;
G2.prototype.STAT_HOLDING = STAT_HOLDING;
G2.prototype.STAT_PROBE = STAT_PROBE;
G2.prototype.STAT_CYCLING = STAT_CYCLING;
G2.prototype.STAT_HOMING = STAT_HOMING;</div></div></div></div></body></html>