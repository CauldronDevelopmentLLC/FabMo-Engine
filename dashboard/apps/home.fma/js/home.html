<!DOCTYPE html><html lang="en"><head><title>dashboard/apps/home.fma/js/home</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../../../"><meta name="groc-document-path" content="dashboard/apps/home.fma/js/home"><meta name="groc-project-path" content="dashboard/apps/home.fma/js/home.js"><link rel="stylesheet" type="text/css" media="all" href="../../../../assets/style.css"><script type="text/javascript" src="../../../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">dashboard/apps/home.fma/js/home.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-built_in">require</span>(<span class="hljs-string">'jquery'</span>);
<span class="hljs-keyword">var</span> Foundation = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../../../static/js/libs/foundation.min.js'</span>);;
<span class="hljs-keyword">var</span> Fabmo = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../../../static/js/libs/fabmo.js'</span>);
<span class="hljs-keyword">var</span> Sortable = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./Sortable.js'</span>);
<span class="hljs-keyword">var</span> fabmo = <span class="hljs-keyword">new</span> Fabmo;
<span class="hljs-keyword">var</span> order = [];
<span class="hljs-keyword">var</span> notApp = [];
<span class="hljs-keyword">var</span> newOrder = [];




setupAppManager();

    



<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">launch</span>(<span class="hljs-params"> id </span>)</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
        fabmo.launchApp(id);
    }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getOrder</span> (<span class="hljs-params">callback</span>) </span>{
        fabmo.getAppConfig(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>)</span>{
            <span class="hljs-keyword">if</span> (data){
                <span class="hljs-keyword">if</span> (data.appOrder) {
                    order = data.appOrder;
                } 
                callback(<span class="hljs-literal">null</span>, data);
            } <span class="hljs-keyword">else</span> {
                callback(err);
            }
        });

}



<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">refreshApps</span>(<span class="hljs-params">callback</span>) </span>{
    newOrder = [];
        getOrder(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>)</span>{
            <span class="hljs-keyword">if</span>(err){
                <span class="hljs-built_in">console</span>.log(err);
            } <span class="hljs-keyword">else</span> {
                fabmo.getApps(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err,apps</span>)</span>{
                    <span class="hljs-keyword">if</span> (apps) {
                        <span class="hljs-keyword">var</span> menu = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'app_menu_container'</span>);
                        menu.innerHTML = <span class="hljs-string">""</span>;
                        <span class="hljs-keyword">var</span> file = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'file'</span>);
                        file.value = <span class="hljs-string">""</span>;
                        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; order.length; i++) {
                            <span class="hljs-keyword">var</span> obj = findById(apps, order[i]);
                            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> obj != <span class="hljs-string">"undefined"</span>) {
                                newOrder.push(obj.id);
                            }
                        };
    
                            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; apps.length; i++) {
                                <span class="hljs-keyword">if</span> (apps[i].icon_display !== <span class="hljs-string">"none"</span>) {
                                    <span class="hljs-keyword">if</span> ( ($.inArray(apps[i].id, order)) &gt; -<span class="hljs-number">1</span> ) {
                                        
                                    } <span class="hljs-keyword">else</span> {
                                        newOrder.push(apps[i].id);
                                    }
                                }
                            }
    
                            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; notApp.length; i++) {
                                <span class="hljs-keyword">if</span> ( $.inArray(notApp[i], newOrder) &gt; -<span class="hljs-number">1</span> ) {
                                    <span class="hljs-keyword">var</span> ind = newOrder.indexOf(notApp[i]);
                                    newOrder.splice(ind,<span class="hljs-number">1</span>);
                                }
                            }
    
                            <span class="hljs-keyword">var</span> noDupesArr = (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">arr</span>)</span>{
                                <span class="hljs-keyword">var</span> m = {}, noDupesArr = []
                                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i&lt;arr.length; i++) {
                                <span class="hljs-keyword">var</span> v = arr[i];
                                <span class="hljs-keyword">if</span> (!m[v]) {
                                    noDupesArr.push(v);
                                    m[v]=<span class="hljs-literal">true</span>;
                                }
                                }
                                <span class="hljs-keyword">return</span> noDupesArr;
                            })(newOrder);
    
                            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; noDupesArr.length; i++) {
                                <span class="hljs-keyword">var</span> obj = findById(apps, noDupesArr[i]);
                                makeListItem(menu, obj);
                            }
    
                        
                        fabmo.getAppConfig(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>)</span>{
                            data.appOrder = newOrder;
                            fabmo.setAppConfig(data, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>)</span>{
    
                            }) 
                        });
    
    
                        <span class="hljs-keyword">var</span> listItem = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">"ul"</span>);
                        listItem.setAttribute(<span class="hljs-string">"id"</span>, <span class="hljs-string">"add"</span>);
                        listItem.setAttribute(<span class="hljs-string">"class"</span>, <span class="hljs-string">"app_add"</span>);
                        menu.appendChild(listItem);
                        <span class="hljs-keyword">var</span> id = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">"add"</span>);
                        id.innerHTML = <span class="hljs-string">"&lt;div class='font-container'&gt;&lt;span class='fa fa-plus'&gt;&lt;/span&gt;&lt;/div&gt;"</span>;
                        $(<span class="hljs-string">'#add'</span>).click(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) </span>{
                            $(<span class="hljs-string">'#file'</span>).trigger(<span class="hljs-string">'click'</span>);
                        });
                        <span class="hljs-keyword">var</span> timeoutId = <span class="hljs-number">0</span>;
                        $(<span class="hljs-string">'.app_item'</span>).on(<span class="hljs-string">'mousedown touchstart'</span>,  <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
                            timeoutId = setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
                                holdfunction(e);
                            }, <span class="hljs-number">1500</span>);
                        }).on(<span class="hljs-string">'mouseup mouseleave touchend'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
                            clearTimeout(timeoutId);
                        });
                        
                        
                        callback(<span class="hljs-literal">null</span>,apps);
                    } <span class="hljs-keyword">else</span> {
                        callback(err);
                    }
                });

            }
        });


  

}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">makeListItem</span> (<span class="hljs-params">menu, obj</span>) </span>{

     <span class="hljs-keyword">var</span> listItem = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">"li"</span>);
        listItem.setAttribute(<span class="hljs-string">"id"</span>, obj.id);
        listItem.setAttribute(<span class="hljs-string">"class"</span>, <span class="hljs-string">"app_item"</span>);
        listItem.setAttribute(<span class="hljs-string">"data-id"</span>, obj.id);
        menu.appendChild(listItem);
        <span class="hljs-keyword">var</span> id = <span class="hljs-built_in">document</span>.getElementById(obj.id);
        <span class="hljs-keyword">var</span> path = obj.icon_url;
        id.innerHTML = <span class="hljs-string">'&lt;img src=/'</span>+path+<span class="hljs-string">'&gt;&lt;div class="deleteApp"&gt;&lt;div&gt;x&lt;/div&gt;&lt;/div&gt;&lt;div class="appname"&gt;'</span>+obj.name+<span class="hljs-string">'&lt;/div&gt;'</span>;
        $(<span class="hljs-string">'#'</span>+obj.id).click(launch(obj.id));
        $(<span class="hljs-string">'#'</span>+obj.id).css(<span class="hljs-string">'background-color'</span>,obj.icon_background_color);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">findById</span>(<span class="hljs-params">source, id</span>) </span>{

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; source.length; i++) {
    <span class="hljs-keyword">if</span> (source[i].id === id) {

      <span class="hljs-keyword">return</span> source[i];
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( i === (source.length - <span class="hljs-number">1</span>) )
        notApp.push(id);
  }
}

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setupAppManager</span>(<span class="hljs-params"></span>) </span>{
        refreshApps(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>)</span>{
            <span class="hljs-keyword">if</span>(err) {
                <span class="hljs-built_in">console</span>.log(err);
            } <span class="hljs-keyword">else</span> {
                setUpSort();
            }
        });
        
        $(<span class="hljs-string">'#file'</span>).change(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) </span>{
            startBusy();
            fabmo.submitApp($(<span class="hljs-string">'#file'</span>), {}, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
                stopBusy();
                <span class="hljs-keyword">if</span> (err) {
                    fabmo.notify(<span class="hljs-string">'error'</span>, <span class="hljs-string">"Could not install app:&lt;/br&gt;"</span> + (err.message || err));
                } <span class="hljs-keyword">else</span> {

                    fabmo.notify(<span class="hljs-string">'success'</span>, data.length + <span class="hljs-string">" app"</span> + ((data.length &gt; <span class="hljs-number">1</span>) ? <span class="hljs-string">'s'</span> : <span class="hljs-string">''</span>) + <span class="hljs-string">" installed successfully."</span>);
                    newOrder.push(data[<span class="hljs-number">0</span>].info.id);
                    fabmo.getAppConfig(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>)</span>{
                        data.appOrder = newOrder;
                        fabmo.setAppConfig(data, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>)</span>{
                            <span class="hljs-keyword">if</span> (err) {
                                <span class="hljs-built_in">console</span>.log(err);
                            }<span class="hljs-keyword">else</span> {
                                refreshApps(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>)</span>{
                                    <span class="hljs-keyword">if</span>(err) {
                                        <span class="hljs-built_in">console</span>.log(err);
                                    } <span class="hljs-keyword">else</span> {
                                        setUpSort();
                                    }
                                });
                            }
                        }) 
                     });
                    
                }
                
            });

        });

    }
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setUpSort</span>(<span class="hljs-params"></span>)</span>{

    <span class="hljs-keyword">var</span> el = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'app_menu_container'</span>);
    <span class="hljs-keyword">var</span> sortable = Sortable.create(el, {
        ghostClass: <span class="hljs-string">'ghost'</span>,
        chosenClass: <span class="hljs-string">'chosen'</span>,
        dataIdAttr: <span class="hljs-string">'data-id'</span>,
        clickDelay: <span class="hljs-number">0</span>,
        touchDelay: <span class="hljs-number">100</span>,
        animation: <span class="hljs-number">150</span>,
        onEnd: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">evt</span>) </span>{
            <span class="hljs-keyword">var</span> order = sortable.toArray();
            fabmo.getAppConfig(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>)</span>{
                data.appOrder = order;
                fabmo.setAppConfig(data, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>)</span>{
            }); 
        });

        },

    });
}

<span class="hljs-keyword">var</span> downTimer = <span class="hljs-literal">null</span>;

<span class="hljs-keyword">var</span> timeoutId = <span class="hljs-number">0</span>;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">holdfunction</span> (<span class="hljs-params">e</span>) </span>{
   <span class="hljs-keyword">var</span> id = e.delegateTarget.id;
   $(<span class="hljs-string">'.filter'</span>).show();
   $( <span class="hljs-string">"#"</span>+id).unbind( <span class="hljs-string">"click"</span> );
   $(<span class="hljs-string">'.deleteApp, .filter'</span>,  <span class="hljs-string">"#"</span>+id).unbind(<span class="hljs-string">"click"</span>);
   $(<span class="hljs-string">'.app_item:not("#'</span>+id+<span class="hljs-string">'")'</span>).addClass(<span class="hljs-string">'blur'</span>);

   $(<span class="hljs-string">'.app_add'</span>).addClass(<span class="hljs-string">'blur'</span>);
   $(<span class="hljs-string">'#'</span>+id+<span class="hljs-string">' .deleteApp'</span>).show();
   $(<span class="hljs-string">'#'</span>+id).css(<span class="hljs-string">'z-index'</span>, <span class="hljs-string">'1001'</span>);
   $(<span class="hljs-string">'.filter'</span>).on(<span class="hljs-string">'click'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
       $(<span class="hljs-string">'.filter'</span>).hide();
       $(<span class="hljs-string">'#'</span>+id+<span class="hljs-string">' .deleteApp'</span>).hide();
       $(<span class="hljs-string">'#'</span>+id).css(<span class="hljs-string">'z-index'</span>, <span class="hljs-string">'1'</span>);
       $(<span class="hljs-string">'#'</span>+id).click(launch(id));
       $(<span class="hljs-string">'.app_add'</span>).removeClass(<span class="hljs-string">'blur'</span>);
       $(<span class="hljs-string">'.app_item'</span>).removeClass(<span class="hljs-string">'blur'</span>);
   });
   $(<span class="hljs-string">'.deleteApp'</span>).click(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
       <span class="hljs-keyword">var</span> ind = newOrder.indexOf(id);
               newOrder.splice(ind,<span class="hljs-number">1</span>);
       fabmo.deleteApp(id, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>)</span>{
           <span class="hljs-keyword">if</span> (err){
               <span class="hljs-built_in">console</span>.log(err);
           } <span class="hljs-keyword">else</span> {
               fabmo.getAppConfig(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>)</span>{
                   data.appOrder = newOrder;
                   fabmo.setAppConfig(data, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>)</span>{
                       <span class="hljs-keyword">if</span> (err){
                           <span class="hljs-built_in">console</span>.log(err)
                       } <span class="hljs-keyword">else</span> {
                            $(<span class="hljs-string">'#'</span>+id).remove();
                            $(<span class="hljs-string">'.filter'</span>).hide();
                            $(<span class="hljs-string">'.app_add'</span>).removeClass(<span class="hljs-string">'blur'</span>);
                            $(<span class="hljs-string">'.app_item'</span>).removeClass(<span class="hljs-string">'blur'</span>);
                       }
                   });
               });
           }
       });
   })
}


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getsetFabmoCongif</span> (<span class="hljs-params"></span>)</span>{

}


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">startBusy</span>(<span class="hljs-params"></span>) </span>{
  $(<span class="hljs-string">"#add span"</span>).removeClass(<span class="hljs-string">'fa-plus'</span>).addClass(<span class="hljs-string">'fa-cog fa-spin'</span>);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">stopBusy</span>(<span class="hljs-params"></span>) </span>{
  $(<span class="hljs-string">"#add span"</span>).removeClass(<span class="hljs-string">'fa-cog fa-spin'</span>).addClass(<span class="hljs-string">'fa-plus'</span>);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setupDropTarget</span>(<span class="hljs-params"></span>) </span>{
  $(<span class="hljs-string">'#tabpending'</span>).dragster({
    enter: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">devt, evt</span>) </span>{
      $(<span class="hljs-string">'#tabpending'</span>).addClass(<span class="hljs-string">'hover'</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    },

    leave: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">devt, evt</span>) </span>{
      $(<span class="hljs-string">'#tabpending'</span>).removeClass(<span class="hljs-string">'hover'</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    },
    drop: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">devt, evt</span>) </span>{
      evt.preventDefault();
      <span class="hljs-keyword">try</span> {
        file = evt.originalEvent.dataTransfer.files;
        <span class="hljs-keyword">if</span>(file.length &gt; <span class="hljs-number">0</span>) {
          fabmo.submitJob(file, {}, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
            <span class="hljs-keyword">if</span> (err) {
              fabmo.notify(<span class="hljs-string">'error'</span>, err);
            }
            updateQueue();
          });
        }
      } <span class="hljs-keyword">finally</span> {
        $(<span class="hljs-string">'#tabpending'</span>).removeClass(<span class="hljs-string">'hover'</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      }
    }
  });
}</div></div></div></div></body></html>