var allow_canvas=true;var ratio=900;var pi=3.141592653589793;var s=null;var Tasks=[];var toolPath=null;var backPath=null;var gridPath=[];var c=null;var canvasColor="rgba(77, 135, 29, 0.8)";var toolpathColor="rgba(156, 33, 12, 0.25)";var appName="Rectangles";var selectShapes=true;$(document).ready(function(){s=new settings;s.synchForm();if(allow_canvas){c=new Canvas}});setAppSetting=function(e,t,n){if(localStorage.getItem("app-"+e)){var r=JSON.parse(localStorage.getItem("app-"+e))}else{var r={}}r[t]=n;localStorage.setItem("app-"+e,JSON.stringify(r))};getAppSetting=function(e,t){if(localStorage.getItem("app-"+e)){if(JSON.parse(localStorage.getItem("app-"+e))[t])return JSON.parse(localStorage.getItem("app-"+e))[t];else return false}else{return false}};delAppSetting=function(e,t){if(localStorage.getItem("app-"+e)){var n=JSON.parse(localStorage.getItem("app-"+e));delete n[t];localStorage.setItem("app-"+e,JSON.stringify(n))}};settings=function(){var e=getAppSetting(appName,"s")?getAppSetting(appName,"s"):false;this.x=e?e.x:6;this.y=e?e.y:8;this.z=e?e.z:.3;this.dz=e?e.dz:.1;this.x0=e?e.x0:0;this.y0=e?e.y0:0;this.z0=e?e.z0:.5;this.cut_speed=e?e.cut_speed:20;this.air_speed=e?e.air_speed:600;this.bit_d=e?e.bit_d:.125};settings.prototype.update=function(){for(var e in this){if($("#s_"+e).length){this[e]=parseFloat($("#s_"+e).val())}}};settings.prototype.synchForm=function(){for(var e in this){if($("#s_"+e).length){$("#s_"+e).val(this[e].toString())}}};settings.prototype.set=function(e,t){if(this[e]){this[e]=t;return true}else{return false}};settings.prototype.get=function(e){if(this[e]){return this[e]}else{return null}};$("#save-settings").click(function(){s.update();setAppSetting(appName,"s",s);if(c){c.loadSettings()}if(Tasks){Tasks.toolpath()}if(Tasks){Tasks.refreshGCode()}if(Tasks){Tasks.refreshCanvas()}});$("#default-settings").click(function(){delAppSetting(appName,"s");s=new settings;s.synchForm();if(Tasks){Tasks.toolpath()}if(Tasks){Tasks.refreshGCode()}if(Tasks){Tasks.refreshCanvas()}});var Selection=function(){this.selected=[]};Canvas=function(){this.grid=[];this.init();this.loadSettings()};Canvas.prototype.init=function(){$("#project_content").addClass("active");paper.install(window);paper.setup("myCanvas");this.resize();$("#project_content").removeClass("active");this.selectionTool()};Canvas.prototype.selectionTool=function(){var e=this;this.select=true;this.selectTool=new Tool;this.selectTool.onMouseDown=function(t){e.startClick=t.point};this.selectTool.onMouseUp=function(t){e.endClick=t.point;if(e.startClick.x>e.endClick.x){Tasks.selectInclusive()}else if(e.startClick.x<e.endClick.x){Tasks.selectExclusive()}}};Canvas.prototype.setRatio=function(){$(window).resize(function(){$("#canvas-container canvas").width($("#canvas-container").width());$("#canvas-container canvas").height($("#canvas-container").width()/s.x*s.y);$("#canvas-container").height($("#canvas-container").width()/s.x*s.y)})};Canvas.prototype.resize=function(){$("#project_content").addClass("active");ratio=$("#canvas-container canvas").width();view.viewSize=new Size(ratio,ratio/s.x*s.y);$("#canvas-container canvas").width($("#canvas-container").width());$("#canvas-container canvas").height($("#canvas-container").width()/s.x*s.y);$("#canvas-container").height($("#canvas-container").width()/s.x*s.y);$("#project_content").removeClass("active")};Canvas.prototype.loadSettings=function(){if(!s){console.log("No Settings object, Canvas use may cause App bugs")}else{$("#project_content").addClass("active");this.resize();project.clear();var e=1;var t=5;var n=10;var r=s.x<100?s.x<10?e:t:n;var i=s.y<100?s.y<10?e:t:n;$("#xScale").html("X : "+s.x+'" '+"("+r+'"/grad)');$("#yScale").html("y : "+s.y+'" '+"("+i+'"/grad)');for(var o=r;o<s.x;o+=r){var u=new Point(this.xPos(o),this.yPos(s.y));var a=new Point(this.xPos(o),this.yPos(0));var f=new Path.Line(u,a);f.strokeColor="#ddd";f.strokeWidth=3;this.grid.push(f)}for(var o=i;o<s.y;o+=i){var l=new Point(this.xPos(0),this.yPos(o));var c=new Point(this.xPos(s.x),this.yPos(o));var f=new Path.Line(l,c);f.strokeColor="#ddd";f.strokeWidth=3;this.grid.push(f)}view.draw();$("#project_content").removeClass("active")}};Canvas.prototype.xPos=function(e){return view.bounds.left+e*(view.bounds.width/s.x)};Canvas.prototype.yPos=function(e){return view.bounds.bottom-e*(view.bounds.height/s.y)};Canvas.prototype.Pos=function(e){console.log(e);return new Point(this.xPos(e.x),this.yPos(e.y))};Canvas.prototype.w=function(e){return e*(view.bounds.height/s.y)};Canvas.prototype.selectAction=function(e,t){console.log(e);var n=this;var r=e.id;$.each(e.canvas,function(t,n){n.bounds.selected=n.bounds.selected?false:true;n.bounds.selected?e.setCurrent(r):e.resetCurrent(r)})};Canvas.prototype.addLine=function(e){var t=this;e.canvas=[];var n=new Path.Line(this.addPoint(e.p0.x,e.p0.y),this.addPoint(e.p1.x,e.p1.y));n.strokeColor=canvasColor;n.strokeWidth=3;n.onClick=function(n){selectShapes?t.selectAction(e,"clickShape"):null};e.canvas.push(n);e.tCanvas=[];var r=0;var i=new Path.Line(new Point(this.xPos(e.t0.x),this.yPos(e.t0.y)),new Point(this.xPos(e.t1.x),this.yPos(e.t1.y)));i.strokeColor=toolpathColor;i.strokeWidth=this.w(s.bit_d)*.5;i.strokeCap="round";i.dashArray=[i.strokeWidth*2,i.strokeWidth*3];e.tCanvas.push(i);view.draw()};Canvas.prototype.removeLine=function(e){$.each(e.canvas,function(e,t){t.remove()});$.each(e.tCanvas,function(e,t){t.remove()});view.draw()};Canvas.prototype.addPoint=function(e,t,n){return new Point(this.xPos(e),this.yPos(t))};Canvas.prototype.addRectangle=function(e){e.canvas=[];var t=this;var n=new Path.Rectangle(new Point(this.xPos(e.p0.x),this.yPos(e.p0.y)),new Point(this.xPos(e.p1.x),this.yPos(e.p1.y)));n.strokeColor=canvasColor;n.strokeWidth=3;n.onClick=function(n){selectShapes?t.selectAction(e,"clickShape"):null};e.canvas.push(n);e.tCanvas=[];var r=0;for(r=0;r<e.t.length;r++){var i=new Path.Rectangle(new Point(this.xPos(e.t[r].p0.x),this.yPos(e.t[r].p0.y)),new Point(this.xPos(e.t[r].p1.x),this.yPos(e.t[r].p1.y)));i.strokeColor=toolpathColor;i.strokeWidth=this.w(s.bit_d)*.5;i.strokeCap="round";i.dashArray=[i.strokeWidth*2,i.strokeWidth*1];e.tCanvas.push(i)}view.draw()};Canvas.prototype.removeRectangle=function(e){$.each(e.canvas,function(e,t){t.remove()});$.each(e.tCanvas,function(e,t){t.remove()});view.draw()};Canvas.prototype.addCircle=function(e){var t=this;e.canvas=[];var n=new Path.Circle(new Point(this.xPos(e.p.x),this.yPos(e.p.y)),this.yPos(e.p.y-e.p0.y)-view.bounds.height);n.strokeColor=canvasColor;n.strokeWidth=3;n.onClick=function(n){selectShapes?t.selectAction(e,"clickShape"):null};e.canvas.push(n);e.tCanvas=[];var r=0;for(r=0;r<e.t.length;r++){var i=new Path.Circle(new Point(this.xPos(e.t[r].p.x),this.yPos(e.t[r].p.y)),this.yPos(e.t[r].p.y-e.t[r].p0.y)-view.bounds.height);i.strokeColor=toolpathColor;i.strokeWidth=this.w(s.bit_d)*.5;i.strokeCap="round";i.dashArray=[i.strokeWidth*2,i.strokeWidth*1];e.tCanvas.push(i)}view.draw()};Canvas.prototype.removeCircle=function(e){$.each(e.canvas,function(e,t){t.remove()});$.each(e.tCanvas,function(e,t){t.remove()});view.draw()};Canvas.prototype.addArc=function(e){e.canvas=[];var t=this;var n=new Path.Arc(new Point(this.xPos(e.p0.x),this.yPos(e.p0.y)),new Point(this.xPos(e.p1.x),this.yPos(e.p1.y)),new Point(this.xPos(e.p2.x),this.yPos(e.p2.y)));n.strokeColor=canvasColor;n.strokeWidth=3;n.onClick=function(n){selectShapes?t.selectAction(e,"clickShape"):null};e.canvas.push(n);e.tCanvas=[];var r=0;for(r=0;r<e.t.length;r++){var i=new Path.Arc(new Point(this.xPos(e.t[r].p0.x),this.yPos(e.t[r].p0.y)),new Point(this.xPos(e.t[r].p1.x),this.yPos(e.t[r].p1.y)),new Point(this.xPos(e.t[r].p2.x),this.yPos(e.t[r].p2.y)));i.strokeColor=toolpathColor;i.strokeWidth=this.w(s.bit_d)*.5;i.strokeCap="round";i.dashArray=[i.strokeWidth*2,i.strokeWidth*1];e.tCanvas.push(i)}view.draw()};Canvas.prototype.removeArc=function(e){$.each(e.canvas,function(e,t){t.remove()});$.each(e.tCanvas,function(e,t){t.remove()});view.draw()};gcode=function(){this.body="";this.init()};gcode.prototype.init=function(){this.header=";Hi,I am a gCode object created with FabMo Shapes Library \n";this.header+=";Absolutes Positions \n";this.header+="G90 \n";this.header+=";Z Security Position \n";this.header+="G1Z"+s.z0.toString()+"F"+s.air_speed+"\n";this.header+=";Go To X0/Y0 compensated with offset (if any) \n";this.header+="G1X"+s.x0.toString()+"Y"+s.y0.toString()+"F"+s.air_speed+"\n";this.footer+=";Arriving to the Footer of GCode File \n";this.footer+=";Z Security Position \n";this.footer+="G1Z"+s.z0+"F"+s.air_speed+"\n";this.footer+=";Go to the end position of a Handibot \n";this.footer+="G1X6Y8F"+s.air_speed+"\n"};gcode.prototype.securZ=function(){this.body+="G1Z"+s.z0+"F"+s.air_speed+"\n"};gcode.prototype.getGc=function(){return""+this.header+this.body+this.footer};gcode.prototype.G1=function(e,t,n,r){console.log("G1"+(e?"X"+(e+r.x0).toString():"")+(t?"Y"+(t+r.y0).toString():"")+(n?"Z"+n.toString():"")+"F"+r+"\n");return"G1"+(e?"X"+(e+r.x0):"")+(t?"Y"+(t+r.y0):"")+(n?"Z"+n:"")+"F"+r+"\n"};Tasks.reset=function(){$.each(this,function(e,t){t.removeCanvas()});this.length=0;setAppSetting(appName,"Tasks",this);this.view()};Tasks.addLine=function(){var e=new line(this.length.toString());this.push(e);setAppSetting(appName,"Tasks",this);this.view()};Tasks.addRectangle=function(){var e=new rectangle(this.length.toString());this.push(e);setAppSetting(appName,"Tasks",this);this.view()};Tasks.addCircle=function(){var e=new circle(this.length.toString());this.push(e);setAppSetting(appName,"Tasks",this);this.view()};Tasks.addArc=function(){var e=new arc(this.length.toString());this.push(e);setAppSetting(appName,"Tasks",this);this.view()};Tasks.remove=function(e){Tasks[Tasks.pos(e)].removeCanvas();this.splice(Tasks.pos(e),1);setAppSetting(appName,"Tasks",this);this.view()};Tasks.edit=function(e){console.log("id a modifier : "+e);var t=this[this.pos(e)];t.setCurrent();t.setForm();this.view()};Tasks.save=function(e){if(this.pos(e)!=null){console.log("Founded");var t=this[this.pos(e)];t.getForm();t.resetCurrent();setAppSetting(appName,"Tasks",this);this.view()}else{this.addCircle()}};Tasks.setCurrent=function(e){if(e){Tasks[Tasks.pos(e)].setCurrent()}else{console.log("This function need an id to set a shape as the current one")}};Tasks.resetCurrent=function(e){if(e){Tasks[Tasks.pos(e)].resetCurrent()}else{$.each(this,function(e,t){t.resetCurrent()})}};Tasks.view=function(){var e="";$.each(this,function(t,n){e+=n.addTaskList()});$(".list-tasks-container").html(e);listenClickTasks()};Tasks.toolpath=function(){$.each(this,function(e,t){t.toolpath()})};Tasks.refreshGCode=function(){$.each(this,function(e,t){t.gCode()})};Tasks.refreshCanvas=function(){$.each(this,function(e,t){t.removeCanvas();t.addCanvas()})};Tasks.gCode=function(e){var t=0;for(t=0;t<Tasks.length;t++){e.body=e.body+Tasks[t].c;console.log(e.body)}};Tasks.pos=function(e){if(!e){console.log("This Function need an ID passed in parameter, in order to work correctly")}else{var t=null;$.each(this,function(n,r){if(r.id==e){t=n}});return t}};Tasks.sort=function(){this.sort(function(e,t){return e.id>t.id?1:t.id>e.id?-1:0})};Tasks.selectExclusive=function(){var e=e;$.each(this,function(e,t){var n=t;$.each(t.canvas,function(e,t){if(c.startClick.x<=t.bounds.topLeft.x&&c.startClick.y<=t.bounds.topLeft.y&&c.endClick.x>=t.bounds.bottomRight.x&&c.endClick.y>=t.bounds.bottomRight.y){c.selectAction(n)}})})};Tasks.selectInclusive=function(e){var e=e;$.each(this,function(e,t){var n=t;$.each(t.canvas,function(e,t){if(t.bounds.topRight.x<=c.startClick.x&&c.endClick.x<=t.bounds.topRight.x&&(c.startClick.y>=t.bounds.topRight.y&&c.startClick.y<=t.bounds.bottomLeft.y||c.startClick.y<=t.bounds.topRight.y&&c.endClick.y>=t.bounds.topRight.y||c.startClick.y>=t.bounds.bottomLeft.y&&c.endClick.y<=t.bounds.bottomLeft.y)||t.bounds.bottomLeft.x<=c.startClick.x&&c.endClick.x<=t.bounds.bottomLeft.x&&(c.startClick.y>=t.bounds.topRight.y&&c.startClick.y<=t.bounds.bottomLeft.y||c.startClick.y<=t.bounds.topRight.y&&c.endClick.y>=t.bounds.topRight.y||c.startClick.y>=t.bounds.bottomLeft.y&&c.endClick.y<=t.bounds.bottomLeft.y)||t.bounds.topRight.y>=c.startClick.y&&c.endClick.y>=t.bounds.topRight.y&&(c.startClick.x<=t.bounds.topRight.x&&c.startClick.x>=t.bounds.bottomLeft.x||c.startClick.x>=t.bounds.topRight.x&&c.endClick.x<=t.bounds.topRight.x||c.startClick.x>=t.bounds.bottomLeft.x&&c.endClick.x<=t.bounds.bottomLeft.x)||t.bounds.bottomLeft.y>=c.startClick.y&&c.endClick.y>=t.bounds.bottomLeft.y&&(c.startClick.x<=t.bounds.topRight.x&&c.startClick.x>=t.bounds.bottomLeft.x||c.startClick.x>=t.bounds.topRight.x&&c.endClick.x<=t.bounds.topRight.x||c.startClick.x>=t.bounds.bottomLeft.x&&c.endClick.x<=t.bounds.bottomLeft.x)){c.selectAction(n)}})})};calculAlpha=function(e,t){var n=0;if(t.y!=e.y&&t.x!=e.x){n=Math.atan((t.y-e.y)/(t.x-e.x))}else{if(t.y==e.y){if(t.x-e.x>0){n=0}else{n=pi}}else if(t.x==e.x){if(t.y-e.y>0){n=pi/2}else{n=3*pi/2}}}return n};rot=function(e,t,n){var r=Math.round(Math.sqrt((t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y))*1e4)/1e4;var i=-n/180*pi;return new e(t.x*Math.cos(i)-t.y*Math.sin(i),t.x*Math.sin(i)+t.y*Math.cos(i))};pos=function(e,t,n,r,i){this.center=e?e:new p(null,null);this.left=t?t:new p(null,null);this.top=n?n:new p(null,null);this.right=r?r:new p(null,null);this.bottom=i?i:new p(null,null)};p=function(e,t){this.x=e;this.y=t};p.prototype.distanceFrom=function(e){return new p(this.x-e.x,this.y-e.y)};p.prototype.absoluteDistance=function(e){return Math.round(Math.sqrt(this.distanceFrom(e).x*this.distanceFrom(e).x+this.distanceFrom(e).y*this.distanceFrom(e).y)*1e4)/1e4};p.prototype.sameAxisThan=function(e){if(this.x==e.x||this.y==e.y){return true}else{return false}};p.prototype.middle=function(e){return new p(this.x+e.x/2,this.y+e.y/2)};p.prototype.translate=function(e){this.x+=e.x;this.y+=e.y};p.prototype.rotate=function(e,t){var n=-t/180*pi;var r=(this.x-e.x)*Math.cos(n)-(this.y-e.y)*Math.sin(n)+e.x;var i=(this.x-e.x)*Math.sin(n)+(this.y-e.y)*Math.cos(n)+e.y;this.x=r;this.y=i};p.prototype.mirror=function(e,t){if(t=="x"){this.rotate(new p(this.x,e.y),180)}else if(t=="y"){this.rotate(new p(e.x,this.y),180)}};line=function(e,t,n,r,i,s,o){this.id="line-"+e;this.pos=e;this.canvas=null;this.tCanvas=null;s?this.name=s:this.name=$("#line_name").val()?$("#line_name").val():this.id;this.current=0;this.p0=new p(t?t:$("#line_x0").length?parseFloat($("#line_x0").val()):0,n?n:$("#line_y0").length?parseFloat($("#line_y0").val()):0);this.p1=new p(r?r:$("#line_x1").length?parseFloat($("#line_x1").val()):0,i?i:$("#line_y1").length?parseFloat($("#line_y1").val()):0);this.side=o?o:$("input:radio[name='line_side']:checked").length?parseInt($("input:radio[name='line_side']:checked").val()):1;this.synch();$("#line_name").val("");$("#line_name").data("cid","")};line.prototype.update=function(e,t,n,r,i,s){this.p0=new p(e,t);this.p1=new p(n,r);this.side=s?s:1;if(i)this.name=i};line.prototype.rotate=function(e,t){this.p0.rotate(e,t);this.p1.rotate(e,t);this.synch()};line.prototype.mirror=function(e,t){this.p0.mirror(e,t);this.p1.mirror(e,t);this.synch()};line.prototype.translate=function(e){this.p0=translate(e);this.p1=translate(e);this.synch()};line.prototype.getPos=function(){this.position=new pos(this.p0.middle(this.p1),Math.min(this.p0.x,this.p1.x),Math.min(this.p0.y,this.p1.y),Math.min(this.p0.x,this.p1.x),Math.min(this.p0.x,this.p1.x))};line.prototype.setCurrent=function(){this.current=1};line.prototype.resetCurrent=function(){this.current=0};line.prototype.getForm=function(){this.update($("#line_x0").length?parseFloat($("#line_x0").val()):null,$("#line_y0").length?parseFloat($("#line_y0").val()):null,$("#line_x1").length?parseFloat($("#line_x1").val()):null,$("#line_y1").length?parseFloat($("#line_y1").val()):null,this.name=$("#line_name").val()?$("#line_name").val():this.id,$("input:radio[name='line_side']:checked").length?parseInt($("input:radio[name='line_side']:checked").val()):null);$("#line_name").val("");$("#line_name").data("cid","")};line.prototype.setForm=function(){if($("#line_name").length){$("#line_name").val(this.name)}if($("#line_name").length){$("#line_name").data("cid",this.id)}if($("#line_x0").length){$("#line_x0").val(this.p0.x.toString())}if($("#line_y0").length){$("#line_y0").val(this.p0.y.toString())}if($("#line_x1").length){$("#line_x1").val(this.p1.x.toString())}if($("#line_y1").length){$("#line_y1").val(this.p1.y.toString())}if($("input:radio[name='line_side']:checked").length){$("input:radio[name='line_side'][value='"+this.side+"']").attr("checked",true)}};line.prototype.toolpath=function(){var e=0;this.t0=new p(this.p0.x,this.p0.y);this.t1=new p(this.p1.x,this.p1.y);if(this.side!=3){e=calculAlpha(this.p0,this.p1);if(this.side==1){e=pi/2+e}else{e=3*pi/2+e}this.t0.x+=s.bit_d/2*Math.cos(e);this.t1.x+=s.bit_d/2*Math.cos(e);this.t0.y+=s.bit_d/2*Math.sin(e);this.t1.y+=s.bit_d/2*Math.sin(e)}};line.prototype.addTaskList=function(){var e="";e+="<tr class='"+(this.current?"current":"")+"' id='"+this.id+"'>";e+="<td>"+this.name+"</td>";e+="<td>("+this.p0.x.toString()+","+this.p0.y.toString()+") - ("+this.p1.x.toString()+","+this.p1.y.toString()+")</td>";e+="<td class='edit'><span>E</span></td>";e+="<td class='delete'><span>D</span></td>";e+="</tr>";return e};line.prototype.viewToolPath=function(){return true};line.prototype.removeCanvas=function(){if(c&&this.canvas){c.removeLine(this)}};line.prototype.addCanvas=function(){if(c){c.addLine(this)}};line.prototype.gCode=function(e){this.c="";code="";var t=0;while(t>-s.z){t-=s.dz;if(t<-s.z){t=-s.z}code+=";***** STARTING A NEW LINE *****\n";code+="G1X"+(this.p0.x+s.x0)+"Y"+(this.p0.y+s.y0)+"F"+s.air_speed+"\n";code+="G1Z"+t+"F"+s.cut_speed+"\n";code+="G1X"+(this.p1.x+s.x0)+"Y"+(this.p1.y+s.y0)+"F"+s.cut_speed+"\n";code+="G1Z"+s.z0+"F"+s.air_speed+"\n"}this.c=code;return this.c};line.prototype.synch=function(){this.removeCanvas();this.getPos();this.toolpath();this.gCode();this.addCanvas()};rectangle=function(e,t,n,r,i,s,o){this.p0=new p(t,n);this.p1=new p(r,i);this.p2=new p(t,i);this.p3=new p(r,n);if(e){this.pos=e;this.id="rectangle-"+e}this.canvas=[];this.tCanvas=[];this.current=0;o?this.name=o:this.name=$("#rectangle_name").val()?$("#rectangle_name").val():this.id;this.p0=new p(t?t:$("#rectangle_x0").length?parseFloat($("#rectangle_x0").val()):0,n?n:$("#rectangle_y0").length?parseFloat($("#rectangle_y0").val()):0);if(!r||!i){if($("#rectangle_x1").length&&$("#rectangle_x1").hasClass("active")){r=parseFloat($("#rectangle_x1").val())}else if($("#rectangle_w").length&&$("#rectangle_w").hasClass("active")){r=this.p0.x+parseFloat($("#rectangle_w").val())}if($("#rectangle_y1").length&&$("#rectangle_y1").hasClass("active")){i=parseFloat($("#rectangle_y1").val())}else if($("#rectangle_h").length&&$("#rectangle_h").hasClass("active")){i=this.p0.y+parseFloat($("#rectangle_h").val())}}this.p1=new p(r,i);this.p2=new p(this.p0.x,this.p1.y);this.p3=new p(this.p1.x,this.p0.y);this.side=s?s:$("input:radio[name='rectangle_side']:checked").length?parseInt($("input:radio[name='rectangle_side']:checked").val()):1;this.synch();$("#rectangle_name").val("");$("#rectangle_name").data("cid","")};rectangle.prototype.update=function(e,t,n,r,i,s){this.p0=new p(e,t);this.p1=new p(n,r);this.p2=new p(e,r);this.p3=new p(n,t);this.side=i?i:1;if(s)this.name=s;this.synch()};rectangle.prototype.rotate=function(e,t){this.p0.rotate(e,t);this.p1.rotate(e,t);this.p2.rotate(e,t);this.p3.rotate(e,t);this.synch()};rectangle.prototype.mirror=function(e,t){this.p0.mirror(e,t);this.p1.mirror(e,t);this.p2.mirror(e,t);this.p3.mirror(e,t);this.synch()};rectangle.prototype.translate=function(e){this.p0=translate(e);this.p1=translate(e);this.p2=translate(e);this.p3=translate(e);this.synch()};rectangle.prototype.getPos=function(){this.position=new pos(this.p0.middle(this.p1),Math.min(this.p0.x,this.p1.x,this.p2.x,this.p3.x),Math.max(this.p0.y,this.p1.y,this.p2.y,this.p3.y),Math.max(this.p0.x,this.p1.x,this.p2.x,this.p3.x),Math.min(this.p0.y,this.p1.y,this.p2.y,this.p3.y))};rectangle.prototype.setCurrent=function(){this.current=1};rectangle.prototype.resetCurrent=function(){this.current=0};rectangle.prototype.getForm=function(){this.update($("#rectangle_x0").length?parseFloat($("#rectangle_x0").val()):null,$("#rectangle_y0").length?parseFloat($("#rectangle_y0").val()):null,$("#rectangle_x1").length?parseFloat($("#rectangle_x1").val()):$("#rectangle_w").length?parseFloat($("#rectangle_x0").val()+$("#rectangle_w").val()):null,$("#rectangle_y1").length?parseFloat($("#rectangle_y1").val()):$("#rectangle_h").length?parseFloat($("#rectangle_y0").val()+$("#rectangle_h").val()):null,$("input:radio[name='rectangle_side']:checked").length?parseInt($("input:radio[name='rectangle_side']:checked").val()):null,this.name=$("#rectangle_name").val()?$("#rectangle_name").val():this.id);$("#rectangle_name").val("");$("#rectangle_name").data("cid","")};rectangle.prototype.setForm=function(){if($("#rectangle_name").length){$("#rectangle_name").val(this.name);$("#rectangle_name").data("cid",this.id)}if($("#rectangle_x0").length){$("#rectangle_x0").val(this.p0.x.toString())}if($("#rectangle_y0").length){$("#rectangle_y0").val(this.p0.y.toString())}if($("#rectangle_x1").length){$("#rectangle_x1").val(this.p1.x.toString())}if($("#rectangle_y1").length){$("#rectangle_y1").val(this.p1.y.toString())}if($("#rectangle_w").length){$("#rectangle_w").val((this.p1.x-this.p0.x).toString())}if($("#rectangle_h").length){$("#rectangle_h").val((this.p1.y-this.p0.y).toString())}if($("input:radio[name='rectangle_side']:checked").length){$("input:radio[name='rectangle_side'][value='"+this.side+"']").attr("checked",true)}};rectangle.prototype.toolpath=function(){this.t=[];if(this.side==3){var e={};e.p0=this.p0;e.p1=this.p1;e.p2=this.p2;e.p3=this.p3;this.t.push(e)}else if(this.side==1){var e={};var t=calculAlpha(this.p0,this.p2)+pi/2;var n=calculAlpha(this.p2,this.p1)+pi/2;var r=calculAlpha(this.p1,this.p3)+pi/2;var i=calculAlpha(this.p3,this.p0)+pi/2;e.p0=new p(this.p0.x+s.bit_d/2*Math.cos(t),this.p0.y+s.bit_d/2*Math.sin(t));e.p1=new p(this.p1.x+s.bit_d/2*Math.cos(n),this.p1.y+s.bit_d/2*Math.sin(n));e.p2=new p(this.p2.x+s.bit_d/2*Math.cos(r),this.p2.y+s.bit_d/2*Math.sin(r));e.p3=new p(this.p3.x+s.bit_d/2*Math.cos(i),this.p3.y+s.bit_d/2*Math.sin(i));this.t.push(e)}else if(this.side==2){var o=this.p1.x-this.p0.x;var u=this.p1.y-this.p0.y;var a=(this.p0.x+this.p1.x)/2;var f=(this.p0.y+this.p1.y)/2;var l=o/u;var c=null;var h=null;var d=null;var v=null;var t=calculAlpha(this.p0,this.p2)+pi/2;var n=calculAlpha(this.p2,this.p1)+pi/2;var r=calculAlpha(this.p1,this.p3)+pi/2;var i=calculAlpha(this.p3,this.p0)+pi/2;if(o>u){c=new p(a-s.bit_d/2*(l>0?l:1/l),f-s.bit_d/2);h=new p(a+s.bit_d/2*(l>0?l:1/l),f+s.bit_d/2)}else{c=new p(a-s.bit_d/2,a-s.bit_d/2*(l>0?l:1/l));h=newp(a+s.bit_d/2,a+s.bit_d/2*(l>0?l:1/l))}var m=0;while(m==0){var e={};if(Math.abs(c.x)<Math.abs(this.p0.x+s.bit_d/2)){c.x=this.p0.x+s.bit_d/2;m=1}if(Math.abs(c.y)<Math.abs(this.p0.y+s.bit_d/2)){c.y=this.p0.y+s.bit_d/2;m=1}if(Math.abs(h.x)>Math.abs(this.p1.x-s.bit_d/2)){h.x=this.p1.x-s.bit_d/2;m=1}if(Math.abs(h.y)>Math.abs(this.p1.y-s.bit_d/2)){h.y=this.p1.y-s.bit_d/2;m=1}if(Math.abs(c.x)==Math.abs(this.p0.x+s.bit_d/2)&&Math.abs(c.y)==Math.abs(this.p0.y+s.bit_d/2)&&Math.abs(h.x)==Math.abs(this.p1.x-s.bit_d/2)&&Math.abs(h.y)==Math.abs(this.p1.y-s.bit_d/2)){m=1}e.p0=c;e.p1=h;c=new p(c.x-s.bit_d,c.y-s.bit_d);h=new p(h.x+s.bit_d,h.y+s.bit_d);this.t.push(e)}}};rectangle.prototype.addTaskList=function(){var e="";e+="<tr class='"+(this.current?"current":"")+"' id='"+this.id+"'>";e+="<td>"+this.name+"</td>";e+="<td>("+this.p0.x+","+this.p0.y+") - ("+this.p1.x+","+this.p1.y+")</td>";e+="<td class='edit'><span>E</span></td>";e+="<td class='delete'><span>D</span></td>";e+="</tr>";return e};rectangle.prototype.removeCanvas=function(){if(c&&this.canvas){c.removeRectangle(this)}};rectangle.prototype.addCanvas=function(){if(c){c.addRectangle(this)}};rectangle.prototype.gCode=function(e){this.c="";var t="";var n=0;while(n>-s.z){n-=s.dz;if(n<-s.z){n=-s.z}$.each(this.t,function(e,r){t+=";***** STARTING A NEW RECTANGLE *****\n";t+="G1X"+(this.p0.x+s.x0)+"Y"+(this.p0.y+s.y0)+"F"+s.air_speed+"\n";t+="G1Z"+n+"F"+s.cut_speed+"\n";t+="G1X"+(this.p2.x+s.x0)+"Y"+(this.p2.y+s.y0)+"F"+s.cut_speed+"\n";t+="G1X"+(this.p1.x+s.x0)+"Y"+(this.p1.y+s.y0)+"F"+s.cut_speed+"\n";t+="G1X"+(this.p3.x+s.x0)+"Y"+(this.p3.y+s.y0)+"F"+s.cut_speed+"\n";t+="G1X"+(this.p0.x+s.x0)+"Y"+(this.p0.y+s.y0)+"F"+s.cut_speed+"\n"})}t+="G1Z"+s.z0+"F"+s.air_speed+"\n";this.c=t;return this.c};rectangle.prototype.synch=function(){this.removeCanvas();this.getPos();this.toolpath();this.gCode();this.addCanvas()};circle=function(e,t,n,r,i,s){var o=null;var u=null;if(e){this.pos=e;this.id="circle-"+e}this.canvas=[];this.tCanvas=[];this.current=0;s?this.name=s:this.name=$("#circle_name").val()?$("#circle_name").val():this.id;if(r){o=r}else if($("#circle_diam").length&&$("#circle_diam").hasClass("active")){o=parseFloat($("#circle_diam").val())}else if($("#circle_radius").length&&$("#circle_radius").hasClass("active")){u=parseFloat($("#circle_radius").val())}if(o){u=o/2}this.r=u;this.p=new p(t?t:$("#circle_x").length?parseFloat($("#circle_x").val()):0,n?n:$("#circle_y").length?parseFloat($("#circle_y").val()):0);this.p0=new p(this.p.x,this.p.y+u);this.side=i?i:$("input:radio[name='circle_side']:checked").length?parseInt($("input:radio[name='circle_side']:checked").val()):1;this.synch();$("#circle_name").val("");$("#circle_name").data("cid","")};circle.prototype.update=function(e,t,n,i,s){this.r=n/2;this.p=new p(e,t);this.p0=new p(this.p.x,this.p.y+r);this.side=i?i:1;if(s)this.name=s;this.synch()};circle.prototype.rotate=function(e,t){this.p.rotate(e,t);this.p0.rotate(e,t);this.synch()};circle.prototype.mirror=function(e,t){this.p.mirror(e,t);this.p0.mirror(e,t);this.synch()};circle.prototype.translate=function(e){this.p=translate(e);this.p0=translate(e);this.synch()};circle.prototype.getPos=function(){this.position=new pos(this.p,this.p.x-this.r,this.p.y+this.r,this.p.x+this.r,this.p.y-this.r)};circle.prototype.setCurrent=function(){this.current=1};circle.prototype.resetCurrent=function(){this.current=0};circle.prototype.getForm=function(){this.update($("#circle_x").length?parseFloat($("#circle_x").val()):null,$("#circle_y").length?parseFloat($("#circle_y").val()):null,$("#circle_radius").length&&$("#circle_radius").hasClass("active")?parseFloat($("#circle_radius").val()*2):$("#circle_diam").length&&$("#circle_diam").hasClass("active")?parseFloat($("#circle_radius").val()):null,$("input:radio[name='circle_side']:checked").length?parseInt($("input:radio[name='circle_side']:checked").val()):null,this.name=$("#circle_name").val()?$("#circle_name").val():this.id);$("#circle_name").val("");$("#circle_name").data("cid","")};circle.prototype.setForm=function(){if($("#circle_name").length){$("#circle_name").val(this.name);$("#circle_name").data("cid",this.id)}if($("#circle_x").length){$("#circle_x").val(this.p.x.toString())}if($("#circle_y").length){$("#circle_y").val(this.p.y.toString())}if($("#circle_radius").length){$("#circle_radius").val(this.r.toString())}if($("#circle_diam").length){$("#circle_diam").val((this.r*2).toString())}if($("input:radio[name='circle_side']:checked").length){$("input:radio[name='circle_side'][value='"+this.side+"']").attr("checked",true)}};circle.prototype.toolpath=function(){this.t=[];if(this.side==3){var e={};e.p=new p(this.p.x,this.p.y);e.p0=new p(this.p0.x,this.p0.y);this.t.push(e)}else if(this.side==1){var t=calculAlpha(this.p,this.p0);var e={};e.p=new p(this.p.x,this.p.y);e.p0=new p(this.p0.x+s.bit_d/2*Math.cos(t),this.p0.y+s.bit_d/2*Math.sin(t));this.t.push(e)}else if(this.side==2){var t=calculAlpha(this.p,this.p0);var n=new p(this.p.x,this.p.y);var r=0;while(r==0){var e={};e.p=new p(this.p.x,this.p.y);if(Math.abs(n.x)>Math.abs(this.p0.x-s.bit_d/2*Math.cos(t))){n.x=this.p0.x-s.bit_d/2*Math.cos(t);r=1}if(Math.abs(n.y)>Math.abs(this.p0.y-s.bit_d/2*Math.sin(t))){n.y=this.p0.y-s.bit_d/2*Math.sin(t);r=1}if(Math.abs(n.x)==Math.abs(this.p0.x-s.bit_d/2*Math.cos(t))&&Math.abs(n.y)==Math.abs(this.p0.y-s.bit_d/2*Math.sin(t))){r=1}e.p0=new p(n.x,n.y);n.x+=s.bit_d*Math.cos(t);n.y+=s.bit_d*Math.sin(t);this.t.push(e)}}};circle.prototype.addTaskList=function(){var e="";e+="<tr class='"+(this.current?"current":"")+"' id='"+this.id+"'>";e+="<td>"+this.name+"</td>";e+="<td>("+this.p.x.toString()+","+this.p.y.toString()+") R="+(this.p0.y-this.p.y).toString()+"</td>";e+="<td class='edit'><span>E</span></td>";e+="<td class='delete'><span>D</span></td>";e+="</tr>";return e};circle.prototype.removeCanvas=function(){if(c&&this.canvas){c.removeCircle(this)}};circle.prototype.addCanvas=function(){if(c){c.addCircle(this)}};circle.prototype.gCode=function(e){this.c="";var t="";var n=0;while(n>-s.z){n-=s.dz;if(n<-s.z){n=-s.z}$.each(this.t,function(e,r){t+=";***** STARTING A NEW CIRCLE *****\n";t+="G1X"+(this.p0.x+s.x0)+"Y"+(this.p0.y+s.y0)+"F"+s.air_speed+"\n";t+="G1Z"+n+"F"+s.cut_speed+"\n";t+="G2X"+(this.p0.x+s.x0)+"Y"+(this.p0.y+s.y0)+"I"+(this.p0.x-this.p.x+s.x0)+"J"+(this.p0.y-this.p.y+s.y0)+"F"+s.cut_speed+"\n"})}t+="G1Z"+s.z0+"F"+s.air_speed+"\n";this.c=t;return this.c};circle.prototype.synch=function(){this.removeCanvas();this.getPos();this.toolpath();this.gCode();this.addCanvas()};arc=function(e,t,n,r,i,s,o,u){if(e){this.id="ar-c"+e;this.pos=e}this.canvas=[];this.tCanvas=[];this.current=0;u?this.name=u:this.name=$("#arc_name").val()?$("#arc_name").val():this.id;this.p=new p(t?t:$("#arc_x").length?parseFloat($("#arc_x").val()):0,n?n:$("#arc_y").length?parseFloat($("#arc_y").val()):0);this.p0=new p(r?r:$("#arc_x0").length?parseFloat($("#arc_x0").val()):0,i?i:$("#arc_y0").length?parseFloat($("#arc_y0").val()):0);this.angle=s?s:$("#arc_angle").length?parseFloat($("#arc_angle").val()):0;this.p1=new p(this.p0.x,this.p0.y);this.p2=new p(this.p0.x,this.p0.y);this.p1.rotate(this.p,this.angle/2);this.p2.rotate(this.p,this.angle);this.side=o?o:$("input:radio[name='arc_side']:checked").length?parseInt($("input:radio[name='arc_side']:checked").val()):1;console.log(this);this.synch();$("#arc_name").val("");$("#arc_name").data("cid","")};arc.prototype.update=function(e,t,n,r,i,s,o){this.p=new p(e,t);this.p0=new p(n,r);this.angle=i;this.p1=new p(this.p0.x,this.p0.y);this.p2=new p(this.p0.x,this.p0.y);this.p1.rotate(this.p,this.angle/2);this.p2.rotate(this.p,this.angle);this.side=s?s:1;if(o)this.name=o;this.synch()};arc.prototype.rotate=function(e,t){this.p.rotate(e,t);this.p0.rotate(e,t);this.p1.rotate(e,t);this.synch()};arc.prototype.mirror=function(e,t){this.p.mirror(e,t);this.p0.mirror(e,t);this.p1.mirror(e,t);this.synch()};arc.prototype.translate=function(e){this.p=translate(e);this.p0=translate(e);this.p1=translate(e);this.synch()};arc.prototype.getPos=function(){this.position=new pos(this.p,Math.min(this.p.x,this.p0.x,this.p1.x),Math.max(this.p.y,this.p0.y,this.p1.y),Math.max(this.p.x,this.p0.x,this.p1.x),Math.min(this.p.y,this.p0.y,this.p1.y))};arc.prototype.setCurrent=function(){this.current=1};arc.prototype.resetCurrent=function(){this.current=0};arc.prototype.getForm=function(){this.update($("#arc_x").length?parseFloat($("#arc_x").val()):null,$("#arc_y").length?parseFloat($("#arc_y").val()):null,$("#arc_x0").length?parseFloat($("#arc_x0").val()):null,$("#arc_y0").length?parseFloat($("#arc_y0").val()):null,$("#arc_angle").length?parseFloat($("#arc_angle").val()):null,$("input:radio[name='arc_side']:checked").length?parseInt($("input:radio[name='arc_side']:checked").val()):null,this.name=$("#arc_name").val()?$("#arc_name").val():this.id);$("#arc_name").val("");$("#arc_name").data("cid","")};arc.prototype.setForm=function(){if($("#arc_name").length){$("#arc_name").val(this.name)}if($("#arc_name").length){$("#arc_name").data("cid",this.id)}if($("#arc_x").length){$("#arc_x").val(this.p.x.toString())}if($("#arc_y").length){$("#arc_y").val(this.p.y.toString())}if($("#arc_x0").length){$("#arc_x0").val(this.p0.x.toString())}if($("#arc_y0").length){$("#arc_y0").val(this.p0.y.toString())}if($("#arc_angle").length){$("#arc_angle").val(this.angle.toString())}if($("input:radio[name='arc_side']:checked").length){$("input:radio[name='arc_side'][value='"+this.side+"']").attr("checked",true)}};arc.prototype.toolpath=function(){this.t=[];if(this.side==3){var e={};e.p=new p(this.p.x,this.p.y);e.p0=new p(this.p0.x,this.p0.y);e.p1=new p(this.p0.x,this.p0.y);e.p2=new p(this.p0.x,this.p0.y);e.p1.rotate(this.p,this.angle/2);e.p2.rotate(this.p,this.angle);this.t.push(e)}else if(this.side==1){var e={};e.p=new p(this.p.x,this.p.y);e.p0=new p(this.p0.x,this.p0.y);e.p1=new p(this.p0.x,this.p0.y);e.p2=new p(this.p0.x,this.p0.y);e.p1.rotate(this.p,this.angle/2);e.p2.rotate(this.p,this.angle);e.p0.x+=s.bit_d/2*Math.cos(calculAlpha(this.p,e.p0));e.p0.y+=s.bit_d/2*Math.sin(calculAlpha(this.p,e.p0));e.p1.x+=s.bit_d/2*Math.cos(calculAlpha(this.p,e.p1));e.p1.y+=s.bit_d/2*Math.sin(calculAlpha(this.p,e.p1));e.p2.x+=s.bit_d/2*Math.cos(calculAlpha(this.p,e.p2));e.p2.y+=s.bit_d/2*Math.sin(calculAlpha(this.p,e.p2));this.t.push(e)}else if(this.side==2){var e={};e.p=new p(this.p.x,this.p.y);e.p0=new p(this.p0.x,this.p0.y);e.p1=new p(this.p0.x,this.p0.y);e.p2=new p(this.p0.x,this.p0.y);e.p1.rotate(this.p,this.angle/2);e.p2.rotate(this.p,this.angle);e.p0.x-=s.bit_d/2*Math.cos(calculAlpha(this.p,this.p0));e.p0.y-=s.bit_d/2*Math.sin(calculAlpha(this.p,this.p0));e.p1.x-=s.bit_d/2*Math.cos(calculAlpha(this.p,e.p1));e.p1.y-=s.bit_d/2*Math.sin(calculAlpha(this.p,e.p1));e.p2.x-=s.bit_d/2*Math.cos(calculAlpha(this.p,e.p2));e.p2.y-=s.bit_d/2*Math.sin(calculAlpha(this.p,e.p2));this.t.push(e)}else if(this.side==4){var t=calculAlpha(this.p,this.p0);var n=this.p;var r=0;while(r==0){var e={};e.p0=this.p;if(Math.abs(n.x)>Math.abs(this.p0.x-s.bit_d/2*Math.cos(t))){n.x=this.p0.x-s.bit_d/2*Math.cos(t);r=1}if(Math.abs(n.y)>Math.abs(this.p0.y-s.bit_d/2*Math.sin(t))){n.y=this.p0.y-s.bit_d/2*Math.sin(t);r=1}if(Math.abs(n.x)==Math.abs(this.p0.x-s.bit_d/2*Math.cos(t))&&Math.abs(n.y)==Math.abs(this.p0.y-s.bit_d/2*Math.sin(t))){r=1}e.P0=n;n.x+=s.bit_d*Math.cos(t);n.y+=s.bit_d*Math.sin(t);this.t.push(e)}}};arc.prototype.addTaskList=function(){var e="";e+="<tr class='"+(this.current?"current":"")+"' id='"+this.id+"'>";e+="<td>"+this.name+"</td>";e+="<td>("+this.p.x.toString()+","+this.p.y.toString()+") - ("+this.p1.x.toString()+","+this.p1.y.toString()+") α="+(this.p0.y-this.p.y).toString()+"</td>";e+="<td class='edit'><span>E</span></td>";e+="<td class='delete'><span>D</span></td>";e+="</tr>";return e};arc.prototype.removeCanvas=function(){if(c&&this.canvas){c.removeArc(this)}};arc.prototype.addCanvas=function(){if(c){c.addArc(this)}};arc.prototype.gCode=function(e){this.c="";code="";var t=0;var n=this.angle;var r=1;var i=null;var o=null;while(t>-s.z){t-=s.dz;if(t<-s.z){t=-s.z}$.each(this.t,function(e,i){r?r=0:r=1;code+=";***** STARTING A NEW ARC *****\n";if(!r){code+="G1X"+(this.p0.x+s.x0)+"Y"+(this.p0.y+s.y0)+"F"+s.air_speed+"\n";code+="G1Z"+t+"F"+s.cut_speed+"\n";if(n>0){code+="G2X"+(this.p2.x+s.x0)+"Y"+(this.p2.y+s.y0)+"I"+(this.p.x-this.p0.x+s.x0)+"J"+(this.p.y-this.p0.y+s.y0)+"F"+s.cut_speed+"\n"}else{code+="G3X"+(this.p2.x+s.x0)+"Y"+(this.p2.y+s.y0)+"I"+(this.p.x-this.p0.x+s.x0)+"J"+(this.p.y-this.p0.y+s.y0)+"F"+s.cut_speed+"\n"}}else{code+="G1X"+(this.p2.x+s.x0)+"Y"+(this.p2.y+s.y0)+"F"+s.air_speed+"\n";code+="G1Z"+t+"F"+s.cut_speed+"\n";if(n>0){code+="G3X"+(this.p0.x+s.x0)+"Y"+(this.p0.y+s.y0)+"I"+(this.p.x-this.p2.x+s.x0)+"J"+(this.p.y-this.p2.y+s.y0)+"F"+s.cut_speed+"\n"}else{code+="G2X"+(this.p0.x+s.x0)+"Y"+(this.p0.y+s.y0)+"I"+(this.p.x-this.p2.x+s.x0)+"J"+(this.p.y-this.p2.y+s.y0)+"F"+s.cut_speed+"\n"}}})}code+="G1Z"+s.z0+"F"+s.air_speed+"\n";this.c=code;return this.c};arc.prototype.synch=function(){this.removeCanvas();this.getPos();this.toolpath();this.gCode();this.addCanvas()};customShape=function(){this.shapes=[];this.oldShapes=[];this.canvas=[];this.tCanvas=[];this.current=0;this.pos=null;this.id=null;this.name=null};customShape.prototype.calculShape=function(){return true}