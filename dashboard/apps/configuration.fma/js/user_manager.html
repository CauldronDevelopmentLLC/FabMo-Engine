<!DOCTYPE html><html lang="en"><head><title>dashboard/apps/configuration.fma/js/user_manager</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../../../"><meta name="groc-document-path" content="dashboard/apps/configuration.fma/js/user_manager"><meta name="groc-project-path" content="dashboard/apps/configuration.fma/js/user_manager.js"><link rel="stylesheet" type="text/css" media="all" href="../../../../assets/style.css"><script type="text/javascript" src="../../../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">dashboard/apps/configuration.fma/js/user_manager.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> moment = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../../../static/js/libs/moment.js'</span>);
<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">users</span>(<span class="hljs-params">fabmo</span>) </span>{
setupUserManager();
<span class="hljs-keyword">var</span> current_user=<span class="hljs-literal">null</span>;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setupUserManager</span>(<span class="hljs-params"></span>) </span>{
  fabmo.getCurrentUser(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err,user</span>)</span>{
    <span class="hljs-keyword">if</span>(err)fabmo.notify(<span class="hljs-string">'error'</span>,err);
    <span class="hljs-keyword">else</span>{
      current_user = user;
      refreshCurrentUserView(user);
      <span class="hljs-keyword">if</span>(user.isAdmin){
        createAdminPanel();
      }
    }
  });

  $(<span class="hljs-string">"#submit-user-password"</span>).one(<span class="hljs-string">'click'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>)</span>{
    password=$(<span class="hljs-string">'#input-user-password'</span>).val();
    password_confirm = $(<span class="hljs-string">'#input-user-passwordConfirmation'</span>).val();
    $(<span class="hljs-string">'#input-user-password'</span>).val(<span class="hljs-string">''</span>);
    $(<span class="hljs-string">'#input-user-passwordConfirmation'</span>).val(<span class="hljs-string">''</span>);
    <span class="hljs-keyword">if</span>(password===password_confirm){
      user = current_user;
      user_info= {
        user:{
          id:current_user.username,
          password:password
        }
      };
      fabmo.modifyUser(user_info,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>)</span>{
        <span class="hljs-keyword">if</span>(err)fabmo.notify(<span class="hljs-string">'error'</span>,err);
        <span class="hljs-keyword">else</span>{
          fabmo.notify(<span class="hljs-string">'success'</span>,<span class="hljs-string">"password successfully changed for user "</span>+current_user.username);
        }
        setupUserManager();
      });
    }
    <span class="hljs-keyword">else</span>{
      fabmo.notify(<span class="hljs-string">'error'</span>,<span class="hljs-string">"passwords don't match"</span>);
    }
  });
}


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createAdminPanel</span>(<span class="hljs-params"></span>)</span>{
  fabmo.getUsers(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err,users</span>) </span>{
    <span class="hljs-keyword">if</span>(err){<span class="hljs-keyword">return</span>;} <span class="hljs-comment">// user is not admin.</span>
    users=users.filter(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">usr</span>)</span>{<span class="hljs-keyword">return</span>(usr.username!==current_user.username)}); <span class="hljs-comment">//remove current user from the list</span>
    refreshUsersListView(users);
  });

  $(<span class="hljs-string">'#add-user'</span>).one(<span class="hljs-string">'click'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-comment">//add new user</span>
    form=[
      <span class="hljs-string">'&lt;div id="adduser-modal" class="reveal-modal medium" data-reveal&gt;'</span>,
        <span class="hljs-string">'&lt;div id="modal-title"&gt;Add User&lt;/div&gt;'</span>,
        <span class="hljs-string">'&lt;div id="adduser-form"&gt;'</span>,
            <span class="hljs-string">'&lt;div class="row"&gt;'</span>,
                <span class="hljs-string">'&lt;label for="adduser-username"&gt;Username :&lt;/label&gt;'</span>,
                <span class="hljs-string">'&lt;input id="adduser-username" type="text" name="adduser-username" value="" /&gt;'</span>,
            <span class="hljs-string">'&lt;/div&gt;'</span>,
            <span class="hljs-string">'&lt;div class="row"&gt;'</span>,
                <span class="hljs-string">'&lt;label for="adduser-password"&gt;New Password :&lt;/label&gt;'</span>,
                <span class="hljs-string">'&lt;input id="adduser-password" type="password" name="adduser-password" value="" /&gt;'</span>,
            <span class="hljs-string">'&lt;/div&gt;'</span>,
            <span class="hljs-string">'&lt;div class="row"&gt;'</span>,
                <span class="hljs-string">'&lt;label for="adduser-name"&gt;Confirm New Password:&lt;/label&gt;'</span>,
                <span class="hljs-string">'&lt;input id="adduser-passwordConfirmation" type="password" name="adduser-passwordConfirmation" value="" /&gt;'</span>,
            <span class="hljs-string">'&lt;/div&gt;'</span>,
            <span class="hljs-string">'&lt;div class="row"&gt;'</span>,
                 <span class="hljs-string">'&lt;div class="right"&gt;'</span>,
                     <span class="hljs-string">'&lt;button id="adduser-cancel" class="button radius alert"&gt;Cancel&lt;/button&gt;'</span>,
                     <span class="hljs-string">'&lt;button id="adduser-submit" class="button radius success"&gt;Add User&lt;/button&gt;'</span>,
                 <span class="hljs-string">'&lt;/div&gt;'</span>,
             <span class="hljs-string">'&lt;/div&gt;'</span>,
         <span class="hljs-string">'&lt;/div&gt;'</span>,
         <span class="hljs-string">'&lt;a class="close-reveal-modal" id="close-adduser-modal"&gt;&amp;#215;&lt;/a&gt;'</span>,
        <span class="hljs-string">'&lt;/div&gt;'</span>,
    ].join(<span class="hljs-string">''</span>);
    $(<span class="hljs-string">'body'</span>).append(form);
    $(<span class="hljs-string">'#adduser-modal'</span>).foundation(<span class="hljs-string">'reveal'</span>, <span class="hljs-string">'open'</span>);
    $(<span class="hljs-string">'#adduser-username'</span>).focus();
    $(<span class="hljs-string">'#adduser-submit'</span>).one(<span class="hljs-string">'click'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"> event </span>) </span>{
      username = $(<span class="hljs-string">'#adduser-username'</span>).val();
      password = $(<span class="hljs-string">'#adduser-password'</span>).val();
      password_confirm = $(<span class="hljs-string">'#adduser-passwordConfirmation'</span>).val();
      <span class="hljs-keyword">if</span>(password===password_confirm){
        user_info= {
          user:{
            username:username,
            password:password
          }
        };
        fabmo.addUser(user_info, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err,user</span>) </span>{
          <span class="hljs-keyword">if</span> (err) {
              fabmo.notify(<span class="hljs-string">'error'</span>, err);
          }<span class="hljs-keyword">else</span>{
              fabmo.notify(<span class="hljs-string">'success'</span>, <span class="hljs-string">'User '</span>+user.username+<span class="hljs-string">' created !'</span>);
          }
          createAdminPanel();
        });
      }<span class="hljs-keyword">else</span>{
        fabmo.notify(<span class="hljs-string">'error'</span>,<span class="hljs-string">"passwords don't match"</span>+event);
      }
      $(<span class="hljs-string">'#adduser-modal'</span>).foundation(<span class="hljs-string">'reveal'</span>, <span class="hljs-string">'close'</span>);
      $(<span class="hljs-string">"#adduser-form"</span>).trigger(<span class="hljs-string">'reset'</span>);
      $(<span class="hljs-string">"#adduser-submit"</span>).off(<span class="hljs-string">'click'</span>);
      $(<span class="hljs-string">"#adduser-modal"</span>).remove();
    });
    $(<span class="hljs-string">'#adduser-modal'</span>).bind(<span class="hljs-string">'closed.fndtn.reveal'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) </span>{
        $(<span class="hljs-string">"#adduser-submit"</span>).off(<span class="hljs-string">'click'</span>);
        $(<span class="hljs-string">"#adduser-modal"</span>).remove();
    });
    $(<span class="hljs-string">'#adduser-cancel'</span>).on(<span class="hljs-string">'click'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) </span>{
      evt.preventDefault();
      $(<span class="hljs-string">'#adduser-modal'</span>).foundation(<span class="hljs-string">'reveal'</span>, <span class="hljs-string">'close'</span>);
      $(<span class="hljs-string">"#adduser-submit"</span>).off(<span class="hljs-string">'click'</span>);
      $(<span class="hljs-string">"#adduser-modal"</span>).remove();
    });

  });


}


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">refreshCurrentUserView</span>(<span class="hljs-params">current_user</span>)</span>{
  $(<span class="hljs-string">"#user-username"</span>).val(current_user.username);
  $(<span class="hljs-string">"#user-_id"</span>).val(current_user._id);
  $(<span class="hljs-string">"#user-isAdmin"</span>).prop( <span class="hljs-string">"checked"</span>,current_user.isAdmin);
  $(<span class="hljs-string">"#user-created_at"</span>).val(moment(current_user.created_at).fromNow());
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">refreshUsersListView</span>(<span class="hljs-params">users</span>)</span>{
  <span class="hljs-keyword">if</span>(current_user.isAdmin){
    $(<span class="hljs-string">'.user-listing'</span>).empty()
    $(<span class="hljs-string">'#user-manager-container'</span>).removeClass(<span class="hljs-string">'hidden'</span>);
    $.each(users, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">key, user</span>) </span>{

      userid = <span class="hljs-string">"user_"</span>+user.username;

      <span class="hljs-keyword">var</span> delete_button = <span class="hljs-string">''</span>;
      <span class="hljs-keyword">var</span> changepassword_button = <span class="hljs-string">''</span>;
      <span class="hljs-keyword">var</span> grantadmin_button = <span class="hljs-string">''</span>;
      <span class="hljs-keyword">var</span> revokeadmin_button = <span class="hljs-string">''</span>;
      <span class="hljs-keyword">if</span>(current_user.username===<span class="hljs-string">"admin"</span> || (!user.isAdmin)){ <span class="hljs-comment">// cannot edit other admin profiles (except if your the super "admin" account)</span>
        delete_button = <span class="hljs-string">'&lt;div class="delete-button" id="delete_'</span> + userid + <span class="hljs-string">'"&gt;&lt;img class="svg" src="images/recycling10.svg"&gt;&lt;/div&gt;'</span>;
        changepassword_button = <span class="hljs-string">'&lt;div class="changepassword-button" id="changepassword_'</span> + userid + <span class="hljs-string">'"&gt;&lt;img class="svg" src="images/changepassword.svg"&gt;&lt;/div&gt;'</span>;
        grantadmin_button =  <span class="hljs-string">'&lt;div class="grantadmin-button" id="grantadmin_'</span> + userid + <span class="hljs-string">'"&gt;&lt;img class="svg" src="images/grantadmin.svg"&gt;&lt;/div&gt;'</span>;
        revokeadmin_button =  <span class="hljs-string">'&lt;div class="revokeadmin-button" id="revokeadmin_'</span> + userid + <span class="hljs-string">'"&gt;&lt;img class="svg" src="images/revokeadmin.svg"&gt;&lt;/div&gt;'</span>;
      }

      html = [
        <span class="hljs-string">'&lt;tr&gt;'</span>,
          <span class="hljs-string">'&lt;td&gt;'</span>+user.username+<span class="hljs-string">'&lt;/td&gt;'</span>, <span class="hljs-comment">// username</span>
          <span class="hljs-string">'&lt;td&gt;&lt;input type="checkbox" '</span>+(user.isAdmin?<span class="hljs-string">'checked'</span>:<span class="hljs-string">''</span>)+<span class="hljs-string">' disabled /&gt;&lt;/td&gt;'</span>, <span class="hljs-comment">// isAdmin</span>
          <span class="hljs-string">'&lt;td&gt;'</span>+moment(user.created_at).fromNow()+<span class="hljs-string">'&lt;/td&gt;'</span>, <span class="hljs-comment">// created_at</span>
          <span class="hljs-string">'&lt;td&gt;'</span>+changepassword_button+<span class="hljs-string">'&lt;/td&gt;'</span>, <span class="hljs-comment">// change_password_button</span>
          <span class="hljs-string">'&lt;td&gt;'</span>+(user.isAdmin?revokeadmin_button:grantadmin_button)+<span class="hljs-string">'&lt;/td&gt;'</span>, <span class="hljs-comment">// grant/revoke admin button</span>
          <span class="hljs-string">'&lt;td&gt;'</span>+delete_button+<span class="hljs-string">'&lt;/td&gt;'</span>, <span class="hljs-comment">// delete button</span>
        <span class="hljs-string">'&lt;/tr&gt;'</span>,
      ].join(<span class="hljs-string">''</span>);
      $(<span class="hljs-string">".user-listing"</span>).append(html);

      $(<span class="hljs-string">'#delete_'</span> + userid).on(<span class="hljs-string">'click'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-comment">//delete button listener</span>
        fabmo.showModal({
          title : <span class="hljs-string">'Delete user '</span>+ user.username,
          message : <span class="hljs-string">'Are you sure you want to delete this user?'</span>,
          okText : <span class="hljs-string">'Yes'</span>,
          cancelText : <span class="hljs-string">'No'</span>,
          ok : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            fabmo.deleteUser({user:user}, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
            <span class="hljs-keyword">if</span> (err) {
              fabmo.notify(<span class="hljs-string">'error'</span>, err);
            }<span class="hljs-keyword">else</span>{
              fabmo.notify(<span class="hljs-string">'success'</span>,<span class="hljs-string">'user '</span>+user.username+<span class="hljs-string">' deleted !'</span>)
            }
            createAdminPanel();
            });
          },
          cancel : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{}
        })
      });

      $(<span class="hljs-string">'#grantadmin_'</span> + userid).on(<span class="hljs-string">'click'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-comment">//grantadmin button listener</span>
        user_info = {
          user :{
            username:user.username,
            isAdmin:<span class="hljs-literal">true</span>
          }
        };
        fabmo.modifyUser(user_info, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
        <span class="hljs-keyword">if</span> (err) {
          fabmo.notify(<span class="hljs-string">'error'</span>, err);
        }<span class="hljs-keyword">else</span>{
          fabmo.notify(<span class="hljs-string">'success'</span>,<span class="hljs-string">'admin permission granted to user '</span>+user.username)
        }
        createAdminPanel();
        });
      });

      $(<span class="hljs-string">'#revokeadmin_'</span> + userid).on(<span class="hljs-string">'click'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-comment">//revokeadmin button listener</span>
        user_info = {
          user :{
            username: user.username,
            isAdmin:<span class="hljs-literal">false</span>
          }
        };
        fabmo.modifyUser(user_info, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
        <span class="hljs-keyword">if</span> (err) {
          fabmo.notify(<span class="hljs-string">'error'</span>, err);
        }<span class="hljs-keyword">else</span>{
          fabmo.notify(<span class="hljs-string">'success'</span>,<span class="hljs-string">'admin permission removed for user '</span>+user.username)
        }
        createAdminPanel();
        });
      });

      $(<span class="hljs-string">'#changepassword_'</span> + userid).on(<span class="hljs-string">'click'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-comment">//change user password</span>
        form=[
          <span class="hljs-string">'&lt;div id="changepassword-modal" class="reveal-modal medium" data-reveal&gt;'</span>,
            <span class="hljs-string">'&lt;div id="modal-title"&gt;Change user '</span>+user.username+<span class="hljs-string">'\'s password&lt;/div&gt;'</span>,
            <span class="hljs-string">'&lt;div id="changepassword-form"&gt;'</span>,
                <span class="hljs-string">'&lt;div class="row"&gt;'</span>,
                    <span class="hljs-string">'&lt;label for="changepassword-password"&gt;New Password :&lt;/label&gt;'</span>,
                    <span class="hljs-string">'&lt;input id="changepassword-password" type="password" name="changepassword-password" value="" /&gt;'</span>,
                <span class="hljs-string">'&lt;/div&gt;'</span>,
                <span class="hljs-string">'&lt;div class="row"&gt;'</span>,
                    <span class="hljs-string">'&lt;label for="changepassword-name"&gt;Confirm New Password:&lt;/label&gt;'</span>,
                    <span class="hljs-string">'&lt;input id="changepassword-passwordConfirmation" type="password" name="changepassword-passwordConfirmation" value="" /&gt;'</span>,
                <span class="hljs-string">'&lt;/div&gt;'</span>,
                <span class="hljs-string">'&lt;div class="row"&gt;'</span>,
                     <span class="hljs-string">'&lt;div class="right"&gt;'</span>,
                         <span class="hljs-string">'&lt;button id="changepassword-cancel" class="button radius alert"&gt;Cancel&lt;/button&gt;'</span>,
                         <span class="hljs-string">'&lt;button id="changepassword-submit" class="button radius success"&gt;Change Password&lt;/button&gt;'</span>,
                     <span class="hljs-string">'&lt;/div&gt;'</span>,
                 <span class="hljs-string">'&lt;/div&gt;'</span>,
             <span class="hljs-string">'&lt;/div&gt;'</span>,
             <span class="hljs-string">'&lt;a class="close-reveal-modal" id="close-changepassword-modal"&gt;&amp;#215;&lt;/a&gt;'</span>,
            <span class="hljs-string">'&lt;/div&gt;'</span>,
        ].join(<span class="hljs-string">''</span>);
        $(<span class="hljs-string">'body'</span>).append(form);
        $(<span class="hljs-string">'#changepassword-modal'</span>).foundation(<span class="hljs-string">'reveal'</span>, <span class="hljs-string">'open'</span>);
        $(<span class="hljs-string">'#changepassword-password'</span>).focus();
        $(<span class="hljs-string">'#changepassword-submit'</span>).one(<span class="hljs-string">'click'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"> event </span>) </span>{
          password = $(<span class="hljs-string">'#changepassword-password'</span>).val();
          password_confirm = $(<span class="hljs-string">'#changepassword-passwordConfirmation'</span>).val();
          <span class="hljs-keyword">if</span>(password===password_confirm){
            user_info= {
              user : {
                id : user._id,
                password:password
              }
            };
            fabmo.modifyUser(user_info, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
              <span class="hljs-keyword">if</span> (err) {
                  fabmo.notify(<span class="hljs-string">'error'</span>, err);
              }<span class="hljs-keyword">else</span>{
                  fabmo.notify(<span class="hljs-string">'success'</span>,<span class="hljs-string">"password successfully changed for user "</span>+user.username);
              }
              createAdminPanel();
            });
          }<span class="hljs-keyword">else</span>{
            fabmo.notify(<span class="hljs-string">'error'</span>,<span class="hljs-string">"passwords don't match"</span>+event);
          }
          $(<span class="hljs-string">'#changepassword-modal'</span>).foundation(<span class="hljs-string">'reveal'</span>, <span class="hljs-string">'close'</span>);
          $(<span class="hljs-string">"#changepassword-form"</span>).trigger(<span class="hljs-string">'reset'</span>);
          $(<span class="hljs-string">"#changepassword-submit"</span>).off(<span class="hljs-string">'click'</span>);
          $(<span class="hljs-string">"#changepassword-modal"</span>).remove();
        });
        $(<span class="hljs-string">'#changepassword-modal'</span>).bind(<span class="hljs-string">'closed.fndtn.reveal'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) </span>{
            $(<span class="hljs-string">"#changepassword-submit"</span>).off(<span class="hljs-string">'click'</span>);
            $(<span class="hljs-string">"#changepassword-modal"</span>).remove();
        });
        $(<span class="hljs-string">'#changepassword-cancel'</span>).on(<span class="hljs-string">'click'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) </span>{
          evt.preventDefault();
          $(<span class="hljs-string">'#changepassword-modal'</span>).foundation(<span class="hljs-string">'reveal'</span>, <span class="hljs-string">'close'</span>);
          $(<span class="hljs-string">"#changepassword-submit"</span>).off(<span class="hljs-string">'click'</span>);
          $(<span class="hljs-string">"#changepassword-modal"</span>).remove();
        });

      });
    });
  }<span class="hljs-keyword">else</span>{
    $(<span class="hljs-string">'#user-manager-container'</span>).addClass(<span class="hljs-string">'hidden'</span>);
  }
}
};</div></div></div></div></body></html>