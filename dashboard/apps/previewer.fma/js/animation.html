<!DOCTYPE html><html lang="en"><head><title>dashboard/apps/previewer.fma/js/animation</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../../../"><meta name="groc-document-path" content="dashboard/apps/previewer.fma/js/animation"><meta name="groc-project-path" content="dashboard/apps/previewer.fma/js/animation.js"><link rel="stylesheet" type="text/css" media="all" href="../../../../assets/style.css"><script type="text/javascript" src="../../../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">dashboard/apps/previewer.fma/js/animation.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-comment">/*jslint todo: true, browser: true, continue: true, white: true*/</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Written by Alex Canales for ShopBotTools, Inc.</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This file contains the class managing the animation of the bit.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> THREE = <span class="hljs-built_in">require</span>(<span class="hljs-string">"three"</span>);
<span class="hljs-keyword">var</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./util"</span>);

<span class="hljs-comment">//refreshFunction is the function to refresh the display/render the scene</span>
<span class="hljs-comment">//path is the instance of the class Path</span>
<span class="hljs-keyword">var</span> Animation = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scene, refreshFunction, gui, path, fps,
        initialPosition</span>) </span>{
<span class="hljs-pi">    "use strict"</span>;
    <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">var</span> lengthBit = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">var</span> G0Feedrate = <span class="hljs-number">120</span>;

    <span class="hljs-comment">//Get the position of the tip of the bit according to the meshes of</span>
    <span class="hljs-comment">//the path class.</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getRelativeBitPosition</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> pos = that.bit.position;
        <span class="hljs-keyword">return</span> {
            x : pos.x - that.initialPosition.x,
            y : pos.y - that.initialPosition.y,
            z : pos.z - that.initialPosition.z
        };
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setBitPosition</span>(<span class="hljs-params">point</span>) </span>{
        that.bit.position.set(point.x, point.y, point.z);
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">translateBit</span>(<span class="hljs-params">vector</span>) </span>{
        that.bit.position.add(vector);
    }

    <span class="hljs-comment">//Used to have an smooth animation</span>
    <span class="hljs-comment">//Returns the time elapsed between each update.</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">calculateDeltaTime</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> newTime = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime();
        <span class="hljs-keyword">var</span> deltaTime = newTime - that.lastTime;
        that.lastTime = newTime;
        <span class="hljs-keyword">return</span> deltaTime;
    }

    <span class="hljs-comment">//Check if the animation is starting to animate a new path</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isStartingPath</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span>(that.iPath === <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">var</span> currentCommand = that.currentPath[that.iPath].commandNumber;
        <span class="hljs-keyword">var</span> previousCommand = that.currentPath[that.iPath-<span class="hljs-number">1</span>].commandNumber;

        <span class="hljs-keyword">return</span> (currentCommand !== previousCommand);
    }

    <span class="hljs-comment">//Check if the animation is ending the animation of a path</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isEndingPath</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span>(that.iPath === <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-keyword">if</span>(that.iPath === that.currentPath.length - <span class="hljs-number">1</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">var</span> currentCommand = that.currentPath[that.iPath].commandNumber;
        <span class="hljs-keyword">var</span> nextCommand = that.currentPath[that.iPath+<span class="hljs-number">1</span>].commandNumber;

        <span class="hljs-keyword">return</span> (currentCommand !== nextCommand);
    }

    <span class="hljs-comment">//Warns the path class of the current position</span>
    <span class="hljs-comment">//changedIndex {bool}, if true, means that the point reached the current point</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">warnPath</span>(<span class="hljs-params">changedIndex</span>) </span>{
        <span class="hljs-keyword">var</span> pointPath = that.currentPath[that.iPath];
        <span class="hljs-keyword">if</span>(changedIndex === <span class="hljs-literal">false</span>) {
            that.path.isReachingPoint(pointPath, getRelativeBitPosition());
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span>(isStartingPath() === <span class="hljs-literal">true</span>) {
                that.path.startPath(pointPath);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(isEndingPath() === <span class="hljs-literal">true</span>) {
                that.path.endPath(pointPath);
            } <span class="hljs-keyword">else</span> {
                that.path.reachedIntermediate(pointPath);
            }
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setCurrentSpeed</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span>(that.currentPath.length === <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-comment">//We use in/ms here and feedrate is in in/min</span>
        <span class="hljs-keyword">var</span> line = that.currentPath[that.iPath];
        <span class="hljs-keyword">if</span>(line.type === <span class="hljs-string">"G0"</span>) {
            that.currentSpeed = G0Feedrate / <span class="hljs-number">60000</span>;
        } <span class="hljs-keyword">else</span> {
            that.currentSpeed = that.currentPath[that.iPath].feedrate / <span class="hljs-number">60000</span>;
        }
    }

    <span class="hljs-comment">//Check if need to change index of the path and do the appropriate operations</span>
    <span class="hljs-comment">//return true if continuing the animation, else false</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkChangeIndexPath</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-comment">//While instead of if because we can have commands that have same</span>
        <span class="hljs-comment">//start and end points</span>
        <span class="hljs-keyword">while</span>(that.iPath &lt; that.currentPath.length &amp;&amp;
                util.samePosition(that.currentPath[that.iPath].point,
                    getRelativeBitPosition()) === <span class="hljs-literal">true</span>) {
            warnPath(<span class="hljs-literal">true</span>);
            that.iPath++;

            <span class="hljs-keyword">if</span>(that.iPath &gt;= that.currentPath.length) {
                that.isInPause = <span class="hljs-literal">true</span>;
                that.gui.setStatusAnimation(<span class="hljs-string">"pause"</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
            that.gui.highlight(that.currentPath[that.iPath].lineNumber);
            setCurrentSpeed();
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-comment">//deltaDistance : the distance to make</span>
    <span class="hljs-comment">//returns true if can continue animation</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">animateBit</span>(<span class="hljs-params">deltaTime</span>) </span>{
        <span class="hljs-keyword">var</span> deltaDistance = that.currentSpeed * deltaTime;
        <span class="hljs-keyword">var</span> destination = that.currentPath[that.iPath].point;
        <span class="hljs-keyword">var</span> position = getRelativeBitPosition();
        <span class="hljs-keyword">var</span> translation = {
            x : destination.x - position.x,
            y : destination.y - position.y,
            z : destination.z - position.z
        };
        <span class="hljs-keyword">var</span> distance2 = translation.x * translation.x;
        distance2 += translation.y * translation.y;
        distance2 += translation.z * translation.z;
        <span class="hljs-keyword">var</span> length = <span class="hljs-built_in">Math</span>.sqrt(distance2);

        <span class="hljs-keyword">if</span>(length &gt; deltaDistance) {
            translation.x = translation.x / length * deltaDistance;
            translation.y = translation.y / length * deltaDistance;
            translation.z = translation.z / length * deltaDistance;
            translateBit(translation);
            warnPath(<span class="hljs-literal">false</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }

        setBitPosition(destination);
        deltaTime -= length / that.currentSpeed;
        <span class="hljs-keyword">if</span>(checkChangeIndexPath() === <span class="hljs-literal">false</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }

        <span class="hljs-keyword">return</span> animateBit(deltaTime);
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Updates the position and do the logical for the animation.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">update</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> deltaTime = calculateDeltaTime(); <span class="hljs-comment">//Must be here to update each time</span>
        <span class="hljs-keyword">if</span>(that.isPaused() === <span class="hljs-literal">true</span>) {
            <span class="hljs-keyword">return</span>;
        }

        animateBit(deltaTime);

        that.refreshFunction();
    }</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p>Returns if the animation is paused.</p>
<p><strong>Returns a boolean</strong><br/>(True if the animation is paused.)</p></div></div><div class="code"><div class="wrapper">    that.isPaused = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> that.isInPause === <span class="hljs-literal">true</span>;
    };</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p>Returns if the animation is running.</p>
<p><strong>Returns a boolean</strong><br/>(True if the animation is running.)</p></div></div><div class="code"><div class="wrapper">    that.isRunning = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> that.isInPause === <span class="hljs-literal">false</span>;
    };

    <span class="hljs-comment">//Returns the index of the point in path associated to this lineNumber</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>returns -1 if nothing found</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">findIndexPath</span>(<span class="hljs-params">lineNumber</span>) </span>{
        <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>; i &lt; that.currentPath.length; i++) {
            <span class="hljs-keyword">if</span>(that.currentPath[i].lineNumber === lineNumber) {
                <span class="hljs-keyword">return</span> i;
            }
        }
        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
    }</div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p>Starts the animation according to the command in the line number given
(the animation is paused).</p>
<p>Parameters:</p>
<ul>
<li><strong>lineNumber must be a number.</strong><br/>(The line number of the command.)</li>
</ul>
<p><strong>Returns a boolean</strong><br/>(Returns true if start the animation; false if problem.)</p></div></div><div class="code"><div class="wrapper">    that.goToLine = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">lineNumber</span>) </span>{
        that.path.redoMeshes();
        that.pause();
        that.currentPath = that.path.getPath();
        <span class="hljs-keyword">var</span> iLine = findIndexPath(lineNumber);
        <span class="hljs-keyword">var</span> pos = { x : <span class="hljs-number">0</span>, y : <span class="hljs-number">0</span>, z : <span class="hljs-number">0</span> };
        <span class="hljs-keyword">var</span> pointPath;

        <span class="hljs-keyword">if</span>(iLine === -<span class="hljs-number">1</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }

        <span class="hljs-keyword">for</span>(that.iPath=<span class="hljs-number">0</span>; that.iPath &lt;= iLine; that.iPath++) {
            pointPath = that.currentPath[that.iPath];
            <span class="hljs-keyword">if</span>(isStartingPath() === <span class="hljs-literal">true</span>) {
                that.path.startPath(pointPath);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(isEndingPath() === <span class="hljs-literal">true</span>) {
                that.path.endPath(pointPath);
            } <span class="hljs-keyword">else</span> {
                that.path.reachedIntermediate(pointPath);
            }
        }

        pos = that.currentPath[that.iPath-<span class="hljs-number">1</span>].point;
        that.bit.position.setX(pos.x + that.initialPosition.x);
        that.bit.position.setY(pos.y + that.initialPosition.y);
        that.bit.position.setZ(pos.z + that.initialPosition.z);

        that.gui.highlight(that.currentPath[that.iPath].lineNumber);
        setCurrentSpeed();
        that.isInPause = <span class="hljs-literal">true</span>;
        that.refreshFunction();

        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Pauses the animation.</p></div></div><div class="code"><div class="wrapper">    that.pause = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        that.isInPause = <span class="hljs-literal">true</span>;
        that.gui.setStatusAnimation(<span class="hljs-string">"pause"</span>);
    };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Resumes the animation.</p></div></div><div class="code"><div class="wrapper">    that.resume = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span>(that.currentPath.length === <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">if</span>(that.iPath === that.currentPath.length) {
            that.rewind();
        }
        that.isInPause = <span class="hljs-literal">false</span>;
        that.gui.setStatusAnimation(<span class="hljs-string">"running"</span>);
    };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Goes back to the beginning of the animation without modifying the path.</p></div></div><div class="code"><div class="wrapper">    that.rewind = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        setBitPosition(that.initialPosition);
        that.iPath = <span class="hljs-number">0</span>;
        that.path.redoMeshes();
        setCurrentSpeed();
        that.pause();
        that.refreshFunction();
    };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Resets the animation (gets the new path and goes to the beginning).</p></div></div><div class="code"><div class="wrapper">    that.reset = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        that.rewind();
        that.currentPath = that.path.getPath();
        setCurrentSpeed();
    };

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createBit</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> material = <span class="hljs-keyword">new</span> THREE.MeshLambertMaterial({color: <span class="hljs-number">0xF07530</span>,
            transparent: <span class="hljs-literal">true</span>, opacity: <span class="hljs-number">0.5</span>});
        <span class="hljs-keyword">var</span> geometry = <span class="hljs-keyword">new</span> THREE.CylinderGeometry(<span class="hljs-number">0</span>, lengthBit / <span class="hljs-number">5</span>, lengthBit, <span class="hljs-number">32</span>);
        geometry.applyMatrix(<span class="hljs-keyword">new</span> THREE.Matrix4().makeRotationX(-<span class="hljs-built_in">Math</span>.PI / <span class="hljs-number">2</span>));
        geometry.applyMatrix(<span class="hljs-keyword">new</span> THREE.Matrix4().makeTranslation(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, lengthBit/<span class="hljs-number">2</span>));
        that.bit = <span class="hljs-keyword">new</span> THREE.Mesh(geometry, material);
        setBitPosition(that.initialPosition);
        that.scene.add(that.bit);
        that.refreshFunction();
    }

    <span class="hljs-comment">//initialize</span>
    that.currentPath = [];
    that.path = path;
    <span class="hljs-keyword">if</span>(initialPosition === <span class="hljs-literal">undefined</span>) {
        that.initialPosition = { x : <span class="hljs-number">0</span>, y : <span class="hljs-number">0</span>, z : <span class="hljs-number">0</span>};
    } <span class="hljs-keyword">else</span> {
        that.initialPosition = initialPosition;
    }
    that.scene = scene;
    that.refreshFunction = refreshFunction;
    that.gui = gui;
    createBit();

    that.pause();
    that.lastTime = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime();
    setInterval(update, <span class="hljs-number">1000</span> / fps);
};

exports.Animation = Animation;</div></div></div></div></body></html>