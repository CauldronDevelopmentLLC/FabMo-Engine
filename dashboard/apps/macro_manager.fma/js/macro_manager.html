<!DOCTYPE html><html lang="en"><head><title>dashboard/apps/macro_manager.fma/js/macro_manager</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../../../"><meta name="groc-document-path" content="dashboard/apps/macro_manager.fma/js/macro_manager"><meta name="groc-project-path" content="dashboard/apps/macro_manager.fma/js/macro_manager.js"><link rel="stylesheet" type="text/css" media="all" href="../../../../assets/style.css"><script type="text/javascript" src="../../../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">dashboard/apps/macro_manager.fma/js/macro_manager.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-built_in">require</span>(<span class="hljs-string">'jquery'</span>);
<span class="hljs-keyword">var</span> Foundation = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../../../static/js/libs/foundation.min.js'</span>);;
<span class="hljs-keyword">var</span> Fabmo = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../../../static/js/libs/fabmo.js'</span>);
<span class="hljs-keyword">var</span> fabmo = <span class="hljs-keyword">new</span> Fabmo;

<span class="hljs-keyword">var</span> macroIndex = {};

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getMacroFromClick</span>(<span class="hljs-params">elem</span>) </span>{
    <span class="hljs-keyword">var</span> id = $(elem).closest(<span class="hljs-string">'tr'</span>).data(<span class="hljs-string">'macro'</span>);
    <span class="hljs-keyword">return</span> macroIndex[id];
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clearMacroTable</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> table = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'macro_table_body'</span>);
    <span class="hljs-keyword">var</span> rows = table.rows.length;
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i&lt;rows; i++) {
        table.deleteRow(<span class="hljs-number">0</span>);
    }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addMacros</span>(<span class="hljs-params">macros, callback</span>) </span>{
    callback = callback || <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{};
    <span class="hljs-keyword">var</span> table = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'macro_table_body'</span>);
    macros.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">macro</span>) </span>{
        <span class="hljs-keyword">var</span> row = table.insertRow(table.rows.length);
        <span class="hljs-keyword">var</span> playCell = row.insertCell(<span class="hljs-number">0</span>);
        <span class="hljs-keyword">var</span> numberCell = row.insertCell(<span class="hljs-number">1</span>);        
        <span class="hljs-keyword">var</span> nameCell = row.insertCell(<span class="hljs-number">2</span>);
        <span class="hljs-keyword">var</span> descriptionCell = row.insertCell(<span class="hljs-number">3</span>);
        <span class="hljs-keyword">var</span> editCell = row.insertCell(<span class="hljs-number">4</span>);
        <span class="hljs-keyword">var</span> deleteCell = row.insertCell(<span class="hljs-number">5</span>);

        row.dataset.macro = macro.index;

        numberCell.className = <span class="hljs-string">'number'</span>;        
        numberCell.innerHTML = <span class="hljs-string">'&lt;input class="field" type="number" data-fieldname="index" size="3" maxlen="3"&gt;&lt;/input&gt;'</span>;
        numberCell.firstChild.setAttribute(<span class="hljs-string">'value'</span>, macro.index);

        nameCell.className = <span class="hljs-string">'name'</span>;
        nameCell.innerHTML = <span class="hljs-string">'&lt;input class="field" type="text" data-fieldname="name"&gt;&lt;/input&gt;'</span>;
        nameCell.firstChild.setAttribute(<span class="hljs-string">'value'</span>, macro.name);

        descriptionCell.className = <span class="hljs-string">'description'</span>;
        descriptionCell.innerHTML = <span class="hljs-string">'&lt;input class="field" type="text" data-fieldname="description"&gt;&lt;/input&gt;'</span>;
        descriptionCell.firstChild.setAttribute(<span class="hljs-string">'value'</span>, macro.description);

        playCell.className = <span class="hljs-string">'run-control'</span>;
        playCell.innerHTML = <span class="hljs-string">'&lt;img class="svg" src="css/images/play_icon.png"&gt;'</span>

        deleteCell.className = <span class="hljs-string">'delete-control'</span>;
        deleteCell.innerHTML = <span class="hljs-string">'&lt;img class="svg" src="css/images/recycling10.svg"&gt;'</span>
        
        editCell.className = <span class="hljs-string">'edit-control'</span>;
        editCell.innerHTML = <span class="hljs-string">'&lt;img class="svg" src="css/images/edit_icon.png"&gt;'</span>

    });

    $(<span class="hljs-string">'.run-control'</span>).click(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) </span>{
        <span class="hljs-keyword">var</span> macro = getMacroFromClick(<span class="hljs-keyword">this</span>);
        fabmo.runMacro(macro.index, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
            <span class="hljs-keyword">if</span>(err) {
                fabmo.notify(<span class="hljs-string">'error'</span>, err.message || err);
            }
            refreshMacros();
        });
    });

    $(<span class="hljs-string">'.delete-control'</span>).click(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) </span>{
        <span class="hljs-keyword">var</span> macro = getMacroFromClick(<span class="hljs-keyword">this</span>);
        fabmo.deleteMacro(macro.index, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
            <span class="hljs-keyword">if</span>(err) {
                fabmo.notify(<span class="hljs-string">'error'</span>, err.message || err);
            } <span class="hljs-keyword">else</span> {
                fabmo.notify(<span class="hljs-string">'success'</span>, <span class="hljs-string">'Macro "'</span> + macro.name + <span class="hljs-string">'" was deleted.'</span>);
            }
            refreshMacros();
        });
    });

    $(<span class="hljs-string">'.edit-control'</span>).click(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) </span>{
        <span class="hljs-keyword">var</span> macro = getMacroFromClick(<span class="hljs-keyword">this</span>);
        fabmo.launchApp(<span class="hljs-string">'editor'</span>, {<span class="hljs-string">'macro'</span> : macro.index});
    });

    $(<span class="hljs-string">'.field'</span>).change(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) </span>{
        <span class="hljs-keyword">var</span> newValue = $(<span class="hljs-keyword">this</span>).val();
        <span class="hljs-keyword">var</span> fieldName = <span class="hljs-keyword">this</span>.dataset.fieldname;
        <span class="hljs-keyword">var</span> macro = getMacroFromClick(<span class="hljs-keyword">this</span>);
        <span class="hljs-keyword">var</span> update = {};
        update[fieldName] = newValue;
        fabmo.updateMacro(macro.index, update, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, result</span>) </span>{
            <span class="hljs-keyword">if</span>(err) {
                fabmo.notify(<span class="hljs-string">'error'</span>, err.message || err);
            }
            refreshMacros();
        });   
    });
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateMacroIndex</span>(<span class="hljs-params">macros</span>) </span>{
    macroIndex = {};
    macros.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>) </span>{
        macroIndex[item.index] = item;
    });
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">refreshMacros</span>(<span class="hljs-params">callback</span>) </span>{
    callback = callback || <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{};
    fabmo.getMacros(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, macros</span>) </span>{
        <span class="hljs-keyword">if</span>(err) {
            <span class="hljs-keyword">return</span> callback(err);
        }
        updateMacroIndex(macros);
        clearMacroTable();
        addMacros(macros);
        callback(<span class="hljs-literal">null</span>);
    });
}


$(<span class="hljs-built_in">document</span>).ready(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

    $(<span class="hljs-built_in">document</span>).foundation();

    refreshMacros();
    
    $(<span class="hljs-string">'#macro-new'</span>).on(<span class="hljs-string">'click'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) </span>{
        <span class="hljs-keyword">var</span> macroCount = <span class="hljs-built_in">Object</span>.keys(macroIndex).length;
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> newIndex=<span class="hljs-number">1</span>; newIndex&lt;macroCount+<span class="hljs-number">1</span>; newIndex++) {
            <span class="hljs-keyword">if</span>(!macroIndex[newIndex]) {
                <span class="hljs-keyword">break</span>;
            }
        }
        fabmo.updateMacro(newIndex, {}, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, result</span>) </span>{
            <span class="hljs-keyword">if</span>(err) {
                fabmo.notify(<span class="hljs-string">'error'</span>, err.message || err);                        
            }
            refreshMacros();
        });
        evt.preventDefault();
    }); 
});</div></div></div></div></body></html>