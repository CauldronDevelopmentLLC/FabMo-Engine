/*
* Generated by PEG.js 0.8.0.
*
* http://pegjs.majda.cz/
*/

/**
 * The rest of this module was written by Alex Canales for ShopBotTools, Inc.
 */

var GParser=function(){function a(a,b){function c(){this.constructor=a}c.prototype=b.prototype,a.prototype=new c}function b(a,b,c,d,e,f){this.message=a,this.expected=b,this.found=c,this.offset=d,this.line=e,this.column=f,this.name="SyntaxError"}function c(a){function c(){return a.substring(Jb,Ib)}function d(b){function c(b,c,d){var e,f;for(e=c;d>e;e++)f=a.charAt(e),"\n"===f?(b.seenCR||b.line++,b.column=1,b.seenCR=!1):"\r"===f||"\u2028"===f||"\u2029"===f?(b.line++,b.column=1,b.seenCR=!0):(b.column++,b.seenCR=!1)}return Kb!==b&&(Kb>b&&(Kb=0,Lb={line:1,column:1,seenCR:!1}),c(Lb,Kb,b),Kb=b),Lb}function e(a){Mb>Ib||(Ib>Mb&&(Mb=Ib,Nb=[]),Nb.push(a))}function f(c,e,f){function g(a){var b=1;for(a.sort(function(a,b){return a.description<b.description?-1:a.description>b.description?1:0});b<a.length;)a[b-1]===a[b]?a.splice(b,1):b++}function h(a,b){function c(a){function b(a){return a.charCodeAt(0).toString(16).toUpperCase()}return a.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E\x0F]/g,function(a){return"\\x0"+b(a)}).replace(/[\x10-\x1F\x80-\xFF]/g,function(a){return"\\x"+b(a)}).replace(/[\u0180-\u0FFF]/g,function(a){return"\\u0"+b(a)}).replace(/[\u1080-\uFFFF]/g,function(a){return"\\u"+b(a)})}var d,e,f,g=new Array(a.length);for(f=0;f<a.length;f++)g[f]=a[f].description;return d=a.length>1?g.slice(0,-1).join(", ")+" or "+g[a.length-1]:g[0],e=b?'"'+c(b)+'"':"end of input","Expected "+d+" but "+e+" found."}var i=d(f),j=f<a.length?a.charAt(f):null;return null!==e&&g(e),new b(null!==c?c:h(e,j),e,j,f,i.line,i.column)}function g(){var a;return a=h()}function h(){var a,b,c,d;if(a=Ib,b=j(),b===B&&(b=F),b!==B){for(c=[],d=i();d!==B;)c.push(d),d=i();c!==B?(Jb=a,b=G(b,c),a=b):(Ib=a,a=E)}else Ib=a,a=E;return a}function i(){var a,b,c;return a=Ib,b=y(),b!==B?(c=q(),c!==B?(Jb=a,b=H(b,c),a=b):(Ib=a,a=E)):(Ib=a,a=E),a}function j(){var b,c,d;return b=Ib,78===a.charCodeAt(Ib)?(c=I,Ib++):(c=B,0===Ob&&e(J)),c!==B?(d=k(),d!==B?(c=[c,d],b=c):(Ib=b,b=E)):(Ib=b,b=E),b}function k(){var b,c,d;if(b=Ib,c=[],K.test(a.charAt(Ib))?(d=a.charAt(Ib),Ib++):(d=B,0===Ob&&e(L)),d!==B)for(;d!==B;)c.push(d),K.test(a.charAt(Ib))?(d=a.charAt(Ib),Ib++):(d=B,0===Ob&&e(L));else c=E;return c!==B&&(Jb=b,c=M()),b=c}function l(){var b,c,d,f,g,h,i;if(b=Ib,N.test(a.charAt(Ib))?(c=a.charAt(Ib),Ib++):(c=B,0===Ob&&e(O)),c===B&&(c=F),c!==B){if(d=[],K.test(a.charAt(Ib))?(f=a.charAt(Ib),Ib++):(f=B,0===Ob&&e(L)),f!==B)for(;f!==B;)d.push(f),K.test(a.charAt(Ib))?(f=a.charAt(Ib),Ib++):(f=B,0===Ob&&e(L));else d=E;if(d!==B){if(f=Ib,P.test(a.charAt(Ib))?(g=a.charAt(Ib),Ib++):(g=B,0===Ob&&e(Q)),g!==B){if(h=[],K.test(a.charAt(Ib))?(i=a.charAt(Ib),Ib++):(i=B,0===Ob&&e(L)),i!==B)for(;i!==B;)h.push(i),K.test(a.charAt(Ib))?(i=a.charAt(Ib),Ib++):(i=B,0===Ob&&e(L));else h=E;h!==B?(g=[g,h],f=g):(Ib=f,f=E)}else Ib=f,f=E;f===B&&(f=F),f!==B?(Jb=b,c=R(),b=c):(Ib=b,b=E)}else Ib=b,b=E}else Ib=b,b=E;return b}function m(){var b,c,d,f;return b=Ib,91===a.charCodeAt(Ib)?(c=S,Ib++):(c=B,0===Ob&&e(T)),c!==B?(d=t(),d!==B?(93===a.charCodeAt(Ib)?(f=U,Ib++):(f=B,0===Ob&&e(V)),f!==B?(Jb=b,c=W(d),b=c):(Ib=b,b=E)):(Ib=b,b=E)):(Ib=b,b=E),b}function n(){var b,c,d,f,g;return b=Ib,a.substr(Ib,4)===X?(c=X,Ib+=4):(c=B,0===Ob&&e(Y)),c!==B?(d=m(),d!==B?(47===a.charCodeAt(Ib)?(f=Z,Ib++):(f=B,0===Ob&&e($)),f!==B?(g=m(),g!==B?(Jb=b,c=_(d,g),b=c):(Ib=b,b=E)):(Ib=b,b=E)):(Ib=b,b=E)):(Ib=b,b=E),b}function o(){var a,b,c;return a=Ib,b=x(),b!==B?(c=m(),c!==B?(Jb=a,b=aa(b,c),a=b):(Ib=a,a=E)):(Ib=a,a=E),a}function p(){var b,c,d;return b=Ib,35===a.charCodeAt(Ib)?(c=ba,Ib++):(c=B,0===Ob&&e(ca)),c!==B?(d=m(),d===B&&(d=l(),d===B&&(d=p())),d!==B?(Jb=b,c=da(d),b=c):(Ib=b,b=E)):(Ib=b,b=E),b}function q(){var a;return a=m(),a===B&&(a=l(),a===B&&(a=n(),a===B&&(a=o(),a===B&&(a=p())))),a}function r(){var a,b,c,d,e,f;if(a=Ib,b=q(),b!==B){for(c=[],d=Ib,e=u(),e!==B?(f=q(),f!==B?(e=[e,f],d=e):(Ib=d,d=E)):(Ib=d,d=E);d!==B;)c.push(d),d=Ib,e=u(),e!==B?(f=q(),f!==B?(e=[e,f],d=e):(Ib=d,d=E)):(Ib=d,d=E);c!==B?(Jb=a,b=ea(b,c),a=b):(Ib=a,a=E)}else Ib=a,a=E;return a}function s(){var a,b,c,d,e,f;if(a=Ib,b=r(),b!==B){for(c=[],d=Ib,e=v(),e!==B?(f=r(),f!==B?(e=[e,f],d=e):(Ib=d,d=E)):(Ib=d,d=E);d!==B;)c.push(d),d=Ib,e=v(),e!==B?(f=r(),f!==B?(e=[e,f],d=e):(Ib=d,d=E)):(Ib=d,d=E);c!==B?(Jb=a,b=fa(b,c),a=b):(Ib=a,a=E)}else Ib=a,a=E;return a}function t(){var a,b,c,d,e,f;if(a=Ib,b=s(),b!==B){for(c=[],d=Ib,e=w(),e!==B?(f=s(),f!==B?(e=[e,f],d=e):(Ib=d,d=E)):(Ib=d,d=E);d!==B;)c.push(d),d=Ib,e=w(),e!==B?(f=s(),f!==B?(e=[e,f],d=e):(Ib=d,d=E)):(Ib=d,d=E);c!==B?(Jb=a,b=fa(b,c),a=b):(Ib=a,a=E)}else Ib=a,a=E;return a}function u(){var b;return a.substr(Ib,2)===ga?(b=ga,Ib+=2):(b=B,0===Ob&&e(ha)),b}function v(){var b;return 42===a.charCodeAt(Ib)?(b=ia,Ib++):(b=B,0===Ob&&e(ja)),b===B&&(47===a.charCodeAt(Ib)?(b=Z,Ib++):(b=B,0===Ob&&e($)),b===B&&(a.substr(Ib,3)===ka?(b=ka,Ib+=3):(b=B,0===Ob&&e(la)))),b}function w(){var b;return 43===a.charCodeAt(Ib)?(b=ma,Ib++):(b=B,0===Ob&&e(na)),b===B&&(45===a.charCodeAt(Ib)?(b=oa,Ib++):(b=B,0===Ob&&e(pa)),b===B&&(a.substr(Ib,2)===qa?(b=qa,Ib+=2):(b=B,0===Ob&&e(ra)),b===B&&(a.substr(Ib,3)===sa?(b=sa,Ib+=3):(b=B,0===Ob&&e(ta)),b===B&&(a.substr(Ib,3)===ua?(b=ua,Ib+=3):(b=B,0===Ob&&e(va)))))),b}function x(){var b;return a.substr(Ib,3)===wa?(b=wa,Ib+=3):(b=B,0===Ob&&e(xa)),b===B&&(a.substr(Ib,4)===ya?(b=ya,Ib+=4):(b=B,0===Ob&&e(za)),b===B&&(a.substr(Ib,4)===Aa?(b=Aa,Ib+=4):(b=B,0===Ob&&e(Ba)),b===B&&(a.substr(Ib,3)===Ca?(b=Ca,Ib+=3):(b=B,0===Ob&&e(Da)),b===B&&(a.substr(Ib,3)===Ea?(b=Ea,Ib+=3):(b=B,0===Ob&&e(Fa)),b===B&&(a.substr(Ib,3)===Ga?(b=Ga,Ib+=3):(b=B,0===Ob&&e(Ha)),b===B&&(a.substr(Ib,3)===Ia?(b=Ia,Ib+=3):(b=B,0===Ob&&e(Ja)),b===B&&(a.substr(Ib,5)===Ka?(b=Ka,Ib+=5):(b=B,0===Ob&&e(La)),b===B&&(a.substr(Ib,2)===Ma?(b=Ma,Ib+=2):(b=B,0===Ob&&e(Na)),b===B&&(a.substr(Ib,3)===Oa?(b=Oa,Ib+=3):(b=B,0===Ob&&e(Pa)),b===B&&(a.substr(Ib,4)===Qa?(b=Qa,Ib+=4):(b=B,0===Ob&&e(Ra)),b===B&&(a.substr(Ib,3)===Sa?(b=Sa,Ib+=3):(b=B,0===Ob&&e(Ta)),b===B&&(a.substr(Ib,6)===Ua?(b=Ua,Ib+=6):(b=B,0===Ob&&e(Va)))))))))))))),b}function y(){var b;return 65===a.charCodeAt(Ib)?(b=Wa,Ib++):(b=B,0===Ob&&e(Xa)),b===B&&(66===a.charCodeAt(Ib)?(b=Ya,Ib++):(b=B,0===Ob&&e(Za)),b===B&&(67===a.charCodeAt(Ib)?(b=$a,Ib++):(b=B,0===Ob&&e(_a)),b===B&&(68===a.charCodeAt(Ib)?(b=ab,Ib++):(b=B,0===Ob&&e(bb)),b===B&&(70===a.charCodeAt(Ib)?(b=cb,Ib++):(b=B,0===Ob&&e(db)),b===B&&(71===a.charCodeAt(Ib)?(b=eb,Ib++):(b=B,0===Ob&&e(fb)),b===B&&(72===a.charCodeAt(Ib)?(b=gb,Ib++):(b=B,0===Ob&&e(hb)),b===B&&(73===a.charCodeAt(Ib)?(b=ib,Ib++):(b=B,0===Ob&&e(jb)),b===B&&(74===a.charCodeAt(Ib)?(b=kb,Ib++):(b=B,0===Ob&&e(lb)),b===B&&(75===a.charCodeAt(Ib)?(b=mb,Ib++):(b=B,0===Ob&&e(nb)),b===B&&(76===a.charCodeAt(Ib)?(b=ob,Ib++):(b=B,0===Ob&&e(pb)),b===B&&(77===a.charCodeAt(Ib)?(b=qb,Ib++):(b=B,0===Ob&&e(rb)),b===B&&(80===a.charCodeAt(Ib)?(b=sb,Ib++):(b=B,0===Ob&&e(tb)),b===B&&(81===a.charCodeAt(Ib)?(b=ub,Ib++):(b=B,0===Ob&&e(vb)),b===B&&(82===a.charCodeAt(Ib)?(b=wb,Ib++):(b=B,0===Ob&&e(xb)),b===B&&(83===a.charCodeAt(Ib)?(b=yb,Ib++):(b=B,0===Ob&&e(zb)),b===B&&(84===a.charCodeAt(Ib)?(b=Ab,Ib++):(b=B,0===Ob&&e(Bb)),b===B&&(88===a.charCodeAt(Ib)?(b=Cb,Ib++):(b=B,0===Ob&&e(Db)),b===B&&(89===a.charCodeAt(Ib)?(b=Eb,Ib++):(b=B,0===Ob&&e(Fb)),b===B&&(90===a.charCodeAt(Ib)?(b=Gb,Ib++):(b=B,0===Ob&&e(Hb))))))))))))))))))))),b}var z,A=arguments.length>1?arguments[1]:{},B={},C={start:g},D=g,E=B,F=null,G=function(a,b){return{N:a,words:b}},H=function(a,b){return[a,b]},I="N",J={type:"literal",value:"N",description:'"N"'},K=/^[0-9]/,L={type:"class",value:"[0-9]",description:"[0-9]"},M=function(){return parseInt(c())},N=/^[+\-]/,O={type:"class",value:"[+\\-]",description:"[+\\-]"},P=/^[.]/,Q={type:"class",value:"[.]",description:"[.]"},R=function(){return parseFloat(c())},S="[",T={type:"literal",value:"[",description:'"["'},U="]",V={type:"literal",value:"]",description:'"]"'},W=function(a){return a},X="ATAN",Y={type:"literal",value:"ATAN",description:'"ATAN"'},Z="/",$={type:"literal",value:"/",description:'"/"'},_=function(a,b){return{op:"ATAN",left:a,right:b}},aa=function(a,b){return{op:a,right:b}},ba="#",ca={type:"literal",value:"#",description:'"#"'},da=function(a){return{op:"#",right:a}},ea=function(a,b){return buildTree(a,b)},fa=function(a,b){return buildTree(a,b)},ga="**",ha={type:"literal",value:"**",description:'"**"'},ia="*",ja={type:"literal",value:"*",description:'"*"'},ka="MOD",la={type:"literal",value:"MOD",description:'"MOD"'},ma="+",na={type:"literal",value:"+",description:'"+"'},oa="-",pa={type:"literal",value:"-",description:'"-"'},qa="OR",ra={type:"literal",value:"OR",description:'"OR"'},sa="XOR",ta={type:"literal",value:"XOR",description:'"XOR"'},ua="AND",va={type:"literal",value:"AND",description:'"AND"'},wa="ABS",xa={type:"literal",value:"ABS",description:'"ABS"'},ya="ACOS",za={type:"literal",value:"ACOS",description:'"ACOS"'},Aa="ASIN",Ba={type:"literal",value:"ASIN",description:'"ASIN"'},Ca="COS",Da={type:"literal",value:"COS",description:'"COS"'},Ea="EXP",Fa={type:"literal",value:"EXP",description:'"EXP"'},Ga="FIX",Ha={type:"literal",value:"FIX",description:'"FIX"'},Ia="FUP",Ja={type:"literal",value:"FUP",description:'"FUP"'},Ka="ROUND",La={type:"literal",value:"ROUND",description:'"ROUND"'},Ma="LN",Na={type:"literal",value:"LN",description:'"LN"'},Oa="SIN",Pa={type:"literal",value:"SIN",description:'"SIN"'},Qa="SQRT",Ra={type:"literal",value:"SQRT",description:'"SQRT"'},Sa="TAN",Ta={type:"literal",value:"TAN",description:'"TAN"'},Ua="EXISTS",Va={type:"literal",value:"EXISTS",description:'"EXISTS"'},Wa="A",Xa={type:"literal",value:"A",description:'"A"'},Ya="B",Za={type:"literal",value:"B",description:'"B"'},$a="C",_a={type:"literal",value:"C",description:'"C"'},ab="D",bb={type:"literal",value:"D",description:'"D"'},cb="F",db={type:"literal",value:"F",description:'"F"'},eb="G",fb={type:"literal",value:"G",description:'"G"'},gb="H",hb={type:"literal",value:"H",description:'"H"'},ib="I",jb={type:"literal",value:"I",description:'"I"'},kb="J",lb={type:"literal",value:"J",description:'"J"'},mb="K",nb={type:"literal",value:"K",description:'"K"'},ob="L",pb={type:"literal",value:"L",description:'"L"'},qb="M",rb={type:"literal",value:"M",description:'"M"'},sb="P",tb={type:"literal",value:"P",description:'"P"'},ub="Q",vb={type:"literal",value:"Q",description:'"Q"'},wb="R",xb={type:"literal",value:"R",description:'"R"'},yb="S",zb={type:"literal",value:"S",description:'"S"'},Ab="T",Bb={type:"literal",value:"T",description:'"T"'},Cb="X",Db={type:"literal",value:"X",description:'"X"'},Eb="Y",Fb={type:"literal",value:"Y",description:'"Y"'},Gb="Z",Hb={type:"literal",value:"Z",description:'"Z"'},Ib=0,Jb=0,Kb=0,Lb={line:1,column:1,seenCR:!1},Mb=0,Nb=[],Ob=0;if("startRule"in A){if(!(A.startRule in C))throw new Error("Can't start parsing from rule \""+A.startRule+'".');D=C[A.startRule]}if(buildTree=function(a,b){if(0==b.length)return a;var c=b.shift(),d=c[0],e=c[1];return{left:a,right:buildTree(e,b),op:d}},z=D(),z!==B&&Ib===a.length)return z;throw z!==B&&Ib<a.length&&e({type:"end",description:"end of input"}),f(null,Nb,Mb)}return a(b,Error),{SyntaxError:b,parse:c}}(),GCodeToGeometry={};GCodeToGeometry.inchToMm=25.4,GCodeToGeometry.mmToInch=.03937008,GCodeToGeometry.findPosition=function(a,b,c,d){var e={x:a.x,y:a.y,z:a.z},f=d===!1?1:GCodeToGeometry.mmToInch;return c===!0?(void 0!==b.x&&(e.x+=b.x*f),void 0!==b.y&&(e.y+=b.y*f),void 0!==b.z&&(e.z+=b.z*f)):(void 0!==b.x&&(e.x=b.x*f),void 0!==b.y&&(e.y=b.y*f),void 0!==b.z&&(e.z=b.z*f)),e},GCodeToGeometry.swapObjects=function(a,b){var c,d=Object.keys(a),e=0;for(e=0;e<d.length;e++)"object"==typeof a[d[e]]?GCodeToGeometry.swapObjects(a[d[e]],b[d[e]]):(c=a[d[e]],a[d[e]]=b[d[e]],b[d[e]]=c)},GCodeToGeometry.copyObject=function(a){var b=Object.keys(a),c=0,d={};for(c=0;c<b.length;c++)"object"==typeof a[b[c]]?d[b[c]]=GCodeToGeometry.copyObject(a[b[c]]):d[b[c]]=a[b[c]];return d},GCodeToGeometry.movePoint=function(a,b){var c=Object.keys(b),d=0;for(d=0;d<c.length;d++)void 0!==a[c[d]]&&(a[c[d]]+=b[c[d]])},GCodeToGeometry.dotProduct2=function(a,b){return a.x*b.x+a.y*b.y},GCodeToGeometry.crossProduct2=function(a,b){return a.x*b.y-b.x*a.y},GCodeToGeometry.lengthVector3=function(a){return Math.sqrt(a.x*a.x+a.y*a.y+a.z*a.z)},GCodeToGeometry.findAxes=function(a){return"x"===a.toLowerCase()?{re:"y",im:"z",cr:"x"}:"y"===a.toLowerCase()?{re:"z",im:"x",cr:"y"}:{re:"x",im:"y",cr:"z"}},GCodeToGeometry.scaleAndRotation=function(a,b,c,d,e,f,g){var h=a,i=b,j=c,k=e,l=Math.cos(d),m=Math.sin(d),n=i[f],o=i[g],p=h[f],q=h[g];j[f]=k*((n-p)*l-(o-q)*m)+p,j[g]=k*((o-q)*l+(n-p)*m)+q},GCodeToGeometry.findAngleVectors2=function(a,b){var c=GCodeToGeometry.crossProduct2(a,b),d=GCodeToGeometry.dotProduct2(a,b),e=Math.sqrt(a.x*a.x+a.y*a.y),f=Math.sqrt(b.x*b.x+b.y*b.y);return 0===e||0===f?0:(0===c&&(c=1),0>c?-Math.acos(d/(e*f)):Math.acos(d/(e*f)))},GCodeToGeometry.findAngleOrientedVectors2=function(a,b,c){var d=GCodeToGeometry.findAngleVectors2(a,b);return c===!1&&d>0?-(2*Math.PI-d):c===!0&&0>d?2*Math.PI+d:d},GCodeToGeometry.findCenter=function(a,b,c,d,e){var f={x:b.x-a.x,y:b.y-a.y,z:b.z-a.z},g=0,h=1,i=0,j=Math.abs(c),k=0,l={x:0,y:0,z:0},m=GCodeToGeometry.findAxes(e);if(i=Math.sqrt(f[m.re]*f[m.re]+f[m.im]*f[m.im]),i>Math.abs(2*c)||0===i)return!1;if(g=Math.acos(i/(2*j)),h=j/i,GCodeToGeometry.scaleAndRotation(a,b,l,g,h,m.re,m.im),k=GCodeToGeometry.findAngleVectors2({x:a[m.re]-l[m.re],y:a[m.im]-l[m.im]},{x:b[m.re]-l[m.re],y:b[m.im]-l[m.im]}),d===!0){if(c>0&&-Math.PI<=k&&0>=k)return l;if(0>c&&k>=0&&k<=Math.PI)return l}else{if(c>0&&k>=0&&k<=Math.PI)return l;if(0>c&&-Math.PI<=k&&0>=k)return l}return GCodeToGeometry.scaleAndRotation(a,b,l,-g,h,m.re,m.im),l},GCodeToGeometry.StraightLine=function(a,b,c,d,e){"use strict";function f(a,b,c,d,e){g.index=a,g.word=c.type,g.start={x:b.x,y:b.y,z:b.z},g.end=GCodeToGeometry.findPosition(b,c,d,e)}var g=this;g.returnLine=function(){return{lineNumber:g.index,type:g.word,start:g.start,end:g.end}},g.getSize=function(){return{min:{x:Math.min(g.start.x,g.end.x),y:Math.min(g.start.y,g.end.y),z:Math.min(g.start.z,g.end.z)},max:{x:Math.max(g.start.x,g.end.x),y:Math.max(g.start.y,g.end.y),z:Math.max(g.start.z,g.end.z)}}},f(a,b,c,d,e)},GCodeToGeometry.CurvedLine=function(a,b,c,d,e,f){"use strict";function g(){var a=GCodeToGeometry.findAxes(r.crossAxe),b={x:r.start[a.re]-r.center[a.re],y:r.start[a.im]-r.center[a.im],z:0},c={x:r.end[a.re]-r.center[a.re],y:r.end[a.im]-r.center[a.im],z:0};return GCodeToGeometry.findAngleOrientedVectors2(b,c,r.clockwise===!1)}function h(){var a=GCodeToGeometry.findAxes(r.crossAxe),b={x:r.start[a.re]-r.center[a.re],y:r.start[a.im]-r.center[a.im],z:0};return GCodeToGeometry.lengthVector3(b)}function i(a,b){var c={},d={},e={},f={};return a=Math.abs(a),a===Math.PI/2?(c={x:.707106781186548,y:.707106781186548,z:0},d={x:1.097631072937817,y:.316582489435277,z:0}):(c={x:Math.cos(a/2),y:Math.sin(a/2),z:0},d={x:(4-c.x)/3,y:(1-c.x)*(3-c.x)/(3*c.y),z:0}),c.x*=b,c.y*=b,d.x*=b,d.y*=b,e={x:d.x,y:-d.y,z:0},f={x:c.x,y:-c.y,z:0},{p0:c,p1:d,p2:e,p3:f}}function j(a,b,c,d){var e=0;return b===!1&&(GCodeToGeometry.swapObjects(a.p0,a.p3),GCodeToGeometry.swapObjects(a.p1,a.p2)),e=c/3,"z"===d.toLowerCase()?(a.p0.z=0,a.p1.z=e,a.p2.z=2*e,a.p3.z=3*e):"x"===d.toLowerCase()?(a.p0.z=a.p0.y,a.p0.y=a.p0.x,a.p0.x=0,a.p1.z=a.p1.y,a.p1.y=a.p1.x,a.p1.x=e,a.p2.z=a.p2.y,a.p2.y=a.p2.x,a.p2.x=2*e,a.p3.z=a.p3.y,a.p3.y=a.p3.x,a.p3.x=3*e):"y"===d.toLowerCase()&&(a.p0.z=a.p0.x,a.p0.x=a.p0.y,a.p0.y=0,a.p1.z=a.p1.x,a.p1.x=a.p1.y,a.p1.y=e,a.p2.z=a.p2.x,a.p2.x=a.p2.y,a.p2.y=2*e,a.p3.z=a.p3.x,a.p3.x=a.p3.y,a.p3.y=3*e),a}function k(a,b,c,d,e){var f={x:0,y:0,z:0};GCodeToGeometry.scaleAndRotation(f,a.p0,a.p0,c,1,d,e),GCodeToGeometry.scaleAndRotation(f,a.p1,a.p1,c,1,d,e),GCodeToGeometry.scaleAndRotation(f,a.p2,a.p2,c,1,d,e),GCodeToGeometry.scaleAndRotation(f,a.p3,a.p3,c,1,d,e),GCodeToGeometry.movePoint(a.p0,b),GCodeToGeometry.movePoint(a.p1,b),GCodeToGeometry.movePoint(a.p2,b),GCodeToGeometry.movePoint(a.p3,b)}function l(a,b,c,d,e){var f=[],g=GCodeToGeometry.copyObject(r.center),h=GCodeToGeometry.findAxes(r.crossAxe),i={x:r.start[h.re]-g[h.re],y:r.start[h.im]-g[h.im]},j=0,l=0,m=r.clockwise===!0?-1:1;if(0===a&&0===c)return f;if(a>0)for(l=GCodeToGeometry.findAngleOrientedVectors2({x:b.p0[h.re],y:b.p0[h.im]},i,r.clockwise===!1),j=0;a>j;j++)f.push(GCodeToGeometry.copyObject(b)),k(f[j],g,l,h.re,h.im),l+=1.570796326794897*m,g[r.crossAxe]+=e;return c>0&&(l=GCodeToGeometry.findAngleOrientedVectors2({x:d.p0[h.re],y:d.p0[h.im]},i,r.clockwise===!1),0!==a&&(l+=1.570796326794897*a*m),f.push(GCodeToGeometry.copyObject(d)),k(f[j],g,l,h.re,h.im)),f[0].p0.x=r.start.x,f[0].p0.y=r.start.y,f[0].p0.z=r.start.z,f[f.length-1].p3.x=r.end.x,f[f.length-1].p3.y=r.end.y,f[f.length-1].p3.z=r.end.z,f}function m(){var a=0,b=1,c={},d={},e=0,f=0,k=0,m=g(),n=h(),o=Math.abs(m),p=1.570796326794897;return 0===m||0===n?[]:(o>p&&(a=parseInt(o/p,10),b=o%p!==0?1:0),k=(r.end[r.crossAxe]-r.start[r.crossAxe])/o,e=p*k,f=(o-a*p)*k,a>0&&(c=i(p,n),j(c,0>m,e,r.crossAxe)),b>0&&(m=o-a*p,r.clockwise===!0&&(m=-m),d=i(m,n),j(d,0>m,f,r.crossAxe)),l(a,c,b,d,e))}function n(a,b,c,d,e,f){var g=f===!1?1:GCodeToGeometry.mmToInch,h={x:a.x,y:a.y,z:a.z};return void 0===c.r?(void 0!==c.i&&(h.x+=c.i*g),void 0!==c.j&&(h.y+=c.j*g),void 0!==c.k&&(h.z+=c.k*g)):h=GCodeToGeometry.findCenter(a,b,c.r*g,d,e),h[e]=a[e],h}function o(a,b,c){return b>c&&(b+=c,c=b-c,b-=c),a>=b&&c>=a}function p(a,b,c,d){var e=GCodeToGeometry.findAngleOrientedVectors2(d,{x:a,y:b},r.clockwise===!1);return o(e,0,c)===!0}function q(a,b,c,d,e,f){r.index=a,r.word=c.type,r.start={x:b.x,y:b.y,z:b.z},r.end=GCodeToGeometry.findPosition(b,c,d,e),r.clockwise="G2"===c.type,r.center=n(b,r.end,c,r.clockwise,f,e),r.crossAxe=f}var r=this;r.returnLine=function(){var a=m();return{lineNumber:r.index,type:r.word,beziers:a}},r.getSize=function(){var a=GCodeToGeometry.findAxes(r.crossAxe),b={x:r.start[a.re]-r.center[a.re],y:r.start[a.im]-r.center[a.im]},c=h(),d=g(),e={x:0,y:0,z:0},f={x:0,y:0,z:0};return e.x=Math.min(r.start.x,r.end.x),e.y=Math.min(r.start.y,r.end.y),e.z=Math.min(r.start.z,r.end.z),f.x=Math.max(r.start.x,r.end.x),f.y=Math.max(r.start.y,r.end.y),f.z=Math.max(r.start.z,r.end.z),p(0,1,d,b)===!0&&(f[a.im]=r.center[a.im]+c),p(0,-1,d,b)===!0&&(e[a.im]=r.center[a.im]-c),p(1,0,d,b)===!0&&(f[a.re]=r.center[a.re]+c),p(-1,0,d,b)===!0&&(e[a.re]=r.center[a.re]-c),{min:e,max:f}},q(a,b,c,d,e,f)},GCodeToGeometry.parse=function(a){"use strict";function b(a,b,c,d,e){return{gcode:a,lines:b,size:c,isComplete:d,errorMessage:e}}function c(a){var b=a.split("(")[0].split(";")[0];return b.split(" ").join("").split("	").join("")}function d(a){var b={},c=0,d="",e="",f=[],g=!0;for(c=0;c<a.words.length;c++)d=a.words[c][0],e=a.words[c][1],"G"===d||"M"===d?(g===!1&&(f.push(b),b={}),b.type=d+e,g=!1):b[d.toLowerCase()]=parseFloat(e,10);return f.push(b),f}function e(a,b){var c=["x","y","z"],d=0;for(d=c.length-1;d>=0;d--)a.min[c[d]]>b.min[c[d]]&&(a.min[c[d]]=b.min[c[d]]),a.max[c[d]]<b.max[c[d]]&&(a.max[c[d]]=b.max[c[d]])}var f={min:{x:0,y:0,z:0},max:{x:0,y:0,z:0}},g=0,h=0,i={},j={},k={x:0,y:0,z:0},l=[],m="z",n=!1,o=!1,p=!0,q=[];if("string"!=typeof a||""===a)return b([],[],!1,f,"There is no GCode");var r=a.split("\n");for(g=0;g<r.length&&p===!0;){for(l=d(GParser.parse(c(r[g]).toUpperCase())),h=0;h<l.length&&p===!0;){if(j=l[h],"G0"===j.type||"G1"===j.type)i=new GCodeToGeometry.StraightLine(g+1,k,j,n,o),q.push(i.returnLine()),e(f,i.getSize()),k=GCodeToGeometry.copyObject(i.end);else if("G2"===j.type||"G3"===j.type){if(i=new GCodeToGeometry.CurvedLine(g+1,k,j,n,o,m),i.center===!1)return b(r,q,f,!1,"Impossible to find the center for "+r[g]+" (line "+g+")");e(f,i.getSize()),q.push(i.returnLine()),k=GCodeToGeometry.copyObject(i.end)}else"G17"===j.type?m="z":"G18"===j.type?m="y":"G19"===j.type?m="x":"G20"===j.type?o=!1:"G21"===j.type?o=!0:"G90"===j.type?n=!1:"G91"===j.type?n=!0:"M2"===j.type&&(p=!1);h++}g++}return b(r,q,f,!0,"")};