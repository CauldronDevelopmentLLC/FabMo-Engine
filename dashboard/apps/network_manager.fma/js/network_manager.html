<!DOCTYPE html><html lang="en"><head><title>dashboard/apps/network_manager.fma/js/network_manager</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../../../"><meta name="groc-document-path" content="dashboard/apps/network_manager.fma/js/network_manager"><meta name="groc-project-path" content="dashboard/apps/network_manager.fma/js/network_manager.js"><link rel="stylesheet" type="text/css" media="all" href="../../../../assets/style.css"><script type="text/javascript" src="../../../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">dashboard/apps/network_manager.fma/js/network_manager.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-built_in">require</span>(<span class="hljs-string">'jquery'</span>);
<span class="hljs-keyword">var</span> Foundation = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../../../static/js/libs/foundation.min.js'</span>);
<span class="hljs-keyword">var</span> moment = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../../../static/js/libs/moment.js'</span>);
<span class="hljs-keyword">var</span> Fabmo = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../../../static/js/libs/fabmo.js'</span>);
<span class="hljs-keyword">var</span> fabmo = <span class="hljs-keyword">new</span> Fabmo;

<span class="hljs-keyword">var</span> networks = {};
<span class="hljs-keyword">var</span> network_history = {};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Get networks from the tool, and add entries to the table</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">refreshWifiTable</span>(<span class="hljs-params">callback</span>)</span>{
	callback = callback || <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{};
	fabmo.getWifiNetworks(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, networks</span>) </span>{
		<span class="hljs-keyword">if</span>(err) {<span class="hljs-keyword">return</span> callback(err);}
		addWifiEntries(networks);
		callback(<span class="hljs-literal">null</span>, networks);
	});
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Add wifi entries (retrieved from the tool) to the HTML table in the UI</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addWifiEntries</span>(<span class="hljs-params">network_entries, callback</span>) </span>{
	callback = callback || <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{};
	<span class="hljs-keyword">var</span> table = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'wifi_table'</span>);
	network_entries.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">entry</span>) </span>{<span class="hljs-string">""</span>
        <span class="hljs-keyword">if</span>(entry.ssid <span class="hljs-keyword">in</span> networks) {
            <span class="hljs-keyword">return</span>;
        }
        networks[entry.ssid] = entry;
		<span class="hljs-keyword">var</span> row = table.insertRow(table.rows.length);
		<span class="hljs-keyword">var</span> ssid = row.insertCell(<span class="hljs-number">0</span>);
        ssid.className = <span class="hljs-string">'ssid noselect'</span>
		<span class="hljs-keyword">var</span> security = row.insertCell(<span class="hljs-number">1</span>);
		security.className = <span class="hljs-string">'security noselect'</span>
        <span class="hljs-keyword">var</span> strength = row.insertCell(<span class="hljs-number">2</span>);
        strength.className = <span class="hljs-string">'wifi0'</span>;

    <span class="hljs-keyword">var</span> ssidText = entry.ssid || <span class="hljs-string">'&lt;Hidden SSID&gt;'</span>;
	<span class="hljs-keyword">var</span> securityText = entry.flags ? entry.flags : <span class="hljs-string">''</span>;
    <span class="hljs-keyword">var</span> rawStrength = entry.signalLevel;
    <span class="hljs-keyword">var</span> strengthNumber;
    <span class="hljs-keyword">if</span>(rawStrength &gt; -<span class="hljs-number">65</span>) {
        strengthNumber = <span class="hljs-number">4</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(-<span class="hljs-number">70</span> &lt; rawStrength &lt; -<span class="hljs-number">65</span>) {
        strengthNumber = <span class="hljs-number">3</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(-<span class="hljs-number">80</span> &lt; rawStrength &lt; -<span class="hljs-number">70</span>) {
        strengthNumber = <span class="hljs-number">2</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(-<span class="hljs-number">90</span> &lt; rawStrength &lt; -<span class="hljs-number">80</span>) {
        strengthNumber =  <span class="hljs-number">1</span>;
    } <span class="hljs-keyword">else</span> {
        strengthNumber =  <span class="hljs-number">0</span>;
    }
	ssid.innerHTML = ssidText;
	security.innerHTML = securityText;
	strength.className = <span class="hljs-string">'wifi'</span>+(strengthNumber);
   });
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Get history from the tool, and add entries to the table</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">refreshHistoryTable</span>(<span class="hljs-params">callback</span>)</span>{
    callback = callback || <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{};
    fabmo.getWifiNetworkHistory(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, networks</span>) </span>{
        <span class="hljs-keyword">if</span>(err) {<span class="hljs-keyword">return</span> callback(err);}
        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">Object</span>.keys(networks).length &gt; <span class="hljs-number">0</span>) {	
            addHistoryEntries(networks);            
            $(<span class="hljs-string">'#recent'</span>).removeClass(<span class="hljs-string">'hidden'</span>);
        } <span class="hljs-keyword">else</span> {
            $(<span class="hljs-string">'#recent'</span>).addClass(<span class="hljs-string">'hidden'</span>);
        }
        callback(<span class="hljs-literal">null</span>, networks);
    });
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Add history entries (retrieved from the tool) to the HTML table in the UI</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addHistoryEntries</span>(<span class="hljs-params">history_entries, callback</span>) </span>{
    callback = callback || <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{};
    <span class="hljs-keyword">var</span> table = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'history_table'</span>);
    <span class="hljs-keyword">for</span>(ssid <span class="hljs-keyword">in</span> history_entries) {
        entry = history_entries[ssid];
        <span class="hljs-keyword">if</span>(entry.ssid <span class="hljs-keyword">in</span> network_history) {
            <span class="hljs-keyword">return</span>;
        }
        network_history[entry.ssid] = entry;
        <span class="hljs-keyword">var</span> row = table.insertRow(table.rows.length);
        <span class="hljs-keyword">var</span> ssid = row.insertCell(<span class="hljs-number">0</span>);
        ssid.className = <span class="hljs-string">'ssid noselect'</span>
        <span class="hljs-keyword">var</span> ipaddress = row.insertCell(<span class="hljs-number">1</span>);
        ipaddress.className = <span class="hljs-string">'ipaddress noselect'</span>
        <span class="hljs-keyword">var</span> lastseen = row.insertCell(<span class="hljs-number">2</span>);
        <span class="hljs-comment">//lastseen.className = '';</span>

        <span class="hljs-keyword">var</span> ssidText = entry.ssid || <span class="hljs-string">'&lt;Hidden SSID&gt;'</span>;
        <span class="hljs-keyword">var</span> ipAddressText = entry.ipaddress || <span class="hljs-string">''</span>;
        <span class="hljs-keyword">var</span> lastSeenText = moment(entry.lastseen).fromNow();

        ssid.innerHTML = ssidText
        ipaddress.innerHTML = ipAddressText;
        lastseen.innerHTML = lastSeenText;
    };
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Show the confirmation dialog</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">confirm</span>(<span class="hljs-params">options</span>)</span>{
    options.ok = options.ok || <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{};
    options.cancel = options.cancel || <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{};

    $(<span class="hljs-string">'#confirm-modal-title'</span>).text(options.title || <span class="hljs-string">''</span>);
    $(<span class="hljs-string">'#confirm-modal-description'</span>).text(options.description || <span class="hljs-string">''</span>);

    $(<span class="hljs-string">'#confirm-modal-ok'</span>).text(options.ok_message || <span class="hljs-string">'Ok'</span>);
    $(<span class="hljs-string">'#confirm-modal-cancel'</span>).text(options.cancel_message || <span class="hljs-string">'Cancel'</span>);

    $(<span class="hljs-string">'#confirm-modal-ok'</span>).one(<span class="hljs-string">'click'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) </span>{
        $(<span class="hljs-string">'#confirm-modal'</span>).foundation(<span class="hljs-string">'reveal'</span>, <span class="hljs-string">'close'</span>);
        $(<span class="hljs-string">'#confirm-modal-cancel'</span>).off(<span class="hljs-string">'click'</span>);
        options.ok();
    });

    $(<span class="hljs-string">'#confirm-modal-cancel'</span>).one(<span class="hljs-string">'click'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) </span>{
        $(<span class="hljs-string">'#confirm-modal'</span>).foundation(<span class="hljs-string">'reveal'</span>, <span class="hljs-string">'close'</span>);
        $(<span class="hljs-string">'#confirm-modal-ok'</span>).off(<span class="hljs-string">'click'</span>);
        options.cancel();
    });
           
    $(<span class="hljs-string">'#confirm-modal'</span>).foundation(<span class="hljs-string">'reveal'</span>, <span class="hljs-string">'open'</span>);
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Prompt for a password with a modal dialog</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">requestPassword</span>(<span class="hljs-params">ssid, callback</span>)</span>{
    $(<span class="hljs-string">'#modal-title'</span>).text(<span class="hljs-string">'Enter the passphrase for '</span> + ssid);
    $(<span class="hljs-string">'#passwd-modal'</span>).foundation(<span class="hljs-string">'reveal'</span>, <span class="hljs-string">'open'</span>);

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">teardown</span>(<span class="hljs-params"></span>) </span>{

      $(<span class="hljs-string">'#btn-connect'</span>).off(<span class="hljs-string">'click'</span>);
      $(<span class="hljs-string">'#txt-password'</span>).off(<span class="hljs-string">'change'</span>);
      $(<span class="hljs-string">'#txt-password'</span>).val(<span class="hljs-string">''</span>);
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">submit</span>(<span class="hljs-params"></span>) </span>{
      callback($(<span class="hljs-string">'#txt-password'</span>).val());
      teardown();
      $(<span class="hljs-string">'#passwd-modal'</span>).foundation(<span class="hljs-string">'reveal'</span>, <span class="hljs-string">'close'</span>);
      $(<span class="hljs-string">"#passwd-form"</span>).trigger(<span class="hljs-string">'reset'</span>);         
    }

    $(<span class="hljs-string">'#btn-connect'</span>).one(<span class="hljs-string">'click'</span>, submit);
    $(<span class="hljs-string">'#txt-password'</span>).one(<span class="hljs-string">'change'</span>, submit);

    $(<span class="hljs-string">'#passwd-modal'</span>).bind(<span class="hljs-string">'closed.fndtn.reveal'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) </span>{
      teardown();
    });
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Confirm, then go to AP mode if requested.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">enterAPMode</span>(<span class="hljs-params">callback</span>) </span>{
    confirm({
        title : <span class="hljs-string">"Enter AP Mode?"</span>,
        description : <span class="hljs-string">"You will lose contact with the dashboard and need to reconnect in Access Point Mode."</span>,
        ok_message : <span class="hljs-string">"Yes"</span>,
        cancel_message : <span class="hljs-string">"No"</span>,
        ok : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            fabmo.enableWifiHotspot(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
                <span class="hljs-keyword">if</span>(err) {
                    fabmo.notify(<span class="hljs-string">'error'</span>, err);
                } <span class="hljs-keyword">else</span> {
                    fabmo.notify(<span class="hljs-string">'info'</span>, data);
                }
            });
        }, 
        cancel : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>No action required.</p></div></div><div class="code"><div class="wrapper">        }
    });
}

  $(<span class="hljs-built_in">document</span>).ready(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

    <span class="hljs-comment">//Foundation Init</span>
    $(<span class="hljs-built_in">document</span>).foundation();</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Check for new networks initially, and then every 3 seconds</p></div></div><div class="code"><div class="wrapper">    refreshWifiTable(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
        <span class="hljs-keyword">if</span>(err){
            fabmo.notify(<span class="hljs-string">'error'</span>,<span class="hljs-string">"failed to retrieve network information. Network management may not be available on your tool."</span>);
            <span class="hljs-keyword">return</span>;
        }
        setInterval(refreshWifiTable, <span class="hljs-number">3000</span>);
    });

    refreshHistoryTable();</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Action for clicking the SSID</p></div></div><div class="code"><div class="wrapper">    $(<span class="hljs-string">'tbody'</span>).on(<span class="hljs-string">'click'</span>, <span class="hljs-string">'td.ssid'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> name = $(<span class="hljs-keyword">this</span>).text();
        requestPassword(name, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">passwd</span>)</span>{
        fabmo.showModal({message:<span class="hljs-string">"Your tool is connecting to the network, please use the Tool Minder to find me on the new network called "</span>+name+<span class="hljs-string">" ."</span>});
            fabmo.connectToWifi(name, passwd,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err,data</span>)</span>{
                <span class="hljs-keyword">if</span>(err) {
                    fabmo.notify(<span class="hljs-string">'error'</span>,err);
                }
            });
        });
    });</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Action for clicking the AP mode button</p></div></div><div class="code"><div class="wrapper">    $(<span class="hljs-string">'#ap-mode-button'</span>).on(<span class="hljs-string">'click'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) </span>{
        enterAPMode();
        evt.preventDefault();
        fabmo.showModal({message:<span class="hljs-string">"Your tool is now back in AP mode."</span>});
    })


});</div></div></div></div></body></html>