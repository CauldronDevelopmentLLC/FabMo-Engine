<!DOCTYPE html><html lang="en"><head><title>dashboard/apps/editor.fma/js/editor</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../../../"><meta name="groc-document-path" content="dashboard/apps/editor.fma/js/editor"><meta name="groc-project-path" content="dashboard/apps/editor.fma/js/editor.js"><link rel="stylesheet" type="text/css" media="all" href="../../../../assets/style.css"><script type="text/javascript" src="../../../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">dashboard/apps/editor.fma/js/editor.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-built_in">require</span>(<span class="hljs-string">'jquery'</span>);
<span class="hljs-keyword">var</span> Foundation = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../../../static/js/libs/foundation.min.js'</span>);
<span class="hljs-keyword">var</span> Fabmo = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../../../static/js/libs/fabmo.js'</span>);
<span class="hljs-keyword">var</span> fabmo = <span class="hljs-keyword">new</span> Fabmo;
<span class="hljs-keyword">var</span> CodeMirror = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./codemirror.js'</span>);
<span class="hljs-built_in">require</span>(<span class="hljs-string">'./simple.js'</span>);
<span class="hljs-built_in">require</span>(<span class="hljs-string">'./cm-fabmo-modes.js'</span>);
    <span class="hljs-keyword">var</span> editor;
    <span class="hljs-keyword">var</span> lang=<span class="hljs-string">"gcode"</span>;
    <span class="hljs-keyword">var</span> source=<span class="hljs-literal">null</span>;
    <span class="hljs-keyword">var</span> source_data=<span class="hljs-literal">null</span>;
    <span class="hljs-keyword">var</span> job_description=<span class="hljs-literal">null</span>;
    <span class="hljs-keyword">var</span> job_title=<span class="hljs-literal">null</span>;
    <span class="hljs-keyword">var</span> job_filename=<span class="hljs-literal">null</span>;

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">execute</span>(<span class="hljs-params"></span>) </span>{
      $(<span class="hljs-string">"#execute-menu"</span>).hide();
      <span class="hljs-keyword">var</span> text = editor.getValue();
      <span class="hljs-keyword">switch</span>(lang) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">"gcode"</span>:
          fabmo.notify(<span class="hljs-string">'info'</span>, <span class="hljs-string">'Executing G-Code program.'</span>);
          fabmo.runGCode(text);
        <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">"opensbp"</span>:
          fabmo.notify(<span class="hljs-string">'info'</span>, <span class="hljs-string">'Executing OpenSBP program.'</span>);
          fabmo.runSBP(text);
        <span class="hljs-keyword">break</span>;
      }
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">supports_html5_storage</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">'localStorage'</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">window</span> &amp;&amp; <span class="hljs-built_in">window</span>[<span class="hljs-string">'localStorage'</span>] !== <span class="hljs-literal">null</span>;
      } <span class="hljs-keyword">catch</span> (e) {
        <span class="hljs-built_in">console</span>.warn(<span class="hljs-string">"HTML5 Local storage unsupported?"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      }
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cycleLanguage</span>(<span class="hljs-params">save</span>) </span>{
      <span class="hljs-keyword">if</span>(lang === <span class="hljs-string">'gcode'</span>) {
        set_language(<span class="hljs-string">'opensbp'</span>, save);
      } <span class="hljs-keyword">else</span> {
        set_language(<span class="hljs-string">'gcode'</span>, save);
      }
    }

    $(<span class="hljs-string">'#app-header'</span>).click(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) </span>{
      cycleLanguage(<span class="hljs-literal">true</span>);
    });

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">set_language</span>(<span class="hljs-params">language, save</span>) </span>{
      <span class="hljs-keyword">switch</span>(language) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">'opensbp'</span>:
          $(<span class="hljs-string">"#app-header"</span>).text(<span class="hljs-string">"Editor (OpenSBP)"</span>);
          $(<span class="hljs-string">"#lang-gcode"</span>).parent().removeClass(<span class="hljs-string">"active"</span>);
          $(<span class="hljs-string">"#lang-opensbp"</span>).parent().addClass(<span class="hljs-string">"active"</span>);
          lang=<span class="hljs-string">'opensbp'</span>;
          editor.setOption(<span class="hljs-string">"mode"</span>, <span class="hljs-string">"opensbp"</span>);
        <span class="hljs-keyword">break</span>;

        <span class="hljs-keyword">case</span> <span class="hljs-string">'gcode'</span>:
          $(<span class="hljs-string">"#app-header"</span>).text(<span class="hljs-string">"Editor (G-Code)"</span>);
          $(<span class="hljs-string">"#lang-opensbp"</span>).parent().removeClass(<span class="hljs-string">"active"</span>);
          $(<span class="hljs-string">"#lang-gcode"</span>).parent().addClass(<span class="hljs-string">"active"</span>);
          lang = <span class="hljs-string">'gcode'</span>;
          editor.setOption(<span class="hljs-string">"mode"</span>, <span class="hljs-string">"gcode"</span>);
          <span class="hljs-keyword">break</span>;
      }
      <span class="hljs-keyword">if</span>(supports_html5_storage() &amp;&amp; save) {
        localStorage.fabmo_editor_language = lang;
      }
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loadFromBrowser</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">if</span>(supports_html5_storage()) {
        <span class="hljs-keyword">var</span> language = localStorage.fabmo_editor_language || <span class="hljs-string">'gcode'</span>;
        set_language(language);
        <span class="hljs-keyword">var</span> content = localStorage.fabmo_editor_content || <span class="hljs-string">''</span>;
        <span class="hljs-keyword">if</span>((content !== content) || (content === <span class="hljs-literal">undefined</span>)) {
          <span class="hljs-built_in">console</span>.warn(<span class="hljs-string">"No saved content to load."</span>);
        } <span class="hljs-keyword">else</span> {
          editor.setValue(content);
        }
        <span class="hljs-keyword">var</span> pos;
        <span class="hljs-keyword">try</span> {
          pos = <span class="hljs-built_in">JSON</span>.parse(localStorage.fabmo_editor_position);
        } <span class="hljs-keyword">catch</span>(e) {
          <span class="hljs-built_in">console</span>.warn(<span class="hljs-string">"Couldn't set position: "</span> + e)
          pos = {row:<span class="hljs-number">0</span>,col:<span class="hljs-number">0</span>};
        }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>TODO load the cursor and scroll positions here</p></div></div><div class="code"><div class="wrapper">      }
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setup</span>(<span class="hljs-params"></span>) </span>{
      fabmo.getAppArgs(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, args</span>) </span>{
        <span class="hljs-keyword">if</span>(<span class="hljs-string">'job'</span> <span class="hljs-keyword">in</span> args) {
          <span class="hljs-keyword">var</span> url = <span class="hljs-string">'/job/'</span> + args.job + <span class="hljs-string">'/file'</span>;
          $.get(url,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data, status</span>) </span>{
              editor.setValue(data, -<span class="hljs-number">1</span>);
              <span class="hljs-comment">//editor.clearSelection();</span>
              source = <span class="hljs-string">"job"</span>;
              fabmo.getJobInfo(args.job, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, info</span>) </span>{
                <span class="hljs-keyword">if</span>(!err) {
                    job_title = info.name || info.file.filename || <span class="hljs-literal">null</span>;
                    job_description = info.description || <span class="hljs-literal">null</span>;
                    job_filename = info.file.filename;
                  <span class="hljs-keyword">if</span>(info.file.filename.endsWith(<span class="hljs-string">'sbp'</span>)) {
                    set_language(<span class="hljs-string">'opensbp'</span>);
                  } <span class="hljs-keyword">else</span> {
                    set_language(<span class="hljs-string">'gcode'</span>);
                  }
                }
              });
          });

        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-string">'macro'</span> <span class="hljs-keyword">in</span> args) {
          $(<span class="hljs-string">'.language-dropdown'</span>).hide();
          lang = <span class="hljs-string">'opensbp'</span>;
          <span class="hljs-keyword">var</span> url = <span class="hljs-string">'/macros/'</span> + args.macro;
          $.get(url,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response, status</span>) </span>{
            <span class="hljs-keyword">var</span> macro = response.data.macro;
            $(<span class="hljs-string">'#app-header'</span>).text(<span class="hljs-string">"Editor - "</span> + macro.name + <span class="hljs-string">" (Macro)"</span>);
            editor.setValue(macro.content, -<span class="hljs-number">1</span>);
            <span class="hljs-comment">//editor.clearSelection();</span>
            source = <span class="hljs-string">"macro"</span>;
            source_data = macro;
            job_description = macro.description;
            job_title = <span class="hljs-string">'macro_'</span> + macro.index + <span class="hljs-string">'.sbp'</span>;
            set_language(<span class="hljs-string">'opensbp'</span>);
            $(<span class="hljs-string">'#macro-menu'</span>).show();
          });
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-string">'new'</span> <span class="hljs-keyword">in</span> args) {
          editor.setValue(args.content || <span class="hljs-string">''</span>, -<span class="hljs-number">1</span>);
          editor.clearSelection();
          source = <span class="hljs-literal">null</span>;
          <span class="hljs-keyword">switch</span>(args.language) {
            <span class="hljs-keyword">case</span> <span class="hljs-string">'sbp'</span>:
            <span class="hljs-keyword">case</span> <span class="hljs-string">'opensbp'</span>:
              set_language(<span class="hljs-string">'opensbp'</span>);
              <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">default</span>:
              set_language(<span class="hljs-string">'gcode'</span>);
              <span class="hljs-keyword">break</span>;
          }
        } <span class="hljs-keyword">else</span> {
          loadFromBrowser();
        }
      });
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">save</span>(<span class="hljs-params">callback</span>) </span>{
      <span class="hljs-keyword">var</span> callback = callback || <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{};
      <span class="hljs-keyword">switch</span>(source) {
        <span class="hljs-keyword">case</span> <span class="hljs-literal">undefined</span>:
        <span class="hljs-keyword">case</span> <span class="hljs-literal">null</span>:
          <span class="hljs-keyword">if</span>(supports_html5_storage()) {
            localStorage.fabmo_editor_content = editor.getValue();
            pos = editor.getCursor();
            localStorage.fabmo_editor_position = <span class="hljs-built_in">JSON</span>.stringify(pos);
          }
          callback();
          <span class="hljs-keyword">break</span>;

        <span class="hljs-keyword">case</span> <span class="hljs-string">"macro"</span>:
          fabmo.updateMacro(source_data.index, {content: editor.getValue()}, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, result</span>) </span>{
            fabmo.notify(<span class="hljs-string">'info'</span>, <span class="hljs-string">"Macro '"</span> + source_data.name + <span class="hljs-string">"' saved."</span>);
            callback();
          });
          <span class="hljs-keyword">break</span>;

        <span class="hljs-keyword">default</span>:
          callback();
          <span class="hljs-keyword">break</span>;
      }
    }

    $(<span class="hljs-built_in">document</span>).ready(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      $(<span class="hljs-built_in">document</span>).foundation();

      editor = CodeMirror(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">elt</span>) </span>{
        <span class="hljs-keyword">var</span> div = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'editor'</span>);
        elt.id = <span class="hljs-string">'editor'</span>
        div.parentNode.replaceChild(elt, div);
      }, {
        lineNumbers : <span class="hljs-literal">true</span>,
        <span class="hljs-comment">//viewportMargin : Infinity,</span>
        theme: <span class="hljs-string">'fabmo'</span>,
        mode: <span class="hljs-string">'text'</span>
      });

      editor.addKeyMap({
          <span class="hljs-string">"Cmd-Enter"</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">cm</span>) </span>{
            execute();
          },
          <span class="hljs-string">"Ctrl-Enter"</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">cm</span>) </span>{
            execute();
          },
          <span class="hljs-string">"Ctrl-s"</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">cm</span>) </span>{
            save();
          },
          <span class="hljs-string">"Cmd-s"</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">cm</span>) </span>{
            save();
          }
        })

      editor.on(<span class="hljs-string">'blur'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">cm</span>) </span>{
          <span class="hljs-keyword">if</span>(!source) {
            save();
          }
        });

      setup();

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">resize</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> h = <span class="hljs-built_in">window</span>.innerHeight;
        <span class="hljs-keyword">var</span> h2 = $(<span class="hljs-string">'#topbar'</span>).height();
        $(<span class="hljs-string">"#editor"</span>).css(<span class="hljs-string">'height'</span>,h-h2);
        $(<span class="hljs-built_in">document</span>).foundation(<span class="hljs-string">'reflow'</span>);
      }

      $(<span class="hljs-built_in">window</span>).resize(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
        resize();
      });
      resize();

    }); <span class="hljs-comment">// document.ready</span>

    $(<span class="hljs-string">"#submit-immediate"</span>).click(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) </span>{
      evt.preventDefault();
      execute();
    });

    $(<span class="hljs-string">"#submit-job"</span>).click(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) </span>{
      evt.preventDefault();
      <span class="hljs-comment">//submit_job();</span>
      submitJob();
    });

    $(<span class="hljs-string">"#lang-opensbp"</span>).click(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) </span>{
      set_language(<span class="hljs-string">'opensbp'</span>, <span class="hljs-literal">true</span>);
      evt.preventDefault();
    });

    $(<span class="hljs-string">"#lang-gcode"</span>).click(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) </span>{
      set_language(<span class="hljs-string">'gcode'</span>, <span class="hljs-literal">true</span>);
      evt.preventDefault();
    });

    $(<span class="hljs-string">"#macro-save"</span>).click(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) </span>{
      save();
      evt.preventDefault();
    });

    $(<span class="hljs-string">"#macro-save-and-close"</span>).click(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) </span>{
      save(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        fabmo.launchApp(<span class="hljs-string">'macros'</span>);
      });
      evt.preventDefault();
    });

    $(<span class="hljs-string">'.disabled'</span>).click(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    });

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">submitJob</span>(<span class="hljs-params"></span>)</span>{
        $(<span class="hljs-string">'#modal-title'</span>).text(<span class="hljs-string">'Submit Job'</span>);
        <span class="hljs-keyword">switch</span>(lang) {
          <span class="hljs-keyword">case</span> <span class="hljs-string">'gcode'</span>:
            $(<span class="hljs-string">'#jobsubmit-name'</span>).val(job_title || <span class="hljs-string">'G-Code (Editor)'</span>);
            $(<span class="hljs-string">'#jobsubmit-description'</span>).val(job_description || <span class="hljs-string">'A G-Code job from the editor'</span>);
            $(<span class="hljs-string">'#jobsubmit-filename'</span>).val(job_filename || <span class="hljs-string">'editor.nc'</span>);
            <span class="hljs-keyword">break</span>;
          <span class="hljs-keyword">case</span> <span class="hljs-string">'opensbp'</span>:
            $(<span class="hljs-string">'#jobsubmit-name'</span>).val(job_title || <span class="hljs-string">'OpenSBP (Editor)'</span>);
            $(<span class="hljs-string">'#jobsubmit-description'</span>).val(job_description || <span class="hljs-string">'An OpenSBP job from the editor'</span>);
            $(<span class="hljs-string">'#jobsubmit-filename'</span>).val(job_filename || <span class="hljs-string">'editor.sbp'</span>);
            <span class="hljs-keyword">break</span>;
          <span class="hljs-keyword">default</span>:
            fabmo.notify(<span class="hljs-string">'warn'</span>, <span class="hljs-string">'Unknown file format in editor?!'</span>);
            <span class="hljs-keyword">break</span>;
        }
        $(<span class="hljs-string">'#jobsubmit-modal'</span>).foundation(<span class="hljs-string">'reveal'</span>, <span class="hljs-string">'open'</span>);
        $(<span class="hljs-string">'#jobsubmit-name'</span>).focus();

        $(<span class="hljs-string">'#jobsubmit-submit'</span>).on(<span class="hljs-string">'click'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"> event </span>) </span>{
          event.preventDefault();
          <span class="hljs-keyword">var</span> name = $(<span class="hljs-string">'#jobsubmit-name'</span>).val();
          <span class="hljs-keyword">var</span> description = $(<span class="hljs-string">'#jobsubmit-description'</span>).val();
          <span class="hljs-keyword">var</span> filename = $(<span class="hljs-string">'#jobsubmit-filename'</span>).val();

          <span class="hljs-keyword">var</span> text = editor.getValue();

          fabmo.submitJob({
              file : text,
              filename: filename,
              name : name,
              description: description
            },
            <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, result</span>) </span>{
              <span class="hljs-keyword">if</span>(err) {
                <span class="hljs-keyword">if</span>(err.message) {
                  fabmo.notify(<span class="hljs-string">'error'</span>, err.message);
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(err.job) {
                  fabmo.notify(<span class="hljs-string">'warn'</span>, err.job);
                } <span class="hljs-keyword">else</span> {
                  fabmo.notify(<span class="hljs-string">'error'</span>, err);
                }
              } <span class="hljs-keyword">else</span> {
                fabmo.launchApp(<span class="hljs-string">'job-manager'</span>);
              }
            }
          );

          $(<span class="hljs-string">'#jobsubmit-modal'</span>).foundation(<span class="hljs-string">'reveal'</span>, <span class="hljs-string">'close'</span>);
          $(<span class="hljs-string">"#jobsubmit-form"</span>).trigger(<span class="hljs-string">'reset'</span>);
        });

        $(<span class="hljs-string">'#jobsubmit-modal'</span>).bind(<span class="hljs-string">'closed.fndtn.reveal'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) </span>{
            $(<span class="hljs-string">"#jobsubmit-form"</span>).off(<span class="hljs-string">'submit'</span>);
        });
    }

    fabmo.on(<span class="hljs-string">'status'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">status</span>) </span>{
      <span class="hljs-keyword">if</span>(status.state === <span class="hljs-string">'idle'</span>) {
        $(<span class="hljs-string">"#execute-menu"</span>).show();
      } <span class="hljs-keyword">else</span> {
        $(<span class="hljs-string">"#execute-menu"</span>).hide();
      }
    });

    $(<span class="hljs-string">'#jobsubmit-cancel'</span>).click(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) </span>{
      evt.preventDefault();
      $(<span class="hljs-string">'#jobsubmit-modal'</span>).foundation(<span class="hljs-string">'reveal'</span>, <span class="hljs-string">'close'</span>);
    });</div></div></div></div></body></html>